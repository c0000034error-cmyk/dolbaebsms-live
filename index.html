<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS - Casino & Clicker Update</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'bounce-click': 'bounceClick 0.1s ease-in-out',
              'spin-slow': 'spin 3s linear infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              bounceClick: { '0%, 100%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.95)' } }
            }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      * { box-sizing: border-box; }
      body { background-color: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
      #root { height: 100vh; overflow: hidden; }
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
      
      .nft-container { position: relative; display: inline-block; }
      .nft-orbital { position: absolute; width: 60px; height: 60px; top: 50%; left: 50%; margin-top: -30px; margin-left: -30px; animation: orbit 10s linear infinite; pointer-events: none; z-index: 10; }
      .nft-item { position: absolute; font-size: 16px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; text-shadow: 0 0 5px black; }
      @keyframes orbit { 0% { transform: rotate(0deg) translateX(35px) rotate(0deg); } 100% { transform: rotate(360deg) translateX(35px) rotate(-360deg); } }
      
      .rarity-common { border: 1px solid #9ca3af; background: rgba(156, 163, 175, 0.1); }
      .rarity-rare { border: 1px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
      .rarity-epic { border: 1px solid #a855f7; background: rgba(168, 85, 247, 0.1); }
      .rarity-legendary { border: 1px solid #eab308; background: rgba(234, 179, 8, 0.1); box-shadow: 0 0 10px rgba(234, 179, 8, 0.2); }
      .rarity-mythic { border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }

      .float-fn { color: #4ade80; } /* Factory New */
      .float-mw { color: #a3e635; } 
      .float-ft { color: #facc15; } 
      .float-ww { color: #fb923c; } 
      .float-bs { color: #f87171; } /* Battle Scarred */

      @media (max-width: 768px) {
        .mobile-chat-hidden { display: none; }
        .mobile-chat-visible { display: flex; width: 100%; position: absolute; top: 0; left: 0; height: 100%; z-index: 20; background: #0f172a; }
        .mobile-sidebar-hidden { display: none; }
      }
    </style>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
        "date-fns": "https://esm.sh/date-fns@2.30.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Settings, Trash2, Smile, MoreVertical, LogOut, User, Loader2, Coins, TrendingUp, Info, ShoppingCart, Dice5, Zap, Bot, Trophy, Play } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        const firebaseConfig = {
          apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
          authDomain: "dolbaebsms-live.firebaseapp.com",
          databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
          projectId: "dolbaebsms-live",
          storageBucket: "dolbaebsms-live.firebasestorage.app",
          messagingSenderId: "912825721862",
          appId: "1:912825721862:web:b92d7f7f553ca4536c0f87",
          measurementId: "G-SCD5JVFM5E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- NFT DATA ---
        const NFT_ITEMS = [
            { id: 'apple', emoji: 'üçé', name: '–Ø–±–ª–æ–∫–æ', base: 500, rarity: 'common' },
            { id: 'rock', emoji: 'ü™®', name: '–ö–∞–º–µ–Ω—å', base: 450, rarity: 'common' },
            { id: 'sword', emoji: '‚öîÔ∏è', name: '–ú–µ—á', base: 1200, rarity: 'rare' },
            { id: 'shield', emoji: 'üõ°Ô∏è', name: '–©–∏—Ç', base: 1100, rarity: 'rare' },
            { id: 'car', emoji: 'üèéÔ∏è', name: '–°–ø–æ—Ä—Ç–∫–∞—Ä', base: 2800, rarity: 'epic' },
            { id: 'house', emoji: 'üè†', name: '–î–æ–º', base: 3500, rarity: 'epic' },
            { id: 'dragon', emoji: 'üêâ', name: '–î—Ä–∞–∫–æ–Ω', base: 9000, rarity: 'legendary' },
            { id: 'crown', emoji: 'üëë', name: '–ö–æ—Ä–æ–Ω–∞', base: 12000, rarity: 'legendary' },
            { id: 'blackhole', emoji: 'üï≥Ô∏è', name: '–ß–µ—Ä–Ω–∞—è –î—ã—Ä–∞', base: 50000, rarity: 'mythic' }
        ];

        // --- COMPONENTS ---

        const Button = ({ children, variant = 'primary', className = '', ...props }) => {
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100",
                danger: "bg-red-500/20 text-red-500 border border-red-500/50",
                gold: "bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg shadow-yellow-500/20",
                green: "bg-green-600 hover:bg-green-500 text-white"
            };
            return (
                <button className={`px-4 py-2 rounded-xl font-medium transition active:scale-95 disabled:opacity-50 flex items-center justify-center gap-2 ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        // --- CASINO MODAL (10 Games) ---
        const CasinoModal = ({ isOpen, onClose, userCoins, onUpdateCoins }) => {
            const [game, setGame] = useState(null); // 'slots', 'dice', 'coin', 'roulette', 'rps', 'cards', 'guess', 'thimbles', 'wheel', 'mines'
            const [bet, setBet] = useState(10);
            const [result, setResult] = useState('');

            if (!isOpen) return null;

            const handleBet = (winMultiplier) => {
                if (userCoins < bet) { alert('–ú–∞–ª–æ –¥–µ–Ω–µ–≥!'); return; }
                const isWin = winMultiplier > 0;
                let newCoins;
                
                if (isWin) {
                    const profit = Math.floor(bet * winMultiplier);
                    newCoins = userCoins + (profit - bet); // Add profit (bet is already included in base calc usually, simpler: coins - bet + bet*mult)
                    // Correct: coins - bet + winnings.
                    newCoins = userCoins - bet + Math.floor(bet * winMultiplier);
                    setResult(`Win! +${Math.floor(bet * winMultiplier)}`);
                } else {
                    newCoins = userCoins - bet;
                    setResult(`Loss -${bet}`);
                }
                onUpdateCoins(newCoins);
            };

            const gamesList = [
                { id: 'slots', icon: 'üé∞', name: '–°–ª–æ—Ç—ã', play: () => {
                    const symbols = ['üçí', 'üçã', '7Ô∏è‚É£', 'üíé'];
                    const res = [0,1,2].map(() => symbols[Math.floor(Math.random()*4)]);
                    const win = res[0] === res[1] && res[1] === res[2] ? (res[0] === '7Ô∏è‚É£' ? 10 : 5) : 0;
                    handleBet(win);
                    alert(`${res.join(' ')} ${win > 0 ? 'WIN!' : 'LOSE'}`);
                }},
                { id: 'dice', icon: 'üé≤', name: '–ö–æ—Å—Ç–∏ (Hi/Lo)', play: () => {
                    const roll = Math.floor(Math.random() * 12) + 2;
                    const choice = confirm("–°—Ç–∞–≤–∏–º –Ω–∞ –ë–æ–ª—å—à–µ 7? (–û–ö - –î–∞, –û—Ç–º–µ–Ω–∞ - –ú–µ–Ω—å—à–µ 7)") ? 'hi' : 'lo';
                    const win = (choice === 'hi' && roll > 7) || (choice === 'lo' && roll < 7) ? 2 : 0;
                    handleBet(win);
                    alert(`–í—ã–ø–∞–ª–æ: ${roll}. ${win > 0 ? '–ü–æ–±–µ–¥–∞!' : '–ü—Ä–æ–∏–≥—Ä—ã—à'}`);
                }},
                { id: 'coin', icon: 'ü™ô', name: '–ú–æ–Ω–µ—Ç–∫–∞', play: () => {
                    const flip = Math.random() > 0.5 ? 'heads' : 'tails';
                    const choice = confirm("–û—Ä–µ–ª? (–û—Ç–º–µ–Ω–∞ - –†–µ—à–∫–∞)") ? 'heads' : 'tails';
                    handleBet(flip === choice ? 1.9 : 0);
                    alert(`–í—ã–ø–∞–ª–æ: ${flip === 'heads' ? '–û—Ä–µ–ª' : '–†–µ—à–∫–∞'}`);
                }},
                { id: 'roulette', icon: 'üé°', name: '–†—É–ª–µ—Ç–∫–∞ (–¶–≤–µ—Ç)', play: () => {
                    const n = Math.floor(Math.random() * 37);
                    const color = n === 0 ? 'green' : (n % 2 === 0 ? 'red' : 'black');
                    const choice = confirm("–°—Ç–∞–≤–∏–º –Ω–∞ –ö—Ä–∞—Å–Ω–æ–µ? (–û—Ç–º–µ–Ω–∞ - –ß–µ—Ä–Ω–æ–µ)") ? 'red' : 'black';
                    handleBet(color === choice ? 2 : 0);
                    alert(`–í—ã–ø–∞–ª–æ: ${n} (${color})`);
                }},
                { id: 'rps', icon: '‚úÇÔ∏è', name: '–ö-–ù-–ë', play: () => {
                    const opts = ['k', 'n', 'b'];
                    const bot = opts[Math.floor(Math.random()*3)];
                    const u = prompt("k = –∫–∞–º–µ–Ω—å, n = –Ω–æ–∂–Ω–∏—Ü—ã, b = –±—É–º–∞–≥–∞", "k");
                    if(!opts.includes(u)) return;
                    let m = 0;
                    if (u === bot) m = 1; // tie return bet
                    else if ((u === 'k' && bot === 'n') || (u === 'n' && bot === 'b') || (u === 'b' && bot === 'k')) m = 2;
                    handleBet(m);
                    alert(`–ë–æ—Ç: ${bot}. ${m === 2 ? 'Win' : m === 1 ? 'Tie' : 'Lose'}`);
                }},
                { id: 'cards', icon: 'üÉè', name: '–ö–∞—Ä—Ç—ã (High)', play: () => {
                    const p = Math.floor(Math.random() * 13) + 2;
                    const d = Math.floor(Math.random() * 13) + 2;
                    handleBet(p > d ? 2 : 0);
                    alert(`–¢—ã: ${p}, –î–∏–ª–µ—Ä: ${d}`);
                }},
                { id: 'guess', icon: 'üî¢', name: '–ß–∏—Å–ª–æ (1-5)', play: () => {
                    const n = Math.floor(Math.random() * 5) + 1;
                    const u = parseInt(prompt("–ß–∏—Å–ª–æ –æ—Ç 1 –¥–æ 5"));
                    handleBet(n === u ? 5 : 0);
                    alert(`–ë—ã–ª–æ: ${n}`);
                }},
                { id: 'thimbles', icon: 'ü•õ', name: '–ù–∞–ø–µ—Ä—Å—Ç–∫–∏', play: () => {
                    const ball = Math.floor(Math.random() * 3);
                    const u = parseInt(prompt("–ì–¥–µ —à–∞—Ä–∏–∫? (0, 1, 2)")) || 0;
                    handleBet(ball === u ? 2.8 : 0);
                    alert(`–®–∞—Ä–∏–∫ –±—ã–ª –≤ ${ball}`);
                }},
                { id: 'wheel', icon: 'üé™', name: '–ö–æ–ª–µ—Å–æ x3', play: () => {
                    const segs = [0, 0, 0, 1.5, 1.5, 3];
                    const res = segs[Math.floor(Math.random()*segs.length)];
                    handleBet(res);
                    alert(`x${res}`);
                }},
                { id: 'mines', icon: 'üí£', name: '–°–∞–ø–µ—Ä (50%)', play: () => {
                    // Simple 1 step mines
                    handleBet(Math.random() > 0.5 ? 2 : 0);
                    alert(result.includes('Win') ? '–ü—Ä–æ–Ω–µ—Å–ª–æ! x2' : '–ë–ê–ë–ê–•!');
                }}
            ];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-2xl flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-white flex gap-2"><Trophy className="text-yellow-500"/> –ö–∞–∑–∏–Ω–æ</h2>
                            <button onClick={onClose}><X className="text-slate-400"/></button>
                        </div>
                        <div className="p-4 border-b border-slate-800 flex gap-4 items-center">
                            <div className="text-yellow-500 font-bold flex gap-1"><Coins size={16}/> {userCoins}</div>
                            <input type="number" value={bet} onChange={e => setBet(Number(e.target.value))} className="bg-slate-800 border border-slate-700 rounded px-2 py-1 w-24 text-white" placeholder="–°—Ç–∞–≤–∫–∞" />
                        </div>
                        <div className="p-4 grid grid-cols-2 sm:grid-cols-3 gap-3 overflow-y-auto custom-scrollbar">
                            {gamesList.map(g => (
                                <button key={g.id} onClick={g.play} className="bg-slate-800 hover:bg-slate-700 p-4 rounded-xl flex flex-col items-center gap-2 border border-slate-700 transition active:scale-95">
                                    <span className="text-4xl">{g.icon}</span>
                                    <span className="font-bold text-sm">{g.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- CLICKER & BOT ---
        const ClickerSection = ({ user, coins, clickLevel, botExpires, onUpdate }) => {
            const hasBot = botExpires > Date.now();
            const clickPower = 1 + (clickLevel * 0.5);
            const upgradeCost = Math.floor(100 * Math.pow(1.5, clickLevel));

            const handleClick = () => {
                onUpdate({ coins: coins + clickPower });
            };

            const buyUpgrade = () => {
                if (coins >= upgradeCost) {
                    onUpdate({ coins: coins - upgradeCost, clickLevel: clickLevel + 1 });
                }
            };

            const buyBot = () => {
                if (coins >= 5000) {
                    // Set bot to expire in 30 mins
                    onUpdate({ coins: coins - 5000, botExpires: Date.now() + 30 * 60 * 1000 });
                }
            };

            return (
                <div className="p-4 border-t border-slate-800 bg-slate-900/50">
                    <h3 className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider flex items-center gap-1"><Zap size={12}/> –ú–∞–π–Ω–∏–Ω–≥</h3>
                    
                    <button 
                        onClick={handleClick}
                        className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition mb-3 flex items-center justify-center gap-2"
                    >
                        <Coins size={20} className="animate-bounce" />
                        –ö–ª–∏–∫ (+{clickPower})
                    </button>

                    <div className="grid grid-cols-2 gap-2">
                        <button onClick={buyUpgrade} disabled={coins < upgradeCost} className="bg-slate-800 p-2 rounded-lg text-xs text-center border border-slate-700 hover:bg-slate-700 disabled:opacity-50">
                            <div className="font-bold text-green-400">Up lvl {clickLevel}</div>
                            <div className="text-slate-400">{upgradeCost} üí∞</div>
                        </button>
                        
                        <button onClick={buyBot} disabled={coins < 5000 || hasBot} className="bg-slate-800 p-2 rounded-lg text-xs text-center border border-slate-700 hover:bg-slate-700 disabled:opacity-50">
                            <div className="font-bold text-blue-400 flex justify-center items-center gap-1"><Bot size={12}/> {hasBot ? 'Active' : 'Bot'}</div>
                            <div className="text-slate-400">{hasBot ? Math.ceil((botExpires - Date.now())/60000) + 'm' : '5000 üí∞'}</div>
                        </button>
                    </div>
                </div>
            );
        };

        // --- NFT MARKET ---
        const NFTMarket = ({ isOpen, onClose, currentUser, userCoins, userNFTs }) => {
            const [marketPrices, setMarketPrices] = useState({});
            const [activeTab, setActiveTab] = useState('buy');
            
            useEffect(() => {
                if (!isOpen) return;
                const marketRef = ref(db, 'market_v2');
                onValue(marketRef, (snap) => {
                    const data = snap.val() || { prices: {}, lastUpdate: 0 };
                    // Simulate price updates
                    if (Date.now() - data.lastUpdate > 10000) {
                        const newPrices = {};
                        NFT_ITEMS.forEach(item => {
                            const old = data.prices[item.id] || item.base;
                            const change = (Math.random() - 0.5) * 0.2;
                            newPrices[item.id] = Math.floor(Math.max(item.base*0.1, old * (1+change)));
                        });
                        update(marketRef, { prices: newPrices, lastUpdate: Date.now() });
                    } else {
                        setMarketPrices(data.prices);
                    }
                });
            }, [isOpen]);

            if (!isOpen) return null;

            const buy = async (item) => {
                const price = marketPrices[item.id] || item.base;
                if (userCoins < price) return alert('No money');
                const newItem = {
                    id: item.id,
                    uuid: Date.now() + Math.random().toString(),
                    float: parseFloat(Math.random().toFixed(4)),
                    pattern: Math.floor(Math.random() * 1000),
                    isEquipped: false
                };
                await update(ref(db, `users/${currentUser}`), {
                    coins: userCoins - price,
                    nfts: [...(userNFTs || []), newItem]
                });
            };

            const sell = async (inst) => {
                const price = marketPrices[NFT_ITEMS.find(n=>n.id===inst.id).id];
                const sellPrice = Math.floor(price * (1 - inst.float * 0.5));
                if (confirm(`Sell for ${sellPrice}?`)) {
                    const newNfts = userNFTs.filter(n => n.uuid !== inst.uuid);
                    await update(ref(db, `users/${currentUser}`), { coins: userCoins + sellPrice, nfts: newNfts });
                }
            };

            const equip = async (inst) => {
                const newNfts = userNFTs.map(n => n.uuid === inst.uuid ? { ...n, isEquipped: !n.isEquipped } : n);
                await update(ref(db, `users/${currentUser}`), { nfts: newNfts });
            };

            const getFloatColor = (f) => f < 0.1 ? 'text-green-400' : f < 0.4 ? 'text-yellow-400' : 'text-red-400';

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur p-4">
                    <div className="bg-slate-900 w-full max-w-4xl rounded-2xl border border-slate-700 flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex justify-between"><h2 className="text-xl font-bold text-white">NFT Market</h2><button onClick={onClose}><X/></button></div>
                        <div className="flex bg-slate-800"><button onClick={()=>setActiveTab('buy')} className={`flex-1 p-3 ${activeTab==='buy'?'bg-indigo-600':''}`}>–ö—É–ø–∏—Ç—å</button><button onClick={()=>setActiveTab('sell')} className={`flex-1 p-3 ${activeTab==='sell'?'bg-indigo-600':''}`}>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button></div>
                        <div className="p-4 overflow-y-auto flex-1 grid grid-cols-2 sm:grid-cols-4 gap-3 bg-slate-950">
                            {activeTab === 'buy' ? NFT_ITEMS.map(i => (
                                <div key={i.id} className="bg-slate-900 p-3 rounded border border-slate-800 flex flex-col items-center">
                                    <div className="text-3xl">{i.emoji}</div>
                                    <div className="font-bold">{i.name}</div>
                                    <div className="text-green-400">{marketPrices[i.id] || i.base} üí∞</div>
                                    <Button onClick={()=>buy(i)} variant="gold" className="w-full mt-2 text-xs">Buy</Button>
                                </div>
                            )) : (userNFTs || []).map(i => {
                                const def = NFT_ITEMS.find(n=>n.id===i.id);
                                return (
                                    <div key={i.uuid} className={`bg-slate-900 p-3 rounded border flex flex-col items-center ${i.isEquipped ? 'border-green-500' : 'border-slate-800'}`}>
                                        <div className="text-3xl">{def.emoji}</div>
                                        <div className="text-[10px] text-slate-400">Pat: {i.pattern}</div>
                                        <div className={`text-[10px] ${getFloatColor(i.float)}`}>F: {i.float}</div>
                                        <div className="flex gap-1 w-full mt-2">
                                            <button onClick={()=>equip(i)} className="flex-1 bg-slate-700 text-[10px] rounded py-1">{i.isEquipped?'Unequip':'Equip'}</button>
                                            <button onClick={()=>sell(i)} className="flex-1 bg-red-900 text-[10px] rounded py-1">Sell</button>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            )
        };

        // --- MAIN APP ---
        const App = () => {
            const [user, setUser] = useState(() => localStorage.getItem('user'));
            const [loginInput, setLoginInput] = useState('');
            
            // Data
            const [userData, setUserData] = useState({ coins: 0, nfts: [], clickLevel: 0, botExpires: 0 });
            const [allUsers, setAllUsers] = useState({});
            const [chats, setChats] = useState([]);
            const [activeChat, setActiveChat] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');

            // Modals
            const [showMarket, setShowMarket] = useState(false);
            const [showCasino, setShowCasino] = useState(false);

            // 1. Load User
            useEffect(() => {
                if(user) {
                    const refUser = ref(db, `users/${user}`);
                    onValue(refUser, s => {
                        const d = s.val();
                        if(d) setUserData({ 
                            coins: d.coins||0, nfts: d.nfts||[], 
                            clickLevel: d.clickLevel||0, botExpires: d.botExpires||0 
                        });
                    });
                    
                    // Load all users for avatars
                    onValue(ref(db, 'users'), s => setAllUsers(s.val()||{}));

                    // Load Chat List
                    onValue(ref(db, 'messages'), s => {
                        const all = s.val()||{};
                        const setC = new Set();
                        Object.keys(all).forEach(k => {
                            if(k.includes(user)) setC.add(k.replace(user, '').replace('_', ''));
                        });
                        setChats(Array.from(setC));
                    });
                }
            }, [user]);

            // 2. Messages
            useEffect(() => {
                if(user && activeChat) {
                    const cid = [user, activeChat].sort().join('_');
                    onValue(ref(db, `messages/${cid}`), s => {
                        const m = s.val();
                        setMessages(m ? Object.values(m).sort((a,b)=>a.timestamp-b.timestamp) : []);
                    });
                }
            }, [user, activeChat]);

            // 3. Bot Logic (Auto-Clicker)
            useEffect(() => {
                if (user && userData.botExpires > Date.now()) {
                    const interval = setInterval(() => {
                        // Check expire again inside
                        if (userData.botExpires > Date.now()) {
                            // Add logic to increment coins in DB directly safely
                            // To keep simple, we assume local state is roughly synced or just push update
                            // We use a transaction-like update by reading current ref
                            const uRef = ref(db, `users/${user}`);
                            get(uRef).then(snap => {
                                const d = snap.val();
                                const power = 1 + ((d.clickLevel||0) * 0.5);
                                update(uRef, { coins: d.coins + power });
                            });
                        }
                    }, 5000); // Every 5 seconds
                    return () => clearInterval(interval);
                }
            }, [user, userData.botExpires]);

            const login = () => {
                const n = loginInput.trim().toLowerCase().replace(/[^a-z0-9]/g, '').substring(0,15);
                if(!n) return;
                const r = ref(db, `users/${n}`);
                get(r).then(s => {
                    if(!s.exists()) set(r, { coins: 500, clickLevel: 0, botExpires: 0 });
                });
                localStorage.setItem('user', n);
                setUser(n);
            };

            const send = () => {
                if(!inputText) return;
                const cid = [user, activeChat].sort().join('_');
                push(ref(db, `messages/${cid}`), { sender: user, content: inputText, type: 'text', timestamp: Date.now() });
                setInputText('');
            };

            const updateUserData = (updates) => update(ref(db, `users/${user}`), updates);

            if(!user) return (
                <div className="h-screen flex items-center justify-center bg-slate-950 p-4">
                    <div className="w-full max-w-sm bg-slate-900 p-6 rounded-2xl border border-slate-800">
                        <h1 className="text-2xl font-bold text-white text-center mb-4">DolbaebSMS</h1>
                        <input className="w-full p-3 rounded-xl bg-slate-800 text-white mb-3" placeholder="Nick (eng/num)" value={loginInput} onChange={e=>setLoginInput(e.target.value)}/>
                        <Button onClick={login} className="w-full">Login</Button>
                    </div>
                </div>
            );

            return (
                <div className="flex h-screen bg-slate-950 text-white overflow-hidden">
                    <NFTMarket isOpen={showMarket} onClose={()=>setShowMarket(false)} currentUser={user} userCoins={userData.coins} userNFTs={userData.nfts} />
                    <CasinoModal isOpen={showCasino} onClose={()=>setShowCasino(false)} userCoins={userData.coins} onUpdateCoins={c => updateUserData({coins: c})} />

                    {/* SIDEBAR */}
                    <div className={`w-full md:w-80 bg-slate-900 border-r border-slate-800 flex flex-col ${activeChat ? 'mobile-sidebar-hidden' : ''}`}>
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="nft-container">
                                    <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center font-bold border border-slate-600">
                                        {user[0].toUpperCase()}
                                    </div>
                                    <div className="nft-orbital">
                                        {(userData.nfts||[]).filter(n=>n.isEquipped).map((n, i, arr) => {
                                            const def = NFT_ITEMS.find(d=>d.id===n.id);
                                            const deg = (i/arr.length)*360;
                                            return <div key={n.uuid} className="nft-item" style={{transform: `rotate(${deg}deg) translateX(28px) rotate(-${deg}deg)`}}>{def.emoji}</div>
                                        })}
                                    </div>
                                </div>
                                <div>
                                    <div className="font-bold">{user}</div>
                                    <div className="text-xs text-yellow-500 font-mono">{Math.floor(userData.coins)} üí∞</div>
                                </div>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={()=>setShowCasino(true)} className="p-2 hover:bg-slate-800 rounded"><Dice5 size={20}/></button>
                                <button onClick={()=>setShowMarket(true)} className="p-2 hover:bg-slate-800 rounded"><ShoppingCart size={20}/></button>
                            </div>
                        </div>

                        {/* CLICKER AREA */}
                        <ClickerSection 
                            user={user} 
                            coins={userData.coins} 
                            clickLevel={userData.clickLevel} 
                            botExpires={userData.botExpires} 
                            onUpdate={updateUserData} 
                        />

                        {/* CHAT LIST */}
                        <div className="flex-1 overflow-y-auto p-2">
                            <div className="text-xs text-slate-500 uppercase px-2 mb-2">Chats</div>
                            {chats.map(c => (
                                <div key={c} onClick={()=>setActiveChat(c)} className="p-3 hover:bg-slate-800 rounded-xl cursor-pointer flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center">{c[0].toUpperCase()}</div>
                                    <span className="font-medium">{c}</span>
                                </div>
                            ))}
                            <div className="p-3 mt-2">
                                <input placeholder="Start chat with..." className="w-full bg-slate-950 p-2 rounded text-sm" 
                                    onKeyDown={e=>{
                                        if(e.key==='Enter'){
                                            const u = e.target.value.toLowerCase();
                                            if(u && u!==user) setActiveChat(u);
                                            e.target.value='';
                                        }
                                    }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* CHAT WINDOW */}
                    {activeChat ? (
                        <div className={`flex-1 flex flex-col bg-slate-950 mobile-chat-visible`}>
                            <div className="p-3 border-b border-slate-800 bg-slate-900/80 backdrop-blur flex items-center gap-3">
                                <button onClick={()=>setActiveChat(null)} className="md:hidden"><ChevronLeft/></button>
                                <div className="nft-container">
                                    <div className="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center">{activeChat[0].toUpperCase()}</div>
                                    <div className="nft-orbital">
                                        {/* Show opponent NFTs */}
                                        {(allUsers[activeChat]?.nfts||[]).filter(n=>n.isEquipped).map((n, i, arr) => {
                                            const def = NFT_ITEMS.find(d=>d.id===n.id);
                                            const deg = (i/arr.length)*360;
                                            return <div key={n.uuid} className="nft-item" style={{transform: `rotate(${deg}deg) translateX(25px) rotate(-${deg}deg)`}}>{def.emoji}</div>
                                        })}
                                    </div>
                                </div>
                                <span className="font-bold">{activeChat}</span>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-2">
                                {messages.map(m => (
                                    <div key={m.timestamp} className={`flex ${m.sender===user ? 'justify-end':'justify-start'}`}>
                                        <div className={`max-w-[70%] p-3 rounded-2xl ${m.sender===user ? 'bg-indigo-600 text-white rounded-br-none':'bg-slate-800 rounded-bl-none'}`}>
                                            {m.content}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            <div className="p-3 bg-slate-900 border-t border-slate-800 flex gap-2">
                                <input className="flex-1 bg-slate-800 rounded-xl px-4 outline-none" value={inputText} onChange={e=>setInputText(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="Message..."/>
                                <Button onClick={send}><Send size={18}/></Button>
                            </div>
                        </div>
                    ) : (
                        <div className="hidden md:flex flex-1 items-center justify-center text-slate-600 select-none">Select a chat</div>
                    )}
                </div>
            )
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
