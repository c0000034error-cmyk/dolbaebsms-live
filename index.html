<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: { gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' } },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-gold': 'pulseGold 2s infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              pulseGold: { '0%, 100%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.05)', opacity: '0.8' } }
            }
          }
        }
      }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body { background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: none; height: 100vh; overflow: hidden; }
      #root { height: 100vh; overflow: hidden; }
      .safe-area-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
      .safe-area-top { padding-top: max(0.5rem, env(safe-area-inset-top)); }
      .frame-basic { border: 2px solid #6b7280; box-shadow: 0 0 5px rgba(107, 114, 128, 0.5); }
      .frame-silver { border: 3px solid #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.7); }
      .frame-gold { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
      .frame-diamond { border: 3px solid #b9f2ff; box-shadow: 0 0 20px rgba(185, 242, 255, 0.9); }
      .frame-rainbow { 
        border: 3px solid transparent;
        background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff) border-box;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
      }
      .avatar-locked { filter: grayscale(1) brightness(0.5); position: relative; }
      .avatar-locked::after { content: "üîí"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; z-index: 10; }
      .nft-container { position: relative; display: inline-block; }
      .nft-orbital { position: absolute; width: 60px; height: 60px; top: 50%; left: 50%; margin-top: -30px; margin-left: -30px; animation: orbit 10s linear infinite; z-index: 5; }
      .nft-item { position: absolute; font-size: 20px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; animation: float 3s ease-in-out infinite; }
      @keyframes orbit { 0% { transform: rotate(0deg) translateX(40px) rotate(0deg); } 100% { transform: rotate(360deg) translateX(40px) rotate(-360deg); } }
      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
      @media (max-width: 640px) {
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button, [role="button"] { min-height: 44px; min-width: 44px; }
      }
    </style>

    <script type="importmap">
{"imports": {
  "react": "https://esm.sh/react@18.2.0",
  "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
  "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
  "date-fns": "https://esm.sh/date-fns@2.30.0",
  "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
  "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
}}</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Video, Settings as SettingsIcon, Trash2, Smile, MoreVertical, LogOut, User as UserIcon, Loader2, Coins, Crown, Palette, Edit3, Trophy, Bot, TrendingUp, Send as SendIcon, Info, Clock, TrendingDown, Star, Zap, Shield, Skull, Crown as CrownIcon, Gem } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        // Firebase config
        const app = initializeApp({
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87"
        });
        const db = getDatabase(app);

        // Components
        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-sm min-h-[44px]";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                gold: "bg-yellow-500 hover:bg-yellow-400 text-white shadow-lg shadow-yellow-500/20"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? <Loader2 className="animate-spin h-4 w-4" /> : <>{icon && <span className="text-base">{icon}</span>}{children}</>}
                </button>
            );
        };

        // Modal Base Component
        const Modal = ({ isOpen, onClose, title, children, className = "" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className={`w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh] ${className}`}>
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // NFT Market Modal
        const NFTMarketModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate, userNFTs, onNFTUpdate, usersData }) => {
            const [activeTab, setActiveTab] = useState('market');
            const [isLoading, setIsLoading] = useState(false);
            const [giftRecipient, setGiftRecipient] = useState('');
            const [giftNFT, setGiftNFT] = useState(null);
            const [sellPrice, setSellPrice] = useState('');
            const [sellNFT, setSellNFT] = useState(null);
            const [nftMarketPrices, setNftMarketPrices] = useState({});

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NFT —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –∏ —Ä–µ–¥–∫–æ—Å—Ç—å—é
            const nfts = [
                { id: 'ghost', name: '–ü—Ä–∏–∑—Ä–∞–∫', emoji: 'üëª', basePrice: 600, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'robot', name: '–†–æ–±–æ—Ç', emoji: 'ü§ñ', basePrice: 800, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω', emoji: 'üêâ', basePrice: 1800, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'unicorn', name: '–ï–¥–∏–Ω–æ—Ä–æ–≥', emoji: 'ü¶Ñ', basePrice: 3000, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'phoenix', name: '–§–µ–Ω–∏–∫—Å', emoji: 'ü¶ö', basePrice: 2200, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'alien', name: '–ü—Ä–∏—à–µ–ª–µ—Ü', emoji: 'üëΩ', basePrice: 1200, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'crown', name: '–ö–æ—Ä–æ–Ω–∞', emoji: 'üëë', basePrice: 5000, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', basePrice: 4000, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'fire', name: '–û–≥–æ–Ω—å', emoji: 'üî•', basePrice: 1500, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'comet', name: '–ö–æ–º–µ—Ç–∞', emoji: '‚òÑÔ∏è', basePrice: 2500, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'star', name: '–ó–≤–µ–∑–¥–∞', emoji: '‚≠ê', basePrice: 1000, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'moon', name: '–õ—É–Ω–∞', emoji: 'üåô', basePrice: 900, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'sun', name: '–°–æ–ª–Ω—Ü–µ', emoji: '‚òÄÔ∏è', basePrice: 2000, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'planet', name: '–ü–ª–∞–Ω–µ—Ç–∞', emoji: 'ü™ê', basePrice: 2800, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'rocket', name: '–†–∞–∫–µ—Ç–∞', emoji: 'üöÄ', basePrice: 1700, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'rainbow', name: '–†–∞–¥—É–≥–∞', emoji: 'üåà', basePrice: 3500, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'thunder', name: '–ì—Ä–æ–º', emoji: '‚ö°', basePrice: 1900, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'snowflake', name: '–°–Ω–µ–∂–∏–Ω–∫–∞', emoji: '‚ùÑÔ∏è', basePrice: 800, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'flower', name: '–¶–≤–µ—Ç–æ–∫', emoji: 'üå∏', basePrice: 700, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'tree', name: '–î–µ—Ä–µ–≤–æ', emoji: 'üå≥', basePrice: 750, rarity: 'common', pattern: 'simple', durability: 100 }
            ];

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä—ã–Ω–æ—á–Ω—ã—Ö —Ü–µ–Ω NFT
            useEffect(() => {
                if (isOpen) {
                    const nftPricesRef = ref(db, 'nftMarketPrices');
                    const unsubscribe = onValue(nftPricesRef, (snapshot) => {
                        const data = snapshot.val() || {};
                        setNftMarketPrices(data);
                    });
                    return () => off(nftPricesRef);
                }
            }, [isOpen]);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã NFT —Å —É—á–µ—Ç–æ–º —Ä—ã–Ω–æ—á–Ω—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏–π
            const getCurrentPrice = (nft) => {
                const marketData = nftMarketPrices[nft.id] || { currentPrice: nft.basePrice, volatility: 0.1 };
                return marketData.currentPrice || nft.basePrice;
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏–∑–Ω–æ—Å–∞ NFT
            const getDurabilityPercentage = (userNft) => {
                return userNft.durability || 100;
            };

            // –ü–æ–∫—É–ø–∫–∞ NFT
            const handleBuyNFT = async (nft) => {
                const currentPrice = getCurrentPrice(nft);
                if (userCoins < currentPrice) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${currentPrice.toFixed(3)} –∫–æ–∏–Ω–æ–≤.`);
                    return;
                }
                setIsLoading(true);
                try {
                    const newNFTs = [...(userNFTs || []), { 
                        id: nft.id, 
                        purchasedAt: Date.now(), 
                        hidden: false,
                        durability: 100,
                        purchasePrice: currentPrice
                    }];
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - currentPrice,
                        nfts: newNFTs
                    });
                    onCoinsUpdate(userCoins - currentPrice);
                    onNFTUpdate(newNFTs);
                    alert(`–í—ã –∫—É–ø–∏–ª–∏ NFT "${nft.name}" –∑–∞ ${currentPrice.toFixed(3)} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('NFT purchase error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT');
                }
                setIsLoading(false);
            };

            // –£–¥–∞–ª–µ–Ω–∏–µ NFT –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
            const handleRemoveNFT = async (nftId) => {
                if (!confirm('–£–±—Ä–∞—Ç—å NFT –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è?')) return;
                setIsLoading(true);
                try {
                    const nftIndex = userNFTs.findIndex(nft => nft.id === nftId);
                    if (nftIndex === -1) return;
                    const newNFTs = [...userNFTs];
                    newNFTs[nftIndex] = { ...newNFTs[nftIndex], hidden: true };
                    await update(ref(db, `users/${currentUser}`), { nfts: newNFTs });
                    onNFTUpdate(newNFTs);
                    alert('NFT —É–±—Ä–∞–Ω –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è!');
                } catch (error) {
                    console.error('NFT remove error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ NFT');
                }
                setIsLoading(false);
            };

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ NFT –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            const handleRestoreNFT = async (nftId) => {
                setIsLoading(true);
                try {
                    const nftIndex = userNFTs.findIndex(nft => nft.id === nftId);
                    if (nftIndex === -1) return;
                    const newNFTs = [...userNFTs];
                    newNFTs[nftIndex] = { ...newNFTs[nftIndex], hidden: false };
                    await update(ref(db, `users/${currentUser}`), { nfts: newNFTs });
                    onNFTUpdate(newNFTs);
                    alert('NFT –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
                } catch (error) {
                    console.error('NFT restore error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ NFT');
                }
                setIsLoading(false);
            };

            // –ü–æ–¥–∞—Ä–æ–∫ NFT
            const handleGiftNFT = async () => {
                if (!giftRecipient.trim() || !giftNFT) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ NFT –∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
                    return;
                }
                if (giftRecipient === currentUser) {
                    alert('–ù–µ–ª—å–∑—è –ø–æ–¥–∞—Ä–∏—Ç—å NFT —Å–∞–º–æ–º—É —Å–µ–±–µ');
                    return;
                }
                setIsLoading(true);
                try {
                    const recipientRef = ref(db, `users/${giftRecipient}`);
                    const snapshot = await get(recipientRef);
                    if (!snapshot.exists()) {
                        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        setIsLoading(false);
                        return;
                    }
                    const recipientData = snapshot.val();
                    const recipientNFTs = recipientData.nfts || [];
                    const newSenderNFTs = userNFTs.filter(nft => nft.id !== giftNFT.id);
                    const newRecipientNFTs = [...recipientNFTs, { 
                        id: giftNFT.id, 
                        gifted: true, 
                        from: currentUser, 
                        giftedAt: Date.now(), 
                        hidden: false,
                        durability: giftNFT.durability || 100
                    }];
                    await update(ref(db, `users/${currentUser}`), { nfts: newSenderNFTs });
                    await update(recipientRef, { nfts: newRecipientNFTs });
                    const chatId = [currentUser, giftRecipient].sort().join('_');
                    const messageRef = push(ref(db, `messages/${chatId}`));
                    await set(messageRef, {
                        sender: currentUser,
                        text: `–ü–æ–¥–∞—Ä–∏–ª –≤–∞–º NFT: ${giftNFT.name} ${giftNFT.emoji}`,
                        timestamp: Date.now(),
                        type: 'nft_gift',
                        nftData: giftNFT,
                        deleted: false
                    });
                    onNFTUpdate(newSenderNFTs);
                    setGiftNFT(null);
                    setGiftRecipient('');
                    alert(`NFT "${giftNFT.name}" –ø–æ–¥–∞—Ä–µ–Ω!`);
                } catch (error) {
                    console.error('NFT gift error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ NFT');
                }
                setIsLoading(false);
            };

            // –ü—Ä–æ–¥–∞–∂–∞ NFT –Ω–∞ —Ä—ã–Ω–∫–µ
            const handleSellNFT = async () => {
                if (!sellPrice || parseFloat(sellPrice) <= 0) {
                    alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏');
                    return;
                }
                setIsLoading(true);
                try {
                    const nftToSell = userNFTs.find(nft => nft.id === sellNFT.id);
                    if (!nftToSell) return;
                    
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø—Ä–æ–¥–∞–∂–µ –Ω–∞ —Ä—ã–Ω–∫–µ
                    const marketListingRef = push(ref(db, 'nftMarketListings'));
                    await set(marketListingRef, {
                        nftId: sellNFT.id,
                        seller: currentUser,
                        price: parseFloat(sellPrice),
                        listedAt: Date.now(),
                        durability: nftToSell.durability || 100
                    });
                    
                    // –£–±–∏—Ä–∞–µ–º NFT —É –ø—Ä–æ–¥–∞–≤—Ü–∞
                    const newNFTs = userNFTs.filter(nft => nft.id !== sellNFT.id);
                    await update(ref(db, `users/${currentUser}`), { nfts: newNFTs });
                    
                    onNFTUpdate(newNFTs);
                    setSellNFT(null);
                    setSellPrice('');
                    alert(`NFT "${sellNFT.name}" –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –∑–∞ ${parseFloat(sellPrice).toFixed(3)} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('NFT sell error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ NFT –Ω–∞ –ø—Ä–æ–¥–∞–∂—É');
                }
                setIsLoading(false);
            };

            // –ü–æ–∫—É–ø–∫–∞ NFT —Å —Ä—ã–Ω–∫–∞
            const handleBuyFromMarket = async (listing) => {
                const nft = nfts.find(n => n.id === listing.nftId);
                if (!nft) return;
                
                if (userCoins < listing.price) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${listing.price.toFixed(3)} –∫–æ–∏–Ω–æ–≤.`);
                    return;
                }
                
                if (listing.seller === currentUser) {
                    alert('–ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å —Å–≤–æ–π –∂–µ NFT');
                    return;
                }
                
                setIsLoading(true);
                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º NFT –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
                    const newNFTs = [...(userNFTs || []), { 
                        id: nft.id, 
                        purchasedAt: Date.now(), 
                        hidden: false,
                        durability: listing.durability,
                        purchasedFromMarket: true,
                        originalSeller: listing.seller
                    }];
                    
                    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–∏–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É
                    const sellerRef = ref(db, `users/${listing.seller}`);
                    const sellerSnapshot = await get(sellerRef);
                    if (sellerSnapshot.exists()) {
                        const sellerData = sellerSnapshot.val();
                        await update(sellerRef, { 
                            coins: (sellerData.coins || 0) + listing.price 
                        });
                    }
                    
                    // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–∏–Ω—ã —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - listing.price,
                        nfts: newNFTs
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å —Å —Ä—ã–Ω–∫–∞
                    await remove(ref(db, `nftMarketListings/${listing.id}`));
                    
                    onCoinsUpdate(userCoins - listing.price);
                    onNFTUpdate(newNFTs);
                    alert(`–í—ã –∫—É–ø–∏–ª–∏ NFT "${nft.name}" –∑–∞ ${listing.price.toFixed(3)} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('Market purchase error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT —Å —Ä—ã–Ω–∫–∞');
                }
                setIsLoading(false);
            };

            // –†–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –º–∞–≥–∞–∑–∏–Ω–∞
            const renderMarketTab = () => (
                <div className="space-y-4">
                    <div className="text-center mb-4">
                        <p className="text-slate-400 text-sm">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ NFT</p>
                        <p className="text-xs text-slate-500 mt-1">–ë–∞–ª–∞–Ω—Å: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        {nfts.map((nft) => {
                            const isPurchased = userNFTs.some(userNft => userNft.id === nft.id);
                            if (isPurchased) return null;
                            const currentPrice = getCurrentPrice(nft);
                            const priceChange = ((currentPrice - nft.basePrice) / nft.basePrice * 100).toFixed(1);
                            return (
                                <div key={nft.id} className="p-3 rounded-xl flex flex-col items-center gap-2 bg-slate-800 border border-slate-700">
                                    <div className="text-3xl">{nft.emoji}</div>
                                    <div className="text-center">
                                        <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                        <p className="text-xs text-slate-300 mt-1">{currentPrice.toFixed(3)} –∫–æ–∏–Ω–æ–≤</p>
                                        <p className={`text-xs ${priceChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {priceChange >= 0 ? '+' : ''}{priceChange}%
                                        </p>
                                        <p className="text-xs text-slate-500 capitalize">{nft.rarity} ‚Ä¢ {nft.pattern}</p>
                                    </div>
                                    <Button onClick={() => handleBuyNFT(nft)} isLoading={isLoading} disabled={userCoins < currentPrice} variant="gold" className="w-full text-xs">
                                        –ö—É–ø–∏—Ç—å
                                    </Button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            // –†–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –º–æ–∏—Ö NFT
            const renderMyNFTsTab = () => (
                <div className="space-y-4">
                    {userNFTs.length > 0 ? (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            {userNFTs.map((userNft) => {
                                const nft = nfts.find(n => n.id === userNft.id);
                                if (!nft) return null;
                                const durability = getDurabilityPercentage(userNft);
                                const currentPrice = getCurrentPrice(nft);
                                return (
                                    <div key={nft.id} className={`p-3 rounded-xl flex flex-col items-center gap-2 bg-slate-800 border border-slate-700 ${userNft.hidden ? 'opacity-50' : ''}`}>
                                        <div className="text-3xl">{nft.emoji}</div>
                                        <div className="text-center">
                                            <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                            {userNft.gifted && <p className="text-xs text-green-400 mt-1">–ü–æ–¥–∞—Ä–æ–∫ –æ—Ç {userNft.from}</p>}
                                            {userNft.hidden && <p className="text-xs text-yellow-400 mt-1">–°–∫—Ä—ã—Ç</p>}
                                            <p className="text-xs text-slate-300 mt-1">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {currentPrice.toFixed(3)}</p>
                                            <div className="w-full bg-slate-700 rounded-full h-1.5 mt-1">
                                                <div 
                                                    className={`h-1.5 rounded-full ${durability > 70 ? 'bg-green-500' : durability > 30 ? 'bg-yellow-500' : 'bg-red-500'}`}
                                                    style={{ width: `${durability}%` }}
                                                ></div>
                                            </div>
                                            <p className="text-xs text-slate-400">–ò–∑–Ω–æ—Å: {durability}%</p>
                                        </div>
                                        <div className="flex gap-1 w-full">
                                            {userNft.hidden ? (
                                                <Button onClick={() => handleRestoreNFT(nft.id)} isLoading={isLoading} variant="primary" className="flex-1 text-xs">
                                                    –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                                </Button>
                                            ) : (
                                                <>
                                                    <Button onClick={() => handleRemoveNFT(nft.id)} isLoading={isLoading} variant="danger" className="flex-1 text-xs">
                                                        –£–±—Ä–∞—Ç—å
                                                    </Button>
                                                    <Button onClick={() => setSellNFT(nft)} variant="gold" className="flex-1 text-xs">
                                                        –ü—Ä–æ–¥–∞—Ç—å
                                                    </Button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç NFT</p>
                            <p className="text-sm mt-1">–ö—É–ø–∏—Ç–µ NFT –≤ –º–∞–≥–∞–∑–∏–Ω–µ</p>
                        </div>
                    )}
                </div>
            );

            // –†–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –ø–æ–¥–∞—Ä–∫–æ–≤
            const renderGiftTab = () => (
                <div className="space-y-4">
                    {giftNFT ? (
                        <div className="bg-slate-800 rounded-xl p-4">
                            <div className="text-center mb-4">
                                <div className="text-4xl mb-2">{giftNFT.emoji}</div>
                                <h3 className="font-bold text-white">{giftNFT.name}</h3>
                            </div>
                            <div className="space-y-3">
                                <input type="text" placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" value={giftRecipient} onChange={e => setGiftRecipient(e.target.value)} className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" />
                                <Button onClick={handleGiftNFT} isLoading={isLoading} disabled={!giftRecipient.trim()} variant="gold" className="w-full">–ü–æ–¥–∞—Ä–∏—Ç—å NFT</Button>
                                <Button onClick={() => setGiftNFT(null)} variant="secondary" className="w-full">–û—Ç–º–µ–Ω–∞</Button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ NFT –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞</p>
                        </div>
                    )}
                </div>
            );

            // –†–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ –ø—Ä–æ–¥–∞–∂–∏
            const renderSellTab = () => (
                <div className="space-y-4">
                    {sellNFT ? (
                        <div className="bg-slate-800 rounded-xl p-4">
                            <div className="text-center mb-4">
                                <div className="text-4xl mb-2">{sellNFT.emoji}</div>
                                <h3 className="font-bold text-white">{sellNFT.name}</h3>
                                <p className="text-slate-400 text-sm">–¢–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞: {getCurrentPrice(sellNFT).toFixed(3)} –∫–æ–∏–Ω–æ–≤</p>
                            </div>
                            <div className="space-y-3">
                                <input type="number" step="0.001" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏" value={sellPrice} onChange={e => setSellPrice(e.target.value)} className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" />
                                <Button onClick={handleSellNFT} isLoading={isLoading} disabled={!sellPrice || parseFloat(sellPrice) <= 0} variant="gold" className="w-full">–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</Button>
                                <Button onClick={() => setSellNFT(null)} variant="secondary" className="w-full">–û—Ç–º–µ–Ω–∞</Button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ NFT –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</p>
                        </div>
                    )}
                </div>
            );

            // –†–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ —Ä—ã–Ω–∫–∞
            const renderMarketplaceTab = () => {
                const [marketListings, setMarketListings] = useState([]);
                
                useEffect(() => {
                    if (isOpen) {
                        const marketListingsRef = ref(db, 'nftMarketListings');
                        const unsubscribe = onValue(marketListingsRef, (snapshot) => {
                            const data = snapshot.val() || {};
                            const listings = Object.entries(data).map(([id, listing]) => ({ id, ...listing }));
                            setMarketListings(listings);
                        });
                        return () => off(marketListingsRef);
                    }
                }, [isOpen]);
                
                return (
                    <div className="space-y-4">
                        <div className="text-center mb-4">
                            <p className="text-slate-400 text-sm">NFT –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
                        </div>
                        {marketListings.length > 0 ? (
                            <div className="grid grid-cols-1 gap-3">
                                {marketListings.map((listing) => {
                                    const nft = nfts.find(n => n.id === listing.nftId);
                                    if (!nft) return null;
                                    return (
                                        <div key={listing.id} className="p-3 rounded-xl flex items-center gap-3 bg-slate-800 border border-slate-700">
                                            <div className="text-3xl">{nft.emoji}</div>
                                            <div className="flex-1">
                                                <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                                <p className="text-xs text-slate-300">–ü—Ä–æ–¥–∞–≤–µ—Ü: {listing.seller}</p>
                                                <p className="text-xs text-slate-400">–ò–∑–Ω–æ—Å: {listing.durability}%</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-yellow-500 font-bold">{listing.price.toFixed(3)}</p>
                                                <Button onClick={() => handleBuyFromMarket(listing)} isLoading={isLoading} disabled={userCoins < listing.price || listing.seller === currentUser} variant="gold" className="mt-1 text-xs">
                                                    –ö—É–ø–∏—Ç—å
                                                </Button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="text-center text-slate-500 py-8">
                                <p>–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç NFT</p>
                            </div>
                        )}
                    </div>
                );
            };

            // –†–µ–Ω–¥–µ—Ä –≤–∫–ª–∞–¥–∫–∏ —Ç–æ–ø–∞
            const renderTopTab = () => {
                // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–æ–ø–∞
                const topUsersByCoins = Object.entries(usersData)
                    .filter(([username]) => username !== currentUser)
                    .map(([username, data]) => ({
                        username,
                        coins: data.coins || 0,
                        nfts: data.nfts || []
                    }))
                    .sort((a, b) => b.coins - a.coins)
                    .slice(0, 10);

                const topUsersByNFTs = Object.entries(usersData)
                    .filter(([username]) => username !== currentUser)
                    .map(([username, data]) => ({
                        username,
                        nftCount: (data.nfts || []).length,
                        nfts: data.nfts || []
                    }))
                    .sort((a, b) => b.nftCount - a.nftCount)
                    .slice(0, 10);

                return (
                    <div className="space-y-6">
                        <div>
                            <h3 className="text-white font-medium mb-3 flex items-center gap-2"><TrendingUp size={16} /> –¢–æ–ø –ø–æ –±–∞–ª–∞–Ω—Å—É</h3>
                            <div className="space-y-2">
                                {topUsersByCoins.map((user, index) => (
                                    <div key={user.username} className="flex items-center justify-between p-2 bg-slate-800 rounded-lg">
                                        <div className="flex items-center gap-2">
                                            <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${index === 0 ? 'bg-yellow-500 text-white' : index === 1 ? 'bg-gray-400 text-white' : index === 2 ? 'bg-orange-600 text-white' : 'bg-slate-700 text-slate-300'}`}>
                                                {index + 1}
                                            </span>
                                            <span className="text-white text-sm">{user.username}</span>
                                        </div>
                                        <span className="text-yellow-500 font-medium">{user.coins.toFixed(3)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        <div>
                            <h3 className="text-white font-medium mb-3 flex items-center gap-2"><CrownIcon size={16} /> –¢–æ–ø –ø–æ NFT</h3>
                            <div className="space-y-2">
                                {topUsersByNFTs.map((user, index) => (
                                    <div key={user.username} className="flex items-center justify-between p-2 bg-slate-800 rounded-lg">
                                        <div className="flex items-center gap-2">
                                            <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${index === 0 ? 'bg-yellow-500 text-white' : index === 1 ? 'bg-gray-400 text-white' : index === 2 ? 'bg-orange-600 text-white' : 'bg-slate-700 text-slate-300'}`}>
                                                {index + 1}
                                            </span>
                                            <span className="text-white text-sm">{user.username}</span>
                                        </div>
                                        <span className="text-purple-500 font-medium">{user.nftCount} NFT</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üé¥ NFT –ú–∞–≥–∞–∑–∏–Ω" className="max-w-4xl">
                    <div className="flex border-b border-slate-800 bg-slate-900/50 overflow-x-auto">
                        {['market', 'my_nfts', 'gift', 'sell', 'marketplace', 'top'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 text-xs font-medium min-h-[44px] whitespace-nowrap ${activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'}`}>
                                {tab === 'market' ? 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω' : 
                                 tab === 'my_nfts' ? 'üé¥ –ú–æ–∏ NFT' : 
                                 tab === 'gift' ? 'üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å' :
                                 tab === 'sell' ? 'üí∞ –ü—Ä–æ–¥–∞—Ç—å' :
                                 tab === 'marketplace' ? 'üè™ –†—ã–Ω–æ–∫' :
                                 'üèÜ –¢–æ–ø'}
                            </button>
                        ))}
                    </div>
                    {activeTab === 'market' && renderMarketTab()}
                    {activeTab === 'my_nfts' && renderMyNFTsTab()}
                    {activeTab === 'gift' && renderGiftTab()}
                    {activeTab === 'sell' && renderSellTab()}
                    {activeTab === 'marketplace' && renderMarketplaceTab()}
                    {activeTab === 'top' && renderTopTab()}
                </Modal>
            );
        };

        // Transfer Coins Modal
        const TransferCoinsModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate }) => {
            const [recipient, setRecipient] = useState('');
            const [amount, setAmount] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleTransfer = async () => {
                if (!recipient.trim()) { alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è'); return; }
                const transferAmount = parseFloat(amount);
                if (isNaN(transferAmount) || transferAmount <= 0) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É'); return; }
                if (transferAmount > userCoins) { alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤'); return; }
                if (recipient === currentUser) { alert('–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã —Å–∞–º–æ–º—É —Å–µ–±–µ'); return; }

                setIsLoading(true);
                try {
                    const recipientRef = ref(db, `users/${recipient}`);
                    const snapshot = await get(recipientRef);
                    if (!snapshot.exists()) { alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'); setIsLoading(false); return; }
                    const recipientData = snapshot.val();
                    const recipientCoins = recipientData.coins || 0;
                    await update(ref(db, `users/${currentUser}`), { coins: userCoins - transferAmount });
                    await update(recipientRef, { coins: recipientCoins + transferAmount });
                    const transactionRef = push(ref(db, 'transactions'));
                    await set(transactionRef, { from: currentUser, to: recipient, amount: transferAmount, timestamp: Date.now() });
                    onCoinsUpdate(userCoins - transferAmount);
                    setRecipient(''); setAmount('');
                    alert(`–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${transferAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('Transfer error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ');
                }
                setIsLoading(false);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üí∏ –ü–µ—Ä–µ–≤–æ–¥ –∫–æ–∏–Ω–æ–≤">
                    <div className="text-center mb-4">
                        <p className="text-slate-400 text-sm">–ü–µ—Ä–µ–≤–æ–¥ –∫–æ–∏–Ω–æ–≤ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
                        <p className="text-xs text-slate-500 mt-1">–ë–∞–ª–∞–Ω—Å: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                    </div>
                    <div className="space-y-3">
                        <div>
                            <label className="text-slate-400 text-sm mb-1 block">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
                            <input type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" value={recipient} onChange={e => setRecipient(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" />
                        </div>
                        <div>
                            <label className="text-slate-400 text-sm mb-1 block">–°—É–º–º–∞</label>
                            <input type="number" step="0.001" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" value={amount} onChange={e => setAmount(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" />
                        </div>
                        <Button onClick={handleTransfer} isLoading={isLoading} disabled={!recipient.trim() || !amount || parseFloat(amount) <= 0} variant="gold" className="w-full text-sm">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</Button>
                    </div>
                </Modal>
            );
        };

        // Casino Modal
        const CasinoModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate }) => {
            const [activeGame, setActiveGame] = useState('slots');
            const [betAmount, setBetAmount] = useState(1);
            const [isSpinning, setIsSpinning] = useState(false);
            const [result, setResult] = useState(null);
            const [slots, setSlots] = useState(['üçí', 'üçã', 'üçä']);

            const spinSlots = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                setIsSpinning(true);
                setResult(null);
                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                let spinCount = 0;
                const spinInterval = setInterval(() => {
                    setSlots([
                        ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'][Math.floor(Math.random() * 7)],
                        ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'][Math.floor(Math.random() * 7)],
                        ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'][Math.floor(Math.random() * 7)]
                    ]);
                    spinCount++;
                    if (spinCount >= 20) {
                        clearInterval(spinInterval);
                        const finalSlots = [
                            ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'][Math.floor(Math.random() * 7)],
                            ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'][Math.floor(Math.random() * 7)],
                            ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'][Math.floor(Math.random() * 7)]
                        ];
                        if (Math.random() < 0.6) {
                            if (Math.random() < 0.7) finalSlots[1] = finalSlots[0];
                            if (Math.random() < 0.4) finalSlots[2] = finalSlots[0];
                        }
                        setSlots(finalSlots);
                        let winMultiplier = 0;
                        if (finalSlots[0] === finalSlots[1] && finalSlots[1] === finalSlots[2]) {
                            winMultiplier = finalSlots[0] === '7Ô∏è‚É£' ? 5 : finalSlots[0] === '‚≠ê' ? 3 : 2.5;
                        } else if (finalSlots[0] === finalSlots[1] || finalSlots[1] === finalSlots[2]) {
                            winMultiplier = 1.8;
                        }
                        const winAmount = betAmount * winMultiplier;
                        if (winAmount > 0) {
                            const finalCoins = newCoins + winAmount;
                            update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                            onCoinsUpdate(finalCoins);
                        }
                        setResult({ win: winAmount > 0, amount: winAmount });
                        setIsSpinning(false);
                    }
                }, 100);
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üé∞ –ö–∞–∑–∏–Ω–æ">
                    <div className="text-center mb-4">
                        <div className="text-xl font-bold text-yellow-500">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</div>
                    </div>
                    <div className="grid grid-cols-3 gap-1 mb-4">
                        {['slots', 'dice', 'coin'].map(game => (
                            <button key={game} onClick={() => setActiveGame(game)} className={`p-2 rounded-lg text-center text-xs min-h-[44px] ${activeGame === game ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-300'}`}>
                                {game === 'slots' ? 'üé∞ –°–ª–æ—Ç—ã' : game === 'dice' ? 'üé≤ –ö–æ—Å—Ç–∏' : 'ü™ô –ú–æ–Ω–µ—Ç–∫–∞'}
                            </button>
                        ))}
                    </div>
                    {activeGame === 'slots' && (
                        <div className="space-y-3">
                            <div className="slot-machine bg-slate-800 border border-slate-700 rounded-xl p-3">
                                <div className="flex justify-between">
                                    {slots.map((slot, i) => <div key={i} className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>{slot}</div>)}
                                </div>
                            </div>
                            <div className="mb-4">
                                <label className="text-slate-400 text-sm mb-1 block">–°—Ç–∞–≤–∫–∞: {betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤</label>
                                <input type="range" min="0.1" max={Math.min(userCoins, 100)} step="0.1" value={betAmount} onChange={e => setBetAmount(parseFloat(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer" disabled={isSpinning} />
                            </div>
                            <Button onClick={spinSlots} isLoading={isSpinning} disabled={userCoins < betAmount} variant="gold" className="w-full text-sm">
                                {isSpinning ? '–ö—Ä—É—Ç–∏–º...' : `–ö—Ä—É—Ç–∏—Ç—å –∑–∞ ${betAmount.toFixed(3)}`}
                            </Button>
                            {result && <div className={`text-center p-2 rounded-lg text-sm ${result.win ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                {result.win ? `üéâ –í—ã–∏–≥—Ä–∞–ª–∏ ${result.amount.toFixed(3)} –∫–æ–∏–Ω–æ–≤!` : 'üò¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!'}
                            </div>}
                        </div>
                    )}
                </Modal>
            );
        };

        // Settings Modal
        const SettingsModal = ({ isOpen, onClose, currentUser, onLogout, userCoins, userAvatar, userFrame, userNameColor, userStatus, userStatusEmoji, onAvatarChange, onFrameChange, onColorChange, onStatusChange }) => {
            const [activeTab, setActiveTab] = useState('profile');
            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isFrameModalOpen, setIsFrameModalOpen] = useState(false);
            const [isNameColorModalOpen, setIsNameColorModalOpen] = useState(false);
            const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);

            const getNameColorStyle = (colorId) => {
                const colors = { 'red': '#ef4444', 'orange': '#f97316', 'yellow': '#eab308', 'green': '#22c55e', 'blue': '#3b82f6', 'purple': '#a855f7', 'rainbow': 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)' };
                return { color: colors[colorId] || '#ffffff', background: colorId === 'rainbow' ? colors[colorId] : 'transparent', WebkitBackgroundClip: colorId === 'rainbow' ? 'text' : 'initial', WebkitTextFillColor: colorId === 'rainbow' ? 'transparent' : 'initial' };
            };

            const getFrameClass = (frameId) => {
                const frames = { 'basic': 'frame-basic', 'silver': 'frame-silver', 'gold': 'frame-gold', 'diamond': 'frame-diamond', 'rainbow': 'frame-rainbow' };
                return frames[frameId] || '';
            };

            return (
                <>
                    <Modal isOpen={isAvatarModalOpen} onClose={() => setIsAvatarModalOpen(false)} title="üîÑ –ê–≤–∞—Ç–∞—Ä–∫–∞">
                        <div className="text-center mb-4">
                            <p className="text-slate-400 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É</p>
                        </div>
                        <div className="grid grid-cols-4 gap-3">
                            {['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº'].map((emoji, i) => (
                                <button key={i} onClick={() => { onAvatarChange(emoji); setIsAvatarModalOpen(false); }} className="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 text-3xl">
                                    {emoji}
                                </button>
                            ))}
                        </div>
                    </Modal>

                    <Modal isOpen={isFrameModalOpen} onClose={() => setIsFrameModalOpen(false)} title="üñºÔ∏è –†–∞–º–∫–∞">
                        <div className="text-center mb-4">
                            <p className="text-slate-400 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–º–∫—É</p>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            {['none', 'basic', 'silver', 'gold'].map(frame => (
                                <button key={frame} onClick={() => { onFrameChange(frame); setIsFrameModalOpen(false); }} className={`p-3 rounded-xl flex flex-col items-center gap-2 ${userFrame === frame ? 'bg-slate-700 border-2 border-yellow-500' : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600'}`}>
                                    <div className={`w-12 h-12 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg ${getFrameClass(frame)}`}>
                                        {currentUser[0].toUpperCase()}
                                    </div>
                                    <div className="text-white text-sm">{frame === 'none' ? '–ë–µ–∑ —Ä–∞–º–∫–∏' : frame === 'basic' ? '–ë–∞–∑–æ–≤–∞—è' : frame === 'silver' ? '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è' : '–ó–æ–ª–æ—Ç–∞—è'}</div>
                                </button>
                            ))}
                        </div>
                    </Modal>

                    <Modal isOpen={isNameColorModalOpen} onClose={() => setIsNameColorModalOpen(false)} title="üé® –¶–≤–µ—Ç –∏–º–µ–Ω–∏">
                        <div className="text-center mb-4">
                            <p className="text-slate-400 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –∏–º–µ–Ω–∏</p>
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            {['red', 'blue', 'green', 'yellow', 'purple', 'rainbow'].map(color => (
                                <button key={color} onClick={() => { onColorChange(color); setIsNameColorModalOpen(false); }} className="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500">
                                    <div className="text-white text-sm" style={getNameColorStyle(color)}>–ò–º—è</div>
                                </button>
                            ))}
                        </div>
                    </Modal>

                    <Modal isOpen={isStatusModalOpen} onClose={() => setIsStatusModalOpen(false)} title="üí¨ –°—Ç–∞—Ç—É—Å">
                        <div className="text-center mb-4">
                            <p className="text-slate-400 text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</p>
                        </div>
                        <div className="grid grid-cols-1 gap-2">
                            {['–í —Å–µ—Ç–∏', '–û—Ç–æ—à–µ–ª', '–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å', '–†–∞–±–æ—Ç–∞—é', '–û—Ç–¥—ã—Ö–∞—é'].map(status => (
                                <button key={status} onClick={() => { onStatusChange(status, 'üí¨'); setIsStatusModalOpen(false); }} className="p-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white text-sm text-left">
                                    {status}
                                </button>
                            ))}
                        </div>
                    </Modal>

                    <Modal isOpen={isOpen} onClose={onClose} title="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                        <div className="flex border-b border-slate-800 bg-slate-900/50 overflow-x-auto">
                            {['profile', 'appearance'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 text-xs font-medium capitalize min-h-[44px] ${activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'}`}>
                                    {tab === 'profile' ? '–ü—Ä–æ—Ñ–∏–ª—å' : '–í–Ω–µ—à–Ω–æ—Å—Ç—å'}
                                </button>
                            ))}
                        </div>
                        
                        {activeTab === 'profile' && (
                            <div className="space-y-4 text-center">
                                <div className={`w-20 h-20 mx-auto rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-3xl shadow-xl ${getFrameClass(userFrame)}`}>
                                    {userAvatar || currentUser[0].toUpperCase()}
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold" style={getNameColorStyle(userNameColor)}>{currentUser}</h3>
                                    <p className="text-slate-400 text-sm">{userStatusEmoji} {userStatus || '–í —Å–µ—Ç–∏'}</p>
                                </div>
                                <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-3">
                                    <div className="flex items-center justify-center gap-2 text-yellow-500">
                                        <Coins size={18} />
                                        <span className="font-bold text-md">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</span>
                                    </div>
                                </div>
                                <Button variant="secondary" onClick={onLogout} className="w-full text-sm" icon={<LogOut size={16} />}>–í—ã–π—Ç–∏</Button>
                            </div>
                        )}

                        {activeTab === 'appearance' && (
                            <div className="space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <Button onClick={() => setIsAvatarModalOpen(true)} variant="secondary" className="flex-col h-auto py-3" icon={<UserIcon size={16} />}>–ê–≤–∞—Ç–∞—Ä–∫–∞</Button>
                                    <Button onClick={() => setIsFrameModalOpen(true)} variant="secondary" className="flex-col h-auto py-3" icon={<ImageIcon size={16} />}>–†–∞–º–∫–∞</Button>
                                    <Button onClick={() => setIsNameColorModalOpen(true)} variant="secondary" className="flex-col h-auto py-3" icon={<Palette size={16} />}>–¶–≤–µ—Ç –∏–º–µ–Ω–∏</Button>
                                    <Button onClick={() => setIsStatusModalOpen(true)} variant="secondary" className="flex-col h-auto py-3" icon={<Edit3 size={16} />}>–°—Ç–∞—Ç—É—Å</Button>
                                </div>
                            </div>
                        )}
                    </Modal>
                </>
            );
        };

        // Message Bubble
        const MessageBubble = ({ message, isOwn, chatId, messageId, currentUser }) => {
            const [showActions, setShowActions] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setShowActions(false);
                    }
                };
                if (showActions) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showActions]);

            const handleDelete = async () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    try {
                        await update(ref(db, `messages/${chatId}/${messageId}`), { deleted: true });
                    } catch (error) {
                        console.error('Delete error:', error);
                    }
                }
                setShowActions(false);
            };

            if (message.deleted) return null;

            return (
                <div className={`group flex mb-3 ${isOwn ? 'justify-end' : 'justify-start'}`} ref={containerRef}>
                    <div className={`relative max-w-[85%] rounded-2xl px-3 py-2 ${isOwn ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-100 rounded-bl-none border border-slate-700'}`}>
                        <button onClick={() => setShowActions(!showActions)} className={`absolute -top-2 ${isOwn ? 'left-0' : 'right-0'} p-1 rounded-full bg-slate-800 border border-slate-700 text-slate-400 z-10 hover:text-white`}><MoreVertical size={12} /></button>
                        {showActions && isOwn && (
                            <div className={`absolute -top-12 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex items-center p-1 gap-1`}>
                                <button onClick={handleDelete} className="p-1.5 rounded-lg hover:bg-red-500/20 text-red-400"><Trash2 size={16} /></button>
                            </div>
                        )}
                        <p className="break-words whitespace-pre-wrap text-[14px]">{message.text}</p>
                        <div className={`flex items-center justify-end gap-1 mt-1 text-[9px] ${isOwn ? 'text-indigo-200' : 'text-slate-500'}`}>
                            <span>{format(message.timestamp, 'HH:mm')}</span>
                        </div>
                    </div>
                </div>
            );
        };

        // Clicker Component
        const Clicker = ({ userCoins, onCoinClick, currentUser, clickerLevel }) => {
            const coinsPerClick = 0.001 + (clickerLevel * 0.004);
            return (
                <button onClick={onCoinClick} className="w-full bg-gradient-to-br from-yellow-500 to-orange-500 text-white p-4 rounded-2xl shadow-2xl shadow-yellow-500/25 transition-all duration-200 active:scale-95 border-2 border-yellow-400/50">
                    <div className="text-center">
                        <Coins size={36} className="mx-auto mb-1" />
                        <div className="text-xl font-bold mb-1">{userCoins.toFixed(3)}</div>
                        <div className="text-yellow-200 text-xs">–ö–ª–∏–∫–Ω–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞!</div>
                        <div className="text-yellow-300/80 text-[10px]">+{coinsPerClick.toFixed(3)} –∑–∞ –∫–ª–∏–∫</div>
                    </div>
                </button>
            );
        };

        // Auto Clicker
        const AutoClicker = ({ userCoins, onCoinsUpdate, currentUser, clickerLevel }) => {
            const [autoClickerActive, setAutoClickerActive] = useState(false);
            const nextUpgradeCost = 10 + (clickerLevel * 5);
            const coinsPerClick = 0.001 + (clickerLevel * 0.004);

            const handleToggleAutoClicker = async () => {
                if (autoClickerActive) {
                    setAutoClickerActive(false);
                    return;
                }
                if (userCoins < 10) {
                    alert('–ù—É–∂–Ω–æ 10 –∫–æ–∏–Ω–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ä–æ–±–æ—Ç–∞.');
                    return;
                }
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - 10,
                        autoClickerActive: true
                    });
                    onCoinsUpdate(userCoins - 10);
                    setAutoClickerActive(true);
                } catch (error) {
                    console.error('Auto clicker activation error:', error);
                }
            };

            const handleUpgradeClicker = async () => {
                if (userCoins < nextUpgradeCost) {
                    alert(`–ù—É–∂–Ω–æ ${nextUpgradeCost} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.`);
                    return;
                }
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - nextUpgradeCost,
                        clickerLevel: clickerLevel + 1
                    });
                    onCoinsUpdate(userCoins - nextUpgradeCost);
                } catch (error) {
                    console.error('Clicker upgrade error:', error);
                }
            };

            return (
                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 mt-3">
                    <div className="flex items-center justify-between mb-2">
                        <h3 className="text-white font-medium text-sm"><Bot size={16} className="inline mr-2 text-green-500" />–ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä</h3>
                        <div className={`text-xs px-2 py-1 rounded-full ${autoClickerActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'}`}>
                            {autoClickerActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </div>
                    </div>
                    <div className="text-xs text-slate-400 mb-3">
                        <div>–£—Ä–æ–≤–µ–Ω—å: {clickerLevel}</div>
                        <div>–î–æ—Ö–æ–¥ –∑–∞ –∫–ª–∏–∫: +{coinsPerClick.toFixed(3)}</div>
                    </div>
                    <div className="flex gap-2">
                        <Button onClick={handleToggleAutoClicker} variant={autoClickerActive ? "danger" : "primary"} className="flex-1 text-xs" disabled={!autoClickerActive && userCoins < 10}>
                            {autoClickerActive ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ö—É–ø–∏—Ç—å –∑–∞ 10'}
                        </Button>
                        <Button onClick={handleUpgradeClicker} variant="gold" className="flex-1 text-xs" disabled={userCoins < nextUpgradeCost}>
                            –£–ª—É—á—à–∏—Ç—å ({nextUpgradeCost})
                        </Button>
                    </div>
                </div>
            );
        };

        // NFT Orbital Display
        const NFTOrbitalDisplay = ({ userNFTs }) => {
            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 3 NFT, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —Å–∫—Ä—ã—Ç—ã
            const activeNFTs = userNFTs
                .filter(nft => !nft.hidden)
                .slice(0, 3);
            
            if (activeNFTs.length === 0) return null;

            // –°–æ–∑–¥–∞–µ–º —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –æ—Ä–±–∏—Ç–µ
            const orbitalItems = activeNFTs.map((userNft, index) => {
                const angle = (index / activeNFTs.length) * 360;
                const radius = 60; // —Ä–∞–¥–∏—É—Å –æ—Ä–±–∏—Ç—ã
                const x = Math.cos(angle * Math.PI / 180) * radius;
                const y = Math.sin(angle * Math.PI / 180) * radius;
                
                return {
                    ...userNft,
                    style: {
                        transform: `translate(${x}px, ${y}px)`,
                        animationDelay: `${index * 0.5}s`
                    }
                };
            });

            return (
                <div className="nft-container">
                    <div className="nft-orbital">
                        {orbitalItems.map((item, index) => (
                            <div 
                                key={index} 
                                className="nft-item"
                                style={item.style}
                                title={item.id}
                            >
                                {item.emoji}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [isLoginView, setIsLoginView] = useState(true);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [chats, setChats] = useState([]);
            const [activeChatUser, setActiveChatUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isNFTMarketOpen, setIsNFTMarketOpen] = useState(false);
            const [isTransferCoinsOpen, setIsTransferCoinsOpen] = useState(false);
            const [isCasinoModalOpen, setIsCasinoModalOpen] = useState(false);
            const [userCoins, setUserCoins] = useState(0);
            const [userAvatar, setUserAvatar] = useState('');
            const [userFrame, setUserFrame] = useState('');
            const [userNameColor, setUserNameColor] = useState('');
            const [userStatus, setUserStatus] = useState('');
            const [userStatusEmoji, setUserStatusEmoji] = useState('');
            const [userNFTs, setUserNFTs] = useState([]);
            const [clickerLevel, setClickerLevel] = useState(0);
            const [usersData, setUsersData] = useState({});
            const messagesEndRef = useRef(null);

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const validateUsername = (username) => {
                if (!username || username.length < 3) {
                    return '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤';
                }
                if (!/^[a-z0-9]+$/.test(username)) {
                    return '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã';
                }
                if (username !== username.toLowerCase()) {
                    return '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ';
                }
                return null;
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            const handleAuth = async () => {
                const validationError = validateUsername(usernameInput);
                if (validationError) {
                    setAuthError(validationError);
                    return;
                }

                try {
                    const userRef = ref(db, `users/${usernameInput}`);
                    const snapshot = await get(userRef);
                    
                    if (snapshot.exists()) {
                        // –í—Ö–æ–¥
                        const userData = snapshot.val();
                        if (userData.password !== passwordInput) {
                            setAuthError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                            return;
                        }
                    } else {
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        if (!passwordInput) {
                            setAuthError('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                            return;
                        }
                        await set(userRef, {
                            password: passwordInput,
                            coins: 10,
                            createdAt: Date.now(),
                            avatar: '',
                            frame: '',
                            nameColor: '',
                            status: '–í —Å–µ—Ç–∏',
                            statusEmoji: 'üí¨',
                            nfts: [],
                            clickerLevel: 0,
                            autoClickerActive: false
                        });
                    }
                    
                    localStorage.setItem('dolbaeb_user', usernameInput);
                    setCurrentUser(usernameInput);
                    setAuthError('');
                } catch (error) {
                    console.error('Auth error:', error);
                    setAuthError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
            };

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            useEffect(() => {
                if (currentUser) {
                    const userRef = ref(db, `users/${currentUser}`);
                    const unsubscribe = onValue(userRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUserCoins(data.coins || 0);
                            setUserAvatar(data.avatar || '');
                            setUserFrame(data.frame || '');
                            setUserNameColor(data.nameColor || '');
                            setUserStatus(data.status || '');
                            setUserStatusEmoji(data.statusEmoji || '');
                            setUserNFTs(data.nfts || []);
                            setClickerLevel(data.clickerLevel || 0);
                        }
                    });
                    return () => off(userRef);
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            useEffect(() => {
                if (currentUser) {
                    const usersRef = ref(db, 'users');
                    const unsubscribe = onValue(usersRef, (snapshot) => {
                        setUsersData(snapshot.val() || {});
                    });
                    return () => off(usersRef);
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
            useEffect(() => {
                if (currentUser) {
                    const messagesRef = ref(db, 'messages');
                    const unsubscribe = onValue(messagesRef, (snapshot) => {
                        const data = snapshot.val();
                        if (!data) { setChats([]); return; }
                        const newChats = new Map();
                        Object.entries(data).forEach(([chatId, chatMessages]) => {
                            const usersInChat = chatId.split('_');
                            if (usersInChat.includes(currentUser)) {
                                const otherUser = usersInChat.find(user => user !== currentUser);
                                if (chatMessages && Object.keys(chatMessages).length > 0) {
                                    const messagesList = Object.values(chatMessages).filter(m => m && !m.deleted).sort((a, b) => b.timestamp - a.timestamp);
                                    if (messagesList.length > 0) {
                                        newChats.set(otherUser, { user: otherUser, lastMessage: messagesList[0], timestamp: messagesList[0].timestamp });
                                    }
                                }
                            }
                        });
                        setChats(Array.from(newChats.values()).sort((a, b) => b.timestamp - a.timestamp));
                    });
                    return () => off(messagesRef);
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            useEffect(() => {
                if (currentUser && activeChatUser) {
                    const chatId = [currentUser, activeChatUser].sort().join('_');
                    const chatRef = ref(db, `messages/${chatId}`);
                    const unsubscribe = onValue(chatRef, (snapshot) => {
                        const data = snapshot.val();
                        if (!data) { setMessages([]); return; }
                        const messagesArray = Object.entries(data).map(([id, message]) => ({ id, ...message })).filter(msg => !msg.deleted).sort((a, b) => a.timestamp - b.timestamp);
                        setMessages(messagesArray);
                    });
                    return () => off(chatRef);
                }
            }, [currentUser, activeChatUser]);

            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            }, [messages]);

            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            useEffect(() => {
                if (searchQuery.trim()) {
                    const results = Object.keys(usersData)
                        .filter(username => 
                            username !== currentUser && 
                            username.toLowerCase().includes(searchQuery.toLowerCase())
                        )
                        .slice(0, 10);
                    setSearchResults(results);
                } else {
                    setSearchResults([]);
                }
            }, [searchQuery, usersData, currentUser]);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            const handleSendMessage = async () => {
                if (!messageInput.trim() || !activeChatUser) return;
                
                const chatId = [currentUser, activeChatUser].sort().join('_');
                const messageRef = push(ref(db, `messages/${chatId}`));
                
                try {
                    await set(messageRef, {
                        sender: currentUser,
                        text: messageInput.trim(),
                        timestamp: Date.now(),
                        deleted: false
                    });
                    setMessageInput('');
                } catch (error) {
                    console.error('Send message error:', error);
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –º–æ–Ω–µ—Ç–∞–º
            const handleCoinClick = async () => {
                const coinsPerClick = 0.001 + (clickerLevel * 0.004);
                const newCoins = userCoins + coinsPerClick;
                try {
                    await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                    setUserCoins(newCoins);
                } catch (error) {
                    console.error('Coin click error:', error);
                }
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
            const handleLogout = () => {
                localStorage.removeItem('dolbaeb_user');
                setCurrentUser(null);
                setIsLoginView(true);
                setUsernameInput('');
                setPasswordInput('');
            };

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const handleAvatarChange = async (avatar) => {
                try {
                    await update(ref(db, `users/${currentUser}`), { avatar });
                    setUserAvatar(avatar);
                } catch (error) {
                    console.error('Avatar update error:', error);
                }
            };

            const handleFrameChange = async (frame) => {
                try {
                    await update(ref(db, `users/${currentUser}`), { frame });
                    setUserFrame(frame);
                } catch (error) {
                    console.error('Frame update error:', error);
                }
            };

            const handleColorChange = async (color) => {
                try {
                    await update(ref(db, `users/${currentUser}`), { nameColor: color });
                    setUserNameColor(color);
                } catch (error) {
                    console.error('Color update error:', error);
                }
            };

            const handleStatusChange = async (status, emoji) => {
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        status, 
                        statusEmoji: emoji 
                    });
                    setUserStatus(status);
                    setUserStatusEmoji(emoji);
                } catch (error) {
                    console.error('Status update error:', error);
                }
            };

            // –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4 safe-area-top safe-area-bottom">
                        <div className="w-full max-w-md bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-2xl">
                            <div className="text-center mb-6">
                                <h1 className="text-3xl font-bold text-white mb-2">DolbaebSMS</h1>
                                <p className="text-slate-400">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</p>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                                    <input 
                                        type="text" 
                                        value={usernameInput}
                                        onChange={(e) => setUsernameInput(e.target.value.toLowerCase())}
                                        placeholder="—Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"
                                        className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm"
                                    />
                                </div>
                                
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–ü–∞—Ä–æ–ª—å</label>
                                    <input 
                                        type="password" 
                                        value={passwordInput}
                                        onChange={(e) => setPasswordInput(e.target.value)}
                                        placeholder="–≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                                        className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm"
                                    />
                                </div>
                                
                                {authError && (
                                    <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-3">
                                        <p className="text-red-400 text-sm text-center">{authError}</p>
                                    </div>
                                )}
                                
                                <Button 
                                    onClick={handleAuth} 
                                    className="w-full"
                                    disabled={!usernameInput.trim()}
                                >
                                    {usersData[usernameInput] ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è'}
                                </Button>
                                
                                <p className="text-slate-500 text-xs text-center">
                                    {usersData[usernameInput] 
                                        ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π–¥–∏—Ç–µ' 
                                        : '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–∫–∫–∞—É–Ω—Ç'}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            // –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            return (
                <div className="h-screen flex flex-col bg-slate-900 safe-area-top safe-area-bottom">
                    {/* Header */}
                    <div className="bg-slate-800 border-b border-slate-700 p-3 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="relative">
                                <div className={`w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg ${userFrame === 'basic' ? 'frame-basic' : userFrame === 'silver' ? 'frame-silver' : userFrame === 'gold' ? 'frame-gold' : userFrame === 'diamond' ? 'frame-diamond' : userFrame === 'rainbow' ? 'frame-rainbow' : ''}`}>
                                    {userAvatar || currentUser[0].toUpperCase()}
                                </div>
                                <NFTOrbitalDisplay userNFTs={userNFTs} />
                            </div>
                            <div>
                                <h1 className="font-bold text-white" style={
                                    userNameColor === 'red' ? {color: '#ef4444'} :
                                    userNameColor === 'orange' ? {color: '#f97316'} :
                                    userNameColor === 'yellow' ? {color: '#eab308'} :
                                    userNameColor === 'green' ? {color: '#22c55e'} :
                                    userNameColor === 'blue' ? {color: '#3b82f6'} :
                                    userNameColor === 'purple' ? {color: '#a855f7'} :
                                    userNameColor === 'rainbow' ? {background: 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'} : {}
                                }>
                                    {currentUser}
                                </h1>
                                <p className="text-slate-400 text-xs">{userStatusEmoji} {userStatus}</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                            <button onClick={() => setIsNFTMarketOpen(true)} className="p-2 text-yellow-500 hover:bg-yellow-500/10 rounded-xl transition-colors">
                                <Coins size={20} />
                            </button>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-xl transition-colors">
                                <SettingsIcon size={20} />
                            </button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex overflow-hidden">
                        {/* Sidebar */}
                        <div className="w-80 bg-slate-800 border-r border-slate-700 flex flex-col shrink-0">
                            {/* Clicker Section */}
                            <div className="p-3 border-b border-slate-700">
                                <Clicker 
                                    userCoins={userCoins}
                                    onCoinClick={handleCoinClick}
                                    currentUser={currentUser}
                                    clickerLevel={clickerLevel}
                                />
                                <AutoClicker
                                    userCoins={userCoins}
                                    onCoinsUpdate={setUserCoins}
                                    currentUser={currentUser}
                                    clickerLevel={clickerLevel}
                                />
                            </div>

                            {/* Actions */}
                            <div className="p-3 border-b border-slate-700 grid grid-cols-2 gap-2">
                                <Button onClick={() => setIsNFTMarketOpen(true)} variant="secondary" className="text-xs" icon={<Coins size={14} />}>
                                    NFT –ú–∞–≥–∞–∑–∏–Ω
                                </Button>
                                <Button onClick={() => setIsTransferCoinsOpen(true)} variant="secondary" className="text-xs" icon={<Send size={14} />}>
                                    –ü–µ—Ä–µ–≤–æ–¥
                                </Button>
                                <Button onClick={() => setIsCasinoModalOpen(true)} variant="secondary" className="text-xs" icon={<Trophy size={14} />}>
                                    –ö–∞–∑–∏–Ω–æ
                                </Button>
                                <Button onClick={() => setIsSettingsOpen(true)} variant="secondary" className="text-xs" icon={<SettingsIcon size={14} />}>
                                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                                </Button>
                            </div>

                            {/* Search */}
                            <div className="p-3 border-b border-slate-700">
                                <div className="relative">
                                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
                                    <input
                                        type="text"
                                        placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full bg-slate-700 border border-slate-600 rounded-xl pl-9 pr-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"
                                    />
                                </div>
                            </div>

                            {/* Chats List */}
                            <div className="flex-1 overflow-y-auto no-scrollbar">
                                {searchQuery ? (
                                    // Search Results
                                    <div className="p-2">
                                        {searchResults.map(username => (
                                            <button
                                                key={username}
                                                onClick={() => {
                                                    setActiveChatUser(username);
                                                    setSearchQuery('');
                                                    setSearchResults([]);
                                                }}
                                                className="w-full p-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-colors text-left"
                                            >
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">
                                                    {usersData[username]?.avatar || username[0].toUpperCase()}
                                                </div>
                                                <div>
                                                    <div className="text-white font-medium">{username}</div>
                                                    <div className="text-slate-400 text-xs">{usersData[username]?.status || '–í —Å–µ—Ç–∏'}</div>
                                                </div>
                                            </button>
                                        ))}
                                        {searchResults.length === 0 && searchQuery.trim() && (
                                            <div className="text-center text-slate-500 py-4">
                                                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    // Chats
                                    <div className="p-2">
                                        {chats.map(chat => (
                                            <button
                                                key={chat.user}
                                                onClick={() => setActiveChatUser(chat.user)}
                                                className={`w-full p-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-colors text-left mb-2 ${activeChatUser === chat.user ? 'bg-slate-700' : ''}`}
                                            >
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">
                                                    {usersData[chat.user]?.avatar || chat.user[0].toUpperCase()}
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-white font-medium truncate">{chat.user}</div>
                                                    <div className="text-slate-400 text-xs truncate">
                                                        {chat.lastMessage.sender === currentUser ? '–í—ã: ' : ''}
                                                        {chat.lastMessage.text}
                                                    </div>
                                                </div>
                                                <div className="text-slate-500 text-xs">
                                                    {format(chat.lastMessage.timestamp, 'HH:mm')}
                                                </div>
                                            </button>
                                        ))}
                                        {chats.length === 0 && (
                                            <div className="text-center text-slate-500 py-8">
                                                <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                                <p className="text-sm mt-1">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –∫–µ–º-–Ω–∏–±—É–¥—å</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Chat Area */}
                        <div className="flex-1 flex flex-col bg-slate-900">
                            {activeChatUser ? (
                                <>
                                    {/* Chat Header */}
                                    <div className="bg-slate-800 border-b border-slate-700 p-3 flex items-center gap-3 shrink-0">
                                        <button 
                                            onClick={() => setActiveChatUser(null)}
                                            className="p-1 text-slate-400 hover:text-white lg:hidden"
                                        >
                                            <ChevronLeft size={20} />
                                        </button>
                                        <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                                            {usersData[activeChatUser]?.avatar || activeChatUser[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <div className="text-white font-medium">{activeChatUser}</div>
                                            <div className="text-slate-400 text-xs">{usersData[activeChatUser]?.status || '–í —Å–µ—Ç–∏'}</div>
                                        </div>
                                    </div>

                                    {/* Messages */}
                                    <div className="flex-1 overflow-y-auto p-4 space-y-1 no-scrollbar">
                                        {messages.map(message => (
                                            <MessageBubble
                                                key={message.id}
                                                message={message}
                                                isOwn={message.sender === currentUser}
                                                chatId={[currentUser, activeChatUser].sort().join('_')}
                                                messageId={message.id}
                                                currentUser={currentUser}
                                            />
                                        ))}
                                        <div ref={messagesEndRef} />
                                    </div>

                                    {/* Message Input */}
                                    <div className="bg-slate-800 border-t border-slate-700 p-3 shrink-0">
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                                value={messageInput}
                                                onChange={(e) => setMessageInput(e.target.value)}
                                                onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                                className="flex-1 bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"
                                            />
                                            <Button onClick={handleSendMessage} disabled={!messageInput.trim()}>
                                                <Send size={16} />
                                            </Button>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                // Empty State
                                <div className="flex-1 flex items-center justify-center">
                                    <div className="text-center text-slate-500">
                                        <MessageCircle className="mx-auto mb-2" size={48} />
                                        <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Modals */}
                    <SettingsModal
                        isOpen={isSettingsOpen}
                        onClose={() => setIsSettingsOpen(false)}
                        currentUser={currentUser}
                        onLogout={handleLogout}
                        userCoins={userCoins}
                        userAvatar={userAvatar}
                        userFrame={userFrame}
                        userNameColor={userNameColor}
                        userStatus={userStatus}
                        userStatusEmoji={userStatusEmoji}
                        onAvatarChange={handleAvatarChange}
                        onFrameChange={handleFrameChange}
                        onColorChange={handleColorChange}
                        onStatusChange={handleStatusChange}
                    />

                    <NFTMarketModal
                        isOpen={isNFTMarketOpen}
                        onClose={() => setIsNFTMarketOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userNFTs={userNFTs}
                        onNFTUpdate={setUserNFTs}
                        usersData={usersData}
                    />

                    <TransferCoinsModal
                        isOpen={isTransferCoinsOpen}
                        onClose={() => setIsTransferCoinsOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                    />

                    <CasinoModal
                        isOpen={isCasinoModalOpen}
                        onClose={() => setIsCasinoModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                    />
                </div>
            );
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
