<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meth OS | Discord Mode</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- PeerJS (–ó–≤–æ–Ω–∫–∏) -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #313338;
            --bg-secondary: #2b2d31;
            --bg-tertiary: #1e1f22;
            --accent: #5865F2;
            --danger: #da373c;
            --success: #23a559;
            --text-main: #dbdee1;
            --text-muted: #949ba4;
            --font: 'Inter', sans-serif;
            --custom-bg: none;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; font-family: var(--font); }
        body { background-color: var(--bg-primary); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }
        
        .app-bg {
            position: absolute; inset: 0; z-index: -1;
            background-image: var(--custom-bg);
            background-size: cover; background-position: center;
            opacity: 0.4; pointer-events: none;
        }

        /* --- AUTH --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: #313338; display: flex; justify-content: center; align-items: center;
        }
        .auth-box {
            background: #2b2d31; padding: 30px; border-radius: 5px; width: 400px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); text-align: center;
        }
        .auth-inp {
            width: 100%; padding: 10px; margin: 10px 0; background: #1e1f22;
            border: none; color: white; border-radius: 3px; font-size: 16px;
        }
        .discord-btn {
            width: 100%; padding: 12px; background: var(--accent); color: white;
            border: none; border-radius: 3px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .discord-btn:hover { background: #4752c4; }

        /* --- LAYOUT --- */
        #app { display: none; width: 100%; height: 100%; }
        
        .servers {
            width: 72px; background: var(--bg-tertiary); display: flex; flex-direction: column;
            align-items: center; padding-top: 12px; gap: 8px; overflow-y: auto;
        }
        .srv-icon {
            width: 48px; height: 48px; background: #313338; border-radius: 50%;
            display: grid; place-items: center; cursor: pointer; transition: 0.2s; color: var(--text-main);
            position: relative;
        }
        .srv-icon:hover, .srv-icon.active { background: var(--accent); border-radius: 16px; color: white; }
        .srv-separator { width: 32px; height: 2px; background: #35363c; margin: 2px 0; }

        .sidebar {
            width: 240px; background: var(--bg-secondary); display: flex; flex-direction: column;
            border-radius: 8px 0 0 0;
        }
        .sb-header { padding: 15px; border-bottom: 1px solid #1f2023; font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .sb-content { flex: 1; padding: 10px; overflow-y: auto; }
        .friend-item {
            display: flex; align-items: center; gap: 10px; padding: 10px;
            border-radius: 4px; cursor: pointer; color: var(--text-muted);
        }
        .friend-item:hover { background: #35373c; color: var(--text-main); }
        
        .user-panel {
            background: #232428; padding: 10px; display: flex; align-items: center; gap: 10px;
        }
        .user-avatar { width: 32px; height: 32px; background: var(--accent); border-radius: 50%; display: grid; place-items: center; font-weight: bold; }
        
        /* CONNECTION STATUS INDICATOR */
        .conn-status {
            width: 10px; height: 10px; border-radius: 50%; background: var(--danger);
            border: 2px solid #232428;
        }
        .conn-status.online { background: var(--success); }

        .main-stage { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); position: relative; }
        
        /* CHAT */
        .chat-view { display: flex; flex-direction: column; height: 100%; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { display: flex; gap: 15px; }
        .msg-content h4 { font-size: 15px; margin-bottom: 2px; }
        .msg-content h4 span { font-size: 11px; color: var(--text-muted); font-weight: 400; margin-left: 5px; }
        .msg-text { font-size: 15px; line-height: 1.4; color: #dbdee1; white-space: pre-wrap; word-break: break-word;}
        
        .chat-input-area { padding: 0 20px 25px 20px; }
        .chat-bar {
            background: #383a40; border-radius: 8px; display: flex; align-items: center;
            padding: 10px; gap: 10px;
        }
        .chat-inp {
            background: transparent; border: none; color: white; flex: 1; height: 25px; font-size: 15px;
        }
        .action-btn { background: none; border: none; color: #b5bac1; cursor: pointer; font-size: 18px; }
        .action-btn:hover { color: var(--text-main); }

        /* EMBED APPS */
        .embed-view { display: none; width: 100%; height: 100%; flex-direction: column; }
        .embed-nav { padding: 10px; background: var(--bg-tertiary); display: flex; gap: 10px; }
        .embed-frame { flex: 1; border: none; background: #fff; }

        /* --- CALL UI --- */
        #call-modal {
            position: fixed; top: 20px; right: 20px; width: 300px;
            background: #000; border-radius: 8px; z-index: 5000;
            border: 1px solid #1f2023; display: none; overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .video-grid { position: relative; width: 100%; height: 200px; background: #111; }
        
        /* Playsinline –≤–∞–∂–Ω–æ –¥–ª—è iPhone */
        video { width: 100%; height: 100%; object-fit: cover; }
        
        #local-video {
            position: absolute; bottom: 10px; right: 10px; width: 80px; height: 60px;
            border: 2px solid #000; border-radius: 4px; background: #222; transform: scaleX(-1);
        }
        .call-controls {
            display: flex; justify-content: space-around; padding: 15px; background: #1e1f22;
        }
        .ctrl-btn {
            width: 40px; height: 40px; border-radius: 50%; border: none;
            background: #2b2d31; color: white; cursor: pointer; font-size: 16px; transition: 0.2s;
        }
        .ctrl-btn:hover { opacity: 0.8; }
        .ctrl-btn.active { background: white; color: black; }
        .ctrl-btn.danger { background: var(--danger); }

        /* SETTINGS */
        #settings-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 6000;
            display: none; place-items: center;
        }
        .settings-box {
            background: #313338; width: 500px; padding: 25px; border-radius: 5px;
        }
        .set-grp { margin-bottom: 20px; }
        .set-grp label { display: block; color: var(--text-muted); font-size: 12px; font-weight: 700; margin-bottom: 8px; }
        .set-inp { width: 100%; padding: 8px; background: #1e1f22; border: none; color: white; border-radius: 3px; }

        /* INCOMING CALL */
        #incoming-call {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #1e1f22; padding: 20px; border-radius: 8px; z-index: 7000;
            display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-align: center; border: 1px solid var(--success);
        }
    </style>
</head>
<body>

<div class="app-bg"></div>

<!-- AUTH -->
<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:white; margin-bottom:20px;">Meth OS</h2>
        <input type="text" id="username" class="auth-inp" placeholder="–ü—Ä–∏–¥—É–º–∞–π –Ω–∏–∫–Ω–µ–π–º (ID)">
        <input type="password" id="password" class="auth-inp" placeholder="–ü–∞—Ä–æ–ª—å">
        <div style="font-size:12px; color:#aaa; margin:10px 0;">–ù–∏–∫–Ω–µ–π–º —Ç–æ–ª—å–∫–æ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –∞–Ω–≥–ª–∏–π—Å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏!</div>
        <button class="discord-btn" onclick="authFunc('login')">–í–æ–π—Ç–∏</button>
        <button class="discord-btn" onclick="authFunc('register')" style="background:#4e5058; margin-top:10px;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <div id="auth-error" style="color:var(--danger); margin-top:10px; font-size:13px;"></div>
    </div>
</div>

<!-- INCOMING CALL ALERT -->
<div id="incoming-call">
    <h3 style="margin-bottom:10px;">üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫!</h3>
    <div id="caller-name" style="color:var(--text-muted); margin-bottom:15px;">Unknown</div>
    <div style="display:flex; gap:10px; justify-content:center;">
        <button onclick="answerCall()" class="discord-btn" style="background:var(--success); width:auto; padding:8px 20px;">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
        <button onclick="rejectCall()" class="discord-btn" style="background:var(--danger); width:auto; padding:8px 20px;">–°–±—Ä–æ—Å</button>
    </div>
</div>

<!-- SETTINGS -->
<div id="settings-modal">
    <div class="settings-box">
        <h2 style="margin-bottom:20px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <div class="set-grp">
            <label>–§–û–ù (URL)</label>
            <input type="text" id="bg-url" class="set-inp" placeholder="https://..." onchange="updateBg()">
        </div>
        <div class="set-grp">
            <label>–ú–ò–ö–†–û–§–û–ù</label>
            <select id="mic-select" class="set-inp"><option>–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option></select>
        </div>
        <button class="discord-btn" onclick="document.getElementById('settings-modal').style.display='none'">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="discord-btn" onclick="logout()" style="background:var(--danger); margin-top:10px;">–í—ã–π—Ç–∏</button>
    </div>
</div>

<!-- CALL UI -->
<div id="call-modal">
    <div class="video-grid">
        <!-- playsinline –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è iPhone -->
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
    </div>
    <div class="call-controls">
        <button class="ctrl-btn" onclick="toggleMic()" id="btn-mic" title="–ú—É—Ç –º–∏–∫—Ä–æ"><i class="fas fa-microphone"></i></button>
        <button class="ctrl-btn" onclick="toggleDeafen()" id="btn-deaf" title="–í—ã–∫–ª –∑–≤—É–∫"><i class="fas fa-volume-up"></i></button>
        <button class="ctrl-btn" onclick="shareScreen()" id="btn-screen" title="–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è"><i class="fas fa-desktop"></i></button>
        <button class="ctrl-btn danger" onclick="endCall()"><i class="fas fa-phone-slash"></i></button>
    </div>
</div>

<!-- APP UI -->
<div id="app">
    <div class="servers">
        <div class="srv-icon active" onclick="switchTab('chat')"><i class="fab fa-discord"></i></div>
        <div class="srv-separator"></div>
        <div class="srv-icon" onclick="switchTab('spotify')"><i class="fab fa-spotify" style="color:#1DB954;"></i></div>
        <div class="srv-icon" onclick="switchTab('youtube')"><i class="fab fa-youtube" style="color:#FF0000;"></i></div>
        <div class="srv-icon" onclick="switchTab('browser')"><i class="fas fa-globe"></i></div>
    </div>

    <div class="sidebar">
        <div class="sb-header">Meth OS</div>
        <div class="sb-content">
            <div style="font-size:11px; font-weight:700; color:var(--text-muted); margin-bottom:8px;">–ó–í–û–ù–ö–ò</div>
            <div style="padding:10px; background:#1e1f22; border-radius:4px; margin-bottom:10px;">
                <input type="text" id="add-friend-inp" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞ (–∞–Ω–≥–ª)..." style="background:transparent; border:none; color:white; width:100%; font-size:13px;">
            </div>
            <button class="discord-btn" onclick="addFriendAndCall()" style="font-size:12px; padding:5px; margin-bottom:15px;">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <div id="friends-list"></div>
        </div>

        <div class="user-panel">
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏ PeerJS -->
            <div style="position:relative;">
                <div class="user-avatar" id="my-avatar">U</div>
                <div id="conn-status" class="conn-status" style="position:absolute; bottom:0; right:0;"></div>
            </div>
            
            <div style="flex:1;">
                <div style="font-size:13px; font-weight:700;" id="my-username">User</div>
                <div style="font-size:10px; color:var(--text-muted);">
                    –°—Ç–∞—Ç—É—Å: <span id="status-text">–û—Ñ—Ñ–ª–∞–π–Ω</span>
                </div>
            </div>
            <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç–∞ -->
            <button class="action-btn" onclick="reconnectPeer()" title="–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ—Ç—å"><i class="fas fa-sync-alt"></i></button>
            <button class="action-btn" onclick="document.getElementById('settings-modal').style.display='grid'"><i class="fas fa-cog"></i></button>
        </div>
    </div>

    <div class="main-stage">
        <!-- TABS -->
        <div id="tab-chat" class="chat-view">
            <div class="sb-header" style="background:var(--bg-primary);"><i class="fas fa-hashtag"></i> general</div>
            <div class="messages" id="msg-container"></div>
            <div class="chat-input-area">
                <div class="chat-bar">
                    <button class="action-btn" onclick="document.getElementById('file-in').click()"><i class="fas fa-plus-circle"></i></button>
                    <input type="file" id="file-in" hidden onchange="uploadFile()">
                    <input type="text" class="chat-inp" id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="action-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        <div id="tab-spotify" class="embed-view"><div class="embed-nav"><input id="spot-url" class="set-inp" placeholder="Spotify Link"><button class="discord-btn" onclick="loadSpotify()">Load</button></div><iframe id="frame-spotify" class="embed-frame" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M"></iframe></div>
        <div id="tab-youtube" class="embed-view"><div class="embed-nav"><input id="yt-url" class="set-inp" placeholder="YouTube Search/Link"><button class="discord-btn" onclick="loadYoutube()">Watch</button></div><iframe id="frame-youtube" class="embed-frame" src="https://www.youtube.com/embed/dQw4w9WgXcQ"></iframe></div>
        <div id="tab-browser" class="embed-view"><div class="embed-nav"><input id="web-url" class="set-inp" placeholder="URL"><button class="discord-btn" onclick="loadWeb()">Go</button></div><iframe id="frame-web" class="embed-frame" src="https://www.bing.com"></iframe></div>
    </div>
</div>

<script>
    // 1. CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBFAWc-An48eKYfTMGhlJICkDPdecEJbb4",
      authDomain: "kolyasurfing-1a685.firebaseapp.com",
      databaseURL: "https://kolyasurfing-1a685-default-rtdb.firebaseio.com",
      projectId: "kolyasurfing-1a685",
      storageBucket: "kolyasurfing-1a685.firebasestorage.app",
      messagingSenderId: "1039204722214",
      appId: "1:1039204722214:web:0f441d51b176645e3ea8e7"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();
    
    let currentUser = null;
    let peer = null;
    let currentCall = null;
    let localStream = null;
    let isMicMuted = false;
    let isDeafened = false;

    // 2. AUTH
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            
            const cleanId = user.email.split('@')[0];
            document.getElementById('my-username').innerText = cleanId;
            document.getElementById('my-avatar').innerText = cleanId[0].toUpperCase();
            
            initPeer(cleanId);
            loadChat();
            loadFriends();
            cleanOldMessages();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    async function authFunc(type) {
        // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –∫–∞–ø—Å –≤ –Ω–∏–∫–µ
        const nick = document.getElementById('username').value.trim().toLowerCase().replace(/[^a-z0-9]/g, '');
        const pass = document.getElementById('password').value;
        const err = document.getElementById('auth-error');

        if(nick.length < 3) return err.innerText = "–ù–∏–∫–Ω–µ–π–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π (—Ç–æ–ª—å–∫–æ a-z –∏ —Ü–∏—Ñ—Ä—ã)";
        const email = nick + "@meth.os";

        try {
            if(type === 'register') {
                await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(nick).set({ uid: auth.currentUser.uid });
            } else {
                await auth.signInWithEmailAndPassword(email, pass);
            }
        } catch(e) { err.innerText = e.message; }
    }

    function logout() { auth.signOut(); location.reload(); }

    // 3. PEERJS (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    function initPeer(id) {
        if(peer) peer.destroy();

        peer = new Peer(id, {
            debug: 2,
            secure: true, // –í–ê–ñ–ù–û –î–õ–Ø FIREBASE
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        });

        peer.on('open', (id) => {
            console.log('Connected to PeerServer as: ' + id);
            document.getElementById('status-text').innerText = "–í —Å–µ—Ç–∏ (–ì–æ—Ç–æ–≤)";
            document.getElementById('conn-status').classList.add('online');
        });

        peer.on('error', (err) => {
            console.error(err);
            document.getElementById('status-text').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            document.getElementById('conn-status').classList.remove('online');
            if(err.type === 'unavailable-id') alert("–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç (–≤–æ–∑–º–æ–∂–Ω–æ, –æ—Ç–∫—Ä—ã—Ç–∞ –¥—Ä—É–≥–∞—è –≤–∫–ª–∞–¥–∫–∞?)");
        });

        peer.on('disconnected', () => {
            document.getElementById('status-text').innerText = "–ü–æ—Ç–µ—Ä—è —Å–≤—è–∑–∏";
            document.getElementById('conn-status').classList.remove('online');
        });

        peer.on('call', (call) => {
            console.log("Incoming call from:", call.peer);
            document.getElementById('incoming-call').style.display = 'block';
            document.getElementById('caller-name').innerText = call.peer;
            currentCall = call;
        });
    }

    function reconnectPeer() {
        if(!currentUser) return;
        const id = currentUser.email.split('@')[0];
        document.getElementById('status-text').innerText = "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
        initPeer(id);
    }

    // 4. CALL LOGIC
    async function startLocalStream(video = true) {
        const micId = document.getElementById('mic-select').value;
        const constraints = {
            video: video,
            audio: { 
                echoCancellation: true, 
                noiseSuppression: true,
                autoGainControl: true
            }
        };
        if(micId !== '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é') constraints.audio.deviceId = { exact: micId };

        try {
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            document.getElementById('local-video').srcObject = localStream;
            return localStream;
        } catch(e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ö–∞–º–µ—Ä–µ/–ú–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ! " + e.message);
            return null;
        }
    }

    function addFriendAndCall() {
        const id = document.getElementById('add-friend-inp').value.trim().toLowerCase();
        if(!id) return;
        
        // Save friend
        let friends = JSON.parse(localStorage.getItem('meth_friends') || '[]');
        if(!friends.includes(id)) {
            friends.push(id);
            localStorage.setItem('meth_friends', JSON.stringify(friends));
            loadFriends();
        }
        makeCall(id);
    }

    function loadFriends() {
        const list = document.getElementById('friends-list');
        list.innerHTML = '';
        const friends = JSON.parse(localStorage.getItem('meth_friends') || '[]');
        friends.forEach(f => {
            const div = document.createElement('div');
            div.className = 'friend-item';
            div.innerHTML = `<div class="user-avatar" style="width:20px;height:20px;font-size:10px;">${f[0]}</div><div style="flex:1;">${f}</div><i class="fas fa-phone" onclick="makeCall('${f}')" style="cursor:pointer;color:var(--success)"></i>`;
            list.appendChild(div);
        });
    }

    async function makeCall(remoteId) {
        if(remoteId === currentUser.email.split('@')[0]) return alert("–ù–µ–ª—å–∑—è –∑–≤–æ–Ω–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ!");
        
        const stream = await startLocalStream();
        if(!stream) return;

        console.log("Calling " + remoteId + "...");
        document.getElementById('call-modal').style.display = 'block';
        
        const call = peer.call(remoteId, stream);
        if(!call) return alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ç–∏.");
        
        handleCallStream(call);
    }

    async function answerCall() {
        document.getElementById('incoming-call').style.display = 'none';
        const stream = await startLocalStream();
        if(!stream) return;

        document.getElementById('call-modal').style.display = 'block';
        currentCall.answer(stream);
        handleCallStream(currentCall);
    }

    function rejectCall() {
        document.getElementById('incoming-call').style.display = 'none';
        if(currentCall) currentCall.close();
    }

    function handleCallStream(call) {
        currentCall = call;
        call.on('stream', remoteStream => {
            console.log("Remote stream received");
            document.getElementById('remote-video').srcObject = remoteStream;
        });
        call.on('close', endCallUI);
        call.on('error', (e) => { console.error(e); alert("–°–±–æ–π –∑–≤–æ–Ω–∫–∞"); endCallUI(); });
    }

    function endCall() {
        if(currentCall) currentCall.close();
        endCallUI();
    }

    function endCallUI() {
        document.getElementById('call-modal').style.display = 'none';
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        document.getElementById('remote-video').srcObject = null;
        currentCall = null;
    }

    // Media Controls
    function toggleMic() {
        if(!localStream) return;
        const track = localStream.getAudioTracks()[0];
        isMicMuted = !isMicMuted;
        track.enabled = !isMicMuted;
        document.getElementById('btn-mic').classList.toggle('danger', isMicMuted);
    }
    function toggleDeafen() {
        const vid = document.getElementById('remote-video');
        isDeafened = !isDeafened;
        vid.muted = isDeafened;
        document.getElementById('btn-deaf').classList.toggle('danger', isDeafened);
    }
    async function shareScreen() {
        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
            const sender = currentCall.peerConnection.getSenders().find(s => s.track.kind === 'video');
            sender.replaceTrack(screenStream.getVideoTracks()[0]);
            document.getElementById('local-video').srcObject = screenStream;
            
            screenStream.getVideoTracks()[0].onended = () => {
                startLocalStream().then(cam => {
                    sender.replaceTrack(cam.getVideoTracks()[0]);
                });
            };
        } catch(e) { console.log("Screen share cancelled"); }
    }

    // 5. CHAT & HELPERS
    function sendMessage() {
        const txt = document.getElementById('msg-in').value.trim();
        if(!txt) return;
        db.collection('messages').add({
            text: txt, uid: currentUser.uid, user: currentUser.email.split('@')[0],
            ts: firebase.firestore.FieldValue.serverTimestamp(), type: 'text'
        });
        document.getElementById('msg-in').value = '';
    }
    function uploadFile() {
        const file = document.getElementById('file-in').files[0];
        if(!file) return;
        const ref = storage.ref('uploads/'+Date.now()+'_'+file.name);
        ref.put(file).then(snap=>snap.ref.getDownloadURL()).then(url=>{
            db.collection('messages').add({
                text: url, uid: currentUser.uid, user: currentUser.email.split('@')[0],
                ts: firebase.firestore.FieldValue.serverTimestamp(), type: file.type.startsWith('image')?'image':'file'
            });
        });
    }
    function loadChat() {
        db.collection('messages').orderBy('ts','asc').limitToLast(50).onSnapshot(snap=>{
            const c = document.getElementById('msg-container'); c.innerHTML='';
            snap.forEach(doc=>{
                const d=doc.data();
                const div=document.createElement('div'); div.className='msg';
                let content = d.type==='image' ? `<img src="${d.text}" style="max-width:250px;border-radius:5px;">` : (d.type==='file'?`<a href="${d.text}" target="_blank" style="color:#5865F2">–§–∞–π–ª</a>` : d.text);
                div.innerHTML=`<div class="user-avatar">${d.user[0]}</div><div class="msg-content"><h4>${d.user}</h4><div class="msg-text">${content}</div></div>`;
                c.appendChild(div);
            });
            c.scrollTop=c.scrollHeight;
        });
    }
    async function cleanOldMessages() {
        const d=new Date(); d.setDate(d.getDate()-2);
        const s=await db.collection('messages').where('ts','<',d).get();
        const b=db.batch(); s.forEach(doc=>b.delete(doc.ref));
        await b.commit();
    }
    
    // Tabs & Embeds
    function switchTab(t) {
        document.querySelectorAll('.chat-view, .embed-view').forEach(e=>e.style.display='none');
        document.querySelectorAll('.srv-icon').forEach(e=>e.classList.remove('active'));
        event.currentTarget.classList.add('active');
        document.getElementById('tab-'+t).style.display = (t==='chat'?'flex':'flex');
    }
    function loadSpotify() { 
        let v=document.getElementById('spot-url').value; 
        if(v&&!v.includes('embed'))v=v.replace('open.spotify.com/','open.spotify.com/embed/');
        document.getElementById('frame-spotify').src=v||"https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M";
    }
    function loadYoutube() {
        let v=document.getElementById('yt-url').value;
        if(v.includes('watch?v='))v=v.replace('watch?v=','embed/');
        else if(!v.includes('http')) v='https://www.youtube.com/embed?listType=search&list='+v;
        document.getElementById('frame-youtube').src=v;
    }
    function loadWeb() { document.getElementById('frame-web').src=document.getElementById('web-url').value; }
    function updateBg() { document.documentElement.style.setProperty('--custom-bg', `url('${document.getElementById('bg-url').value}')`); }

    // Mic List
    navigator.mediaDevices.enumerateDevices().then(ds=>{
        const s=document.getElementById('mic-select');
        ds.filter(d=>d.kind==='audioinput').forEach(d=>{
            const o=document.createElement('option'); o.value=d.deviceId; o.text=d.label||'Mic'; s.appendChild(o);
        });
    });
</script>
</body>
</html>
