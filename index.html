<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS - Secure Messenger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-gold': 'pulseGold 2s infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              pulseGold: { '0%, 100%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.05)', opacity: '0.8' } }
            }
          }
        }
      }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles -->
    <style>
      body { background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
      
      /* Mobile optimizations */
      @media (max-width: 640px) {
        .safe-area-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        /* Hide scrollbar on mobile for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      }

      .coin-animation {
        animation: coinPop 0.5s ease-out;
      }

      @keyframes coinPop {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
      }

      /* Frame styles */
      .frame-basic { border: 3px solid #64748b; }
      .frame-silver { border: 3px solid #c0c0c0; box-shadow: 0 0 10px #c0c0c0; }
      .frame-gold { border: 3px solid #ffd700; box-shadow: 0 0 15px #ffd700; }
      .frame-rainbow { 
        border: 3px solid;
        border-image: linear-gradient(45deg, #ff0000, #ff8000, #ffff00, #00ff00, #0080ff, #0000ff, #8000ff) 1;
        box-shadow: 0 0 20px rgba(255,255,255,0.3);
      }
      .frame-galaxy {
        border: 3px solid;
        border-image: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c) 1;
        box-shadow: 0 0 25px rgba(102, 126, 234, 0.5);
      }
      .frame-diamond {
        border: 3px solid;
        border-image: linear-gradient(45deg, #00ffff, #00ff80, #ffff00, #ff8000) 1;
        box-shadow: 0 0 30px rgba(0, 255, 255, 0.6);
      }
    </style>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Video, Settings as SettingsIcon, Menu, Trash2, Smile, MoreVertical, Lock, LogOut, User as UserIcon, Loader2, Coins, Zap, Crown, Gift, Sparkles } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        // --- Services ---
        const firebaseConfig = {
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87",
            measurementId: "G-SCD5JVFM5E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Frame configurations
        const FRAMES = {
            basic: { name: '–ë–∞–∑–æ–≤–∞—è', price: 10, className: 'frame-basic' },
            silver: { name: '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è', price: 25, className: 'frame-silver' },
            gold: { name: '–ó–æ–ª–æ—Ç–∞—è', price: 50, className: 'frame-gold' },
            rainbow: { name: '–†–∞–¥—É–∂–Ω–∞—è', price: 100, className: 'frame-rainbow' },
            galaxy: { name: '–ì–∞–ª–∞–∫—Ç–∏–∫–∞', price: 200, className: 'frame-galaxy' },
            diamond: { name: '–ê–ª–º–∞–∑–Ω–∞—è', price: 500, className: 'frame-diamond' }
        };

        // --- Components ---

        // 1. User Avatar Component
        const UserAvatar = ({ username, avatar, frame, size = 'medium', className = '' }) => {
            const frameClass = FRAMES[frame]?.className || '';
            const sizeClasses = {
                small: 'w-8 h-8 text-sm',
                medium: 'w-10 h-10 text-base',
                large: 'w-12 h-12 text-lg',
                xlarge: 'w-16 h-16 text-xl'
            };

            return (
                <div className={`${sizeClasses[size]} rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold relative ${frameClass} ${className}`}>
                    {avatar || username[0].toUpperCase()}
                </div>
            );
        };

        // 2. Button
        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                ghost: "bg-transparent hover:bg-white/5 text-slate-300",
                gold: "bg-yellow-500 hover:bg-yellow-400 text-white shadow-lg shadow-yellow-500/20"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? (
                        <Loader2 className="animate-spin h-5 w-5" />
                    ) : (<>{icon && <span className="text-lg">{icon}</span>}{children}</>)}
                </button>
            );
        };

        // 3. Send Coins Modal
        const SendCoinsModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate }) => {
            const [recipient, setRecipient] = useState('');
            const [amount, setAmount] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });

            if (!isOpen) return null;

            const handleSendCoins = async () => {
                if (!recipient.trim() || !amount) {
                    setMessage({ type: 'error', text: '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è' });
                    return;
                }

                const coinsAmount = parseFloat(amount);
                if (isNaN(coinsAmount) || coinsAmount <= 0) {
                    setMessage({ type: 'error', text: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É' });
                    return;
                }

                if (coinsAmount > userCoins) {
                    setMessage({ type: 'error', text: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤' });
                    return;
                }

                if (recipient === currentUser) {
                    setMessage({ type: 'error', text: '–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã —Å–∞–º–æ–º—É —Å–µ–±–µ' });
                    return;
                }

                setIsLoading(true);
                try {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                    const recipientRef = ref(db, `users/${recipient}`);
                    const snapshot = await get(recipientRef);
                    
                    if (!snapshot.exists()) {
                        setMessage({ type: 'error', text: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                        setIsLoading(false);
                        return;
                    }

                    const recipientData = snapshot.val();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - coinsAmount 
                    });
                    
                    await update(ref(db, `users/${recipient}`), { 
                        coins: (recipientData.coins || 0) + coinsAmount 
                    });

                    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                    const transactionRef = push(ref(db, 'transactions'));
                    await set(transactionRef, {
                        from: currentUser,
                        to: recipient,
                        amount: coinsAmount,
                        timestamp: Date.now(),
                        type: 'transfer'
                    });

                    setMessage({ type: 'success', text: `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${coinsAmount} –∫–æ–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${recipient}` });
                    onCoinsUpdate(userCoins - coinsAmount);
                    setRecipient('');
                    setAmount('');
                    
                    setTimeout(() => {
                        onClose();
                    }, 2000);
                } catch (error) {
                    console.error('Send coins error:', error);
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Gift size={20} className="text-yellow-500" /> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            {message.text && (
                                <div className={`mb-4 p-3 rounded-lg text-sm text-center ${
                                    message.type === 'error' ? 'text-red-400 bg-red-500/10' : 'text-green-400 bg-green-500/10'
                                }`}>
                                    {message.text}
                                </div>
                            )}
                            
                            <div className="space-y-4">
                                <div className="text-center p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                                    <div className="flex items-center justify-center gap-2 text-yellow-500 mb-2">
                                        <Coins size={24} />
                                        <span className="font-bold text-xl">{userCoins.toFixed(3)}</span>
                                    </div>
                                    <p className="text-slate-400 text-sm">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
                                </div>

                                <div>
                                    <label className="text-slate-300 text-sm mb-2 block">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
                                    <input 
                                        type="text" 
                                        placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                        value={recipient} 
                                        onChange={e => setRecipient(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-yellow-500 outline-none" 
                                    />
                                </div>

                                <div>
                                    <label className="text-slate-300 text-sm mb-2 block">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤</label>
                                    <input 
                                        type="number"
                                        step="0.001"
                                        min="0.001"
                                        max={userCoins}
                                        placeholder="0.001" 
                                        value={amount} 
                                        onChange={e => setAmount(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-yellow-500 outline-none" 
                                    />
                                </div>

                                <Button 
                                    onClick={handleSendCoins} 
                                    isLoading={isLoading}
                                    variant="gold"
                                    className="w-full"
                                    disabled={!recipient || !amount}
                                >
                                    <Gift size={18} />
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Frames Modal
        const FramesModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate, userFrame, onFrameChange }) => {
            const [selectedFrame, setSelectedFrame] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const frames = Object.entries(FRAMES).map(([id, frame]) => ({
                id,
                ...frame,
                description: `–°—Ç–∏–ª—å–Ω–∞—è ${frame.name.toLowerCase()} —Ä–∞–º–∫–∞`
            }));

            if (!isOpen) return null;

            const handleFramePurchase = async (frame) => {
                if (userCoins < frame.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${frame.price} –∫–æ–∏–Ω–æ–≤.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (currentUser !== 'kayivi') {
                        // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–∏–Ω—ã
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - frame.price,
                            frame: frame.id
                        });
                    } else {
                        // kayivi –ø–æ–∫—É–ø–∞–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ
                        await update(ref(db, `users/${currentUser}`), { 
                            frame: frame.id
                        });
                    }
                    
                    setSelectedFrame(frame.id);
                    onFrameChange(frame.id);
                    onCoinsUpdate(currentUser === 'kayivi' ? userCoins : userCoins - frame.price);
                    onClose();
                } catch (error) {
                    console.error('Frame purchase error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ä–∞–º–∫–∏');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-4xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Sparkles size={20} className="text-purple-500" /> –ú–∞–≥–∞–∑–∏–Ω —Ä–∞–º–æ–∫</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            <div className="text-center mb-6">
                                <p className="text-slate-400">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={16} /> –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–∫—É–ø–∞—Ç—å —Ä–∞–º–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></span>
                                    )}
                                </p>
                                <p className="text-sm text-slate-500 mt-2">–¢–µ–∫—É—â–∞—è —Ä–∞–º–∫–∞: <span className="text-purple-500 font-bold">
                                    {frames.find(f => f.id === userFrame)?.name || '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
                                </span></p>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {frames.map((frame) => (
                                    <div
                                        key={frame.id}
                                        className={`p-4 rounded-xl border-2 transition-all duration-200 ${
                                            userFrame === frame.id 
                                                ? 'border-purple-500 bg-purple-500/10' 
                                                : 'border-slate-700 bg-slate-800 hover:border-slate-600'
                                        }`}
                                    >
                                        <UserAvatar 
                                            username={currentUser}
                                            avatar=""
                                            frame={frame.id}
                                            size="large"
                                            className="mx-auto mb-3"
                                        />
                                        <h3 className="font-bold text-white text-center mb-2">{frame.name}</h3>
                                        <p className="text-slate-400 text-sm text-center mb-3">{frame.description}</p>
                                        <div className="flex items-center justify-between">
                                            <span className="text-yellow-500 font-bold">{frame.price} –∫–æ–∏–Ω–æ–≤</span>
                                            <button
                                                onClick={() => handleFramePurchase(frame)}
                                                disabled={isLoading || (userCoins < frame.price && currentUser !== 'kayivi')}
                                                className={`px-3 py-1 rounded-lg text-sm font-medium transition-all ${
                                                    userFrame === frame.id
                                                        ? 'bg-purple-500 text-white'
                                                        : (userCoins >= frame.price || currentUser === 'kayivi')
                                                        ? 'bg-green-500 hover:bg-green-400 text-white'
                                                        : 'bg-slate-700 text-slate-400 cursor-not-allowed'
                                                }`}
                                            >
                                                {userFrame === frame.id ? '–í—ã–±—Ä–∞–Ω–∞' : 
                                                 (userCoins >= frame.price || currentUser === 'kayivi') ? '–ö—É–ø–∏—Ç—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ'}
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Avatar Modal
        const AvatarModal = ({ isOpen, onClose, currentUser, userCoins, onAvatarChange }) => {
            const [selectedAvatar, setSelectedAvatar] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const avatars = [
                'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ',
                'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ñ',
                'üêô', 'üê†', 'üê¨', 'üê≥', 'ü¶Å', 'üêØ', 'üê®', 'üêº', 'üêª', 'üê∞'
            ];

            if (!isOpen) return null;

            const handleAvatarSelect = async (avatar) => {
                if (userCoins < 10 && currentUser !== 'kayivi') {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ 10 –∫–æ–∏–Ω–æ–≤ –¥–ª—è —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∫–∏.');
                    return;
                }

                setIsLoading(true);
                try {
                    if (currentUser !== 'kayivi') {
                        // –°–ø–∏—Å—ã–≤–∞–µ–º 10 –∫–æ–∏–Ω–æ–≤
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - 10,
                            avatar: avatar
                        });
                    } else {
                        // kayivi –º–µ–Ω—è–µ—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ
                        await update(ref(db, `users/${currentUser}`), { 
                            avatar: avatar
                        });
                    }
                    setSelectedAvatar(avatar);
                    onAvatarChange(avatar);
                    onClose();
                } catch (error) {
                    console.error('Avatar change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–≤–∞—Ç–∞—Ä–∫–∏');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><UserIcon size={20} className="text-yellow-500" /> –í—ã–±–æ—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            <div className="text-center mb-6">
                                <p className="text-slate-400">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={16} /> –í—ã –º–æ–∂–µ—Ç–µ –º–µ–Ω—è—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–°—Ç–æ–∏–º–æ—Å—Ç—å —Å–º–µ–Ω—ã –∞–≤–∞—Ç–∞—Ä–∫–∏: <span className="text-yellow-500 font-bold">10 –∫–æ–∏–Ω–æ–≤</span></span>
                                    )}
                                </p>
                                <p className="text-sm text-slate-500 mt-2">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-6 gap-4">
                                {avatars.map((avatar, index) => (
                                    <button
                                        key={index}
                                        onClick={() => handleAvatarSelect(avatar)}
                                        disabled={isLoading}
                                        className="text-4xl p-4 rounded-xl bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 transition-all duration-200 hover:scale-105"
                                    >
                                        {avatar}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Settings Modal
        const SettingsModal = ({ isOpen, onClose, currentUser, onLogout, userCoins, onCoinsUpdate, userAvatar, userFrame }) => {
            const [activeTab, setActiveTab] = useState('profile');
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmDelete, setConfirmDelete] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });
            const [coinsToAdd, setCoinsToAdd] = useState('');

            if (!isOpen) return null;

            const handleChangePassword = async () => {
                if (!oldPassword || !newPassword) return;
                setIsLoading(true);
                try {
                    const userRef = ref(db, `users/${currentUser}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val();
                    if (userData.password !== oldPassword) {
                        setMessage({ type: 'error', text: '–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω' });
                        setIsLoading(false); return;
                    }
                    await update(userRef, { password: newPassword });
                    setMessage({ type: 'success', text: '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω' });
                    setOldPassword(''); setNewPassword('');
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è' }); }
                setIsLoading(false);
            };

            const handleDeleteAccount = async () => {
                if (confirmDelete !== currentUser) {
                     setMessage({ type: 'error', text: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
                     return;
                }
                setIsLoading(true);
                try {
                    await remove(ref(db, `users/${currentUser}`));
                    onLogout();
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è' }); setIsLoading(false); }
            };

            const handleAddCoins = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã!');
                    return;
                }
                
                const coins = parseFloat(coinsToAdd);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins + coins 
                    });
                    onCoinsUpdate(userCoins + coins);
                    setMessage({ type: 'success', text: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤!` });
                    setCoinsToAdd('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><UserIcon size={20} className="text-indigo-500" /> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="flex border-b border-slate-800 bg-slate-900/50">
                            {['profile', 'coins', 'security', 'danger'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 text-sm font-medium transition-colors capitalize ${activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'}`}>
                                    {tab === 'profile' ? '–ü—Ä–æ—Ñ–∏–ª—å' : tab === 'coins' ? '–ö–æ–∏–Ω—Å—ã' : tab === 'security' ? '–ü–∞—Ä–æ–ª—å' : '–£–¥–∞–ª–∏—Ç—å'}
                                </button>
                            ))}
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            {message.text && <div className={`mb-4 p-3 rounded-lg text-sm text-center ${message.type === 'error' ? 'text-red-400 bg-red-500/10' : 'text-green-400 bg-green-500/10'}`}>{message.text}</div>}
                            
                            {activeTab === 'profile' && (
                                <div className="space-y-6 text-center">
                                    <UserAvatar 
                                        username={currentUser}
                                        avatar={userAvatar}
                                        frame={userFrame}
                                        size="xlarge"
                                        className="mx-auto"
                                    />
                                    <div>
                                        <h3 className="text-2xl font-bold text-white">{currentUser}</h3>
                                        <p className="text-slate-400">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                                        {userFrame && (
                                            <p className="text-purple-500 text-sm mt-1">
                                                –†–∞–º–∫–∞: {FRAMES[userFrame]?.name}
                                            </p>
                                        )}
                                    </div>
                                    <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4">
                                        <div className="flex items-center justify-center gap-2 text-yellow-500">
                                            <Coins size={20} />
                                            <span className="font-bold text-lg">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</span>
                                        </div>
                                    </div>
                                    <Button variant="secondary" onClick={onLogout} className="w-full" icon={<LogOut size={18} />}>–í—ã–π—Ç–∏</Button>
                                </div>
                            )}

                            {activeTab === 'coins' && (
                                <div className="space-y-4">
                                    <div className="text-center p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                                        <div className="flex items-center justify-center gap-2 text-yellow-500 mb-2">
                                            <Coins size={24} />
                                            <span className="font-bold text-xl">{userCoins.toFixed(3)}</span>
                                        </div>
                                        <p className="text-slate-400 text-sm">–í–∞—à –±–∞–ª–∞–Ω—Å –∫–æ–∏–Ω–æ–≤</p>
                                    </div>
                                    
                                    {currentUser === 'kayivi' && (
                                        <div className="space-y-3 p-4 bg-green-500/10 border border-green-500/20 rounded-xl">
                                            <div className="flex items-center gap-2 text-green-500 mb-2">
                                                <Crown size={16} />
                                                <span className="font-bold">–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</span>
                                            </div>
                                            <div className="flex gap-2">
                                                <input 
                                                    type="number" 
                                                    step="0.001"
                                                    placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                    value={coinsToAdd} 
                                                    onChange={e => setCoinsToAdd(e.target.value)}
                                                    className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white focus:border-green-500 outline-none" 
                                                />
                                                <Button 
                                                    onClick={handleAddCoins} 
                                                    isLoading={isLoading}
                                                    variant="gold"
                                                    className="whitespace-nowrap"
                                                >
                                                    –î–æ–±–∞–≤–∏—Ç—å
                                                </Button>
                                            </div>
                                        </div>
                                    )}

                                    <div className="text-slate-400 text-sm space-y-2">
                                        <p>üíé 1 –∫–ª–∏–∫ = +0.001 –∫–æ–∏–Ω</p>
                                        <p>üîÑ –°–º–µ–Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ = 10 –∫–æ–∏–Ω–æ–≤</p>
                                        <p>üñºÔ∏è –†–∞–º–∫–∏ = –æ—Ç 10 –¥–æ 500 –∫–æ–∏–Ω–æ–≤</p>
                                        {currentUser === 'kayivi' && (
                                            <p className="text-green-500">üëë –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ</p>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'security' && (
                                <div className="space-y-4">
                                    <input type="password" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" value={oldPassword} onChange={e => setOldPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none" />
                                    <input type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" value={newPassword} onChange={e => setNewPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none" />
                                    <Button onClick={handleChangePassword} isLoading={isLoading} disabled={!oldPassword || !newPassword} className="w-full">–û–±–Ω–æ–≤–∏—Ç—å</Button>
                                </div>
                            )}

                            {activeTab === 'danger' && (
                                <div className="space-y-4 p-4 bg-red-500/5 border border-red-500/10 rounded-xl">
                                    <p className="text-sm text-slate-400">–í–≤–µ–¥–∏—Ç–µ <b>{currentUser}</b> –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.</p>
                                    <input type="text" placeholder={currentUser} value={confirmDelete} onChange={e => setConfirmDelete(e.target.value)} className="w-full bg-slate-800 border border-red-900/30 rounded-xl px-4 py-3 text-white focus:border-red-500 outline-none" />
                                    <Button variant="danger" onClick={handleDeleteAccount} isLoading={isLoading} disabled={confirmDelete !== currentUser} className="w-full">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞</Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 7. Message Bubble
        const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•'];
        const MessageBubble = ({ message, isOwn, chatId, messageId, currentUser, userData }) => {
            const [showActions, setShowActions] = useState(false);
            const [showReactions, setShowReactions] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setShowActions(false); setShowReactions(false);
                    }
                };
                if (showActions || showReactions) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showActions, showReactions]);

            const handleDelete = async () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    try {
                        await update(ref(db, `messages/${chatId}/${messageId}`), { deleted: true });
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                }
                setShowActions(false);
            };

            const handleReaction = async (emoji) => {
                try {
                    const msgRef = ref(db, `messages/${chatId}/${messageId}/reactions`);
                    const currentReactions = message.reactions || {};
                    if (currentReactions[currentUser] === emoji) {
                        await update(msgRef, { [currentUser]: null });
                    } else {
                        await update(msgRef, { [currentUser]: emoji });
                    }
                    setShowReactions(false); setShowActions(false);
                } catch (error) {
                    console.error('Reaction error:', error);
                }
            };

            if (message.deleted) return null;

            const renderContent = () => {
                switch (message.type) {
                    case 'photo': return <div className="relative group"><img src={message.mediaUrl} alt="Photo" className="max-w-full sm:max-w-[320px] max-h-[400px] object-cover rounded-lg" loading="lazy" /></div>;
                    case 'video': return <video controls src={message.mediaUrl} className="max-w-full sm:max-w-[320px] max-h-[400px] rounded-lg bg-black" playsInline />;
                    case 'audio': return <div className="flex items-center gap-3 min-w-[200px]"><div className={`p-2 rounded-full ${isOwn ? 'bg-white/20' : 'bg-indigo-500/20 text-indigo-400'}`}><Mic size={16}/></div><audio controls src={message.mediaUrl} className="h-8 w-full max-w-[200px]" /></div>;
                    default: return <p className="break-words whitespace-pre-wrap leading-relaxed text-[15px]">{message.text}</p>;
                }
            };

            const senderData = userData[message.sender] || {};

            return (
                <div className={`group flex mb-4 ${isOwn ? 'justify-end' : 'justify-start'} animate-slide-up relative z-0`} ref={containerRef}>
                    {!isOwn && (
                        <div className="mr-2 flex-shrink-0">
                            <UserAvatar 
                                username={message.sender}
                                avatar={senderData.avatar}
                                frame={senderData.frame}
                                size="small"
                            />
                        </div>
                    )}
                    <div className={`relative max-w-[85%] sm:max-w-[70%] rounded-2xl px-4 py-3 shadow-sm transition-all ${isOwn ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-100 rounded-bl-none border border-slate-700'}`}>
                        {!isOwn && (
                            <div className="text-xs text-slate-400 mb-1 font-medium">
                                {message.sender}
                                {message.sender === 'kayivi' && <Crown size={10} className="inline ml-1 text-yellow-500" />}
                            </div>
                        )}
                        <button onClick={(e) => { e.stopPropagation(); setShowActions(!showActions); if(!showActions) setShowReactions(false); }} className={`absolute -top-3 ${isOwn ? 'left-0' : 'right-0'} p-1.5 rounded-full bg-slate-800 border border-slate-700 shadow-md text-slate-400 z-10 hover:text-white hover:scale-110`}><MoreVertical size={14} /></button>
                        
                        {showActions && (
                            <div className={`absolute -top-14 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex items-center p-1.5 gap-1 animate-fade-in`}>
                                <button onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); }} className="p-2 rounded-lg hover:bg-slate-800 text-slate-300"><Smile size={18} /></button>
                                {isOwn && <><div className="w-px h-6 bg-slate-800 mx-1"></div><button onClick={(e) => { e.stopPropagation(); handleDelete(); }} className="p-2 rounded-lg hover:bg-red-500/20 text-red-400"><Trash2 size={18} /></button></>}
                            </div>
                        )}
                        
                        {showReactions && (
                            <div className={`absolute -top-28 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl z-50 flex flex-wrap max-w-[160px] p-2 gap-2 animate-fade-in`}>
                                {EMOJIS.map(emoji => <button key={emoji} onClick={(e) => { e.stopPropagation(); handleReaction(emoji); }} className="hover:bg-slate-800 p-1.5 rounded-lg text-xl">{emoji}</button>)}
                            </div>
                        )}

                        {renderContent()}
                        <div className={`flex items-center justify-end gap-1 mt-1 text-[10px] ${isOwn ? 'text-indigo-200' : 'text-slate-500'} font-medium`}><span>{format(message.timestamp, 'HH:mm')}</span></div>
                        
                        {message.reactions && Object.keys(message.reactions).length > 0 && (
                            <div className={`absolute -bottom-3 ${isOwn ? 'left-0' : 'right-0'} flex -space-x-1 cursor-pointer`} onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); setShowActions(true); }}>
                                {Object.entries(message.reactions).slice(0, 4).map(([user, emoji]) => (
                                    <div key={user} className="bg-slate-800 border border-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md z-10" title={user}>{emoji}</div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 8. Clicker Component
        const Clicker = ({ userCoins, onCoinClick, currentUser }) => {
            const [showCoin, setShowCoin] = useState(false);
            const [coinPosition, setCoinPosition] = useState({ x: 0, y: 0 });

            const handleClick = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                setCoinPosition({ x, y });
                setShowCoin(true);
                onCoinClick();
                
                setTimeout(() => setShowCoin(false), 500);
            };

            return (
                <div className="relative">
                    {showCoin && (
                        <div 
                            className="absolute text-yellow-500 text-2xl font-bold coin-animation z-50"
                            style={{ left: coinPosition.x, top: coinPosition.y }}
                        >
                            +0.001
                        </div>
                    )}
                    <button
                        onClick={handleClick}
                        className="w-full bg-gradient-to-br from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white p-6 rounded-2xl shadow-2xl shadow-yellow-500/25 transition-all duration-200 active:scale-95 border-2 border-yellow-400/50 animate-pulse-gold"
                    >
                        <div className="text-center">
                            <Coins size={48} className="mx-auto mb-2" />
                            <div className="text-2xl font-bold mb-1">{userCoins.toFixed(3)}</div>
                            <div className="text-yellow-200 text-sm">–ö–ª–∏–∫–Ω–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞!</div>
                            <div className="text-yellow-300/80 text-xs mt-1">+0.001 –∑–∞ –∫–ª–∏–∫</div>
                        </div>
                    </button>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [isLoginView, setIsLoginView] = useState(true);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [chats, setChats] = useState([]);
            const [areChatsLoading, setAreChatsLoading] = useState(false);
            const [activeChatUser, setActiveChatUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isFramesModalOpen, setIsFramesModalOpen] = useState(false);
            const [isSendCoinsModalOpen, setIsSendCoinsModalOpen] = useState(false);
            const [showMobileSidebar, setShowMobileSidebar] = useState(true);
            const [isRecording, setIsRecording] = useState(false);
            const [connectionError, setConnectionError] = useState('');
            const [userCoins, setUserCoins] = useState(0);
            const [userAvatar, setUserAvatar] = useState('');
            const [userFrame, setUserFrame] = useState('');
            const [allUsersData, setAllUsersData] = useState({});
            const mediaRecorderRef = useRef(null);
            const messagesEndRef = useRef(null);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫ –∏ —Ä–∞–º–æ–∫
            useEffect(() => {
                const usersRef = ref(db, 'users');
                const unsubscribe = onValue(usersRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setAllUsersData(data);
                    }
                });
                
                return () => off(usersRef);
            }, []);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            useEffect(() => {
                if (currentUser) {
                    const userRef = ref(db, `users/${currentUser}`);
                    const unsubscribe = onValue(userRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUserCoins(data.coins || 0);
                            setUserAvatar(data.avatar || '');
                            setUserFrame(data.frame || '');
                        }
                    });
                    
                    return () => off(userRef);
                }
            }, [currentUser]);

            // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏...
            // [–ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏–º–µ—Ä–∞]

            // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–ª—é —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —á–∞—Å—Ç–∏, –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∞–Ω–∞–ª–æ–≥–∏—á–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        currentUser={currentUser} 
                        onLogout={handleLogout}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userAvatar={userAvatar}
                        userFrame={userFrame}
                    />
                    
                    <AvatarModal
                        isOpen={isAvatarModalOpen}
                        onClose={() => setIsAvatarModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onAvatarChange={setUserAvatar}
                    />

                    <FramesModal
                        isOpen={isFramesModalOpen}
                        onClose={() => setIsFramesModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userFrame={userFrame}
                        onFrameChange={setUserFrame}
                    />

                    <SendCoinsModal
                        isOpen={isSendCoinsModalOpen}
                        onClose={() => setIsSendCoinsModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                    />
                    
                    {connectionError && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg text-sm backdrop-blur-sm">
                            {connectionError}
                        </div>
                    )}
                    
                    {/* Sidebar */}
                    <div className={`${showMobileSidebar ? 'flex' : 'hidden'} md:flex w-full md:w-[420px] flex-col border-r border-slate-800 bg-slate-900 z-10`}>
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between h-[72px]">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setIsAvatarModalOpen(true)}
                                    className="relative group"
                                >
                                    <UserAvatar 
                                        username={currentUser}
                                        avatar={userAvatar}
                                        frame={userFrame}
                                        size="medium"
                                    />
                                    {userCoins >= 10 && (
                                        <div className="absolute -top-1 -right-1 bg-yellow-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                                            !
                                        </div>
                                    )}
                                </button>
                                <div>
                                    <h2 className="font-bold text-white flex items-center gap-1">
                                        {currentUser}
                                        {currentUser === 'kayivi' && <Crown size={14} className="text-yellow-500" />}
                                    </h2>
                                    <span className="text-[11px] text-green-500 flex items-center gap-1">‚óè –í —Å–µ—Ç–∏</span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => setIsSendCoinsModalOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 hover:bg-yellow-500/10 transition-colors"
                                    title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã"
                                >
                                    <Gift size={18} />
                                </button>
                                <button 
                                    onClick={() => setIsFramesModalOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-purple-500 hover:bg-purple-500/10 transition-colors"
                                    title="–ú–∞–≥–∞–∑–∏–Ω —Ä–∞–º–æ–∫"
                                >
                                    <Sparkles size={18} />
                                </button>
                                <button 
                                    onClick={() => setIsSettingsOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-white"
                                >
                                    <SettingsIcon size={20} />
                                </button>
                            </div>
                        </div>

                        {/* Clicker Section */}
                        <div className="p-4 border-b border-slate-800">
                            <Clicker 
                                userCoins={userCoins} 
                                onCoinClick={handleCoinClick}
                                currentUser={currentUser}
                            />
                        </div>

                        <div className="p-4">
                            <div className="relative">
                                <Search className="absolute left-3 top-3 text-slate-500" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="–ü–æ–∏—Å–∫..." 
                                    className="w-full bg-slate-800 border border-slate-700 rounded-xl py-2.5 pl-10 text-slate-200 outline-none focus:border-indigo-500" 
                                    value={searchQuery} 
                                    onChange={e => handleSearch(e.target.value)} 
                                />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-2">
                            {areChatsLoading ? (
                                <div className="flex flex-col items-center justify-center mt-10 text-slate-500 gap-2">
                                    <Loader2 className="animate-spin text-indigo-500" size={24} />
                                    <p className="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                                </div>
                            ) : searchQuery ? (
                                searchResults.length ? searchResults.map(u => (
                                    <div 
                                        key={u.username} 
                                        onClick={() => { setActiveChatUser(u.username); setSearchQuery(''); setSearchResults([]); }} 
                                        className="p-3 flex items-center gap-3 rounded-xl hover:bg-slate-800 cursor-pointer"
                                    >
                                        <UserAvatar 
                                            username={u.username}
                                            avatar={u.avatar}
                                            frame={u.frame}
                                            size="medium"
                                        />
                                        <div>
                                            <h3 className="font-medium text-slate-200 flex items-center gap-1">
                                                {u.username}
                                                {u.username === 'kayivi' && <Crown size={12} className="text-yellow-500" />}
                                            </h3>
                                            {u.frame && (
                                                <p className="text-xs text-purple-400">
                                                    {FRAMES[u.frame]?.name}
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                )) : <div className="text-center text-slate-500 mt-4">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            ) : (
                                chats.length ? chats.map(c => {
                                    const userData = allUsersData[c.user] || {};
                                    return (
                                        <div 
                                            key={c.user} 
                                            onClick={() => setActiveChatUser(c.user)} 
                                            className={`p-3 flex items-center gap-3 rounded-xl cursor-pointer hover:bg-slate-800 ${activeChatUser === c.user ? 'bg-slate-800' : ''}`}
                                        >
                                            <UserAvatar 
                                                username={c.user}
                                                avatar={userData.avatar}
                                                frame={userData.frame}
                                                size="medium"
                                            />
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-baseline">
                                                    <h3 className="font-semibold text-slate-200 truncate flex items-center gap-1">
                                                        {c.user}
                                                        {c.user === 'kayivi' && <Crown size={12} className="text-yellow-500" />}
                                                    </h3>
                                                    <span className="text-xs text-slate-500">
                                                        {new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-slate-400 truncate">
                                                    {c.lastMessage.type === 'text' ? c.lastMessage.text : 
                                                     c.lastMessage.type === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 
                                                     c.lastMessage.type === 'video' ? 'üé• –í–∏–¥–µ–æ' : 
                                                     c.lastMessage.type === 'audio' ? 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ' : '–°–æ–æ–±—â–µ–Ω–∏–µ'}
                                                </p>
                                                {userData.frame && (
                                                    <p className="text-xs text-purple-400 truncate">
                                                        {FRAMES[userData.frame]?.name}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    );
                                }) : (
                                    <div className="text-center text-slate-500 mt-10 p-4">
                                        <p>–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                                        <p className="text-xs mt-2">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                                    </div>
                                )
                            )}
                        </div>
                    </div>

                    {/* Chat Area */}
                    {activeChatUser ? (
                        <div className={`${!showMobileSidebar ? 'flex' : 'hidden md:flex'} flex-1 flex-col bg-slate-950 relative`}>
                            <div className="h-[72px] px-4 flex items-center gap-3 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md sticky top-0 z-20">
                                <button onClick={() => { setActiveChatUser(null); setShowMobileSidebar(true); }} className="md:hidden text-slate-400">
                                    <ChevronLeft size={24} />
                                </button>
                                <UserAvatar 
                                    username={activeChatUser}
                                    avatar={allUsersData[activeChatUser]?.avatar}
                                    frame={allUsersData[activeChatUser]?.frame}
                                    size="medium"
                                />
                                <div>
                                    <h3 className="font-bold text-slate-200 flex items-center gap-1">
                                        {activeChatUser}
                                        {activeChatUser === 'kayivi' && <Crown size={14} className="text-yellow-500" />}
                                    </h3>
                                    {allUsersData[activeChatUser]?.frame && (
                                        <p className="text-xs text-purple-400">
                                            {FRAMES[allUsersData[activeChatUser]?.frame]?.name}
                                        </p>
                                    )}
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                {messages.length === 0 ? (
                                    <div className="text-center text-slate-500 mt-10">
                                        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                        <p className="text-sm mt-2">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                                    </div>
                                ) : (
                                    messages.map(msg => (
                                        <MessageBubble 
                                            key={msg.id} 
                                            message={msg} 
                                            isOwn={msg.sender === currentUser} 
                                            chatId={[currentUser, activeChatUser].sort().join('_')} 
                                            messageId={msg.id} 
                                            currentUser={currentUser}
                                            userData={allUsersData}
                                        />
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="p-3 bg-slate-900 border-t border-slate-800 safe-area-bottom">
                                <div className="flex items-end gap-2 max-w-4xl mx-auto">
                                    <div className="flex gap-1 bg-slate-800 p-1 rounded-xl shrink-0">
                                        <label className="p-2 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <ImageIcon size={20} />
                                            <input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(e, 'photo')} />
                                        </label>
                                        <label className="p-2 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <Video size={20} />
                                            <input type="file" className="hidden" accept="video/*" onChange={e => handleFileUpload(e, 'video')} />
                                        </label>
                                        <button 
                                            onClick={toggleRecording} 
                                            className={`p-2 rounded-lg ${isRecording ? 'text-red-500 animate-pulse' : 'text-slate-400 hover:text-indigo-400'}`}
                                        >
                                            {isRecording ? <div className="w-5 h-5 bg-red-500 rounded-sm" /> : <Mic size={20} />}
                                        </button>
                                    </div>
                                    <div className="flex-1 min-w-0 bg-slate-800 rounded-2xl border border-slate-700">
                                        <textarea 
                                            value={messageInput} 
                                            onChange={e => setMessageInput(e.target.value)} 
                                            onKeyPress={e => { 
                                                if(e.key === 'Enter' && !e.shiftKey) { 
                                                    e.preventDefault(); 
                                                    handleSendMessage('text'); 
                                                }
                                            }} 
                                            placeholder={isRecording ? "–ó–∞–ø–∏—Å—å..." : "–°–æ–æ–±—â–µ–Ω–∏–µ..."} 
                                            className="w-full bg-transparent text-white px-4 py-3 outline-none resize-none h-[50px] custom-scrollbar" 
                                        />
                                    </div>
                                    <button 
                                        onClick={() => handleSendMessage('text')} 
                                        disabled={!messageInput.trim() && !isRecording} 
                                        className="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 shadow-lg shadow-indigo-600/20 shrink-0"
                                    >
                                        <Send size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="hidden md:flex flex-1 items-center justify-center bg-slate-950 text-slate-500 flex-col gap-4">
                            <div className="w-24 h-24 rounded-full bg-slate-900 border border-slate-800 flex items-center justify-center">
                                <Send size={40} className="text-indigo-500" />
                            </div>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
