<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS - Secure Messenger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-gold': 'pulseGold 2s infinite',
              'float': 'float 3s ease-in-out infinite',
              'gift-float': 'giftFloat 2s ease-in-out',
              'orbit-slow': 'orbitSlow 15s linear infinite',
              'orbit-medium': 'orbitMedium 12s linear infinite',
              'orbit-fast': 'orbitFast 8s linear infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              pulseGold: { '0%, 100%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.05)', opacity: '0.8' } },
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
              giftFloat: { 
                '0%': { transform: 'translateY(100px) scale(0.5)', opacity: '0' },
                '50%': { transform: 'translateY(-20px) scale(1.2)', opacity: '1' },
                '100%': { transform: 'translateY(0) scale(1)', opacity: '1' }
              },
              orbitSlow: {
                '0%': { transform: 'rotate(0deg) translateX(45px) rotate(0deg)' },
                '100%': { transform: 'rotate(360deg) translateX(45px) rotate(-360deg)' }
              },
              orbitMedium: {
                '0%': { transform: 'rotate(120deg) translateX(55px) rotate(-120deg)' },
                '100%': { transform: 'rotate(480deg) translateX(55px) rotate(-480deg)' }
              },
              orbitFast: {
                '0%': { transform: 'rotate(240deg) translateX(65px) rotate(-240deg)' },
                '100%': { transform: 'rotate(600deg) translateX(65px) rotate(-600deg)' }
              }
            }
          }
        }
      }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles -->
    <style>
      * {
        box-sizing: border-box;
      }
      
      body { 
        background-color: #0f172a; 
        color: #e2e8f0; 
        overscroll-behavior-y: none;
        height: 100vh;
        overflow: hidden;
      }
      
      #root {
        height: 100vh;
        overflow: hidden;
      }
      
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
      
      /* Frame styles */
      .frame-basic { border: 2px solid #6b7280; box-shadow: 0 0 5px rgba(107, 114, 128, 0.5); }
      .frame-silver { border: 3px solid #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.7); }
      .frame-gold { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
      .frame-diamond { border: 3px solid #b9f2ff; box-shadow: 0 0 20px rgba(185, 242, 255, 0.9); }
      .frame-rainbow { 
        border: 3px solid transparent;
        background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff) border-box;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
      }
      .frame-platinum { border: 3px solid #e5e4e2; box-shadow: 0 0 20px rgba(229, 228, 226, 0.8); }
      .frame-obsidian { border: 3px solid #0b0b0b; box-shadow: 0 0 25px rgba(11, 11, 11, 0.9); }
      .frame-emerald { border: 3px solid #50c878; box-shadow: 0 0 20px rgba(80, 200, 120, 0.8); }
      .frame-ruby { border: 3px solid #e0115f; box-shadow: 0 0 20px rgba(224, 17, 95, 0.8); }
      .frame-sapphire { border: 3px solid #0f52ba; box-shadow: 0 0 20px rgba(15, 82, 186, 0.8); }
      .frame-legendary { 
        border: 3px solid transparent;
        background: linear-gradient(45deg, #ff6b6b, #ffa500, #ffff00, #00ff00, #00ffff, #0000ff, #8a2be2) border-box;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.7);
        animation: legendary-glow 3s infinite alternate;
      }
      
      @keyframes legendary-glow {
        0% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.7); }
        25% { box-shadow: 0 0 25px rgba(255, 165, 0, 0.7); }
        50% { box-shadow: 0 0 30px rgba(255, 255, 0, 0.7); }
        75% { box-shadow: 0 0 25px rgba(0, 255, 0, 0.7); }
        100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.7); }
      }
      
      /* Mobile optimizations */
      @media (max-width: 640px) {
        .safe-area-bottom { 
          padding-bottom: max(1rem, env(safe-area-inset-bottom)); 
        }
        .safe-area-top { 
          padding-top: max(0.5rem, env(safe-area-inset-top)); 
        }
        /* Hide scrollbar on mobile for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Better touch targets */
        button, [role="button"] {
          min-height: 44px;
          min-width: 44px;
        }
        
        /* Compact header for mobile */
        .compact-header {
          padding: 0.5rem;
          height: 50px;
        }
        
        .compact-header-buttons {
          gap: 0.25rem;
        }
        
        .compact-header-buttons button {
          padding: 0.4rem;
        }
      }

      .coin-animation {
        animation: coinPop 0.5s ease-out;
      }

      @keyframes coinPop {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
      }

      .avatar-locked {
        filter: grayscale(1) brightness(0.5);
        position: relative;
      }

      .avatar-locked::after {
        content: "üîí";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 20px;
        z-index: 10;
      }

      /* NFT styles */
      .nft-container {
        position: relative;
        display: inline-block;
      }

      .nft-orbital {
        position: absolute;
        width: 140px;
        height: 140px;
        top: 50%;
        left: 50%;
        margin-top: -70px;
        margin-left: -70px;
        z-index: 5;
      }

      .nft-item {
        position: absolute;
        font-size: 20px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: float 3s ease-in-out infinite;
      }

      .nft-orbit-slow {
        animation: orbitSlow 15s linear infinite;
      }

      .nft-orbit-medium {
        animation: orbitMedium 12s linear infinite;
      }

      .nft-orbit-fast {
        animation: orbitFast 8s linear infinite;
      }

      /* Casino animations */
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes win {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }

      .slot-machine {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 2px solid #475569;
        border-radius: 12px;
        padding: 8px;
        position: relative;
        overflow: hidden;
      }

      .slot-reel {
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background: #0f172a;
        border-radius: 6px;
        margin: 4px;
        border: 1px solid #334155;
      }

      .spinning {
        animation: spin 0.1s linear infinite;
      }

      .win-animation {
        animation: win 0.5s ease-in-out 3;
      }

      /* NFT Gift Animation */
      .nft-gift-message {
        animation: giftFloat 2s ease-in-out;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 12px;
        margin: 8px 0;
        text-align: center;
        border: 2px solid gold;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      }

      /* Responsive text sizes */
      @media (max-width: 380px) {
        .text-responsive-sm {
          font-size: 0.875rem;
        }
        .text-responsive-xs {
          font-size: 0.75rem;
        }
      }

      /* Settings grid for mobile */
      .settings-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
      }

      @media (max-width: 480px) {
        .settings-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      /* NFT rarity colors */
      .nft-common { border: 2px solid #6b7280; background: linear-gradient(135deg, #6b728020, #9ca3af20); }
      .nft-rare { border: 2px solid #3b82f6; background: linear-gradient(135deg, #1e40af20, #3b82f620); }
      .nft-epic { border: 2px solid #8b5cf6; background: linear-gradient(135deg, #7c3aed20, #8b5cf620); }
      .nft-legendary { border: 2px solid #f59e0b; background: linear-gradient(135deg, #d9770620, #f59e0b20); }
      .nft-mythic { border: 2px solid #ef4444; background: linear-gradient(135deg, #dc262620, #ef444420); }
      .nft-divine { border: 2px solid #10b981; background: linear-gradient(135deg, #04785720, #10b98120); }

      /* NFT wear levels */
      .nft-wear-mint { border-style: solid; }
      .nft-wear-excellent { border-style: dashed; }
      .nft-wear-good { border-style: dotted; }
      .nft-wear-fair { border-style: double; }
      .nft-wear-worn { border-style: groove; }

      /* Leaderboard styles */
      .leaderboard-item {
        transition: all 0.3s ease;
      }

      .leaderboard-item:hover {
        transform: translateX(5px);
        background: linear-gradient(90deg, #1e293b, #334155);
      }

      .rank-1 { background: linear-gradient(90deg, #fef3c7, #f59e0b); color: #78350f; }
      .rank-2 { background: linear-gradient(90deg, #e5e7eb, #9ca3af); color: #374151; }
      .rank-3 { background: linear-gradient(90deg, #fcd34d, #d97706); color: #451a03; }

      /* Price change indicators */
      .price-up { color: #10b981; }
      .price-down { color: #ef4444; }
      .price-stable { color: #6b7280; }

      /* Pattern backgrounds for NFTs */
      .pattern-stars { background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 10px 10px; }
      .pattern-dots { background-image: radial-gradient(#ffffff 2px, transparent 2px); background-size: 8px 8px; }
      .pattern-lines { background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #ffffff 5px, #ffffff 10px); }
      .pattern-grid { background-image: linear-gradient(#ffffff 1px, transparent 1px), linear-gradient(90deg, #ffffff 1px, transparent 1px); background-size: 10px 10px; }
      .pattern-hexagon { background-image: radial-gradient(circle at center, #ffffff 1px, transparent 1px); background-size: 15px 15px; }
      .pattern-circles { background-image: radial-gradient(circle, #ffffff 1px, transparent 1px); background-size: 12px 12px; }
      .pattern-diamonds { background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, #ffffff 5px, #ffffff 7px); }
      .pattern-waves { background-image: repeating-linear-gradient(0deg, transparent, transparent 5px, #ffffff 5px, #ffffff 8px); }
    </style>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Video, Settings as SettingsIcon, Menu, Trash2, Smile, MoreVertical, Lock, LogOut, User as UserIcon, Loader2, Coins, Zap, Crown, Palette, Edit3, Dice5, Trophy, Gift, Bot, TrendingUp, Send as SendIcon, Info, Clock, Star, Sparkles, ShoppingCart, Users, ArrowLeftRight, Award, TrendingUp as TrendingUpIcon, BarChart3 } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        // --- Services ---
        const firebaseConfig = {
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87",
            measurementId: "G-SCD5JVFM5E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Components ---

        // 1. Button Component
        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-sm min-h-[44px]";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                ghost: "bg-transparent hover:bg-white/5 text-slate-300",
                gold: "bg-yellow-500 hover:bg-yellow-400 text-white shadow-lg shadow-yellow-500/20"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? (
                        <Loader2 className="animate-spin h-4 w-4" />
                    ) : (<>{icon && <span className="text-base">{icon}</span>}{children}</>)}
                </button>
            );
        };

        // 2. NFT Market Modal with Enhanced Features
        const NFTMarketModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate, userNFTs, onNFTUpdate }) => {
            const [selectedNFT, setSelectedNFT] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('market');
            const [giftRecipient, setGiftRecipient] = useState('');
            const [giftNFT, setGiftNFT] = useState(null);
            const [nftPrices, setNftPrices] = useState({});
            const [marketNFTs, setMarketNFTs] = useState([]);
            const [sellPrice, setSellPrice] = useState('');
            const [selectedSellNFT, setSelectedSellNFT] = useState(null);

            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ NFT —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–µ–¥–∫–æ—Å—Ç—è–º–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
            const nfts = [
                // Common NFTs
                { id: 'ghost', name: '–ü—Ä–∏–∑—Ä–∞–∫', emoji: 'üëª', basePrice: 600, description: '–¢–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∏–∑—Ä–∞–∫', rarity: 'common', element: 'shadow', power: 10, pattern: 'pattern-dots' },
                { id: 'robot', name: '–†–æ–±–æ—Ç', emoji: 'ü§ñ', basePrice: 800, description: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π —Ä–æ–±–æ—Ç', rarity: 'common', element: 'tech', power: 15, pattern: 'pattern-grid' },
                { id: 'panda', name: '–ü–∞–Ω–¥–∞', emoji: 'üêº', basePrice: 900, description: '–ú–∏–ª–∞—è –ø–∞–Ω–¥–∞', rarity: 'common', element: 'nature', power: 12, pattern: 'pattern-circles' },
                { id: 'fox', name: '–õ–∏—Å–∞', emoji: 'ü¶ä', basePrice: 1100, description: '–•–∏—Ç—Ä–∞—è –ª–∏—Å–∞', rarity: 'common', element: 'nature', power: 18, pattern: 'pattern-dots' },
                { id: 'cat', name: '–ö–æ—Ç', emoji: 'üê±', basePrice: 700, description: '–õ–æ–≤–∫–∏–π –∫–æ—Ç', rarity: 'common', element: 'nature', power: 14, pattern: 'pattern-lines' },
                { id: 'dog', name: '–°–æ–±–∞–∫–∞', emoji: 'üê∂', basePrice: 750, description: '–í–µ—Ä–Ω—ã–π –ø–µ—Å', rarity: 'common', element: 'nature', power: 16, pattern: 'pattern-waves' },
                { id: 'rabbit', name: '–ö—Ä–æ–ª–∏–∫', emoji: 'üê∞', basePrice: 850, description: '–ë—ã—Å—Ç—Ä—ã–π –∫—Ä–æ–ª–∏–∫', rarity: 'common', element: 'nature', power: 13, pattern: 'pattern-stars' },
                { id: 'bear', name: '–ú–µ–¥–≤–µ–¥—å', emoji: 'üêª', basePrice: 950, description: '–°–∏–ª—å–Ω—ã–π –º–µ–¥–≤–µ–¥—å', rarity: 'common', element: 'nature', power: 20, pattern: 'pattern-hexagon' },
                
                // Rare NFTs
                { id: 'alien', name: '–ü—Ä–∏—à–µ–ª–µ—Ü', emoji: 'üëΩ', basePrice: 1200, description: '–ò–Ω–æ–ø–ª–∞–Ω–µ—Ç–Ω—ã–π –≥–æ—Å—Ç—å', rarity: 'rare', element: 'cosmic', power: 25, pattern: 'pattern-stars' },
                { id: 'tiger', name: '–¢–∏–≥—Ä', emoji: 'üêØ', basePrice: 1300, description: '–°–∏–ª—å–Ω—ã–π —Ç–∏–≥—Ä', rarity: 'rare', element: 'nature', power: 30, pattern: 'pattern-lines' },
                { id: 'lion', name: '–õ–µ–≤', emoji: 'ü¶Å', basePrice: 1400, description: '–¶–∞—Ä—å –∑–≤–µ—Ä–µ–π', rarity: 'rare', element: 'nature', power: 35, pattern: 'pattern-grid' },
                { id: 'eagle', name: '–û—Ä—ë–ª', emoji: 'ü¶Ö', basePrice: 1600, description: '–ì–æ—Ä–¥—ã–π –æ—Ä—ë–ª', rarity: 'rare', element: 'air', power: 28, pattern: 'pattern-hexagon' },
                { id: 'shark', name: '–ê–∫—É–ª–∞', emoji: 'ü¶à', basePrice: 1500, description: '–ú–æ—Ä—Å–∫–æ–π —Ö–∏—â–Ω–∏–∫', rarity: 'rare', element: 'water', power: 32, pattern: 'pattern-waves' },
                { id: 'wolf', name: '–í–æ–ª–∫', emoji: 'üê∫', basePrice: 1350, description: '–î–∏–∫–∏–π –≤–æ–ª–∫', rarity: 'rare', element: 'nature', power: 29, pattern: 'pattern-diamonds' },
                { id: 'elephant', name: '–°–ª–æ–Ω', emoji: 'üêò', basePrice: 1700, description: '–ú–æ–≥—É—á–∏–π —Å–ª–æ–Ω', rarity: 'rare', element: 'earth', power: 38, pattern: 'pattern-circles' },
                { id: 'octopus', name: '–û—Å—å–º–∏–Ω–æ–≥', emoji: 'üêô', basePrice: 1450, description: '–£–º–Ω—ã–π –æ—Å—å–º–∏–Ω–æ–≥', rarity: 'rare', element: 'water', power: 27, pattern: 'pattern-dots' },
                
                // Epic NFTs
                { id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω', emoji: 'üêâ', basePrice: 1800, description: '–ú–æ–≥—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥—Ä–∞–∫–æ–Ω', rarity: 'epic', element: 'fire', power: 50, pattern: 'pattern-diamonds' },
                { id: 'dinosaur', name: '–î–∏–Ω–æ–∑–∞–≤—Ä', emoji: 'ü¶ñ', basePrice: 2000, description: '–î—Ä–µ–≤–Ω–∏–π —è—â–µ—Ä', rarity: 'epic', element: 'earth', power: 45, pattern: 'pattern-waves' },
                { id: 'phoenix', name: '–§–µ–Ω–∏–∫—Å', emoji: 'ü¶ö', basePrice: 2200, description: '–û–≥–Ω–µ–Ω–Ω–∞—è –ø—Ç–∏—Ü–∞', rarity: 'epic', element: 'fire', power: 55, pattern: 'pattern-stars' },
                { id: 'whale', name: '–ö–∏—Ç', emoji: 'üêã', basePrice: 2400, description: '–ú–æ–≥—É—á–∏–π –∫–∏—Ç', rarity: 'epic', element: 'water', power: 48, pattern: 'pattern-circles' },
                { id: 'griffin', name: '–ì—Ä–∏—Ñ–æ–Ω', emoji: 'ü¶Öü¶Å', basePrice: 2600, description: '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –≥—Ä–∏—Ñ–æ–Ω', rarity: 'epic', element: 'air', power: 58, pattern: 'pattern-grid' },
                { id: 'kraken', name: '–ö—Ä–∞–∫–µ–Ω', emoji: 'üêôüåä', basePrice: 2800, description: '–ú–æ—Ä—Å–∫–æ–µ —á—É–¥–æ–≤–∏—â–µ', rarity: 'epic', element: 'water', power: 52, pattern: 'pattern-waves' },
                { id: 'minotaur', name: '–ú–∏–Ω–æ—Ç–∞–≤—Ä', emoji: 'üêÇüë§', basePrice: 2500, description: '–õ–∞–±–∏—Ä–∏–Ω—Ç–Ω—ã–π —Å—Ç—Ä–∞–∂', rarity: 'epic', element: 'earth', power: 47, pattern: 'pattern-lines' },
                { id: 'pegasus', name: '–ü–µ–≥–∞—Å', emoji: 'ü¶Ñü™Ω', basePrice: 2700, description: '–ö—Ä—ã–ª–∞—Ç—ã–π –∫–æ–Ω—å', rarity: 'epic', element: 'air', power: 53, pattern: 'pattern-stars' },
                
                // Legendary NFTs
                { id: 'unicorn', name: '–ï–¥–∏–Ω–æ—Ä–æ–≥', emoji: 'ü¶Ñ', basePrice: 3000, description: '–í–æ–ª—à–µ–±–Ω—ã–π –µ–¥–∏–Ω–æ—Ä–æ–≥', rarity: 'legendary', element: 'magic', power: 80, pattern: 'pattern-diamonds' },
                { id: 'spaceship', name: '–ö–æ—Ä–∞–±–ª—å', emoji: 'üöÄ', basePrice: 3500, description: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å', rarity: 'legendary', element: 'cosmic', power: 75, pattern: 'pattern-stars' },
                { id: 'comet', name: '–ö–æ–º–µ—Ç–∞', emoji: '‚òÑÔ∏è', basePrice: 4000, description: '–ù–µ–±–µ—Å–Ω–∞—è –∫–æ–º–µ—Ç–∞', rarity: 'legendary', element: 'cosmic', power: 85, pattern: 'pattern-lines' },
                { id: 'treasure', name: '–°–æ–∫—Ä–æ–≤–∏—â–µ', emoji: 'üíé', basePrice: 5000, description: '–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π –∫–ª–∞–¥', rarity: 'legendary', element: 'gold', power: 90, pattern: 'pattern-grid' },
                { id: 'leviathan', name: '–õ–µ–≤–∏–∞—Ñ–∞–Ω', emoji: 'üêâüåä', basePrice: 4500, description: '–ú–æ—Ä—Å–∫–æ–π –∑–º–µ–π', rarity: 'legendary', element: 'water', power: 88, pattern: 'pattern-waves' },
                { id: 'behemoth', name: '–ë–µ–≥–µ–º–æ—Ç', emoji: 'üêòüî•', basePrice: 4200, description: '–ó–µ–º–Ω–æ–π –≥–∏–≥–∞–Ω—Ç', rarity: 'legendary', element: 'earth', power: 82, pattern: 'pattern-circles' },
                { id: 'ziz', name: '–ó–∏–∑', emoji: 'ü¶Ö‚òÅÔ∏è', basePrice: 3800, description: '–ù–µ–±–µ—Å–Ω–∞—è –ø—Ç–∏—Ü–∞', rarity: 'legendary', element: 'air', power: 78, pattern: 'pattern-stars' },
                { id: 'sphinx', name: '–°—Ñ–∏–Ω–∫—Å', emoji: 'ü¶Åüß†', basePrice: 4700, description: '–ó–∞–≥–∞–¥–æ—á–Ω—ã–π —Å—Ñ–∏–Ω–∫—Å', rarity: 'legendary', element: 'earth', power: 86, pattern: 'pattern-diamonds' },
                
                // Mythic NFTs
                { id: 'rainbow_dragon', name: '–†–∞–¥—É–∂–Ω—ã–π –î—Ä–∞–∫–æ–Ω', emoji: 'üåàüêâ', basePrice: 8000, description: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π —Ä–∞–¥—É–∂–Ω—ã–π –¥—Ä–∞–∫–æ–Ω', rarity: 'mythic', element: 'rainbow', power: 150, pattern: 'pattern-diamonds' },
                { id: 'cosmic_phoenix', name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –§–µ–Ω–∏–∫—Å', emoji: 'üååü¶ö', basePrice: 10000, description: '–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ñ–µ–Ω–∏–∫—Å', rarity: 'mythic', element: 'cosmic', power: 180, pattern: 'pattern-stars' },
                { id: 'time_wizard', name: '–ú–∞–≥ –í—Ä–µ–º–µ–Ω–∏', emoji: '‚è≥üßô', basePrice: 12000, description: '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞', rarity: 'mythic', element: 'time', power: 200, pattern: 'pattern-waves' },
                { id: 'infinity_guardian', name: '–°—Ç—Ä–∞–∂ –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏', emoji: '‚àûüõ°Ô∏è', basePrice: 15000, description: '–ó–∞—â–∏—Ç–Ω–∏–∫ –≤—Å–µ–ª–µ–Ω–Ω–æ–π', rarity: 'mythic', element: 'infinity', power: 250, pattern: 'pattern-hexagon' },
                { id: 'void_walker', name: '–•–æ–¥–æ–∫ –ë–µ–∑–¥–Ω—ã', emoji: 'üåëüë§', basePrice: 11000, description: '–ü—É—Ç–Ω–∏–∫ –º–µ–∂–¥—É –º–∏—Ä–∞–º–∏', rarity: 'mythic', element: 'void', power: 190, pattern: 'pattern-grid' },
                { id: 'dream_weaver', name: '–¢–∫–∞—á –°–Ω–æ–≤', emoji: 'üí≠üï∏Ô∏è', basePrice: 13000, description: '–°–æ–∑–¥–∞—Ç–µ–ª—å –º–∏—Ä–æ–≤ —Å–Ω–æ–≤', rarity: 'mythic', element: 'dream', power: 210, pattern: 'pattern-stars' },
                { id: 'star_forger', name: '–ö—É–∑–Ω–µ—Ü –ó–≤–µ–∑–¥', emoji: '‚≠êüî®', basePrice: 14000, description: '–°–æ–∑–¥–∞—Ç–µ–ª—å –Ω–æ–≤—ã—Ö –∑–≤–µ–∑–¥', rarity: 'mythic', element: 'cosmic', power: 230, pattern: 'pattern-diamonds' },
                { id: 'ocean_king', name: '–¶–∞—Ä—å –û–∫–µ–∞–Ω–∞', emoji: 'üåäüëë', basePrice: 9000, description: '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å –≤—Å–µ—Ö –º–æ—Ä–µ–π', rarity: 'mythic', element: 'water', power: 170, pattern: 'pattern-waves' },

                // Divine NFTs
                { id: 'eternal_dragon', name: '–í–µ—á–Ω—ã–π –î—Ä–∞–∫–æ–Ω', emoji: '‚ôæÔ∏èüê≤', basePrice: 20000, description: '–î—Ä–∞–∫–æ–Ω –≤–µ—á–Ω–æ—Å—Ç–∏', rarity: 'divine', element: 'infinity', power: 300, pattern: 'pattern-stars' },
                { id: 'celestial_phoenix', name: '–ù–µ–±–µ—Å–Ω—ã–π –§–µ–Ω–∏–∫—Å', emoji: 'üå†ü¶Ö', basePrice: 25000, description: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ø—Ç–∏—Ü–∞', rarity: 'divine', element: 'celestial', power: 350, pattern: 'pattern-diamonds' },
                { id: 'void_walker_divine', name: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –•–æ–¥–æ–∫', emoji: 'üååüë§', basePrice: 30000, description: '–ë–æ–≥ –ø—É—Å—Ç–æ—Ç—ã', rarity: 'divine', element: 'void', power: 400, pattern: 'pattern-grid' },
                { id: 'creation_god', name: '–ë–æ–≥ –¢–≤–æ—Ä–µ–Ω–∏—è', emoji: '‚ú®üëë', basePrice: 50000, description: '–°–æ–∑–¥–∞—Ç–µ–ª—å –≤—Å–µ–ª–µ–Ω–Ω–æ–π', rarity: 'divine', element: 'creation', power: 500, pattern: 'pattern-lines' },
                { id: 'destiny_weaver', name: '–¢–∫–∞—á –°—É–¥—å–±—ã', emoji: 'üßµ‚öñÔ∏è', basePrice: 35000, description: '–ü—Ä—è–¥—ë—Ç –Ω–∏—Ç–∏ —Å—É–¥—å–±—ã', rarity: 'divine', element: 'fate', power: 380, pattern: 'pattern-waves' },
                { id: 'primordial_titan', name: '–ü–µ—Ä–≤–æ–∑–¥–∞–Ω–Ω—ã–π –¢–∏—Ç–∞–Ω', emoji: 'üóøüåã', basePrice: 40000, description: '–°—É—â–µ—Å—Ç–≤–æ –∏–∑ –Ω–∞—á–∞–ª–∞ –≤—Ä–µ–º–µ–Ω', rarity: 'divine', element: 'primordial', power: 450, pattern: 'pattern-circles' },
                { id: 'cosmic_balance', name: '–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –ë–∞–ª–∞–Ω—Å', emoji: '‚öñÔ∏èüåå', basePrice: 45000, description: '–•—Ä–∞–Ω–∏—Ç–µ–ª—å —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è', rarity: 'divine', element: 'balance', power: 480, pattern: 'pattern-stars' },
                { id: 'infinity_heart', name: '–°–µ—Ä–¥—Ü–µ –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏', emoji: 'üíñ‚àû', basePrice: 55000, description: '–ò—Å—Ç–æ—á–Ω–∏–∫ –≤—Å–µ–π –∂–∏–∑–Ω–∏', rarity: 'divine', element: 'life', power: 520, pattern: 'pattern-diamonds' }
            ];

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–∏—Ö —Ü–µ–Ω NFT –∏ —Ä—ã–Ω–æ—á–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
            useEffect(() => {
                const nftPricesRef = ref(db, 'nftPrices');
                onValue(nftPricesRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        setNftPrices(data);
                    }
                });

                const marketRef = ref(db, 'nftMarket');
                onValue(marketRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const marketItems = Object.entries(data).map(([id, item]) => ({
                            id,
                            ...item
                        }));
                        setMarketNFTs(marketItems);
                    }
                });
            }, []);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω NFT (–∏–º–∏—Ç–∞—Ü–∏—è –±–∏—Ä–∂–∏)
            useEffect(() => {
                const interval = setInterval(() => {
                    const newPrices = { ...nftPrices };
                    nfts.forEach(nft => {
                        const currentPrice = newPrices[nft.id] || nft.basePrice;
                        // –°–ª—É—á–∞–π–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –æ—Ç -10% –¥–æ +15%
                        const change = (Math.random() * 0.25 - 0.1);
                        const newPrice = Math.max(nft.basePrice * 0.5, currentPrice * (1 + change));
                        newPrices[nft.id] = Math.round(newPrice);
                    });
                    setNftPrices(newPrices);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É
                    update(ref(db, 'nftPrices'), newPrices);
                }, 10000); // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

                return () => clearInterval(interval);
            }, [nftPrices]);

            if (!isOpen) return null;

            const getCurrentPrice = (nft) => {
                return nftPrices[nft.id] || nft.basePrice;
            };

            const getPriceChange = (nft) => {
                const currentPrice = getCurrentPrice(nft);
                const basePrice = nft.basePrice;
                const change = ((currentPrice - basePrice) / basePrice) * 100;
                return change;
            };

            const getWearLevel = (purchasedAt) => {
                const age = Date.now() - purchasedAt;
                const days = age / (1000 * 60 * 60 * 24);
                
                if (days < 7) return { level: 'mint', name: '–ò–¥–µ–∞–ª—å–Ω–æ–µ', class: 'nft-wear-mint' };
                if (days < 30) return { level: 'excellent', name: '–û—Ç–ª–∏—á–Ω–æ–µ', class: 'nft-wear-excellent' };
                if (days < 90) return { level: 'good', name: '–•–æ—Ä–æ—à–µ–µ', class: 'nft-wear-good' };
                if (days < 180) return { level: 'fair', name: '–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ', class: 'nft-wear-fair' };
                return { level: 'worn', name: '–ò–∑–Ω–æ—à–µ–Ω–Ω–æ–µ', class: 'nft-wear-worn' };
            };

            const getRarityClass = (rarity) => {
                switch(rarity) {
                    case 'common': return 'nft-common';
                    case 'rare': return 'nft-rare';
                    case 'epic': return 'nft-epic';
                    case 'legendary': return 'nft-legendary';
                    case 'mythic': return 'nft-mythic';
                    case 'divine': return 'nft-divine';
                    default: return 'nft-common';
                }
            };

            const getRarityColor = (rarity) => {
                switch(rarity) {
                    case 'common': return 'text-gray-400';
                    case 'rare': return 'text-blue-400';
                    case 'epic': return 'text-purple-400';
                    case 'legendary': return 'text-yellow-400';
                    case 'mythic': return 'text-red-400';
                    case 'divine': return 'text-green-400';
                    default: return 'text-gray-400';
                }
            };

            const handleBuyNFT = async (nft) => {
                const currentPrice = getCurrentPrice(nft);
                if (userCoins < currentPrice) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${currentPrice} –∫–æ–∏–Ω–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —ç—Ç–æ–≥–æ NFT.`);
                    return;
                }

                setIsLoading(true);
                try {
                    const newNFTs = [...(userNFTs || []), { 
                        id: nft.id, 
                        purchasedAt: Date.now(),
                        purchasedPrice: currentPrice,
                        hidden: false,
                        wear: 'mint'
                    }];
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - currentPrice,
                        nfts: newNFTs
                    });
                    onCoinsUpdate(userCoins - currentPrice);
                    onNFTUpdate(newNFTs);
                    setSelectedNFT(nft.id);
                    alert(`–í—ã —É—Å–ø–µ—à–Ω–æ –∫—É–ø–∏–ª–∏ NFT "${nft.name}"!`);
                } catch (error) {
                    console.error('NFT purchase error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT');
                }
                setIsLoading(false);
            };

            const handleBuyFromMarket = async (marketItem) => {
                if (userCoins < marketItem.price) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${marketItem.price} –∫–æ–∏–Ω–æ–≤.`);
                    return;
                }

                setIsLoading(true);
                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º NFT –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
                    const newNFTs = [...(userNFTs || []), { 
                        id: marketItem.nftId,
                        purchasedAt: Date.now(),
                        purchasedPrice: marketItem.price,
                        hidden: false,
                        wear: marketItem.wear || 'mint'
                    }];
                    
                    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–∏–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É
                    const sellerRef = ref(db, `users/${marketItem.seller}`);
                    const sellerSnapshot = await get(sellerRef);
                    const sellerData = sellerSnapshot.val();
                    await update(sellerRef, { 
                        coins: (sellerData.coins || 0) + marketItem.price
                    });

                    // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - marketItem.price,
                        nfts: newNFTs
                    });

                    // –£–¥–∞–ª—è–µ–º —Å —Ä—ã–Ω–∫–∞
                    await remove(ref(db, `nftMarket/${marketItem.id}`));

                    onCoinsUpdate(userCoins - marketItem.price);
                    onNFTUpdate(newNFTs);
                    alert(`–í—ã —É—Å–ø–µ—à–Ω–æ –∫—É–ø–∏–ª–∏ NFT "${marketItem.nftData.name}" –∑–∞ ${marketItem.price} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('Market purchase error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT —Å —Ä—ã–Ω–∫–∞');
                }
                setIsLoading(false);
            };

            const handleRemoveNFT = async (nftId) => {
                if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–±—Ä–∞—Ç—å —ç—Ç–æ—Ç NFT –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è? –û–Ω –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–æ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.')) {
                    return;
                }

                setIsLoading(true);
                try {
                    const nftIndex = userNFTs.findIndex(nft => nft.id === nftId);
                    if (nftIndex === -1) {
                        alert('NFT –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
                        return;
                    }

                    const newNFTs = [...userNFTs];
                    newNFTs[nftIndex] = {
                        ...newNFTs[nftIndex],
                        hidden: true
                    };

                    await update(ref(db, `users/${currentUser}`), { 
                        nfts: newNFTs
                    });
                    onNFTUpdate(newNFTs);
                    alert(`NFT —É–±—Ä–∞–Ω –∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è!`);
                } catch (error) {
                    console.error('NFT remove error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ NFT');
                }
                setIsLoading(false);
            };

            const handleRestoreNFT = async (nftId) => {
                setIsLoading(true);
                try {
                    const nftIndex = userNFTs.findIndex(nft => nft.id === nftId);
                    if (nftIndex === -1) {
                        alert('NFT –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
                        return;
                    }

                    const newNFTs = [...userNFTs];
                    newNFTs[nftIndex] = {
                        ...newNFTs[nftIndex],
                        hidden: false
                    };

                    await update(ref(db, `users/${currentUser}`), { 
                        nfts: newNFTs
                    });
                    onNFTUpdate(newNFTs);
                    alert(`NFT –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ!`);
                } catch (error) {
                    console.error('NFT restore error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ NFT');
                }
                setIsLoading(false);
            };

            const handleSellNFT = async (nft, price) => {
                if (price <= 0) {
                    alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
                    return;
                }

                if (price > 1000000) {
                    alert('–¶–µ–Ω–∞ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞! –ú–∞–∫—Å–∏–º—É–º 1,000,000 –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    const nftData = userNFTs.find(item => item.id === nft.id);
                    const wear = nftData ? getWearLevel(nftData.purchasedAt).level : 'mint';
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º NFT –Ω–∞ —Ä—ã–Ω–æ–∫
                    const marketRef = push(ref(db, 'nftMarket'));
                    await set(marketRef, {
                        nftId: nft.id,
                        seller: currentUser,
                        price: parseInt(price),
                        listedAt: Date.now(),
                        nftData: nfts.find(item => item.id === nft.id),
                        wear: wear
                    });

                    // –£–¥–∞–ª—è–µ–º NFT —É –ø—Ä–æ–¥–∞–≤—Ü–∞
                    const newNFTs = userNFTs.filter(item => item.id !== nft.id);
                    await update(ref(db, `users/${currentUser}`), { 
                        nfts: newNFTs
                    });

                    onNFTUpdate(newNFTs);
                    setSelectedSellNFT(null);
                    setSellPrice('');
                    alert(`NFT "${nft.name}" –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –∑–∞ ${price} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('NFT sell error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ NFT –Ω–∞ –ø—Ä–æ–¥–∞–∂—É');
                }
                setIsLoading(false);
            };

            const handleGiftNFT = async () => {
                if (!giftRecipient.trim() || !giftNFT) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ NFT –∏ —É–∫–∞–∂–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è');
                    return;
                }

                if (giftRecipient === currentUser) {
                    alert('–ù–µ–ª—å–∑—è –ø–æ–¥–∞—Ä–∏—Ç—å NFT —Å–∞–º–æ–º—É —Å–µ–±–µ');
                    return;
                }

                setIsLoading(true);
                try {
                    const recipientRef = ref(db, `users/${giftRecipient}`);
                    const snapshot = await get(recipientRef);
                    
                    if (!snapshot.exists()) {
                        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        setIsLoading(false);
                        return;
                    }

                    const recipientData = snapshot.val();
                    const recipientNFTs = recipientData.nfts || [];

                    // –£–¥–∞–ª—è–µ–º NFT —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    const newSenderNFTs = userNFTs.filter(nft => nft.id !== giftNFT.id);
                    await update(ref(db, `users/${currentUser}`), { 
                        nfts: newSenderNFTs
                    });

                    // –î–æ–±–∞–≤–ª—è–µ–º NFT –ø–æ–ª—É—á–∞—Ç–µ–ª—é
                    const newRecipientNFTs = [...recipientNFTs, { 
                        id: giftNFT.id, 
                        gifted: true, 
                        from: currentUser, 
                        giftedAt: Date.now(),
                        hidden: false,
                        wear: 'mint'
                    }];
                    await update(recipientRef, { 
                        nfts: newRecipientNFTs
                    });

                    // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–∞—Ä–∫–µ
                    const chatId = [currentUser, giftRecipient].sort().join('_');
                    const messageRef = push(ref(db, `messages/${chatId}`));
                    await set(messageRef, {
                        sender: currentUser,
                        text: `–ü–æ–¥–∞—Ä–∏–ª –≤–∞–º NFT: ${giftNFT.name} ${giftNFT.emoji}`,
                        timestamp: Date.now(),
                        type: 'nft_gift',
                        nftData: giftNFT,
                        deleted: false
                    });

                    onNFTUpdate(newSenderNFTs);
                    setGiftNFT(null);
                    setGiftRecipient('');
                    alert(`NFT "${giftNFT.name}" —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∞—Ä–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${giftRecipient}!`);
                } catch (error) {
                    console.error('NFT gift error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ NFT –≤ –ø–æ–¥–∞—Ä–æ–∫');
                }
                setIsLoading(false);
            };

            const getActiveNFTs = () => {
                return userNFTs.filter(nft => !nft.hidden).slice(0, 3); // –ú–∞–∫—Å–∏–º—É–º 3 –∞–∫—Ç–∏–≤–Ω—ã—Ö NFT
            };

            const renderMarketTab = () => (
                <div className="space-y-4">
                    <div className="text-center mb-4">
                        <p className="text-slate-400 text-sm">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ NFT —Å –∏–∑–º–µ–Ω—è—é—â–∏–º–∏—Å—è —Ü–µ–Ω–∞–º–∏</p>
                        <p className="text-xs text-slate-500 mt-1">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                    </div>
                    
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 max-h-[60vh] overflow-y-auto">
                        {nfts.map((nft) => {
                            const userNFT = userNFTs.find(userNft => userNft.id === nft.id);
                            const isPurchased = !!userNFT;
                            const currentPrice = getCurrentPrice(nft);
                            const priceChange = getPriceChange(nft);
                            const priceChangeClass = priceChange > 0 ? 'price-up' : priceChange < 0 ? 'price-down' : 'price-stable';
                            const priceChangeSymbol = priceChange > 0 ? '‚Üó' : priceChange < 0 ? '‚Üò' : '‚Üí';
                            
                            if (isPurchased) return null;
                            
                            return (
                                <div
                                    key={nft.id}
                                    className={`p-3 rounded-xl flex flex-col items-center gap-2 transition-all duration-200 min-h-[160px] ${getRarityClass(nft.rarity)} ${nft.pattern}`}
                                >
                                    <div className="text-3xl">{nft.emoji}</div>
                                    <div className="text-center">
                                        <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                        <p className="text-xs text-slate-400 mb-1">{nft.description}</p>
                                        <div className={`text-xs ${getRarityColor(nft.rarity)}`}>
                                            {nft.rarity.toUpperCase()} ‚Ä¢ {nft.element} ‚Ä¢ ‚ö°{nft.power}
                                        </div>
                                        <div className="flex items-center justify-center gap-1 mt-1">
                                            <p className="text-xs text-slate-300">
                                                {currentPrice} –∫–æ–∏–Ω–æ–≤
                                            </p>
                                            <span className={`text-xs ${priceChangeClass}`}>
                                                {priceChangeSymbol} {Math.abs(priceChange).toFixed(1)}%
                                            </span>
                                        </div>
                                    </div>
                                    <Button 
                                        onClick={() => handleBuyNFT(nft)}
                                        isLoading={isLoading}
                                        disabled={userCoins < currentPrice}
                                        variant="gold"
                                        className="w-full text-xs mt-1"
                                    >
                                        –ö—É–ø–∏—Ç—å
                                    </Button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            const renderMyNFTsTab = () => (
                <div className="space-y-4">
                    {userNFTs.length > 0 ? (
                        <>
                            <div className="bg-slate-800 rounded-xl p-4 mb-4">
                                <h3 className="text-white font-medium mb-2 text-sm">–ê–∫—Ç–∏–≤–Ω—ã–µ NFT –Ω–∞ –ø—Ä–æ—Ñ–∏–ª–µ (–º–∞–∫—Å. 3)</h3>
                                <div className="flex flex-wrap gap-2">
                                    {getActiveNFTs().map((userNft) => {
                                        const nft = nfts.find(n => n.id === userNft.id);
                                        if (!nft) return null;
                                        const wear = getWearLevel(userNft.purchasedAt);
                                        return (
                                            <div key={nft.id} className={`p-2 rounded-lg ${getRarityClass(nft.rarity)} ${wear.class}`}>
                                                <div className="text-2xl">{nft.emoji}</div>
                                                <div className="text-xs text-center mt-1">{wear.name}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto">
                                {userNFTs.map((userNft) => {
                                    const nft = nfts.find(n => n.id === userNft.id);
                                    if (!nft) return null;
                                    const wear = getWearLevel(userNft.purchasedAt);
                                    const currentPrice = getCurrentPrice(nft);
                                    const purchasePrice = userNft.purchasedPrice || nft.basePrice;
                                    const profit = currentPrice - purchasePrice;
                                    const profitClass = profit > 0 ? 'text-green-400' : profit < 0 ? 'text-red-400' : 'text-slate-400';
                                    
                                    return (
                                        <div
                                            key={nft.id}
                                            className={`p-3 rounded-xl flex flex-col items-center gap-2 ${getRarityClass(nft.rarity)} ${wear.class} ${
                                                userNft.hidden ? 'opacity-50 bg-slate-800' : ''
                                            }`}
                                        >
                                            <div className="text-3xl">{nft.emoji}</div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                                <div className={`text-xs ${getRarityColor(nft.rarity)}`}>
                                                    {nft.rarity.toUpperCase()} ‚Ä¢ ‚ö°{nft.power}
                                                </div>
                                                <div className="text-xs text-slate-400 mt-1">
                                                    –°–æ—Å—Ç–æ—è–Ω–∏–µ: {wear.name}
                                                </div>
                                                <div className="text-xs text-slate-300 mt-1">
                                                    –¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞: {currentPrice}
                                                </div>
                                                <div className={`text-xs ${profitClass}`}>
                                                    {profit >= 0 ? '+' : ''}{profit} –∫–æ–∏–Ω–æ–≤
                                                </div>
                                                {userNft.gifted && (
                                                    <p className="text-xs text-green-400 mt-1">
                                                        –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç {userNft.from}
                                                    </p>
                                                )}
                                                {userNft.hidden && (
                                                    <p className="text-xs text-yellow-400 mt-1">
                                                        –°–∫—Ä—ã—Ç
                                                    </p>
                                                )}
                                            </div>
                                            <div className="flex gap-1 w-full">
                                                {userNft.hidden ? (
                                                    <Button 
                                                        onClick={() => handleRestoreNFT(nft.id)}
                                                        isLoading={isLoading}
                                                        variant="primary"
                                                        className="flex-1 text-xs"
                                                    >
                                                        –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                                    </Button>
                                                ) : (
                                                    <>
                                                        <Button 
                                                            onClick={() => handleRemoveNFT(nft.id)}
                                                            isLoading={isLoading}
                                                            variant="danger"
                                                            className="flex-1 text-xs"
                                                        >
                                                            –£–±—Ä–∞—Ç—å
                                                        </Button>
                                                        <Button 
                                                            onClick={() => setSelectedSellNFT(nft)}
                                                            variant="gold"
                                                            className="flex-1 text-xs"
                                                        >
                                                            –ü—Ä–æ–¥–∞—Ç—å
                                                        </Button>
                                                        <Button 
                                                            onClick={() => setGiftNFT(nft)}
                                                            variant="primary"
                                                            className="flex-1 text-xs"
                                                        >
                                                            –ü–æ–¥–∞—Ä–∏—Ç—å
                                                        </Button>
                                                    </>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç NFT</p>
                            <p className="text-sm mt-1">–ö—É–ø–∏—Ç–µ —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ NFT –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ú–∞–≥–∞–∑–∏–Ω"</p>
                        </div>
                    )}
                </div>
            );

            const renderMarketplaceTab = () => (
                <div className="space-y-4">
                    <div className="text-center mb-4">
                        <p className="text-slate-400 text-sm">NFT –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É</p>
                    </div>

                    {marketNFTs.length > 0 ? (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto">
                            {marketNFTs.map((marketItem) => {
                                const nft = marketItem.nftData;
                                const wear = getWearLevel(marketItem.listedAt);
                                return (
                                    <div
                                        key={marketItem.id}
                                        className={`p-3 rounded-xl flex flex-col items-center gap-2 ${getRarityClass(nft.rarity)} ${wear.class}`}
                                    >
                                        <div className="text-3xl">{nft.emoji}</div>
                                        <div className="text-center">
                                            <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                            <p className="text-xs text-slate-400">–ü—Ä–æ–¥–∞–≤–µ—Ü: {marketItem.seller}</p>
                                            <div className={`text-xs ${getRarityColor(nft.rarity)}`}>
                                                {nft.rarity.toUpperCase()} ‚Ä¢ ‚ö°{nft.power}
                                            </div>
                                            <div className="text-xs text-slate-400 mt-1">
                                                –°–æ—Å—Ç–æ—è–Ω–∏–µ: {wear.name}
                                            </div>
                                            <p className="text-lg text-yellow-500 font-bold mt-1">
                                                {marketItem.price} –∫–æ–∏–Ω–æ–≤
                                            </p>
                                        </div>
                                        <Button 
                                            onClick={() => handleBuyFromMarket(marketItem)}
                                            isLoading={isLoading}
                                            disabled={userCoins < marketItem.price}
                                            variant="gold"
                                            className="w-full text-xs"
                                        >
                                            –ö—É–ø–∏—Ç—å –∑–∞ {marketItem.price}
                                        </Button>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç NFT</p>
                            <p className="text-sm mt-1">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –≤—ã—Å—Ç–∞–≤–∏—Ç NFT –Ω–∞ –ø—Ä–æ–¥–∞–∂—É!</p>
                        </div>
                    )}
                </div>
            );

            const renderGiftTab = () => (
                <div className="space-y-4">
                    <div className="text-center">
                        <p className="text-slate-400 text-sm">–ü–æ–¥–∞—Ä–∏—Ç–µ NFT –¥—Ä—É–≥–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</p>
                    </div>
                    
                    {giftNFT ? (
                        <div className="bg-slate-800 rounded-xl p-4">
                            <div className="text-center mb-4">
                                <div className="text-4xl mb-2">{giftNFT.emoji}</div>
                                <h3 className="font-bold text-white">{giftNFT.name}</h3>
                                <p className="text-slate-400 text-sm">{giftNFT.description}</p>
                            </div>
                            
                            <div className="space-y-3">
                                <input 
                                    type="text" 
                                    placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" 
                                    value={giftRecipient}
                                    onChange={e => setGiftRecipient(e.target.value)}
                                    className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                />
                                <Button 
                                    onClick={handleGiftNFT}
                                    isLoading={isLoading}
                                    disabled={!giftRecipient.trim()}
                                    variant="gold"
                                    className="w-full"
                                >
                                    –ü–æ–¥–∞—Ä–∏—Ç—å NFT
                                </Button>
                                <Button 
                                    onClick={() => setGiftNFT(null)}
                                    variant="secondary"
                                    className="w-full"
                                >
                                    –û—Ç–º–µ–Ω–∞
                                </Button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ NFT –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–ú–æ–∏ NFT"</p>
                        </div>
                    )}
                </div>
            );

            const renderSellModal = () => {
                if (!selectedSellNFT) return null;

                const nftData = nfts.find(n => n.id === selectedSellNFT.id);
                const userNFT = userNFTs.find(n => n.id === selectedSellNFT.id);
                const currentPrice = getCurrentPrice(nftData);
                const wear = userNFT ? getWearLevel(userNFT.purchasedAt) : { name: '–ò–¥–µ–∞–ª—å–Ω–æ–µ' };

                return (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in">
                        <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
                            <div className="p-3 border-b border-slate-800 flex items-center justify-between">
                                <h3 className="text-lg font-bold text-white">–ü—Ä–æ–¥–∞–∂–∞ NFT</h3>
                                <button onClick={() => setSelectedSellNFT(null)} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                            </div>
                            <div className="p-4">
                                <div className="text-center mb-4">
                                    <div className="text-4xl mb-2">{nftData.emoji}</div>
                                    <h4 className="font-bold text-white">{nftData.name}</h4>
                                    <p className="text-slate-400 text-sm">–°–æ—Å—Ç–æ—è–Ω–∏–µ: {wear.name}</p>
                                    <p className="text-slate-400 text-sm">–¢–µ–∫—É—â–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Ü–µ–Ω–∞: {currentPrice} –∫–æ–∏–Ω–æ–≤</p>
                                </div>
                                
                                <div className="space-y-3">
                                    <div>
                                        <label className="text-slate-400 text-sm mb-1 block">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</label>
                                        <input 
                                            type="number" 
                                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É" 
                                            value={sellPrice}
                                            onChange={e => setSellPrice(e.target.value)}
                                            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                        />
                                    </div>
                                    <div className="flex gap-2">
                                        <Button 
                                            onClick={() => handleSellNFT(nftData, sellPrice)}
                                            isLoading={isLoading}
                                            disabled={!sellPrice || sellPrice <= 0}
                                            variant="gold"
                                            className="flex-1"
                                        >
                                            –í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–¥–∞–∂—É
                                        </Button>
                                        <Button 
                                            onClick={() => setSelectedSellNFT(null)}
                                            variant="secondary"
                                            className="flex-1"
                                        >
                                            –û—Ç–º–µ–Ω–∞
                                        </Button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <>
                    {renderSellModal()}
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                        <div className="w-full max-w-6xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                            <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                                <h2 className="text-lg font-bold text-white flex items-center gap-2"><TrendingUp size={18} className="text-yellow-500" /> NFT –ú–∞–≥–∞–∑–∏–Ω –∏ –ë–∏—Ä–∂–∞</h2>
                                <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                            </div>
                            
                            {/* Tabs */}
                            <div className="flex border-b border-slate-800 bg-slate-900/50 overflow-x-auto">
                                {['market', 'my_nfts', 'marketplace', 'gift'].map(tab => (
                                    <button 
                                        key={tab} 
                                        onClick={() => setActiveTab(tab)} 
                                        className={`flex-1 py-3 text-xs font-medium transition-colors min-h-[44px] whitespace-nowrap px-2 ${
                                            activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'
                                        }`}
                                    >
                                        {tab === 'market' ? 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω' : 
                                         tab === 'my_nfts' ? 'üé¥ –ú–æ–∏ NFT' : 
                                         tab === 'marketplace' ? 'üè™ –ë–∏—Ä–∂–∞' :
                                         'üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å'}
                                    </button>
                                ))}
                            </div>
                            
                            <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                                {activeTab === 'market' && renderMarketTab()}
                                {activeTab === 'my_nfts' && renderMyNFTsTab()}
                                {activeTab === 'marketplace' && renderMarketplaceTab()}
                                {activeTab === 'gift' && renderGiftTab()}
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // 3. Leaderboard Modal
        const LeaderboardModal = ({ isOpen, onClose, usersData }) => {
            const [activeTab, setActiveTab] = useState('coins');
            const [allUsers, setAllUsers] = useState([]);

            useEffect(() => {
                if (usersData) {
                    const usersArray = Object.entries(usersData).map(([username, data]) => ({
                        username,
                        ...data
                    }));
                    setAllUsers(usersArray);
                }
            }, [usersData]);

            if (!isOpen) return null;

            const getTopUsers = (type, limit = 10) => {
                return allUsers
                    .filter(user => user.username && user[type] !== undefined)
                    .sort((a, b) => {
                        if (type === 'coins') return (b.coins || 0) - (a.coins || 0);
                        if (type === 'nfts') return ((b.nfts || []).length) - ((a.nfts || []).length);
                        return 0;
                    })
                    .slice(0, limit);
            };

            const getNFTValue = (user) => {
                const nfts = user.nfts || [];
                // –ü—Ä–æ—Å—Ç–∞—è –æ—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ NFT –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                return nfts.length * 1000; // –ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞
            };

            const getTotalValue = (user) => {
                return (user.coins || 0) + getNFTValue(user);
            };

            const topCoins = getTopUsers('coins');
            const topNFTs = getTopUsers('nfts');
            const topTotal = allUsers
                .filter(user => user.username)
                .sort((a, b) => getTotalValue(b) - getTotalValue(a))
                .slice(0, 10);

            const renderLeaderboardItem = (user, index, value, isNFTCount = false) => {
                const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : '';
                return (
                    <div 
                        key={user.username} 
                        className={`leaderboard-item p-3 rounded-xl flex items-center gap-3 mb-2 ${rankClass}`}
                    >
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                            index === 0 ? 'bg-yellow-500 text-yellow-900' :
                            index === 1 ? 'bg-gray-400 text-gray-800' :
                            index === 2 ? 'bg-orange-500 text-orange-900' :
                            'bg-slate-700 text-slate-300'
                        }`}>
                            {index + 1}
                        </div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2">
                                <div className={`w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-sm`}>
                                    {user.avatar || user.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <h4 className="font-medium text-white text-sm truncate">
                                        {user.username}
                                        {user.username === 'kayivi' && <Crown size={12} className="text-yellow-500 inline ml-1" />}
                                    </h4>
                                    <p className="text-xs text-slate-400">
                                        {isNFTCount ? `${value} NFT` : `${value.toFixed(3)} –∫–æ–∏–Ω–æ–≤`}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {index < 3 && (
                            <div className="text-lg">
                                {index === 0 && 'ü•á'}
                                {index === 1 && 'ü•à'}
                                {index === 2 && 'ü•â'}
                            </div>
                        )}
                    </div>
                );
            };

            const renderCoinsLeaderboard = () => (
                <div className="space-y-2">
                    {topCoins.map((user, index) => 
                        renderLeaderboardItem(user, index, user.coins || 0)
                    )}
                </div>
            );

            const renderNFTsLeaderboard = () => (
                <div className="space-y-2">
                    {topNFTs.map((user, index) => 
                        renderLeaderboardItem(user, index, (user.nfts || []).length, true)
                    )}
                </div>
            );

            const renderTotalLeaderboard = () => (
                <div className="space-y-2">
                    {topTotal.map((user, index) => 
                        renderLeaderboardItem(user, index, getTotalValue(user))
                    )}
                </div>
            );

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Trophy size={18} className="text-yellow-500" /> –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        
                        <div className="flex border-b border-slate-800 bg-slate-900/50">
                            {['coins', 'nfts', 'total'].map(tab => (
                                <button 
                                    key={tab} 
                                    onClick={() => setActiveTab(tab)} 
                                    className={`flex-1 py-3 text-xs font-medium transition-colors min-h-[44px] ${
                                        activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'
                                    }`}
                                >
                                    {tab === 'coins' ? 'üí∞ –ë–æ–≥–∞—á–∏' : 
                                     tab === 'nfts' ? 'üé¥ –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä—ã' : 
                                     'üèÜ –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥'}
                                </button>
                            ))}
                        </div>
                        
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            {activeTab === 'coins' && renderCoinsLeaderboard()}
                            {activeTab === 'nfts' && renderNFTsLeaderboard()}
                            {activeTab === 'total' && renderTotalLeaderboard()}
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Transfer Coins Modal
        const TransferCoinsModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate }) => {
            const [recipient, setRecipient] = useState('');
            const [amount, setAmount] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });

            if (!isOpen) return null;

            const handleTransfer = async () => {
                if (!recipient.trim()) {
                    setMessage({ type: 'error', text: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è' });
                    return;
                }

                const transferAmount = parseFloat(amount);
                if (isNaN(transferAmount) || transferAmount <= 0) {
                    setMessage({ type: 'error', text: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É' });
                    return;
                }

                if (transferAmount > userCoins) {
                    setMessage({ type: 'error', text: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤' });
                    return;
                }

                if (recipient === currentUser) {
                    setMessage({ type: 'error', text: '–ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã —Å–∞–º–æ–º—É —Å–µ–±–µ' });
                    return;
                }

                setIsLoading(true);
                try {
                    const recipientRef = ref(db, `users/${recipient}`);
                    const snapshot = await get(recipientRef);
                    
                    if (!snapshot.exists()) {
                        setMessage({ type: 'error', text: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                        setIsLoading(false);
                        return;
                    }

                    const recipientData = snapshot.val();
                    const recipientCoins = recipientData.coins || 0;

                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - transferAmount 
                    });
                    
                    await update(recipientRef, { 
                        coins: recipientCoins + transferAmount 
                    });

                    const transactionRef = push(ref(db, 'transactions'));
                    await set(transactionRef, {
                        from: currentUser,
                        to: recipient,
                        amount: transferAmount,
                        timestamp: Date.now()
                    });

                    onCoinsUpdate(userCoins - transferAmount);
                    setMessage({ type: 'success', text: `–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${transferAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${recipient}` });
                    setRecipient('');
                    setAmount('');
                } catch (error) {
                    console.error('Transfer error:', error);
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><SendIcon size={18} className="text-yellow-500" /> –ü–µ—Ä–µ–≤–æ–¥ –∫–æ–∏–Ω–æ–≤</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <p className="text-slate-400 text-sm">–ü–µ—Ä–µ–≤–æ–¥ –∫–æ–∏–Ω–æ–≤ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
                                <p className="text-xs text-slate-500 mt-1">–í–∞—à –±–∞–ª–∞–Ω—Å: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>

                            {message.text && (
                                <div className={`mb-3 p-2 rounded-lg text-xs text-center ${
                                    message.type === 'error' ? 'text-red-400 bg-red-500/10' : 'text-green-400 bg-green-500/10'
                                }`}>
                                    {message.text}
                                </div>
                            )}

                            <div className="space-y-3">
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
                                    <input 
                                        type="text" 
                                        placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                        value={recipient}
                                        onChange={e => setRecipient(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                    />
                                </div>
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–°—É–º–º–∞</label>
                                    <input 
                                        type="number" 
                                        step="0.001"
                                        placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                        value={amount}
                                        onChange={e => setAmount(e.target.value)}
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                    />
                                </div>
                                <Button 
                                    onClick={handleTransfer}
                                    isLoading={isLoading}
                                    disabled={!recipient.trim() || !amount || parseFloat(amount) <= 0}
                                    variant="gold"
                                    className="w-full text-sm"
                                >
                                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. User Profile Modal
        const UserProfileModal = ({ isOpen, onClose, user, currentUser, onSendMessage }) => {
            const [description, setDescription] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [isLoading, setIsLoading] = useState(false);

            useEffect(() => {
                if (user && user.description) {
                    setDescription(user.description);
                } else {
                    setDescription('');
                }
            }, [user]);

            if (!isOpen || !user) return null;

            const handleSaveDescription = async () => {
                if (description.length > 20) {
                    alert('–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 20 —Å–∏–º–≤–æ–ª–æ–≤!');
                    return;
                }

                setIsLoading(true);
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        description: description 
                    });
                    setIsEditing(false);
                } catch (error) {
                    console.error('Description update error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è');
                }
                setIsLoading(false);
            };

            const getNameColorStyle = (colorId) => {
                const colors = {
                    'red': '#ef4444',
                    'orange': '#f97316',
                    'yellow': '#eab308',
                    'green': '#22c55e',
                    'blue': '#3b82f6',
                    'purple': '#a855f7',
                    'pink': '#ec4899',
                    'cyan': '#06b6d4',
                    'rainbow': 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)'
                };
                return { 
                    color: colors[colorId] || '#ffffff',
                    background: colorId === 'rainbow' ? colors[colorId] : 'transparent',
                    WebkitBackgroundClip: colorId === 'rainbow' ? 'text' : 'initial',
                    WebkitTextFillColor: colorId === 'rainbow' ? 'transparent' : 'initial'
                };
            };

            const getFrameClass = (frameId) => {
                switch(frameId) {
                    case 'basic': return 'frame-basic';
                    case 'silver': return 'frame-silver';
                    case 'gold': return 'frame-gold';
                    case 'diamond': return 'frame-diamond';
                    case 'rainbow': return 'frame-rainbow';
                    case 'platinum': return 'frame-platinum';
                    case 'obsidian': return 'frame-obsidian';
                    case 'emerald': return 'frame-emerald';
                    case 'ruby': return 'frame-ruby';
                    case 'sapphire': return 'frame-sapphire';
                    case 'legendary': return 'frame-legendary';
                    default: return '';
                }
            };

            // NFT data
            const nfts = [
                { id: 'dragon', emoji: 'üêâ' },
                { id: 'phoenix', emoji: 'ü¶ö' },
                { id: 'unicorn', emoji: 'ü¶Ñ' },
                { id: 'robot', emoji: 'ü§ñ' },
                { id: 'alien', emoji: 'üëΩ' },
                { id: 'ghost', emoji: 'üëª' },
                { id: 'dinosaur', emoji: 'ü¶ñ' },
                { id: 'spaceship', emoji: 'üöÄ' },
                { id: 'comet', emoji: '‚òÑÔ∏è' },
                { id: 'treasure', emoji: 'üíé' },
                { id: 'panda', emoji: 'üêº' },
                { id: 'tiger', emoji: 'üêØ' },
                { id: 'eagle', emoji: 'ü¶Ö' },
                { id: 'whale', emoji: 'üêã' },
                { id: 'lion', emoji: 'ü¶Å' },
                { id: 'fox', emoji: 'ü¶ä' }
            ];

            const getActiveNFTs = () => {
                return (user.nfts || []).filter(nft => !nft.hidden).slice(0, 3);
            };

            const getOrbitClass = (index) => {
                switch(index) {
                    case 0: return 'nft-orbit-slow';
                    case 1: return 'nft-orbit-medium';
                    case 2: return 'nft-orbit-fast';
                    default: return 'nft-orbit-slow';
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><UserIcon size={18} className="text-indigo-500" /> –ü—Ä–æ—Ñ–∏–ª—å</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <div className="relative mx-auto w-20 h-20 mb-3">
                                    <div className={`w-20 h-20 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-3xl shadow-xl ${getFrameClass(user.frame)}`}>
                                        {user.avatar || user.username[0].toUpperCase()}
                                    </div>
                                    {user.nfts && getActiveNFTs().length > 0 && (
                                        <div className="nft-orbital">
                                            {getActiveNFTs().map((nft, index) => {
                                                const nftData = nfts.find(n => n.id === nft.id);
                                                if (!nftData) return null;
                                                return (
                                                    <div 
                                                        key={nft.id}
                                                        className={`nft-item ${getOrbitClass(index)}`}
                                                    >
                                                        {nftData.emoji}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                <div className="mt-3">
                                    <h3 className="text-xl font-bold" style={getNameColorStyle(user.nameColor)}>{user.username}</h3>
                                    <p className="text-slate-400 text-sm flex items-center justify-center gap-1">
                                        {user.statusEmoji} {user.status || '–í —Å–µ—Ç–∏'}
                                    </p>
                                </div>
                                <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-3 mt-3">
                                    <div className="flex items-center justify-center gap-2 text-yellow-500">
                                        <Coins size={18} />
                                        <span className="font-bold text-md">{(user.coins || 0).toFixed(3)} –∫–æ–∏–Ω–æ–≤</span>
                                    </div>
                                </div>
                            </div>

                            {currentUser === user.username && (
                                <div className="mb-4">
                                    <div className="flex items-center justify-between mb-2">
                                        <label className="text-slate-400 text-sm">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è (–º–∞–∫—Å. 20 —Å–∏–º–≤–æ–ª–æ–≤)</label>
                                        <button 
                                            onClick={isEditing ? handleSaveDescription : () => setIsEditing(true)}
                                            disabled={isLoading}
                                            className="text-indigo-400 text-xs hover:text-indigo-300"
                                        >
                                            {isEditing ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}
                                        </button>
                                    </div>
                                    {isEditing ? (
                                        <div>
                                            <textarea 
                                                value={description}
                                                onChange={e => setDescription(e.target.value)}
                                                placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."
                                                maxLength={20}
                                                className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm h-20 resize-none"
                                            />
                                            <div className="text-right text-xs text-slate-500 mt-1">
                                                {description.length}/20
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-slate-300 text-sm min-h-20">
                                            {description || '–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ...'}
                                        </div>
                                    )}
                                </div>
                            )}

                            {currentUser !== user.username && user.description && (
                                <div className="mb-4">
                                    <label className="text-slate-400 text-sm mb-2 block">–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</label>
                                    <div className="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-slate-300 text-sm">
                                        {user.description}
                                    </div>
                                </div>
                            )}

                            {user.nfts && user.nfts.length > 0 && (
                                <div className="mb-4">
                                    <label className="text-slate-400 text-sm mb-2 block">–ö–æ–ª–ª–µ–∫—Ü–∏—è NFT ({user.nfts.length})</label>
                                    <div className="flex flex-wrap gap-2">
                                        {user.nfts.slice(0, 12).map(nft => {
                                            const nftData = nfts.find(n => n.id === nft.id);
                                            if (!nftData) return null;
                                            return (
                                                <div key={nft.id} className="text-2xl" title={nftData.name}>
                                                    {nftData.emoji}
                                                </div>
                                            );
                                        })}
                                        {user.nfts.length > 12 && (
                                            <div className="text-slate-400 text-sm">
                                                +{user.nfts.length - 12} –µ—â–µ
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {currentUser !== user.username && (
                                <Button 
                                    onClick={() => {
                                        onSendMessage(user.username);
                                        onClose();
                                    }}
                                    variant="primary"
                                    className="w-full text-sm"
                                >
                                    –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                                </Button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Auto Clicker Component
        const AutoClicker = ({ userCoins, onCoinsUpdate, currentUser, clickerLevel, onUpgradeClicker, autoClickerActive, onAutoClickerToggle, autoClickerStartTime }) => {
            const [nextUpgradeCost, setNextUpgradeCost] = useState(10 + (clickerLevel * 5));
            const [timeLeft, setTimeLeft] = useState(0);

            useEffect(() => {
                setNextUpgradeCost(10 + (clickerLevel * 5));
            }, [clickerLevel]);

            useEffect(() => {
                if (autoClickerActive && autoClickerStartTime) {
                    const calculateTimeLeft = () => {
                        const thirtyMinutes = 30 * 60 * 1000;
                        const elapsed = Date.now() - autoClickerStartTime;
                        const remaining = Math.max(0, thirtyMinutes - elapsed);
                        setTimeLeft(remaining);
                        
                        if (remaining <= 0) {
                            onAutoClickerToggle(false);
                        }
                    };
                    
                    calculateTimeLeft();
                    const interval = setInterval(calculateTimeLeft, 1000);
                    return () => clearInterval(interval);
                } else {
                    setTimeLeft(0);
                }
            }, [autoClickerActive, autoClickerStartTime, onAutoClickerToggle]);

            const handleToggleAutoClicker = async () => {
                if (autoClickerActive) {
                    onAutoClickerToggle(false);
                    return;
                }

                if (userCoins < 10) {
                    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ 10 –∫–æ–∏–Ω–æ–≤ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ä–æ–±–æ—Ç–∞.');
                    return;
                }

                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - 10,
                        autoClickerActive: true,
                        autoClickerStartTime: Date.now()
                    });
                    onCoinsUpdate(userCoins - 10);
                    onAutoClickerToggle(true);
                } catch (error) {
                    console.error('Auto clicker activation error:', error);
                }
            };

            const handleUpgradeClicker = async () => {
                if (userCoins < nextUpgradeCost) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${nextUpgradeCost} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è.`);
                    return;
                }

                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - nextUpgradeCost,
                        clickerLevel: clickerLevel + 1
                    });
                    onCoinsUpdate(userCoins - nextUpgradeCost);
                    onUpgradeClicker(clickerLevel + 1);
                } catch (error) {
                    console.error('Clicker upgrade error:', error);
                }
            };

            const coinsPerClick = 0.001 + (clickerLevel * 0.004);
            const minutesLeft = Math.floor(timeLeft / 60000);
            const secondsLeft = Math.floor((timeLeft % 60000) / 1000);

            return (
                <div className="bg-slate-800 border border-slate-700 rounded-xl p-3 mb-3">
                    <div className="flex items-center justify-between mb-2">
                        <h3 className="text-white font-medium text-sm flex items-center gap-2">
                            <Bot size={16} className="text-green-500" /> –ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä
                        </h3>
                        <div className={`text-xs px-2 py-1 rounded-full ${autoClickerActive ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'}`}>
                            {autoClickerActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </div>
                    </div>
                    
                    <div className="text-xs text-slate-400 mb-3">
                        <div>–£—Ä–æ–≤–µ–Ω—å: {clickerLevel}</div>
                        <div>–î–æ—Ö–æ–¥ –∑–∞ –∫–ª–∏–∫: +{coinsPerClick.toFixed(3)}</div>
                        {autoClickerActive && timeLeft > 0 && (
                            <div className="flex items-center gap-1 mt-1 text-yellow-400">
                                <Clock size={12} />
                                <span>–û—Å—Ç–∞–ª–æ—Å—å: {minutesLeft}:{secondsLeft.toString().padStart(2, '0')}</span>
                            </div>
                        )}
                    </div>

                    <div className="flex gap-2">
                        <Button 
                            onClick={handleToggleAutoClicker}
                            variant={autoClickerActive ? "danger" : "primary"}
                            className="flex-1 text-xs"
                            disabled={!autoClickerActive && userCoins < 10}
                        >
                            {autoClickerActive ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ö—É–ø–∏—Ç—å –∑–∞ 10'}
                        </Button>
                        <Button 
                            onClick={handleUpgradeClicker}
                            variant="gold"
                            className="flex-1 text-xs"
                            disabled={userCoins < nextUpgradeCost}
                        >
                            –£–ª—É—á—à–∏—Ç—å ({nextUpgradeCost})
                        </Button>
                    </div>
                </div>
            );
        };

        // 7. Casino Modal
        const CasinoModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate }) => {
            const [activeGame, setActiveGame] = useState('slots');
            const [betAmount, setBetAmount] = useState(1);
            const [isSpinning, setIsSpinning] = useState(false);
            const [result, setResult] = useState(null);
            const [lastWin, setLastWin] = useState(0);

            const [slots, setSlots] = useState(['üçí', 'üçã', 'üçä']);
            const [dice1, setDice1] = useState(1);
            const [dice2, setDice2] = useState(1);
            const [diceBet, setDiceBet] = useState('over');
            const [cards, setCards] = useState([null, null, null]);
            const [selectedCard, setSelectedCard] = useState(null);
            const [rouletteNumber, setRouletteNumber] = useState(0);
            const [rouletteColor, setRouletteColor] = useState('red');
            const [rouletteBet, setRouletteBet] = useState('red');
            const [coinSide, setCoinSide] = useState('heads');
            const [coinBet, setCoinBet] = useState('heads');

            if (!isOpen) return null;

            const games = [
                { id: 'slots', name: 'üé∞ –°–ª–æ—Ç—ã', description: '3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö = x3' },
                { id: 'dice', name: 'üé≤ –ö–æ—Å—Ç–∏', description: '–®–∞–Ω—Å 60%' },
                { id: 'cards', name: 'üÉè –ö–∞—Ä—Ç—ã', description: '–ù–∞–π–¥–∏ —Ç—É–∑–∞!' },
                { id: 'roulette', name: 'üé° –†—É–ª–µ—Ç–∫–∞', description: '–¶–≤–µ—Ç–∞' },
                { id: 'coin', name: 'ü™ô –ú–æ–Ω–µ—Ç–∫–∞', description: '50/50' }
            ];

            const symbols = ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'];

            const spinSlots = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                
                setIsSpinning(true);
                setResult(null);

                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                const spins = 20;
                let spinCount = 0;

                const spinInterval = setInterval(() => {
                    const newSlots = [
                        symbols[Math.floor(Math.random() * symbols.length)],
                        symbols[Math.floor(Math.random() * symbols.length)],
                        symbols[Math.floor(Math.random() * symbols.length)]
                    ];
                    setSlots(newSlots);
                    spinCount++;

                    if (spinCount >= spins) {
                        clearInterval(spinInterval);
                        
                        const finalSlots = [
                            symbols[Math.floor(Math.random() * symbols.length)],
                            symbols[Math.floor(Math.random() * symbols.length)],
                            symbols[Math.floor(Math.random() * symbols.length)]
                        ];
                        
                        if (Math.random() < 0.6) {
                            if (Math.random() < 0.7) {
                                finalSlots[1] = finalSlots[0];
                            }
                            if (Math.random() < 0.4) {
                                finalSlots[2] = finalSlots[0];
                                finalSlots[1] = finalSlots[0];
                            }
                        }
                        
                        setSlots(finalSlots);

                        let winMultiplier = 0;
                        if (finalSlots[0] === finalSlots[1] && finalSlots[1] === finalSlots[2]) {
                            if (finalSlots[0] === '7Ô∏è‚É£') winMultiplier = 5;
                            else if (finalSlots[0] === '‚≠ê') winMultiplier = 3;
                            else winMultiplier = 2.5;
                        } else if (finalSlots[0] === finalSlots[1] || finalSlots[1] === finalSlots[2] || finalSlots[0] === finalSlots[2]) {
                            winMultiplier = 1.8;
                        }

                        const winAmount = betAmount * winMultiplier;
                        if (winAmount > 0) {
                            const finalCoins = newCoins + winAmount;
                            update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                            onCoinsUpdate(finalCoins);
                            setLastWin(winAmount);
                        }

                        setResult({
                            win: winAmount > 0,
                            amount: winAmount,
                            multiplier: winMultiplier
                        });

                        setIsSpinning(false);
                    }
                }, 100);
            };

            // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∑–∏–Ω–æ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ)

            const maxBet = Math.min(userCoins, 100);

            const renderGame = () => {
                switch (activeGame) {
                    case 'slots':
                        return (
                            <div className="space-y-3">
                                <div className="slot-machine">
                                    <div className="flex justify-between">
                                        <div className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>
                                            {slots[0]}
                                        </div>
                                        <div className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>
                                            {slots[1]}
                                        </div>
                                        <div className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>
                                            {slots[2]}
                                        </div>
                                    </div>
                                </div>
                                <Button 
                                    onClick={spinSlots}
                                    isLoading={isSpinning}
                                    disabled={userCoins < betAmount || isSpinning}
                                    variant="gold"
                                    className="w-full text-sm"
                                >
                                    {isSpinning ? '–ö—Ä—É—Ç–∏–º...' : `–ö—Ä—É—Ç–∏—Ç—å –∑–∞ ${betAmount.toFixed(3)}`}
                                </Button>
                            </div>
                        );
                    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–≥—Ä—ã)
                    default:
                        return null;
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden max-h-[95vh] flex flex-col">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Trophy size={18} className="text-yellow-500" /> –ö–∞–∑–∏–Ω–æ</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <div className="text-slate-400 mb-1 text-sm">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                                <div className="text-xl font-bold text-yellow-500">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</div>
                            </div>

                            <div className="grid grid-cols-3 gap-1 mb-4">
                                {games.map(game => (
                                    <button
                                        key={game.id}
                                        onClick={() => setActiveGame(game.id)}
                                        className={`p-2 rounded-lg text-center text-xs min-h-[44px] ${
                                            activeGame === game.id 
                                            ? 'bg-indigo-600 text-white' 
                                            : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                                        }`}
                                    >
                                        <div className="font-medium">{game.name}</div>
                                        <div className="opacity-75 text-[10px]">{game.description}</div>
                                    </button>
                                ))}
                            </div>

                            <div className="mb-4">
                                <label className="text-slate-400 text-sm mb-1 block">–°—Ç–∞–≤–∫–∞: {betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤</label>
                                <input 
                                    type="range" 
                                    min="0.1" 
                                    max={maxBet} 
                                    step="0.1"
                                    value={betAmount} 
                                    onChange={e => setBetAmount(parseFloat(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider"
                                    disabled={isSpinning}
                                />
                                <div className="flex justify-between text-xs text-slate-500 mt-1">
                                    <span>0.1</span>
                                    <span>{maxBet.toFixed(1)}</span>
                                </div>
                            </div>

                            {renderGame()}

                            {result && (
                                <div className={`text-center mt-3 p-2 rounded-lg text-sm ${result.win ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                    {result.win ? (
                                        <div className="win-animation">
                                            üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ {result.amount.toFixed(3)} –∫–æ–∏–Ω–æ–≤!
                                        </div>
                                    ) : (
                                        'üò¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!'
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 8. Name Color Modal
        const NameColorModal = ({ isOpen, onClose, currentUser, userCoins, onColorChange, purchasedColors }) => {
            const [selectedColor, setSelectedColor] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const colors = [
                { id: 'red', name: '–ö—Ä–∞—Å–Ω—ã–π', value: '#ef4444', price: 50 },
                { id: 'orange', name: '–û—Ä–∞–Ω–∂–µ–≤—ã–π', value: '#f97316', price: 50 },
                { id: 'yellow', name: '–ñ–µ–ª—Ç—ã–π', value: '#eab308', price: 50 },
                { id: 'green', name: '–ó–µ–ª–µ–Ω—ã–π', value: '#22c55e', price: 50 },
                { id: 'blue', name: '–°–∏–Ω–∏–π', value: '#3b82f6', price: 50 },
                { id: 'purple', name: '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', value: '#a855f7', price: 50 },
                { id: 'pink', name: '–†–æ–∑–æ–≤—ã–π', value: '#ec4899', price: 50 },
                { id: 'cyan', name: '–ì–æ–ª—É–±–æ–π', value: '#06b6d4', price: 50 },
                { id: 'rainbow', name: '–†–∞–¥—É–∂–Ω—ã–π', value: 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)', price: 200 }
            ];

            if (!isOpen) return null;

            const handleColorSelect = async (color) => {
                const isPurchased = purchasedColors.includes(color.id);
                
                if (!isPurchased && userCoins < color.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${color.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedColors = [...purchasedColors, color.id];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - color.price,
                            nameColor: color.id,
                            purchasedColors: newPurchasedColors
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            nameColor: color.id
                        });
                    }
                    setSelectedColor(color.id);
                    onColorChange(color.id);
                    onClose();
                } catch (error) {
                    console.error('Color change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ü–≤–µ—Ç–∞');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Palette size={18} className="text-yellow-500" /> –¶–≤–µ—Ç –∏–º–µ–Ω–∏</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <p className="text-slate-400 text-sm">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={14} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Ü–≤–µ—Ç–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
                                    )}
                                </p>
                                <p className="text-xs text-slate-500 mt-1">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                {colors.map((color) => {
                                    const isPurchased = purchasedColors.includes(color.id);
                                    const canAfford = userCoins >= color.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi';
                                    
                                    return (
                                        <button
                                            key={color.id}
                                            onClick={() => !isLocked && handleColorSelect(color)}
                                            disabled={isLoading || isLocked}
                                            className={`p-3 rounded-xl flex flex-col items-center gap-2 transition-all duration-200 min-h-[100px] ${
                                                isLocked 
                                                    ? 'bg-slate-800 border-2 border-slate-700 avatar-locked' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 hover:scale-105'
                                            }`}
                                        >
                                            <div 
                                                className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-xl"
                                                style={{ 
                                                    background: color.value,
                                                    border: '2px solid #374151'
                                                }}
                                            >
                                                A
                                            </div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white text-sm">{color.name}</h3>
                                                <p className="text-xs text-slate-400">
                                                    {color.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : 
                                                     isPurchased ? <span className="text-green-500">‚úì –ö—É–ø–ª–µ–Ω–æ</span> :
                                                     currentUser === 'kayivi' ? <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span> :
                                                     `${color.price} –∫–æ–∏–Ω–æ–≤`}
                                                </p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 9. Status Modal
        const StatusModal = ({ isOpen, onClose, currentUser, userCoins, onStatusChange, purchasedStatuses }) => {
            const [selectedStatus, setSelectedStatus] = useState('');
            const [customStatus, setCustomStatus] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const statuses = [
                { id: 'online', text: '–í —Å–µ—Ç–∏', emoji: 'üü¢', price: 0 },
                { id: 'away', text: '–û—Ç–æ—à–µ–ª', emoji: 'üü°', price: 0 },
                { id: 'dnd', text: '–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å', emoji: 'üî¥', price: 0 },
                { id: 'custom1', text: '–û—Ç–¥—ã—Ö–∞—é', emoji: 'üò¥', price: 50 },
                { id: 'custom2', text: '–†–∞–±–æ—Ç–∞—é', emoji: 'üíº', price: 50 },
                { id: 'custom3', text: '–í –ø—É—Ç–∏', emoji: 'üöó', price: 50 },
                { id: 'custom4', text: '–í –æ—Ç–ø—É—Å–∫–µ', emoji: 'üèñÔ∏è', price: 50 },
                { id: 'custom5', text: '–£—á—É—Å—å', emoji: 'üìö', price: 50 },
                { id: 'custom6', text: '–ò–≥—Ä–∞—é', emoji: 'üéÆ', price: 50 },
                { id: 'custom7', text: '–°–ø–ª—é', emoji: 'üí§', price: 50 },
                { id: 'custom8', text: '–¢—Ä–µ–Ω–∏—Ä—É—é—Å—å', emoji: 'üí™', price: 50 },
                { id: 'custom9', text: '–ü—É—Ç–µ—à–µ—Å—Ç–≤—É—é', emoji: '‚úàÔ∏è', price: 50 },
                { id: 'custom10', text: '–ù–∞ –≤—Å—Ç—Ä–µ—á–µ', emoji: 'ü§ù', price: 50 },
                { id: 'custom11', text: '–ë–æ–ª–µ—é', emoji: 'ü§í', price: 50 },
                { id: 'custom12', text: '–í –∫–∏–Ω–æ', emoji: 'üé¨', price: 50 },
                { id: 'custom13', text: '–ù–∞ –∫–æ–Ω—Ü–µ—Ä—Ç–µ', emoji: 'üéµ', price: 50 },
                { id: 'custom14', text: '–í —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ', emoji: 'üçΩÔ∏è', price: 50 },
                { id: 'custom15', text: '–ó–∞ —Ä—É–ª–µ–º', emoji: 'üöô', price: 50 }
            ];

            if (!isOpen) return null;

            const handleStatusSelect = async (status) => {
                const isPurchased = purchasedStatuses.includes(status.id) || status.price === 0;
                
                if (!isPurchased && userCoins < status.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${status.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedStatuses = [...purchasedStatuses, status.id];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - status.price,
                            status: status.text,
                            statusEmoji: status.emoji,
                            purchasedStatuses: newPurchasedStatuses
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            status: status.text,
                            statusEmoji: status.emoji
                        });
                    }
                    setSelectedStatus(status.id);
                    onStatusChange(status.text, status.emoji);
                    onClose();
                } catch (error) {
                    console.error('Status change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞');
                }
                setIsLoading(false);
            };

            const handleCustomStatus = async () => {
                if (!customStatus.trim() || userCoins < 50 && currentUser !== 'kayivi') {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤ (50)');
                    return;
                }

                setIsLoading(true);
                try {
                    if (currentUser !== 'kayivi') {
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - 50,
                            status: customStatus,
                            statusEmoji: 'üí¨'
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            status: customStatus,
                            statusEmoji: 'üí¨'
                        });
                    }
                    onStatusChange(customStatus, 'üí¨');
                    onClose();
                } catch (error) {
                    console.error('Custom status error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><Edit3 size={18} className="text-yellow-500" /> –°—Ç–∞—Ç—É—Å</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <p className="text-slate-400 text-sm">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={14} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å</span>
                                    )}
                                </p>
                                <p className="text-xs text-slate-500 mt-1">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>

                            <div className="mb-4 p-3 bg-slate-800 rounded-xl">
                                <h3 className="text-white font-medium mb-2 text-sm">–°–≤–æ–π —Å—Ç–∞—Ç—É—Å (50 –∫–æ–∏–Ω–æ–≤)</h3>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å..." 
                                        value={customStatus}
                                        onChange={e => setCustomStatus(e.target.value)}
                                        className="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white outline-none text-sm"
                                    />
                                    <Button 
                                        onClick={handleCustomStatus}
                                        isLoading={isLoading}
                                        disabled={!customStatus.trim() || (userCoins < 50 && currentUser !== 'kayivi')}
                                        variant="primary"
                                        className="text-xs"
                                    >
                                        –û–ö
                                    </Button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 gap-2">
                                {statuses.map((status) => {
                                    const isPurchased = purchasedStatuses.includes(status.id) || status.price === 0;
                                    const canAfford = userCoins >= status.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi';
                                    
                                    return (
                                        <button
                                            key={status.id}
                                            onClick={() => !isLocked && handleStatusSelect(status)}
                                            disabled={isLoading || isLocked}
                                            className={`p-2 rounded-xl flex items-center gap-2 transition-all duration-200 text-left min-h-[44px] ${
                                                isLocked 
                                                    ? 'bg-slate-800 border border-slate-700 avatar-locked' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-yellow-500'
                                            }`}
                                        >
                                            <span className="text-xl">{status.emoji}</span>
                                            <div className="flex-1">
                                                <div className="text-white text-sm">{status.text}</div>
                                            </div>
                                            <div className="text-xs text-slate-400">
                                                {status.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : 
                                                 isPurchased ? <span className="text-green-500">‚úì</span> :
                                                 currentUser === 'kayivi' ? <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span> :
                                                 `${status.price} –∫–æ–∏–Ω–æ–≤`}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 10. Avatar Modal
        const AvatarModal = ({ isOpen, onClose, currentUser, userCoins, onAvatarChange, purchasedAvatars }) => {
            const [selectedAvatar, setSelectedAvatar] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const avatars = [
                { emoji: 'üê∂', price: 50, name: '–°–æ–±–∞–∫–∞' },
                { emoji: 'üê±', price: 75, name: '–ö–æ—à–∫–∞' },
                { emoji: 'üê≠', price: 100, name: '–ú—ã—à—å' },
                { emoji: 'üêπ', price: 125, name: '–•–æ–º—è–∫' },
                { emoji: 'üê∞', price: 150, name: '–ö—Ä–æ–ª–∏–∫' },
                { emoji: 'ü¶ä', price: 175, name: '–õ–∏—Å–∞' },
                { emoji: 'üêª', price: 200, name: '–ú–µ–¥–≤–µ–¥—å' },
                { emoji: 'üêº', price: 225, name: '–ü–∞–Ω–¥–∞' },
                { emoji: 'üê®', price: 250, name: '–ö–æ–∞–ª–∞' },
                { emoji: 'üêØ', price: 300, name: '–¢–∏–≥—Ä' },
                { emoji: 'ü¶Å', price: 350, name: '–õ–µ–≤' },
                { emoji: 'üêÆ', price: 400, name: '–ö–æ—Ä–æ–≤–∞' },
                { emoji: 'üê∑', price: 450, name: '–°–≤–∏–Ω—å—è' },
                { emoji: 'üê∏', price: 500, name: '–õ—è–≥—É—à–∫–∞' },
                { emoji: 'üêµ', price: 600, name: '–û–±–µ–∑—å—è–Ω–∞' },
                { emoji: 'ü¶Ñ', price: 750, name: '–ï–¥–∏–Ω–æ—Ä–æ–≥' },
                { emoji: 'üêô', price: 1000, name: '–û—Å—å–º–∏–Ω–æ–≥' },
                { emoji: 'üê¨', price: 1250, name: '–î–µ–ª—å—Ñ–∏–Ω' },
                { emoji: 'üê≥', price: 1500, name: '–ö–∏—Ç' },
                { emoji: 'ü¶ì', price: 2000, name: '–ó–µ–±—Ä–∞' },
                { emoji: 'ü¶í', price: 2200, name: '–ñ–∏—Ä–∞—Ñ' },
                { emoji: 'üêò', price: 2400, name: '–°–ª–æ–Ω' },
                { emoji: 'ü¶è', price: 2600, name: '–ù–æ—Å–æ—Ä–æ–≥' },
                { emoji: 'ü¶õ', price: 2800, name: '–ë–µ–≥–µ–º–æ—Ç' },
                { emoji: 'üêä', price: 3000, name: '–ö—Ä–æ–∫–æ–¥–∏–ª' },
                { emoji: 'üê¢', price: 1200, name: '–ß–µ—Ä–µ–ø–∞—Ö–∞' },
                { emoji: 'üêç', price: 1400, name: '–ó–º–µ—è' },
                { emoji: 'ü¶é', price: 1600, name: '–Ø—â–µ—Ä–∏—Ü–∞' },
                { emoji: 'ü¶ú', price: 1800, name: '–ü–æ–ø—É–≥–∞–π' },
                { emoji: 'ü¶¢', price: 2000, name: '–õ–µ–±–µ–¥—å' }
            ];

            if (!isOpen) return null;

            const handleAvatarSelect = async (avatar) => {
                const isPurchased = purchasedAvatars.includes(avatar.emoji);
                
                if (!isPurchased && userCoins < avatar.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${avatar.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–π –∞–≤–∞—Ç–∞—Ä–∫–∏.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedAvatars = [...purchasedAvatars, avatar.emoji];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - avatar.price,
                            avatar: avatar.emoji,
                            purchasedAvatars: newPurchasedAvatars
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            avatar: avatar.emoji
                        });
                    }
                    setSelectedAvatar(avatar.emoji);
                    onAvatarChange(avatar.emoji);
                    onClose();
                } catch (error) {
                    console.error('Avatar change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-4xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><UserIcon size={18} className="text-yellow-500" /> –ú–∞–≥–∞–∑–∏–Ω –∞–≤–∞—Ç–∞—Ä–æ–∫</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <p className="text-slate-400 text-sm">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={14} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
                                    )}
                                </p>
                                <p className="text-xs text-slate-500 mt-1">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                                {avatars.map((avatar, index) => {
                                    const isPurchased = purchasedAvatars.includes(avatar.emoji);
                                    const canAfford = userCoins >= avatar.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi';
                                    
                                    return (
                                        <button
                                            key={index}
                                            onClick={() => !isLocked && handleAvatarSelect(avatar)}
                                            disabled={isLoading || isLocked}
                                            className={`p-3 rounded-xl flex flex-col items-center gap-2 transition-all duration-200 min-h-[100px] ${
                                                isLocked 
                                                    ? 'bg-slate-800 border-2 border-slate-700 avatar-locked' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 hover:scale-105'
                                            }`}
                                        >
                                            <div className="text-3xl">{avatar.emoji}</div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white text-xs">{avatar.name}</h3>
                                                <p className="text-xs text-slate-400">
                                                    {isPurchased ? (
                                                        <span className="text-green-500">‚úì –ö—É–ø–ª–µ–Ω–æ</span>
                                                    ) : currentUser === 'kayivi' ? (
                                                        <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                                                    ) : (
                                                        `${avatar.price} –∫–æ–∏–Ω–æ–≤`
                                                    )}
                                                </p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 11. Frame Modal
        const FrameModal = ({ isOpen, onClose, currentUser, userCoins, onFrameChange, userFrame, purchasedFrames }) => {
            const [selectedFrame, setSelectedFrame] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const frames = [
                { id: 'none', name: '–ë–µ–∑ —Ä–∞–º–∫–∏', price: 0, className: '' },
                { id: 'basic', name: '–ë–∞–∑–æ–≤–∞—è —Ä–∞–º–∫–∞', price: 50, className: 'frame-basic' },
                { id: 'silver', name: '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è —Ä–∞–º–∫–∞', price: 250, className: 'frame-silver' },
                { id: 'gold', name: '–ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞', price: 500, className: 'frame-gold' },
                { id: 'diamond', name: '–ê–ª–º–∞–∑–Ω–∞—è —Ä–∞–º–∫–∞', price: 1250, className: 'frame-diamond' },
                { id: 'rainbow', name: '–†–∞–¥—É–∂–Ω–∞—è —Ä–∞–º–∫–∞', price: 2500, className: 'frame-rainbow' },
                { id: 'platinum', name: '–ü–ª–∞—Ç–∏–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞', price: 3000, className: 'frame-platinum' },
                { id: 'obsidian', name: '–û–±—Å–∏–¥–∏–∞–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞', price: 3500, className: 'frame-obsidian' },
                { id: 'emerald', name: '–ò–∑—É–º—Ä—É–¥–Ω–∞—è —Ä–∞–º–∫–∞', price: 4000, className: 'frame-emerald' },
                { id: 'ruby', name: '–†—É–±–∏–Ω–æ–≤–∞—è —Ä–∞–º–∫–∞', price: 4500, className: 'frame-ruby' },
                { id: 'sapphire', name: '–°–∞–ø—Ñ–∏—Ä–æ–≤–∞—è —Ä–∞–º–∫–∞', price: 5000, className: 'frame-sapphire' },
                { id: 'legendary', name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è —Ä–∞–º–∫–∞', price: 10000, className: 'frame-legendary' }
            ];

            if (!isOpen) return null;

            const handleFrameSelect = async (frame) => {
                const isPurchased = purchasedFrames.includes(frame.id);
                
                if (!isPurchased && userCoins < frame.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${frame.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–π —Ä–∞–º–∫–∏.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedFrames = [...purchasedFrames, frame.id];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - frame.price,
                            frame: frame.id,
                            purchasedFrames: newPurchasedFrames
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            frame: frame.id
                        });
                    }
                    setSelectedFrame(frame.id);
                    onFrameChange(frame.id);
                    onClose();
                } catch (error) {
                    console.error('Frame change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ä–∞–º–∫–∏');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white flex items-center gap-2"><ImageIcon size={18} className="text-yellow-500" /> –ú–∞–≥–∞–∑–∏–Ω —Ä–∞–º–æ–∫</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                            <div className="text-center mb-4">
                                <p className="text-slate-400 text-sm">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={14} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Ä–∞–º–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–º–∫—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
                                    )}
                                </p>
                                <p className="text-xs text-slate-500 mt-1">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                {frames.map((frame) => {
                                    const isPurchased = purchasedFrames.includes(frame.id);
                                    const canAfford = userCoins >= frame.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi' && frame.price > 0;
                                    
                                    return (
                                        <button
                                            key={frame.id}
                                            onClick={() => !isLocked && handleFrameSelect(frame)}
                                            disabled={isLoading || isLocked}
                                            className={`p-3 rounded-xl flex flex-col items-center gap-2 transition-all duration-200 min-h-[120px] ${
                                                isLocked 
                                                    ? 'bg-slate-800 border-2 border-slate-700 avatar-locked' 
                                                    : userFrame === frame.id 
                                                    ? 'bg-slate-700 border-2 border-yellow-500' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 hover:scale-105'
                                            }`}
                                        >
                                            <div className={`w-12 h-12 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg ${frame.className}`}>
                                                {currentUser[0].toUpperCase()}
                                            </div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white text-sm">{frame.name}</h3>
                                                <p className="text-xs text-slate-400">
                                                    {frame.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : 
                                                     isPurchased ? <span className="text-green-500">‚úì –ö—É–ø–ª–µ–Ω–æ</span> :
                                                     currentUser === 'kayivi' ? <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span> :
                                                     `${frame.price} –∫–æ–∏–Ω–æ–≤`}
                                                </p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 12. Settings Modal
        const SettingsModal = ({ isOpen, onClose, currentUser, onLogout, userCoins, onCoinsUpdate, userAvatar, userFrame, userNameColor, userStatus, userStatusEmoji, onAvatarChange, onFrameChange, onColorChange, onStatusChange, purchasedAvatars, purchasedFrames, purchasedColors, purchasedStatuses }) => {
            const [activeTab, setActiveTab] = useState('profile');
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmDelete, setConfirmDelete] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });
            const [coinsToAdd, setCoinsToAdd] = useState('');
            const [coinsToRemove, setCoinsToRemove] = useState('');
            const [targetUser, setTargetUser] = useState('');
            const [coinsToAddToOther, setCoinsToAddToOther] = useState('');
            const [targetUserToAdd, setTargetUserToAdd] = useState('');

            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isFrameModalOpen, setIsFrameModalOpen] = useState(false);
            const [isNameColorModalOpen, setIsNameColorModalOpen] = useState(false);
            const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);

            if (!isOpen) return null;

            const handleChangePassword = async () => {
                if (!oldPassword || !newPassword) return;
                setIsLoading(true);
                try {
                    const userRef = ref(db, `users/${currentUser}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val();
                    if (userData.password !== oldPassword) {
                        setMessage({ type: 'error', text: '–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω' });
                        setIsLoading(false); return;
                    }
                    await update(userRef, { password: newPassword });
                    setMessage({ type: 'success', text: '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω' });
                    setOldPassword(''); setNewPassword('');
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è' }); }
                setIsLoading(false);
            };

            const handleDeleteAccount = async () => {
                if (confirmDelete !== currentUser) {
                     setMessage({ type: 'error', text: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
                     return;
                }
                setIsLoading(true);
                try {
                    await remove(ref(db, `users/${currentUser}`));
                    onLogout();
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è' }); setIsLoading(false); }
            };

            const handleAddCoins = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã!');
                    return;
                }
                
                const coins = parseFloat(coinsToAdd);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins + coins 
                    });
                    onCoinsUpdate(userCoins + coins);
                    setMessage({ type: 'success', text: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤!` });
                    setCoinsToAdd('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            const handleRemoveCoins = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç —É–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã!');
                    return;
                }
                
                if (!targetUser) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                const coins = parseFloat(coinsToRemove);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    const targetUserRef = ref(db, `users/${targetUser}`);
                    const snapshot = await get(targetUserRef);
                    const targetUserData = snapshot.val();
                    
                    if (!targetUserData) {
                        setMessage({ type: 'error', text: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                        setIsLoading(false);
                        return;
                    }
                    
                    const currentCoins = targetUserData.coins || 0;
                    const newCoins = Math.max(0, currentCoins - coins);
                    
                    await update(targetUserRef, { 
                        coins: newCoins 
                    });
                    
                    setMessage({ type: 'success', text: `–°–ø–∏—Å–∞–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${targetUser}!` });
                    setCoinsToRemove('');
                    setTargetUser('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            const handleAddCoinsToOther = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã –¥—Ä—É–≥–∏–º!');
                    return;
                }
                
                if (!targetUserToAdd) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                const coins = parseFloat(coinsToAddToOther);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    const targetUserRef = ref(db, `users/${targetUserToAdd}`);
                    const snapshot = await get(targetUserRef);
                    const targetUserData = snapshot.val();
                    
                    if (!targetUserData) {
                        setMessage({ type: 'error', text: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                        setIsLoading(false);
                        return;
                    }
                    
                    const currentCoins = targetUserData.coins || 0;
                    const newCoins = currentCoins + coins;
                    
                    await update(targetUserRef, { 
                        coins: newCoins 
                    });
                    
                    setMessage({ type: 'success', text: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserToAdd}!` });
                    setCoinsToAddToOther('');
                    setTargetUserToAdd('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            const getNameColorStyle = (colorId) => {
                const colors = {
                    'red': '#ef4444',
                    'orange': '#f97316',
                    'yellow': '#eab308',
                    'green': '#22c55e',
                    'blue': '#3b82f6',
                    'purple': '#a855f7',
                    'pink': '#ec4899',
                    'cyan': '#06b6d4',
                    'rainbow': 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)'
                };
                return { 
                    color: colors[colorId] || '#ffffff',
                    background: colorId === 'rainbow' ? colors[colorId] : 'transparent',
                    WebkitBackgroundClip: colorId === 'rainbow' ? 'text' : 'initial',
                    WebkitTextFillColor: colorId === 'rainbow' ? 'transparent' : 'initial'
                };
            };

            const getFrameClass = (frameId) => {
                switch(frameId) {
                    case 'basic': return 'frame-basic';
                    case 'silver': return 'frame-silver';
                    case 'gold': return 'frame-gold';
                    case 'diamond': return 'frame-diamond';
                    case 'rainbow': return 'frame-rainbow';
                    case 'platinum': return 'frame-platinum';
                    case 'obsidian': return 'frame-obsidian';
                    case 'emerald': return 'frame-emerald';
                    case 'ruby': return 'frame-ruby';
                    case 'sapphire': return 'frame-sapphire';
                    case 'legendary': return 'frame-legendary';
                    default: return '';
                }
            };

            return (
                <>
                    <AvatarModal
                        isOpen={isAvatarModalOpen}
                        onClose={() => setIsAvatarModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onAvatarChange={onAvatarChange}
                        purchasedAvatars={purchasedAvatars}
                    />
                    
                    <FrameModal
                        isOpen={isFrameModalOpen}
                        onClose={() => setIsFrameModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onFrameChange={onFrameChange}
                        userFrame={userFrame}
                        purchasedFrames={purchasedFrames}
                    />

                    <NameColorModal
                        isOpen={isNameColorModalOpen}
                        onClose={() => setIsNameColorModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onColorChange={onColorChange}
                        purchasedColors={purchasedColors}
                    />

                    <StatusModal
                        isOpen={isStatusModalOpen}
                        onClose={() => setIsStatusModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onStatusChange={onStatusChange}
                        purchasedStatuses={purchasedStatuses}
                    />

                    <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                        <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh]">
                            <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                                <h2 className="text-lg font-bold text-white flex items-center gap-2"><UserIcon size={18} className="text-indigo-500" /> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                                <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                            </div>
                            <div className="flex border-b border-slate-800 bg-slate-900/50 shrink-0 overflow-x-auto">
                                {['profile', 'appearance', 'coins', 'security', 'danger'].map(tab => (
                                    <button 
                                        key={tab} 
                                        onClick={() => setActiveTab(tab)} 
                                        className={`flex-1 py-2 text-xs font-medium transition-colors capitalize min-h-[44px] whitespace-nowrap px-2 ${
                                            activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'
                                        }`}
                                    >
                                        {tab === 'profile' ? '–ü—Ä–æ—Ñ–∏–ª—å' : 
                                         tab === 'appearance' ? '–í–Ω–µ—à–Ω–æ—Å—Ç—å' :
                                         tab === 'coins' ? '–ö–æ–∏–Ω—Å—ã' : 
                                         tab === 'security' ? '–ü–∞—Ä–æ–ª—å' : '–£–¥–∞–ª–∏—Ç—å'}
                                    </button>
                                ))}
                            </div>
                            <div className="p-4 overflow-y-auto custom-scrollbar flex-1">
                                {message.text && (
                                    <div className={`mb-3 p-2 rounded-lg text-xs text-center ${
                                        message.type === 'error' ? 'text-red-400 bg-red-500/10' : 'text-green-400 bg-green-500/10'
                                    }`}>
                                        {message.text}
                                    </div>
                                )}
                                
                                {activeTab === 'profile' && (
                                    <div className="space-y-4 text-center">
                                        <div className={`w-20 h-20 mx-auto rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-3xl shadow-xl ${getFrameClass(userFrame)}`}>
                                            {userAvatar || currentUser[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-bold" style={getNameColorStyle(userNameColor)}>{currentUser}</h3>
                                            <p className="text-slate-400 text-sm flex items-center justify-center gap-1">
                                                {userStatusEmoji} {userStatus || '–í —Å–µ—Ç–∏'}
                                            </p>
                                        </div>
                                        <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-3">
                                            <div className="flex items-center justify-center gap-2 text-yellow-500">
                                                <Coins size={18} />
                                                <span className="font-bold text-md">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</span>
                                            </div>
                                        </div>
                                        <Button 
                                            variant="secondary" 
                                            onClick={onLogout} 
                                            className="w-full text-sm" 
                                            icon={<LogOut size={16} />}
                                        >
                                            –í—ã–π—Ç–∏
                                        </Button>
                                    </div>
                                )}

                                {activeTab === 'appearance' && (
                                    <div className="space-y-3">
                                        <div className="settings-grid">
                                            <Button 
                                                onClick={() => setIsAvatarModalOpen(true)}
                                                variant="secondary"
                                                className="flex-col h-auto py-3"
                                                icon={<UserIcon size={16} />}
                                            >
                                                –ê–≤–∞—Ç–∞—Ä–∫–∞
                                            </Button>
                                            <Button 
                                                onClick={() => setIsFrameModalOpen(true)}
                                                variant="secondary"
                                                className="flex-col h-auto py-3"
                                                icon={<ImageIcon size={16} />}
                                            >
                                                –†–∞–º–∫–∞
                                            </Button>
                                            <Button 
                                                onClick={() => setIsNameColorModalOpen(true)}
                                                variant="secondary"
                                                className="flex-col h-auto py-3"
                                                icon={<Palette size={16} />}
                                            >
                                                –¶–≤–µ—Ç –∏–º–µ–Ω–∏
                                            </Button>
                                            <Button 
                                                onClick={() => setIsStatusModalOpen(true)}
                                                variant="secondary"
                                                className="flex-col h-auto py-3"
                                                icon={<Edit3 size={16} />}
                                            >
                                                –°—Ç–∞—Ç—É—Å
                                            </Button>
                                        </div>
                                        <div className="text-xs text-slate-400 text-center">
                                            –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'coins' && (
                                    <div className="space-y-3">
                                        <div className="text-center p-3 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                                            <div className="flex items-center justify-center gap-2 text-yellow-500 mb-1">
                                                <Coins size={20} />
                                                <span className="font-bold text-lg">{userCoins.toFixed(3)}</span>
                                            </div>
                                            <p className="text-slate-400 text-xs">–í–∞—à –±–∞–ª–∞–Ω—Å –∫–æ–∏–Ω–æ–≤</p>
                                        </div>
                                        
                                        {currentUser === 'kayivi' && (
                                            <>
                                                <div className="space-y-2 p-3 bg-green-500/10 border border-green-500/20 rounded-xl">
                                                    <div className="flex items-center gap-2 text-green-500 mb-1">
                                                        <Crown size={14} />
                                                        <span className="font-bold text-sm">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã —Å–µ–±–µ</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <input 
                                                            type="number" 
                                                            step="0.001"
                                                            placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                            value={coinsToAdd} 
                                                            onChange={e => setCoinsToAdd(e.target.value)}
                                                            className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-green-500 outline-none text-sm" 
                                                        />
                                                        <Button 
                                                            onClick={handleAddCoins} 
                                                            isLoading={isLoading}
                                                            variant="gold"
                                                            className="whitespace-nowrap text-xs"
                                                        >
                                                            –î–æ–±–∞–≤–∏—Ç—å
                                                        </Button>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2 p-3 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                                                    <div className="flex items-center gap-2 text-blue-500 mb-1">
                                                        <Crown size={14} />
                                                        <span className="font-bold text-sm">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã –¥—Ä—É–≥–æ–º—É</span>
                                                    </div>
                                                    <div className="space-y-2">
                                                        <input 
                                                            type="text" 
                                                            placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                                            value={targetUserToAdd} 
                                                            onChange={e => setTargetUserToAdd(e.target.value)}
                                                            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-blue-500 outline-none text-sm" 
                                                        />
                                                        <div className="flex gap-2">
                                                            <input 
                                                                type="number" 
                                                                step="0.001"
                                                                placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                                value={coinsToAddToOther} 
                                                                onChange={e => setCoinsToAddToOther(e.target.value)}
                                                                className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-blue-500 outline-none text-sm" 
                                                            />
                                                            <Button 
                                                                onClick={handleAddCoinsToOther} 
                                                                isLoading={isLoading}
                                                                variant="primary"
                                                                className="whitespace-nowrap text-xs"
                                                            >
                                                                –î–æ–±–∞–≤–∏—Ç—å
                                                            </Button>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2 p-3 bg-red-500/10 border border-red-500/20 rounded-xl">
                                                    <div className="flex items-center gap-2 text-red-500 mb-1">
                                                        <Crown size={14} />
                                                        <span className="font-bold text-sm">–£–±–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã</span>
                                                    </div>
                                                    <div className="space-y-2">
                                                        <input 
                                                            type="text" 
                                                            placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                                            value={targetUser} 
                                                            onChange={e => setTargetUser(e.target.value)}
                                                            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-red-500 outline-none text-sm" 
                                                        />
                                                        <div className="flex gap-2">
                                                            <input 
                                                                type="number" 
                                                                step="0.001"
                                                                placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                                value={coinsToRemove} 
                                                                onChange={e => setCoinsToRemove(e.target.value)}
                                                                className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-red-500 outline-none text-sm" 
                                                            />
                                                            <Button 
                                                                onClick={handleRemoveCoins} 
                                                                isLoading={isLoading}
                                                                variant="danger"
                                                                className="whitespace-nowrap text-xs"
                                                            >
                                                                –£–±–∞–≤–∏—Ç—å
                                                            </Button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </>
                                        )}

                                        <div className="text-slate-400 text-xs space-y-1">
                                            <p>üíé 1 –∫–ª–∏–∫ = +0.001 –∫–æ–∏–Ω (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)</p>
                                            <p>ü§ñ –ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä = 10 –∫–æ–∏–Ω–æ–≤ + —É–ª—É—á—à–µ–Ω–∏—è</p>
                                            <p>üîÑ –ê–≤–∞—Ç–∞—Ä–∫–∏ = –æ—Ç 50 –¥–æ 3000 –∫–æ–∏–Ω–æ–≤</p>
                                            <p>üñºÔ∏è –†–∞–º–∫–∏ = –æ—Ç 50 –¥–æ 10000 –∫–æ–∏–Ω–æ–≤</p>
                                            <p>üé® –¶–≤–µ—Ç –∏–º–µ–Ω–∏ = 50 –∫–æ–∏–Ω–æ–≤</p>
                                            <p>üí¨ –°—Ç–∞—Ç—É—Å = 50 –∫–æ–∏–Ω–æ–≤</p>
                                            <p>üé∞ –ö–∞–∑–∏–Ω–æ = 5 –∏–≥—Ä —Å –≤—ã—Å–æ–∫–∏–º–∏ —à–∞–Ω—Å–∞–º–∏!</p>
                                            <p>üéÅ NFT = –æ—Ç 600 –¥–æ 3000 –∫–æ–∏–Ω–æ–≤</p>
                                            {currentUser === 'kayivi' && (
                                                <p className="text-green-500">üëë –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã</p>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {activeTab === 'security' && (
                                    <div className="space-y-3">
                                        <input 
                                            type="password" 
                                            placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" 
                                            value={oldPassword} 
                                            onChange={e => setOldPassword(e.target.value)} 
                                            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                        />
                                        <input 
                                            type="password" 
                                            placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" 
                                            value={newPassword} 
                                            onChange={e => setNewPassword(e.target.value)} 
                                            className="w-full bg-slate-800 border border-slate-700 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                        />
                                        <Button 
                                            onClick={handleChangePassword} 
                                            isLoading={isLoading} 
                                            disabled={!oldPassword || !newPassword} 
                                            className="w-full text-sm"
                                        >
                                            –û–±–Ω–æ–≤–∏—Ç—å
                                        </Button>
                                    </div>
                                )}

                                {activeTab === 'danger' && (
                                    <div className="space-y-3 p-3 bg-red-500/5 border border-red-500/10 rounded-xl">
                                        <p className="text-xs text-slate-400">–í–≤–µ–¥–∏—Ç–µ <b>{currentUser}</b> –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.</p>
                                        <input 
                                            type="text" 
                                            placeholder={currentUser} 
                                            value={confirmDelete} 
                                            onChange={e => setConfirmDelete(e.target.value)} 
                                            className="w-full bg-slate-800 border border-red-900/30 rounded-xl px-3 py-2 text-white focus:border-red-500 outline-none text-sm" 
                                        />
                                        <Button 
                                            variant="danger" 
                                            onClick={handleDeleteAccount} 
                                            isLoading={isLoading} 
                                            disabled={confirmDelete !== currentUser} 
                                            className="w-full text-sm"
                                        >
                                            –£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
                                        </Button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </>
            );
        };

        // 13. Message Bubble
        const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•'];
        const MessageBubble = ({ message, isOwn, chatId, messageId, currentUser }) => {
            const [showActions, setShowActions] = useState(false);
            const [showReactions, setShowReactions] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setShowActions(false); setShowReactions(false);
                    }
                };
                if (showActions || showReactions) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showActions, showReactions]);

            const handleDelete = async () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    try {
                        await update(ref(db, `messages/${chatId}/${messageId}`), { deleted: true });
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                }
                setShowActions(false);
            };

            const handleReaction = async (emoji) => {
                try {
                    const msgRef = ref(db, `messages/${chatId}/${messageId}/reactions`);
                    const currentReactions = message.reactions || {};
                    if (currentReactions[currentUser] === emoji) {
                        await update(msgRef, { [currentUser]: null });
                    } else {
                        await update(msgRef, { [currentUser]: emoji });
                    }
                    setShowReactions(false); setShowActions(false);
                } catch (error) {
                    console.error('Reaction error:', error);
                }
            };

            if (message.deleted) return null;

            const renderContent = () => {
                switch (message.type) {
                    case 'photo': return <div className="relative group"><img src={message.mediaUrl} alt="Photo" className="max-w-full sm:max-w-[280px] max-h-[300px] object-cover rounded-lg" loading="lazy" /></div>;
                    case 'video': return <video controls src={message.mediaUrl} className="max-w-full sm:max-w-[280px] max-h-[300px] rounded-lg bg-black" playsInline />;
                    case 'audio': return <div className="flex items-center gap-2 min-w-[160px]"><div className={`p-1.5 rounded-full ${isOwn ? 'bg-white/20' : 'bg-indigo-500/20 text-indigo-400'}`}><Mic size={14}/></div><audio controls src={message.mediaUrl} className="h-7 w-full max-w-[160px]" /></div>;
                    case 'nft_gift': return (
                        <div className="nft-gift-message">
                            <div className="text-4xl mb-2">{message.nftData?.emoji}</div>
                            <p className="text-white font-bold">{message.text}</p>
                            <p className="text-yellow-200 text-sm mt-1">üéÅ –í–∞–º –ø–æ–¥–∞—Ä–∏–ª–∏ NFT!</p>
                        </div>
                    );
                    default: return <p className="break-words whitespace-pre-wrap leading-relaxed text-[14px]">{message.text}</p>;
                }
            };

            return (
                <div className={`group flex mb-3 ${isOwn ? 'justify-end' : 'justify-start'} animate-slide-up relative z-0`} ref={containerRef}>
                    <div className={`relative max-w-[85%] sm:max-w-[70%] rounded-2xl px-3 py-2 shadow-sm transition-all ${isOwn ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-100 rounded-bl-none border border-slate-700'}`}>
                        <button onClick={(e) => { e.stopPropagation(); setShowActions(!showActions); if(!showActions) setShowReactions(false); }} className={`absolute -top-2 ${isOwn ? 'left-0' : 'right-0'} p-1 rounded-full bg-slate-800 border border-slate-700 shadow-md text-slate-400 z-10 hover:text-white hover:scale-110`}><MoreVertical size={12} /></button>
                        
                        {showActions && (
                            <div className={`absolute -top-12 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex items-center p-1 gap-1 animate-fade-in`}>
                                <button onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); }} className="p-1.5 rounded-lg hover:bg-slate-800 text-slate-300"><Smile size={16} /></button>
                                {isOwn && <><div className="w-px h-4 bg-slate-800 mx-0.5"></div><button onClick={(e) => { e.stopPropagation(); handleDelete(); }} className="p-1.5 rounded-lg hover:bg-red-500/20 text-red-400"><Trash2 size={16} /></button></>}
                            </div>
                        )}
                        
                        {showReactions && (
                            <div className={`absolute -top-24 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl z-50 flex flex-wrap max-w-[140px] p-1.5 gap-1.5 animate-fade-in`}>
                                {EMOJIS.map(emoji => <button key={emoji} onClick={(e) => { e.stopPropagation(); handleReaction(emoji); }} className="hover:bg-slate-800 p-1 rounded-lg text-lg">{emoji}</button>)}
                            </div>
                        )}

                        {renderContent()}
                        <div className={`flex items-center justify-end gap-1 mt-1 text-[9px] ${isOwn ? 'text-indigo-200' : 'text-slate-500'} font-medium`}><span>{format(message.timestamp, 'HH:mm')}</span></div>
                        
                        {message.reactions && Object.keys(message.reactions).length > 0 && (
                            <div className={`absolute -bottom-2 ${isOwn ? 'left-0' : 'right-0'} flex -space-x-1 cursor-pointer`} onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); setShowActions(true); }}>
                                {Object.entries(message.reactions).slice(0, 4).map(([user, emoji]) => (
                                    <div key={user} className="bg-slate-800 border border-slate-700 rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-md z-10" title={user}>{emoji}</div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 14. Clicker Component
        const Clicker = ({ userCoins, onCoinClick, currentUser, clickerLevel }) => {
            const [showCoin, setShowCoin] = useState(false);
            const [coinPosition, setCoinPosition] = useState({ x: 0, y: 0 });

            const handleClick = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                setCoinPosition({ x, y });
                setShowCoin(true);
                onCoinClick();
                
                setTimeout(() => setShowCoin(false), 500);
            };

            const coinsPerClick = 0.001 + (clickerLevel * 0.004);

            return (
                <div className="relative">
                    {showCoin && (
                        <div 
                            className="absolute text-yellow-500 text-xl font-bold coin-animation z-50"
                            style={{ left: coinPosition.x, top: coinPosition.y }}
                        >
                            +{coinsPerClick.toFixed(3)}
                        </div>
                    )}
                    <button
                        onClick={handleClick}
                        className="w-full bg-gradient-to-br from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white p-4 rounded-2xl shadow-2xl shadow-yellow-500/25 transition-all duration-200 active:scale-95 border-2 border-yellow-400/50 animate-pulse-gold"
                    >
                        <div className="text-center">
                            <Coins size={36} className="mx-auto mb-1" />
                            <div className="text-xl font-bold mb-1">{userCoins.toFixed(3)}</div>
                            <div className="text-yellow-200 text-xs">–ö–ª–∏–∫–Ω–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞!</div>
                            <div className="text-yellow-300/80 text-[10px] mt-0.5">+{coinsPerClick.toFixed(3)} –∑–∞ –∫–ª–∏–∫</div>
                            <div className="text-yellow-300/70 text-[10px]">–£—Ä–æ–≤–µ–Ω—å: {clickerLevel}</div>
                        </div>
                    </div>
                </div>
            );
        };

        // Helper function to get frame class
        const getFrameClass = (frameId) => {
            switch(frameId) {
                case 'basic': return 'frame-basic';
                case 'silver': return 'frame-silver';
                case 'gold': return 'frame-gold';
                case 'diamond': return 'frame-diamond';
                case 'rainbow': return 'frame-rainbow';
                case 'platinum': return 'frame-platinum';
                case 'obsidian': return 'frame-obsidian';
                case 'emerald': return 'frame-emerald';
                case 'ruby': return 'frame-ruby';
                case 'sapphire': return 'frame-sapphire';
                case 'legendary': return 'frame-legendary';
                default: return '';
            }
        };

        // Helper function to get name color style
        const getNameColorStyle = (colorId) => {
            const colors = {
                'red': '#ef4444',
                'orange': '#f97316',
                'yellow': '#eab308',
                'green': '#22c55e',
                'blue': '#3b82f6',
                'purple': '#a855f7',
                'pink': '#ec4899',
                'cyan': '#06b6d4',
                'rainbow': 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)'
            };
            return { 
                color: colors[colorId] || '#ffffff',
                background: colorId === 'rainbow' ? colors[colorId] : 'transparent',
                WebkitBackgroundClip: colorId === 'rainbow' ? 'text' : 'initial',
                WebkitTextFillColor: colorId === 'rainbow' ? 'transparent' : 'initial'
            };
        };

        // --- Main App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [isLoginView, setIsLoginView] = useState(true);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [chats, setChats] = useState([]);
            const [areChatsLoading, setAreChatsLoading] = useState(false);
            const [activeChatUser, setActiveChatUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isFrameModalOpen, setIsFrameModalOpen] = useState(false);
            const [isCasinoModalOpen, setIsCasinoModalOpen] = useState(false);
            const [isNameColorModalOpen, setIsNameColorModalOpen] = useState(false);
            const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);
            const [isNFTMarketOpen, setIsNFTMarketOpen] = useState(false);
            const [isTransferCoinsOpen, setIsTransferCoinsOpen] = useState(false);
            const [isUserProfileOpen, setIsUserProfileOpen] = useState(false);
            const [isLeaderboardOpen, setIsLeaderboardOpen] = useState(false);
            const [selectedUserProfile, setSelectedUserProfile] = useState(null);
            const [showMobileSidebar, setShowMobileSidebar] = useState(true);
            const [isRecording, setIsRecording] = useState(false);
            const [connectionError, setConnectionError] = useState('');
            const [userCoins, setUserCoins] = useState(0);
            const [userAvatar, setUserAvatar] = useState('');
            const [userFrame, setUserFrame] = useState('');
            const [userNameColor, setUserNameColor] = useState('');
            const [userStatus, setUserStatus] = useState('');
            const [userStatusEmoji, setUserStatusEmoji] = useState('');
            const [userNFTs, setUserNFTs] = useState([]);
            const [clickerLevel, setClickerLevel] = useState(0);
            const [autoClickerActive, setAutoClickerActive] = useState(false);
            const [autoClickerStartTime, setAutoClickerStartTime] = useState(null);
            const [usersData, setUsersData] = useState({});
            const [purchasedAvatars, setPurchasedAvatars] = useState([]);
            const [purchasedFrames, setPurchasedFrames] = useState([]);
            const [purchasedColors, setPurchasedColors] = useState([]);
            const [purchasedStatuses, setPurchasedStatuses] = useState([]);
            const mediaRecorderRef = useRef(null);
            const messagesEndRef = useRef(null);
            const autoClickerIntervalRef = useRef(null);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            useEffect(() => {
                if (currentUser) {
                    const userRef = ref(db, `users/${currentUser}`);
                    const unsubscribe = onValue(userRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUserCoins(data.coins || 0);
                            setUserAvatar(data.avatar || '');
                            setUserFrame(data.frame || '');
                            setUserNameColor(data.nameColor || '');
                            setUserStatus(data.status || '');
                            setUserStatusEmoji(data.statusEmoji || '');
                            setUserNFTs(data.nfts || []);
                            setClickerLevel(data.clickerLevel || 0);
                            setAutoClickerActive(data.autoClickerActive || false);
                            setAutoClickerStartTime(data.autoClickerStartTime || null);
                            setPurchasedAvatars(data.purchasedAvatars || []);
                            setPurchasedFrames(data.purchasedFrames || []);
                            setPurchasedColors(data.purchasedColors || []);
                            setPurchasedStatuses(data.purchasedStatuses || []);
                        }
                    });
                    
                    return () => off(userRef);
                }
            }, [currentUser]);

            // –ê–≤—Ç–æ–∫–ª–∏–∫–µ—Ä
            useEffect(() => {
                if (autoClickerActive && currentUser) {
                    const coinsPerClick = 0.001 + (clickerLevel * 0.004);
                    
                    autoClickerIntervalRef.current = setInterval(async () => {
                        try {
                            await update(ref(db, `users/${currentUser}`), { 
                                coins: userCoins + coinsPerClick
                            });
                            setUserCoins(prev => prev + coinsPerClick);
                        } catch (error) {
                            console.error('Auto clicker error:', error);
                        }
                    }, 10000); // –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                    
                    return () => {
                        if (autoClickerIntervalRef.current) {
                            clearInterval(autoClickerIntervalRef.current);
                        }
                    };
                }
            }, [autoClickerActive, currentUser, userCoins, clickerLevel]);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–∞
            useEffect(() => {
                if (autoClickerActive && autoClickerStartTime) {
                    const thirtyMinutes = 30 * 60 * 1000;
                    const checkInterval = setInterval(() => {
                        const elapsed = Date.now() - autoClickerStartTime;
                        if (elapsed >= thirtyMinutes) {
                            handleAutoClickerToggle(false);
                        }
                    }, 60000);
                    
                    return () => clearInterval(checkInterval);
                }
            }, [autoClickerActive, autoClickerStartTime]);

            const handleAutoClickerToggle = async (active) => {
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        autoClickerActive: active,
                        autoClickerStartTime: active ? Date.now() : null
                    });
                    setAutoClickerActive(active);
                    setAutoClickerStartTime(active ? Date.now() : null);
                    
                    if (!active && autoClickerIntervalRef.current) {
                        clearInterval(autoClickerIntervalRef.current);
                    }
                } catch (error) {
                    console.error('Auto clicker toggle error:', error);
                }
            };

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            useEffect(() => {
                if (currentUser) {
                    const usersRef = ref(db, 'users');
                    const unsubscribe = onValue(usersRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUsersData(data);
                        }
                    });
                    
                    return () => off(usersRef);
                }
            }, [currentUser]);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase
            useEffect(() => {
                if (currentUser) {
                    const testConnection = async () => {
                        try {
                            const testRef = ref(db, '.info/connected');
                            onValue(testRef, (snapshot) => {
                                if (snapshot.val() === true) {
                                    setConnectionError('');
                                } else {
                                    setConnectionError('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                                }
                            });
                        } catch (error) {
                            setConnectionError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase');
                        }
                    };
                    testConnection();
                }
            }, [currentUser]);

            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
            useEffect(() => {
                if (currentUser) {
                    setAreChatsLoading(true);
                    const userRef = ref(db, `users/${currentUser}`);
                    
                    update(userRef, { 
                        isOnline: true, 
                        lastSeen: Date.now() 
                    }).catch(error => {
                        console.warn('Cannot update user status:', error);
                    });
                    
                    const messagesRef = ref(db, 'messages');
                    const unsubscribe = onValue(messagesRef, (snapshot) => {
                        setAreChatsLoading(false);
                        const data = snapshot.val();
                        if (!data) { 
                            setChats([]); 
                            return; 
                        }
                        
                        const newChats = new Map();
                        
                        Object.entries(data).forEach(([chatId, chatMessages]) => {
                            const usersInChat = chatId.split('_');
                            if (usersInChat.includes(currentUser)) {
                                const otherUser = usersInChat.find(user => user !== currentUser) || currentUser;
                                
                                if (chatMessages && Object.keys(chatMessages).length > 0) {
                                    const messagesList = Object.values(chatMessages)
                                        .filter(m => m && !m.deleted)
                                        .sort((a, b) => b.timestamp - a.timestamp);
                                    
                                    if (messagesList.length > 0) {
                                        newChats.set(otherUser, { 
                                            user: otherUser, 
                                            lastMessage: messagesList[0], 
                                            timestamp: messagesList[0].timestamp 
                                        });
                                    }
                                }
                            }
                        });
                        
                        setChats(Array.from(newChats.values()).sort((a, b) => b.timestamp - a.timestamp));
                    }, (error) => {
                        console.error('Chats loading error:', error);
                        setAreChatsLoading(false);
                        setConnectionError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
                    });
                    
                    return () => { 
                        off(messagesRef); 
                        update(userRef, { isOnline: false }).catch(()=>{}); 
                    };
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            useEffect(() => {
                if (currentUser && activeChatUser) {
                    const chatId = [currentUser, activeChatUser].sort().join('_');
                    const chatRef = ref(db, `messages/${chatId}`);
                    
                    const unsubscribe = onValue(chatRef, (snapshot) => {
                        const data = snapshot.val();
                        
                        if (!data) {
                            setMessages([]);
                            return;
                        }
                        
                        const messagesArray = Object.entries(data)
                            .map(([id, message]) => ({
                                id,
                                ...message
                            }))
                            .filter(msg => !msg.deleted);
                        
                        const sortedMessages = messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        setMessages(sortedMessages);
                    }, (error) => {
                        console.error('Messages loading error:', error);
                        setConnectionError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
                    });
                    
                    setShowMobileSidebar(false);
                    return () => off(chatRef);
                } else { 
                    setShowMobileSidebar(true); 
                    setMessages([]);
                }
            }, [currentUser, activeChatUser]);

            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            useEffect(() => { 
                if (messages.length > 0) {
                    setTimeout(() => {
                        messagesEndRef.current?.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'end'
                        });
                    }, 100);
                }
            }, [messages]);

            const handleAuth = () => {
                if (!usernameInput.trim() || !passwordInput.trim()) return;
                const cleanUsername = usernameInput.trim();
                const userRef = ref(db, `users/${cleanUsername}`);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (isLoginView) {
                        if (data && data.password === passwordInput) {
                            localStorage.setItem('dolbaeb_user', cleanUsername); 
                            setCurrentUser(cleanUsername); 
                            setAuthError('');
                        } else { 
                            setAuthError('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); 
                        }
                    } else {
                        if (data) { 
                            setAuthError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); 
                        } else {
                            set(userRef, { 
                                username: cleanUsername, 
                                password: passwordInput, 
                                createdAt: Date.now(), 
                                isOnline: true, 
                                lastSeen: Date.now(),
                                coins: 0,
                                avatar: '',
                                frame: '',
                                nameColor: '',
                                status: '',
                                statusEmoji: '',
                                nfts: [],
                                clickerLevel: 0,
                                autoClickerActive: false,
                                autoClickerStartTime: null,
                                purchasedAvatars: [],
                                purchasedFrames: [],
                                purchasedColors: [],
                                purchasedStatuses: []
                            }).then(() => { 
                                localStorage.setItem('dolbaeb_user', cleanUsername); 
                                setCurrentUser(cleanUsername); 
                                setAuthError(''); 
                            }).catch(error => {
                                console.error('Registration error:', error);
                                setAuthError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.');
                            });
                        }
                    }
                }, { onlyOnce: true });
            };

            const handleLogout = () => {
                if(currentUser) {
                    update(ref(db, `users/${currentUser}`), { 
                        isOnline: false, 
                        lastSeen: Date.now(),
                        autoClickerActive: false
                    }).catch(() => {});
                }
                localStorage.removeItem('dolbaeb_user'); 
                setCurrentUser(null); 
                setActiveChatUser(null); 
                setChats([]); 
                setIsSettingsOpen(false);
                setUserCoins(0);
                setUserAvatar('');
                setUserFrame('');
                setUserNameColor('');
                setUserStatus('');
                setUserStatusEmoji('');
                setUserNFTs([]);
                setClickerLevel(0);
                setAutoClickerActive(false);
                setAutoClickerStartTime(null);
                setPurchasedAvatars([]);
                setPurchasedFrames([]);
                setPurchasedColors([]);
                setPurchasedStatuses([]);
                
                if (autoClickerIntervalRef.current) {
                    clearInterval(autoClickerIntervalRef.current);
                }
            };

            const handleCoinClick = async () => {
                try {
                    const coinsPerClick = 0.001 + (clickerLevel * 0.004);
                    const newCoins = userCoins + coinsPerClick;
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: newCoins 
                    });
                    setUserCoins(newCoins);
                } catch (error) {
                    console.error('Coin update error:', error);
                }
            };

            const handleSendMessage = async (type = 'text', content = messageInput) => {
                if ((!content.trim() && type === 'text') || !currentUser || !activeChatUser) return;
                
                const chatId = [currentUser, activeChatUser].sort().join('_');
                const timestamp = Date.now();
                
                try {
                    const messageRef = push(ref(db, `messages/${chatId}`));
                    
                    const messageData = {
                        sender: currentUser, 
                        text: type === 'text' ? content : '', 
                        timestamp: timestamp,
                        type, 
                        deleted: false
                    };
                    
                    if (type !== 'text' && content) {
                        messageData.mediaUrl = content;
                    }
                    
                    await set(messageRef, messageData);
                    
                    if (type === 'text') setMessageInput('');
                } catch (e) { 
                    console.error("Send error details:", e);
                    if (e.code === 'PERMISSION_DENIED') {
                        alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Firebase Database.");
                    } else {
                        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + (e.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'));
                    }
                }
            };

            const handleSearch = (term) => {
                setSearchQuery(term);
                if (!term.trim()) { 
                    setSearchResults([]); 
                    return; 
                }
                const q = query(ref(db, 'users'), orderByChild('username'), startAt(term), endAt(term + '\uf8ff'));
                onValue(q, (snapshot) => {
                    const data = snapshot.val();
                    setSearchResults(data ? Object.values(data).filter(u => u.username !== currentUser) : []);
                }, { onlyOnce: true });
            };

            const handleFileUpload = (e, type) => {
                const file = e.target.files?.[0];
                if (!file || file.size > 8 * 1024 * 1024) { 
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 8MB'); 
                    return; 
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    if (ev.target.result) {
                        handleSendMessage(type, ev.target.result);
                    }
                };
                reader.onerror = () => {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                };
                reader.readAsDataURL(file); 
                e.target.value = '';
            };

            const toggleRecording = async () => {
                if (isRecording) { 
                    mediaRecorderRef.current?.stop(); 
                    setIsRecording(false); 
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 
                                         MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
                        
                        const mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
                        const audioChunks = [];
                        
                        mediaRecorder.ondataavailable = (e) => { 
                            if (e.data.size > 0) audioChunks.push(e.data); 
                        };
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                if (e.target.result) {
                                    handleSendMessage('audio', e.target.result);
                                }
                            };
                            reader.readAsDataURL(blob);
                            stream.getTracks().forEach(t => t.stop());
                        };
                        mediaRecorder.start(); 
                        setIsRecording(true); 
                        mediaRecorderRef.current = mediaRecorder;
                    } catch (err) { 
                        alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"); 
                    }
                }
            };

            const handleOpenUserProfile = (user) => {
                setSelectedUserProfile(user);
                setIsUserProfileOpen(true);
            };

            const getActiveNFTs = () => {
                return userNFTs.filter(nft => !nft.hidden).slice(0, 3);
            };

            const getOrbitClass = (index) => {
                switch(index) {
                    case 0: return 'nft-orbit-slow';
                    case 1: return 'nft-orbit-medium';
                    case 2: return 'nft-orbit-fast';
                    default: return 'nft-orbit-slow';
                }
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-slate-950 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-950 to-slate-950 safe-area-top safe-area-bottom">
                        <div className="w-full max-w-md bg-slate-900/60 backdrop-blur-xl p-6 rounded-3xl shadow-2xl border border-indigo-500/20 animate-fade-in relative overflow-hidden">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-white mb-2">DolbaebSMS</h1>
                                <p className="text-slate-400 font-light text-sm">Secure. Fast. Simple.</p>
                            </div>
                            {authError && <div className="p-2 mb-3 rounded-xl bg-red-500/10 text-red-400 text-center text-sm">{authError}</div>}
                            <div className="space-y-3">
                                <input type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none text-sm" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} />
                                <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none text-sm" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAuth()} />
                            </div>
                            <Button className="w-full mt-4 py-3 text-sm" onClick={handleAuth}>{isLoginView ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'}</Button>
                            <div className="text-center mt-4">
                                <button onClick={() => { setIsLoginView(!isLoginView); setAuthError(''); }} className="text-slate-400 hover:text-indigo-400 text-xs">
                                    {isLoginView ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950 safe-area-top">
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        currentUser={currentUser} 
                        onLogout={handleLogout}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userAvatar={userAvatar}
                        userFrame={userFrame}
                        userNameColor={userNameColor}
                        userStatus={userStatus}
                        userStatusEmoji={userStatusEmoji}
                        onAvatarChange={setUserAvatar}
                        onFrameChange={setUserFrame}
                        onColorChange={setUserNameColor}
                        onStatusChange={(status, emoji) => { setUserStatus(status); setUserStatusEmoji(emoji); }}
                        purchasedAvatars={purchasedAvatars}
                        purchasedFrames={purchasedFrames}
                        purchasedColors={purchasedColors}
                        purchasedStatuses={purchasedStatuses}
                    />
                    
                    <AvatarModal
                        isOpen={isAvatarModalOpen}
                        onClose={() => setIsAvatarModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onAvatarChange={setUserAvatar}
                        purchasedAvatars={purchasedAvatars}
                    />
                    
                    <FrameModal
                        isOpen={isFrameModalOpen}
                        onClose={() => setIsFrameModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onFrameChange={setUserFrame}
                        userFrame={userFrame}
                        purchasedFrames={purchasedFrames}
                    />

                    <CasinoModal
                        isOpen={isCasinoModalOpen}
                        onClose={() => setIsCasinoModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                    />

                    <NameColorModal
                        isOpen={isNameColorModalOpen}
                        onClose={() => setIsNameColorModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onColorChange={setUserNameColor}
                        purchasedColors={purchasedColors}
                    />

                    <StatusModal
                        isOpen={isStatusModalOpen}
                        onClose={() => setIsStatusModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onStatusChange={(status, emoji) => { setUserStatus(status); setUserStatusEmoji(emoji); }}
                        purchasedStatuses={purchasedStatuses}
                    />

                    <NFTMarketModal
                        isOpen={isNFTMarketOpen}
                        onClose={() => setIsNFTMarketOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userNFTs={userNFTs}
                        onNFTUpdate={setUserNFTs}
                    />

                    <TransferCoinsModal
                        isOpen={isTransferCoinsOpen}
                        onClose={() => setIsTransferCoinsOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                    />

                    <UserProfileModal
                        isOpen={isUserProfileOpen}
                        onClose={() => setIsUserProfileOpen(false)}
                        user={selectedUserProfile}
                        currentUser={currentUser}
                        onSendMessage={setActiveChatUser}
                    />

                    <LeaderboardModal
                        isOpen={isLeaderboardOpen}
                        onClose={() => setIsLeaderboardOpen(false)}
                        usersData={usersData}
                    />
                    
                    {connectionError && (
                        <div className="fixed top-2 left-1/2 transform -translate-x-1/2 z-50 bg-red-500/90 text-white px-3 py-1 rounded-lg text-xs backdrop-blur-sm max-w-[90vw]">
                            {connectionError}
                        </div>
                    )}
                    
                    {/* Sidebar */}
                    <div className={`${showMobileSidebar ? 'flex' : 'hidden'} md:flex w-full md:w-[380px] flex-col border-r border-slate-800 bg-slate-900 z-10`}>
                        <div className="compact-header p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <div className="flex items-center gap-2">
                                <div className="nft-container">
                                    <button 
                                        onClick={() => setIsAvatarModalOpen(true)}
                                        className={`w-8 h-8 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-sm relative group ${getFrameClass(userFrame)}`}
                                    >
                                        {userAvatar || currentUser[0].toUpperCase()}
                                    </button>
                                    {userNFTs && getActiveNFTs().length > 0 && (
                                        <div className="nft-orbital">
                                            {getActiveNFTs().map((nft, index) => {
                                                const nftsData = [
                                                    { id: 'dragon', emoji: 'üêâ' },
                                                    { id: 'phoenix', emoji: 'ü¶ö' },
                                                    { id: 'unicorn', emoji: 'ü¶Ñ' },
                                                    { id: 'robot', emoji: 'ü§ñ' },
                                                    { id: 'alien', emoji: 'üëΩ' },
                                                    { id: 'ghost', emoji: 'üëª' },
                                                    { id: 'dinosaur', emoji: 'ü¶ñ' },
                                                    { id: 'spaceship', emoji: 'üöÄ' },
                                                    { id: 'comet', emoji: '‚òÑÔ∏è' },
                                                    { id: 'treasure', emoji: 'üíé' },
                                                    { id: 'panda', emoji: 'üêº' },
                                                    { id: 'tiger', emoji: 'üêØ' },
                                                    { id: 'eagle', emoji: 'ü¶Ö' },
                                                    { id: 'whale', emoji: 'üêã' },
                                                    { id: 'lion', emoji: 'ü¶Å' },
                                                    { id: 'fox', emoji: 'ü¶ä' }
                                                ];
                                                const nftData = nftsData.find(n => n.id === nft.id);
                                                if (!nftData) return null;
                                                return (
                                                    <div 
                                                        key={nft.id}
                                                        className={`nft-item ${getOrbitClass(index)}`}
                                                    >
                                                        {nftData.emoji}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <h2 className="font-bold text-white text-sm flex items-center gap-1" style={getNameColorStyle(userNameColor)}>
                                        {currentUser}
                                        {currentUser === 'kayivi' && <Crown size={12} className="text-yellow-500" />}
                                    </h2>
                                    <span className="text-[10px] text-green-500 flex items-center gap-1">
                                        ‚óè {userStatusEmoji} {userStatus || '–í —Å–µ—Ç–∏'}
                                    </span>
                                </div>
                            </div>
                            <div className="compact-header-buttons flex items-center gap-1">
                                <button 
                                    onClick={() => setIsCasinoModalOpen(true)}
                                    className="p-1.5 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–ö–∞–∑–∏–Ω–æ"
                                >
                                    <Trophy size={16} />
                                </button>
                                <button 
                                    onClick={() => setIsNFTMarketOpen(true)}
                                    className="p-1.5 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="NFT –ú–∞–≥–∞–∑–∏–Ω"
                                >
                                    <TrendingUp size={16} />
                                </button>
                                <button 
                                    onClick={() => setIsLeaderboardOpen(true)}
                                    className="p-1.5 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤"
                                >
                                    <Award size={16} />
                                </button>
                                <button 
                                    onClick={() => setIsTransferCoinsOpen(true)}
                                    className="p-1.5 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–ü–µ—Ä–µ–≤–æ–¥ –∫–æ–∏–Ω–æ–≤"
                                >
                                    <SendIcon size={16} />
                                </button>
                                <button 
                                    onClick={() => setIsSettingsOpen(true)}
                                    className="p-1.5 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
                                >
                                    <SettingsIcon size={16} />
                                </button>
                            </div>
                        </div>

                        {/* Clicker Section */}
                        <div className="p-3 border-b border-slate-800 shrink-0">
                            <Clicker 
                                userCoins={userCoins} 
                                onCoinClick={handleCoinClick}
                                currentUser={currentUser}
                                clickerLevel={clickerLevel}
                            />
                            
                            <AutoClicker
                                userCoins={userCoins}
                                onCoinsUpdate={setUserCoins}
                                currentUser={currentUser}
                                clickerLevel={clickerLevel}
                                onUpgradeClicker={setClickerLevel}
                                autoClickerActive={autoClickerActive}
                                onAutoClickerToggle={handleAutoClickerToggle}
                                autoClickerStartTime={autoClickerStartTime}
                            />
                        </div>

                        <div className="p-3 shrink-0">
                            <div className="relative">
                                <Search className="absolute left-2 top-2 text-slate-500" size={16} />
                                <input 
                                    type="text" 
                                    placeholder="–ü–æ–∏—Å–∫..." 
                                    className="w-full bg-slate-800 border border-slate-700 rounded-xl py-2 pl-8 text-slate-200 outline-none focus:border-indigo-500 text-sm" 
                                    value={searchQuery} 
                                    onChange={e => handleSearch(e.target.value)} 
                                />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-1">
                            {areChatsLoading ? (
                                <div className="flex flex-col items-center justify-center mt-8 text-slate-500 gap-1">
                                    <Loader2 className="animate-spin text-indigo-500" size={20} />
                                    <p className="text-xs">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                                </div>
                            ) : searchQuery ? (
                                searchResults.length ? searchResults.map(u => (
                                    <div 
                                        key={u.username} 
                                        onClick={() => { 
                                            setActiveChatUser(u.username); 
                                            setSearchQuery(''); 
                                            setSearchResults([]); 
                                        }} 
                                        className="p-2 flex items-center gap-2 rounded-xl hover:bg-slate-800 cursor-pointer"
                                    >
                                        <div className="nft-container">
                                            <div className={`w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-slate-300 font-bold border border-slate-700 text-md ${getFrameClass(u.frame)}`}>
                                                {u.avatar || u.username[0].toUpperCase()}
                                            </div>
                                            {u.nfts && u.nfts.filter(nft => !nft.hidden).length > 0 && (
                                                <div className="nft-orbital">
                                                    {u.nfts.filter(nft => !nft.hidden).slice(0, 3).map((nft, index) => {
                                                        const nftsData = [
                                                            { id: 'dragon', emoji: 'üêâ' },
                                                            { id: 'phoenix', emoji: 'ü¶ö' },
                                                            { id: 'unicorn', emoji: 'ü¶Ñ' },
                                                            { id: 'robot', emoji: 'ü§ñ' },
                                                            { id: 'alien', emoji: 'üëΩ' },
                                                            { id: 'ghost', emoji: 'üëª' },
                                                            { id: 'dinosaur', emoji: 'ü¶ñ' },
                                                            { id: 'spaceship', emoji: 'üöÄ' },
                                                            { id: 'comet', emoji: '‚òÑÔ∏è' },
                                                            { id: 'treasure', emoji: 'üíé' },
                                                            { id: 'panda', emoji: 'üêº' },
                                                            { id: 'tiger', emoji: 'üêØ' },
                                                            { id: 'eagle', emoji: 'ü¶Ö' },
                                                            { id: 'whale', emoji: 'üêã' },
                                                            { id: 'lion', emoji: 'ü¶Å' },
                                                            { id: 'fox', emoji: 'ü¶ä' }
                                                        ];
                                                        const nftData = nftsData.find(n => n.id === nft.id);
                                                        if (!nftData) return null;
                                                        return (
                                                            <div 
                                                                key={nft.id}
                                                                className={`nft-item ${getOrbitClass(index)}`}
                                                            >
                                                                {nftData.emoji}
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                        <div>
                                            <h3 className="font-medium text-slate-200 text-sm" style={getNameColorStyle(u.nameColor)}>{u.username}</h3>
                                            <p className="text-xs text-slate-500 flex items-center gap-1">
                                                {u.statusEmoji} {u.status || '–í —Å–µ—Ç–∏'}
                                            </p>
                                        </div>
                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                handleOpenUserProfile(u);
                                            }}
                                            className="ml-auto p-1 text-slate-500 hover:text-white"
                                        >
                                            <Info size={14} />
                                        </button>
                                    </div>
                                )) : <div className="text-center text-slate-500 mt-3 text-sm">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            ) : (
                                chats.length ? chats.map(c => {
                                    const userData = usersData[c.user];
                                    return (
                                        <div 
                                            key={c.user} 
                                            onClick={() => setActiveChatUser(c.user)} 
                                            className={`p-2 flex items-center gap-2 rounded-xl cursor-pointer hover:bg-slate-800 ${activeChatUser === c.user ? 'bg-slate-800' : ''}`}
                                        >
                                            <div className="nft-container">
                                                <div className={`w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold border border-slate-700 text-md ${getFrameClass(userData?.frame)}`}>
                                                    {userData?.avatar || c.user[0].toUpperCase()}
                                                </div>
                                                {userData?.nfts && userData.nfts.filter(nft => !nft.hidden).length > 0 && (
                                                    <div className="nft-orbital">
                                                        {userData.nfts.filter(nft => !nft.hidden).slice(0, 3).map((nft, index) => {
                                                            const nftsData = [
                                                                { id: 'dragon', emoji: 'üêâ' },
                                                                { id: 'phoenix', emoji: 'ü¶ö' },
                                                                { id: 'unicorn', emoji: 'ü¶Ñ' },
                                                                { id: 'robot', emoji: 'ü§ñ' },
                                                                { id: 'alien', emoji: 'üëΩ' },
                                                                { id: 'ghost', emoji: 'üëª' },
                                                                { id: 'dinosaur', emoji: 'ü¶ñ' },
                                                                { id: 'spaceship', emoji: 'üöÄ' },
                                                                { id: 'comet', emoji: '‚òÑÔ∏è' },
                                                                { id: 'treasure', emoji: 'üíé' },
                                                                { id: 'panda', emoji: 'üêº' },
                                                                { id: 'tiger', emoji: 'üêØ' },
                                                                { id: 'eagle', emoji: 'ü¶Ö' },
                                                                { id: 'whale', emoji: 'üêã' },
                                                                { id: 'lion', emoji: 'ü¶Å' },
                                                                { id: 'fox', emoji: 'ü¶ä' }
                                                            ];
                                                            const nftData = nftsData.find(n => n.id === nft.id);
                                                            if (!nftData) return null;
                                                            return (
                                                                <div 
                                                                    key={nft.id}
                                                                    className={`nft-item ${getOrbitClass(index)}`}
                                                                >
                                                                    {nftData.emoji}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-baseline">
                                                    <h3 className="font-semibold text-slate-200 truncate text-sm" style={getNameColorStyle(userData?.nameColor)}>{c.user}</h3>
                                                    <span className="text-xs text-slate-500">
                                                        {new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                    </span>
                                                </div>
                                                <p className="text-xs text-slate-400 truncate">
                                                    {c.lastMessage.type === 'text' ? c.lastMessage.text : 
                                                     c.lastMessage.type === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 
                                                     c.lastMessage.type === 'video' ? 'üé• –í–∏–¥–µ–æ' : 
                                                     c.lastMessage.type === 'audio' ? 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ' : 
                                                     c.lastMessage.type === 'nft_gift' ? 'üéÅ NFT –ü–æ–¥–∞—Ä–æ–∫' : '–°–æ–æ–±—â–µ–Ω–∏–µ'}
                                                </p>
                                            </div>
                                            <button 
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleOpenUserProfile(userData);
                                                }}
                                                className="ml-1 p-1 text-slate-500 hover:text-white"
                                            >
                                                <Info size={14} />
                                            </button>
                                        </div>
                                    );
                                }) : (
                                    <div className="text-center text-slate-500 mt-8 p-3">
                                        <p className="text-sm">–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                                        <p className="text-xs mt-1">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                                    </div>
                                )
                            )}
                        </div>
                    </div>

                    {/* Chat Area */}
                    {activeChatUser ? (
                        <div className={`${!showMobileSidebar ? 'flex' : 'hidden md:flex'} flex-1 flex-col bg-slate-950 relative`}>
                            <div className="compact-header h-[60px] px-3 flex items-center gap-2 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md sticky top-0 z-20 shrink-0">
                                <button onClick={() => { setActiveChatUser(null); setShowMobileSidebar(true); }} className="md:hidden text-slate-400 p-1">
                                    <ChevronLeft size={20} />
                                </button>
                                <div className="nft-container">
                                    <div className={`w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold ${getFrameClass(usersData[activeChatUser]?.frame)}`}>
                                        {usersData[activeChatUser]?.avatar || activeChatUser[0].toUpperCase()}
                                    </div>
                                    {usersData[activeChatUser]?.nfts && usersData[activeChatUser].nfts.filter(nft => !nft.hidden).length > 0 && (
                                        <div className="nft-orbital">
                                            {usersData[activeChatUser].nfts.filter(nft => !nft.hidden).slice(0, 3).map((nft, index) => {
                                                const nftsData = [
                                                    { id: 'dragon', emoji: 'üêâ' },
                                                    { id: 'phoenix', emoji: 'ü¶ö' },
                                                    { id: 'unicorn', emoji: 'ü¶Ñ' },
                                                    { id: 'robot', emoji: 'ü§ñ' },
                                                    { id: 'alien', emoji: 'üëΩ' },
                                                    { id: 'ghost', emoji: 'üëª' },
                                                    { id: 'dinosaur', emoji: 'ü¶ñ' },
                                                    { id: 'spaceship', emoji: 'üöÄ' },
                                                    { id: 'comet', emoji: '‚òÑÔ∏è' },
                                                    { id: 'treasure', emoji: 'üíé' },
                                                    { id: 'panda', emoji: 'üêº' },
                                                    { id: 'tiger', emoji: 'üêØ' },
                                                    { id: 'eagle', emoji: 'ü¶Ö' },
                                                    { id: 'whale', emoji: 'üêã' },
                                                    { id: 'lion', emoji: 'ü¶Å' },
                                                    { id: 'fox', emoji: 'ü¶ä' }
                                                ];
                                                const nftData = nftsData.find(n => n.id === nft.id);
                                                if (!nftData) return null;
                                                return (
                                                    <div 
                                                        key={nft.id}
                                                        className={`nft-item ${getOrbitClass(index)}`}
                                                    >
                                                        {nftData.emoji}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-200 text-sm" style={getNameColorStyle(usersData[activeChatUser]?.nameColor)}>{activeChatUser}</h3>
                                    <p className="text-xs text-slate-500 flex items-center gap-1">
                                        {usersData[activeChatUser]?.statusEmoji} {usersData[activeChatUser]?.status || '–í —Å–µ—Ç–∏'}
                                    </p>
                                </div>
                                <button 
                                    onClick={() => handleOpenUserProfile(usersData[activeChatUser])}
                                    className="ml-auto p-1 text-slate-500 hover:text-white"
                                >
                                    <Info size={16} />
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-3 custom-scrollbar">
                                {messages.length === 0 ? (
                                    <div className="text-center text-slate-500 mt-8">
                                        <p className="text-sm">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                        <p className="text-xs mt-1">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                                    </div>
                                ) : (
                                    messages.map(msg => (
                                        <MessageBubble 
                                            key={msg.id} 
                                            message={msg} 
                                            isOwn={msg.sender === currentUser} 
                                            chatId={[currentUser, activeChatUser].sort().join('_')} 
                                            messageId={msg.id} 
                                            currentUser={currentUser} 
                                        />
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="p-2 bg-slate-900 border-t border-slate-800 safe-area-bottom shrink-0">
                                <div className="flex items-end gap-2 max-w-4xl mx-auto">
                                    <div className="flex gap-1 bg-slate-800 p-1 rounded-xl shrink-0">
                                        <label className="p-1.5 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <ImageIcon size={16} />
                                            <input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(e, 'photo')} />
                                        </label>
                                        <label className="p-1.5 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <Video size={16} />
                                            <input type="file" className="hidden" accept="video/*" onChange={e => handleFileUpload(e, 'video')} />
                                        </label>
                                        <button 
                                            onClick={toggleRecording} 
                                            className={`p-1.5 rounded-lg ${isRecording ? 'text-red-500 animate-pulse' : 'text-slate-400 hover:text-indigo-400'}`}
                                        >
                                            {isRecording ? <div className="w-4 h-4 bg-red-500 rounded-sm" /> : <Mic size={16} />}
                                        </button>
                                    </div>
                                    <div className="flex-1 min-w-0 bg-slate-800 rounded-2xl border border-slate-700">
                                        <textarea 
                                            value={messageInput} 
                                            onChange={e => setMessageInput(e.target.value)} 
                                            onKeyPress={e => { 
                                                if(e.key === 'Enter' && !e.shiftKey) { 
                                                    e.preventDefault(); 
                                                    handleSendMessage('text'); 
                                                }
                                            }} 
                                            placeholder={isRecording ? "–ó–∞–ø–∏—Å—å..." : "–°–æ–æ–±—â–µ–Ω–∏–µ..."} 
                                            className="w-full bg-transparent text-white px-3 py-2 outline-none resize-none h-[44px] custom-scrollbar text-sm" 
                                            rows="1"
                                        />
                                    </div>
                                    <button 
                                        onClick={() => handleSendMessage('text')} 
                                        disabled={!messageInput.trim() && !isRecording} 
                                        className="p-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 shadow-lg shadow-indigo-600/20 shrink-0"
                                    >
                                        <Send size={16} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="hidden md:flex flex-1 items-center justify-center bg-slate-950 text-slate-500 flex-col gap-3">
                            <div className="w-16 h-16 rounded-full bg-slate-900 border border-slate-800 flex items-center justify-center">
                                <Send size={28} className="text-indigo-500" />
                            </div>
                            <p className="text-sm">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
