<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: { 
              gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' },
              rarity: {
                common: '#6b7280',
                rare: '#3b82f6', 
                epic: '#8b5cf6',
                legendary: '#f59e0b',
                mythical: '#ef4444'
              }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-gold': 'pulseGold 2s infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              pulseGold: { '0%, 100%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.05)', opacity: '0.8' } }
            }
          }
        }
      }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      * { box-sizing: border-box; }
      body { background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: none; height: 100vh; overflow: hidden; }
      #root { height: 100vh; overflow: hidden; }
      .safe-area-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
      .safe-area-top { padding-top: max(0.5rem, env(safe-area-inset-top)); }
      
      /* NFT Patterns */
      .pattern-simple { background: linear-gradient(45deg, #6b7280, #9ca3af); }
      .pattern-detailed { background: linear-gradient(45deg, #3b82f6, #60a5fa); }
      .pattern-complex { background: linear-gradient(45deg, #8b5cf6, #a78bfa); }
      .pattern-exquisite { background: linear-gradient(45deg, #f59e0b, #fbbf24); }
      .pattern-mythical { background: linear-gradient(45deg, #ef4444, #f87171); }
      
      .frame-basic { border: 2px solid #6b7280; box-shadow: 0 0 5px rgba(107, 114, 128, 0.5); }
      .frame-silver { border: 3px solid #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.7); }
      .frame-gold { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
      .frame-diamond { border: 3px solid #b9f2ff; box-shadow: 0 0 20px rgba(185, 242, 255, 0.9); }
      .frame-rainbow { 
        border: 3px solid transparent;
        background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff) border-box;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
      }
      
      .nft-container { position: relative; display: inline-block; }
      .nft-orbital { position: absolute; width: 60px; height: 60px; top: 50%; left: 50%; margin-top: -30px; margin-left: -30px; animation: orbit 10s linear infinite; z-index: 5; }
      .nft-item { position: absolute; font-size: 20px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; animation: float 3s ease-in-out infinite; }
      @keyframes orbit { 0% { transform: rotate(0deg) translateX(40px) rotate(0deg); } 100% { transform: rotate(360deg) translateX(40px) rotate(-360deg); } }
      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
      
      /* Mobile optimizations */
      .mobile-tab-bar {
        height: 60px;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .mobile-full-height { 
        height: calc(100vh - 60px - env(safe-area-inset-bottom)); 
        margin-bottom: env(safe-area-inset-bottom);
      }
      
      @media (max-width: 768px) {
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        button, [role="button"] { min-height: 44px; min-width: 44px; }
        .mobile-chat-input { padding-bottom: env(safe-area-inset-bottom); }
      }
      
      /* Chat optimizations */
      .chat-message { max-width: 85%; }
      @media (max-width: 640px) {
        .chat-message { max-width: 95%; }
      }
    </style>

    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, X, ChevronLeft, Settings as SettingsIcon, Trash2, MoreVertical, LogOut, User as UserIcon, Loader2, Coins, Palette, Edit3, Trophy, Bot, TrendingUp, MessageCircle, Wallet, Store, Gift, TrendingDown, Crown, Zap, Star, Gem, ShoppingCart, Users, BarChart3, Shield, Skull, Flame, Sparkles } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, remove, get } from 'firebase/database';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Components
        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-sm min-h-[44px]";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                gold: "bg-yellow-500 hover:bg-yellow-400 text-white shadow-lg shadow-yellow-500/20"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? <Loader2 className="animate-spin h-4 w-4" /> : <>{icon && <span className="text-base">{icon}</span>}{children}</>}
                </button>
            );
        };

        // Mobile Tab Bar
        const MobileTabBar = ({ activeView, onViewChange, unreadCount }) => {
            const tabs = [
                { id: 'chats', icon: MessageCircle, label: '–ß–∞—Ç—ã', color: 'indigo' },
                { id: 'clicker', icon: Coins, label: '–ó–∞—Ä–∞–±–æ—Ç–æ–∫', color: 'yellow' },
                { id: 'market', icon: Store, label: '–ú–∞–≥–∞–∑–∏–Ω', color: 'green' },
                { id: 'profile', icon: UserIcon, label: '–ü—Ä–æ—Ñ–∏–ª—å', color: 'purple' }
            ];

            return (
                <div className="md:hidden mobile-tab-bar fixed bottom-0 left-0 right-0 bg-slate-800 border-t border-slate-700 flex justify-around items-center safe-area-bottom z-40">
                    {tabs.map(tab => {
                        const Icon = tab.icon;
                        const isActive = activeView === tab.id;
                        return (
                            <button 
                                key={tab.id}
                                onClick={() => onViewChange(tab.id)}
                                className={`flex flex-col items-center justify-center p-2 flex-1 min-h-[60px] transition-colors ${
                                    isActive ? `text-${tab.color}-400` : 'text-slate-400'
                                }`}
                            >
                                <div className="relative">
                                    <Icon size={20} />
                                    {tab.id === 'chats' && unreadCount > 0 && (
                                        <span className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-xs flex items-center justify-center">
                                            {unreadCount}
                                        </span>
                                    )}
                                </div>
                                <span className="text-xs mt-1">{tab.label}</span>
                            </button>
                        );
                    })}
                </div>
            );
        };

        // Modal Base Component
        const Modal = ({ isOpen, onClose, title, children, className = "" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/60 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className={`w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[95vh] ${className}`}>
                        <div className="p-3 border-b border-slate-800 flex items-center justify-between bg-slate-900 shrink-0">
                            <h2 className="text-lg font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-1"><X size={20} /></button>
                        </div>
                        <div className="p-4 overflow-y-auto no-scrollbar flex-1">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // NFT Market Modal - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        const NFTMarketModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate, userNFTs, onNFTUpdate, usersData }) => {
            const [activeTab, setActiveTab] = useState('market');
            const [isLoading, setIsLoading] = useState(false);
            const [giftRecipient, setGiftRecipient] = useState('');
            const [giftNFT, setGiftNFT] = useState(null);
            const [sellPrice, setSellPrice] = useState('');
            const [sellNFT, setSellNFT] = useState(null);
            const [marketListings, setMarketListings] = useState([]);

            // –£–õ–£–ß–®–ï–ù–ù–´–ï NFT –° –ü–ê–¢–¢–ï–†–ù–ê–ú–ò –ò –ò–ó–ù–û–°–û–ú
            const nfts = [
                // COMMON
                { id: 'ghost', name: '–ü—Ä–∏–∑—Ä–∞–∫', emoji: 'üëª', basePrice: 500, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'robot', name: '–†–æ–±–æ—Ç', emoji: 'ü§ñ', basePrice: 600, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'alien', name: '–ü—Ä–∏—à–µ–ª–µ—Ü', emoji: 'üëΩ', basePrice: 700, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'clown', name: '–ö–ª–æ—É–Ω', emoji: 'ü§°', basePrice: 550, rarity: 'common', pattern: 'simple', durability: 100 },
                { id: 'poop', name: '–ö–∞–∫–∞—à–∫–∞', emoji: 'üí©', basePrice: 300, rarity: 'common', pattern: 'simple', durability: 100 },
                
                // RARE
                { id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω', emoji: 'üêâ', basePrice: 1500, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'phoenix', name: '–§–µ–Ω–∏–∫—Å', emoji: 'ü¶ö', basePrice: 1800, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'unicorn', name: '–ï–¥–∏–Ω–æ—Ä–æ–≥', emoji: 'ü¶Ñ', basePrice: 2000, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'thunder', name: '–ì—Ä–æ–º', emoji: '‚ö°', basePrice: 1200, rarity: 'rare', pattern: 'detailed', durability: 100 },
                { id: 'comet', name: '–ö–æ–º–µ—Ç–∞', emoji: '‚òÑÔ∏è', basePrice: 1600, rarity: 'rare', pattern: 'detailed', durability: 100 },
                
                // EPIC
                { id: 'crown', name: '–ö–æ—Ä–æ–Ω–∞', emoji: 'üëë', basePrice: 3500, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', basePrice: 4000, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'rainbow', name: '–†–∞–¥—É–≥–∞', emoji: 'üåà', basePrice: 3200, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'fire', name: '–û–≥–æ–Ω—å', emoji: 'üî•', basePrice: 2800, rarity: 'epic', pattern: 'complex', durability: 100 },
                { id: 'planet', name: '–ü–ª–∞–Ω–µ—Ç–∞', emoji: 'ü™ê', basePrice: 3800, rarity: 'epic', pattern: 'complex', durability: 100 },
                
                // LEGENDARY
                { id: 'king', name: '–ö–æ—Ä–æ–ª—å', emoji: 'ü§¥', basePrice: 6000, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'queen', name: '–ö–æ—Ä–æ–ª–µ–≤–∞', emoji: 'üë∏', basePrice: 6500, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'wizard', name: '–í–æ–ª—à–µ–±–Ω–∏–∫', emoji: 'üßô', basePrice: 7000, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'sparkles', name: '–ë–ª–µ—Å–∫', emoji: '‚ú®', basePrice: 5500, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                { id: 'superhero', name: '–°—É–ø–µ—Ä–≥–µ—Ä–æ–π', emoji: 'ü¶∏', basePrice: 7500, rarity: 'legendary', pattern: 'exquisite', durability: 100 },
                
                // MYTHICAL
                { id: 'god', name: '–ë–æ–≥', emoji: 'üëº', basePrice: 10000, rarity: 'mythical', pattern: 'mythical', durability: 100 },
                { id: 'demon', name: '–î–µ–º–æ–Ω', emoji: 'üòà', basePrice: 12000, rarity: 'mythical', pattern: 'mythical', durability: 100 },
                { id: 'angel', name: '–ê–Ω–≥–µ–ª', emoji: 'üòá', basePrice: 11000, rarity: 'mythical', pattern: 'mythical', durability: 100 },
                { id: 'galaxy', name: '–ì–∞–ª–∞–∫—Ç–∏–∫–∞', emoji: 'üåå', basePrice: 15000, rarity: 'mythical', pattern: 'mythical', durability: 100 },
                { id: 'infinity', name: '–ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å', emoji: '‚ôæÔ∏è', basePrice: 20000, rarity: 'mythical', pattern: 'mythical', durability: 100 }
            ];

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–æ–≤ —Ä—ã–Ω–∫–∞
            useEffect(() => {
                if (isOpen && activeTab === 'marketplace') {
                    const marketListingsRef = ref(db, 'nftMarketListings');
                    const unsubscribe = onValue(marketListingsRef, (snapshot) => {
                        const data = snapshot.val() || {};
                        const listings = Object.entries(data).map(([id, listing]) => ({ id, ...listing }));
                        setMarketListings(listings);
                    });
                    return () => off(marketListingsRef);
                }
            }, [isOpen, activeTab]);

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏
            const getCurrentPrice = (nft) => {
                return nft.basePrice;
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            const getPatternClass = (pattern) => {
                const patterns = {
                    'simple': 'pattern-simple',
                    'detailed': 'pattern-detailed',
                    'complex': 'pattern-complex',
                    'exquisite': 'pattern-exquisite',
                    'mythical': 'pattern-mythical'
                };
                return patterns[pattern] || '';
            };

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏
            const getRarityColor = (rarity) => {
                const colors = {
                    'common': 'text-gray-400',
                    'rare': 'text-blue-400',
                    'epic': 'text-purple-400',
                    'legendary': 'text-yellow-400',
                    'mythical': 'text-red-400'
                };
                return colors[rarity] || 'text-gray-400';
            };

            // –ü–û–ö–£–ü–ö–ê NFT
            const handleBuyNFT = async (nft) => {
                const currentPrice = getCurrentPrice(nft);
                if (userCoins < currentPrice) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${currentPrice} –∫–æ–∏–Ω–æ–≤.`);
                    return;
                }
                setIsLoading(true);
                try {
                    const newNFTs = [...(userNFTs || []), { 
                        id: nft.id, 
                        purchasedAt: Date.now(), 
                        hidden: false,
                        durability: 100,
                        purchasePrice: currentPrice
                    }];
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - currentPrice,
                        nfts: newNFTs
                    });
                    onCoinsUpdate(userCoins - currentPrice);
                    onNFTUpdate(newNFTs);
                    alert(`üéâ –í—ã –∫—É–ø–∏–ª–∏ NFT "${nft.name}" –∑–∞ ${currentPrice} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('NFT purchase error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT');
                }
                setIsLoading(false);
            };

            // –ü–†–û–î–ê–ñ–ê NFT - –£–õ–£–ß–®–ï–ù–ù–ê–Ø
            const handleSellNFT = async () => {
                if (!sellPrice || parseFloat(sellPrice) <= 0) {
                    alert('üí∞ –£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏');
                    return;
                }

                const price = parseFloat(sellPrice);
                if (price > 1000000) {
                    alert('‚ùå –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∞—è —Ü–µ–Ω–∞! –ú–∞–∫—Å–∏–º—É–º 1,000,000 –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    const nftToSell = userNFTs.find(nft => nft.id === sellNFT.id);
                    if (!nftToSell) return;
                    
                    // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø—Ä–æ–¥–∞–∂–µ
                    const marketListingRef = push(ref(db, 'nftMarketListings'));
                    await set(marketListingRef, {
                        nftId: sellNFT.id,
                        seller: currentUser,
                        price: price,
                        listedAt: Date.now(),
                        durability: nftToSell.durability || 100,
                        originalPrice: nftToSell.purchasePrice || sellNFT.basePrice
                    });
                    
                    // –£–±–∏—Ä–∞–µ–º NFT —É –ø—Ä–æ–¥–∞–≤—Ü–∞
                    const newNFTs = userNFTs.filter(nft => nft.id !== sellNFT.id);
                    await update(ref(db, `users/${currentUser}`), { nfts: newNFTs });
                    
                    onNFTUpdate(newNFTs);
                    setSellNFT(null);
                    setSellPrice('');
                    alert(`‚úÖ NFT "${sellNFT.name}" –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–¥–∞–∂—É –∑–∞ ${price} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('NFT sell error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ NFT –Ω–∞ –ø—Ä–æ–¥–∞–∂—É');
                }
                setIsLoading(false);
            };

            // –ü–û–ö–£–ü–ö–ê –° –†–´–ù–ö–ê
            const handleBuyFromMarket = async (listing) => {
                const nft = nfts.find(n => n.id === listing.nftId);
                if (!nft) return;
                
                if (userCoins < listing.price) {
                    alert(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${listing.price} –∫–æ–∏–Ω–æ–≤.`);
                    return;
                }
                
                if (listing.seller === currentUser) {
                    alert('‚ùå –ù–µ–ª—å–∑—è –∫—É–ø–∏—Ç—å —Å–≤–æ–π –∂–µ NFT');
                    return;
                }
                
                setIsLoading(true);
                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º NFT –ø–æ–∫—É–ø–∞—Ç–µ–ª—é
                    const newNFTs = [...(userNFTs || []), { 
                        id: nft.id, 
                        purchasedAt: Date.now(), 
                        hidden: false,
                        durability: listing.durability,
                        purchasedFromMarket: true,
                        originalSeller: listing.seller,
                        purchasePrice: listing.price
                    }];
                    
                    // –ü–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–∏–Ω—ã –ø—Ä–æ–¥–∞–≤—Ü—É
                    const sellerRef = ref(db, `users/${listing.seller}`);
                    const sellerSnapshot = await get(sellerRef);
                    if (sellerSnapshot.exists()) {
                        const sellerData = sellerSnapshot.val();
                        await update(sellerRef, { 
                            coins: (sellerData.coins || 0) + listing.price 
                        });
                    }
                    
                    // –°–ø–∏—Å—ã–≤–∞–µ–º –∫–æ–∏–Ω—ã —É –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - listing.price,
                        nfts: newNFTs
                    });
                    
                    // –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å —Å —Ä—ã–Ω–∫–∞
                    await remove(ref(db, `nftMarketListings/${listing.id}`));
                    
                    onCoinsUpdate(userCoins - listing.price);
                    onNFTUpdate(newNFTs);
                    alert(`üéâ –í—ã –∫—É–ø–∏–ª–∏ NFT "${nft.name}" –∑–∞ ${listing.price} –∫–æ–∏–Ω–æ–≤!`);
                } catch (error) {
                    console.error('Market purchase error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ NFT —Å —Ä—ã–Ω–∫–∞');
                }
                setIsLoading(false);
            };

            // –í–ö–õ–ê–î–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê
            const renderMarketTab = () => (
                <div className="space-y-4">
                    <div className="text-center mb-4">
                        <p className="text-slate-400 text-sm">üé¥ –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ NFT</p>
                        <p className="text-xs text-slate-500 mt-1">–ë–∞–ª–∞–Ω—Å: <span className="text-yellow-500 font-bold">{userCoins.toFixed(0)} –∫–æ–∏–Ω–æ–≤</span></p>
                    </div>
                    <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        {nfts.map((nft) => {
                            const isPurchased = userNFTs.some(userNft => userNft.id === nft.id);
                            if (isPurchased) return null;
                            const currentPrice = getCurrentPrice(nft);
                            return (
                                <div key={nft.id} className={`p-3 rounded-xl flex flex-col items-center gap-2 bg-slate-800 border border-slate-700 ${getPatternClass(nft.pattern)}`}>
                                    <div className="text-3xl bg-white/10 rounded-lg p-2">{nft.emoji}</div>
                                    <div className="text-center">
                                        <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                        <p className="text-xs text-slate-300 mt-1">{currentPrice} –∫–æ–∏–Ω–æ–≤</p>
                                        <p className={`text-xs font-medium mt-1 ${getRarityColor(nft.rarity)}`}>
                                            {nft.rarity === 'common' ? '‚ö™ –û–±—ã—á–Ω—ã–π' : 
                                             nft.rarity === 'rare' ? 'üîµ –†–µ–¥–∫–∏–π' :
                                             nft.rarity === 'epic' ? 'üü£ –≠–ø–∏—á–µ—Å–∫–∏–π' :
                                             nft.rarity === 'legendary' ? 'üü° –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' : 'üî¥ –ú–∏—Ñ–∏—á–µ—Å–∫–∏–π'}
                                        </p>
                                        <p className="text-xs text-slate-400 capitalize">–ü–∞—Ç—Ç–µ—Ä–Ω: {nft.pattern}</p>
                                    </div>
                                    <Button 
                                        onClick={() => handleBuyNFT(nft)} 
                                        isLoading={isLoading} 
                                        disabled={userCoins < currentPrice} 
                                        variant="gold" 
                                        className="w-full text-xs"
                                    >
                                        {userCoins < currentPrice ? '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ' : `–ö—É–ø–∏—Ç—å –∑–∞ ${currentPrice}`}
                                    </Button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );

            // –í–ö–õ–ê–î–ö–ê –ú–û–ò–• NFT
            const renderMyNFTsTab = () => (
                <div className="space-y-4">
                    {userNFTs.length > 0 ? (
                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                            {userNFTs.map((userNft) => {
                                const nft = nfts.find(n => n.id === userNft.id);
                                if (!nft) return null;
                                const durability = userNft.durability || 100;
                                const currentPrice = getCurrentPrice(nft);
                                
                                return (
                                    <div key={nft.id} className={`p-3 rounded-xl flex flex-col items-center gap-2 bg-slate-800 border border-slate-700 ${userNft.hidden ? 'opacity-50' : ''} ${getPatternClass(nft.pattern)}`}>
                                        <div className="text-3xl bg-white/10 rounded-lg p-2">{nft.emoji}</div>
                                        <div className="text-center w-full">
                                            <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                            <p className={`text-xs font-medium mt-1 ${getRarityColor(nft.rarity)}`}>
                                                {nft.rarity === 'common' ? '‚ö™ –û–±—ã—á–Ω—ã–π' : 
                                                 nft.rarity === 'rare' ? 'üîµ –†–µ–¥–∫–∏–π' :
                                                 nft.rarity === 'epic' ? 'üü£ –≠–ø–∏—á–µ—Å–∫–∏–π' :
                                                 nft.rarity === 'legendary' ? 'üü° –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' : 'üî¥ –ú–∏—Ñ–∏—á–µ—Å–∫–∏–π'}
                                            </p>
                                            
                                            {/* –ò–ó–ù–û–° */}
                                            <div className="mt-2">
                                                <div className="flex justify-between text-xs text-slate-400 mb-1">
                                                    <span>–ò–∑–Ω–æ—Å:</span>
                                                    <span>{durability}%</span>
                                                </div>
                                                <div className="w-full bg-slate-700 rounded-full h-2">
                                                    <div 
                                                        className={`h-2 rounded-full ${
                                                            durability > 70 ? 'bg-green-500' : 
                                                            durability > 30 ? 'bg-yellow-500' : 'bg-red-500'
                                                        }`}
                                                        style={{ width: `${durability}%` }}
                                                    ></div>
                                                </div>
                                            </div>

                                            {userNft.gifted && (
                                                <p className="text-xs text-green-400 mt-1">üéÅ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç {userNft.from}</p>
                                            )}
                                        </div>
                                        <div className="flex gap-1 w-full">
                                            {userNft.hidden ? (
                                                <Button onClick={() => handleRestoreNFT(nft.id)} isLoading={isLoading} variant="primary" className="flex-1 text-xs">
                                                    –ü–æ–∫–∞–∑–∞—Ç—å
                                                </Button>
                                            ) : (
                                                <>
                                                    <Button onClick={() => setSellNFT(nft)} variant="gold" className="flex-1 text-xs">
                                                        üí∞ –ü—Ä–æ–¥–∞—Ç—å
                                                    </Button>
                                                    <Button onClick={() => setGiftNFT(nft)} variant="primary" className="flex-1 text-xs">
                                                        üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å
                                                    </Button>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>üòî –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç NFT</p>
                            <p className="text-sm mt-1">–ö—É–ø–∏—Ç–µ NFT –≤ –º–∞–≥–∞–∑–∏–Ω–µ</p>
                        </div>
                    )}
                </div>
            );

            // –í–ö–õ–ê–î–ö–ê –†–´–ù–ö–ê
            const renderMarketplaceTab = () => (
                <div className="space-y-4">
                    <div className="text-center mb-4">
                        <p className="text-slate-400 text-sm">üè™ –†—ã–Ω–æ–∫ NFT</p>
                        <p className="text-xs text-slate-500 mt-1">–ü–æ–∫—É–ø–∞–π—Ç–µ NFT —É –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤</p>
                    </div>
                    {marketListings.length > 0 ? (
                        <div className="space-y-3">
                            {marketListings.map((listing) => {
                                const nft = nfts.find(n => n.id === listing.nftId);
                                if (!nft) return null;
                                
                                const profit = listing.price - (listing.originalPrice || nft.basePrice);
                                const profitPercentage = ((profit / (listing.originalPrice || nft.basePrice)) * 100).toFixed(1);
                                
                                return (
                                    <div key={listing.id} className="p-3 rounded-xl flex items-center gap-3 bg-slate-800 border border-slate-700">
                                        <div className={`text-2xl bg-white/10 rounded-lg p-2 ${getPatternClass(nft.pattern)}`}>
                                            {nft.emoji}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-medium text-white text-sm">{nft.name}</h3>
                                            <p className="text-xs text-slate-300">–ü—Ä–æ–¥–∞–≤–µ—Ü: {listing.seller}</p>
                                            <p className="text-xs text-slate-400">–ò–∑–Ω–æ—Å: {listing.durability}%</p>
                                            <p className={`text-xs ${profit >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                {profit >= 0 ? 'üìà' : 'üìâ'} {profitPercentage}%
                                            </p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-yellow-500 font-bold">{listing.price} –∫–æ–∏–Ω–æ–≤</p>
                                            <Button 
                                                onClick={() => handleBuyFromMarket(listing)} 
                                                isLoading={isLoading} 
                                                disabled={userCoins < listing.price || listing.seller === currentUser} 
                                                variant="gold" 
                                                className="mt-1 text-xs"
                                            >
                                                –ö—É–ø–∏—Ç—å
                                            </Button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>üè™ –ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –Ω–µ—Ç NFT</p>
                            <p className="text-sm mt-1">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –≤—ã—Å—Ç–∞–≤–∏—Ç NFT –Ω–∞ –ø—Ä–æ–¥–∞–∂—É!</p>
                        </div>
                    )}
                </div>
            );

            // –í–ö–õ–ê–î–ö–ê –ü–†–û–î–ê–ñ–ò
            const renderSellTab = () => (
                <div className="space-y-4">
                    {sellNFT ? (
                        <div className="bg-slate-800 rounded-xl p-4">
                            <div className="text-center mb-4">
                                <div className="text-4xl mb-2">{sellNFT.emoji}</div>
                                <h3 className="font-bold text-white">{sellNFT.name}</h3>
                                <p className="text-slate-400 text-sm">
                                    –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: {sellNFT.basePrice} –∫–æ–∏–Ω–æ–≤
                                </p>
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</label>
                                    <input 
                                        type="number" 
                                        step="1"
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –≤ –∫–æ–∏–Ω–∞—Ö"
                                        value={sellPrice} 
                                        onChange={e => setSellPrice(e.target.value)} 
                                        className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm"
                                    />
                                    <p className="text-xs text-slate-500 mt-1">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Ü–µ–Ω–∞: {Math.floor(sellNFT.basePrice * 1.5)} –∫–æ–∏–Ω–æ–≤</p>
                                </div>
                                <Button 
                                    onClick={handleSellNFT} 
                                    isLoading={isLoading} 
                                    disabled={!sellPrice || parseFloat(sellPrice) <= 0} 
                                    variant="gold" 
                                    className="w-full"
                                >
                                    üí∞ –í—ã—Å—Ç–∞–≤–∏—Ç—å –∑–∞ {sellPrice || 0} –∫–æ–∏–Ω–æ–≤
                                </Button>
                                <Button onClick={() => setSellNFT(null)} variant="secondary" className="w-full">
                                    –û—Ç–º–µ–Ω–∞
                                </Button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>üí∞ –í—ã–±–µ—Ä–∏—Ç–µ NFT –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏</p>
                            <p className="text-sm mt-1">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "–ú–æ–∏ NFT"</p>
                        </div>
                    )}
                </div>
            );

            // –í–ö–õ–ê–î–ö–ê –ü–û–î–ê–†–ö–û–í
            const renderGiftTab = () => (
                <div className="space-y-4">
                    {giftNFT ? (
                        <div className="bg-slate-800 rounded-xl p-4">
                            <div className="text-center mb-4">
                                <div className="text-4xl mb-2">{giftNFT.emoji}</div>
                                <h3 className="font-bold text-white">{giftNFT.name}</h3>
                            </div>
                            <div className="space-y-3">
                                <input 
                                    type="text" 
                                    placeholder="–ò–º—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è" 
                                    value={giftRecipient} 
                                    onChange={e => setGiftRecipient(e.target.value)} 
                                    className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm" 
                                />
                                <Button 
                                    onClick={handleGiftNFT} 
                                    isLoading={isLoading} 
                                    disabled={!giftRecipient.trim()} 
                                    variant="gold" 
                                    className="w-full"
                                >
                                    üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å NFT
                                </Button>
                                <Button onClick={() => setGiftNFT(null)} variant="secondary" className="w-full">
                                    –û—Ç–º–µ–Ω–∞
                                </Button>
                            </div>
                        </div>
                    ) : (
                        <div className="text-center text-slate-500 py-8">
                            <p>üéÅ –í—ã–±–µ—Ä–∏—Ç–µ NFT –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞</p>
                            <p className="text-sm mt-1">–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "–ú–æ–∏ NFT"</p>
                        </div>
                    )}
                </div>
            );

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="üé¥ NFT –ú–∞–≥–∞–∑–∏–Ω" className="max-w-4xl">
                    <div className="flex border-b border-slate-800 bg-slate-900/50 overflow-x-auto">
                        {[
                            { id: 'market', label: 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω', icon: ShoppingCart },
                            { id: 'my_nfts', label: 'üé¥ –ú–æ–∏ NFT', icon: Wallet },
                            { id: 'marketplace', label: 'üè™ –†—ã–Ω–æ–∫', icon: Store },
                            { id: 'sell', label: 'üí∞ –ü—Ä–æ–¥–∞—Ç—å', icon: TrendingUp },
                            { id: 'gift', label: 'üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å', icon: Gift }
                        ].map(tab => (
                            <button 
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)} 
                                className={`flex items-center gap-1 py-3 text-xs font-medium min-h-[44px] whitespace-nowrap px-4 ${
                                    activeTab === tab.id ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'
                                }`}
                            >
                                <span>{tab.label}</span>
                            </button>
                        ))}
                    </div>
                    
                    <div className="mt-4">
                        {activeTab === 'market' && renderMarketTab()}
                        {activeTab === 'my_nfts' && renderMyNFTsTab()}
                        {activeTab === 'marketplace' && renderMarketplaceTab()}
                        {activeTab === 'sell' && renderSellTab()}
                        {activeTab === 'gift' && renderGiftTab()}
                    </div>
                </Modal>
            );
        };

        // –û–°–¢–ê–õ–¨–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –û–°–¢–ê–Æ–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
        // [TransferCoinsModal, CasinoModal, SettingsModal, MessageBubble, Clicker, AutoClicker, NFTOrbitalDisplay]
        // –û–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏

        // Main App - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [activeView, setActiveView] = useState('chats');
            const [chats, setChats] = useState([]);
            const [activeChatUser, setActiveChatUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isNFTMarketOpen, setIsNFTMarketOpen] = useState(false);
            const [isTransferCoinsOpen, setIsTransferCoinsOpen] = useState(false);
            const [isCasinoModalOpen, setIsCasinoModalOpen] = useState(false);
            const [userCoins, setUserCoins] = useState(0);
            const [userAvatar, setUserAvatar] = useState('');
            const [userFrame, setUserFrame] = useState('');
            const [userNameColor, setUserNameColor] = useState('');
            const [userStatus, setUserStatus] = useState('');
            const [userStatusEmoji, setUserStatusEmoji] = useState('');
            const [userNFTs, setUserNFTs] = useState([]);
            const [clickerLevel, setClickerLevel] = useState(0);
            const [usersData, setUsersData] = useState({});
            const messagesEndRef = useRef(null);

            // [–ó–î–ï–°–¨ –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –í–°–ï –§–£–ù–ö–¶–ò–ò –ò useEffect –ò–ó –ü–†–ï–î–´–î–£–©–ï–ô –í–ï–†–°–ò–ò]
            // handleAuth, validateUsername, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç.–¥.

            // –≠–ö–†–ê–ù –í–•–û–î–ê
            if (!currentUser) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-slate-800 flex items-center justify-center p-4 safe-area-top safe-area-bottom">
                        <div className="w-full max-w-md bg-slate-800 border border-slate-700 rounded-2xl p-6 shadow-2xl">
                            <div className="text-center mb-6">
                                <h1 className="text-3xl font-bold text-white mb-2">DolbaebSMS</h1>
                                <p className="text-slate-400">–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</p>
                            </div>
                            
                            <div className="space-y-4">
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                                    <input 
                                        type="text" 
                                        value={usernameInput}
                                        onChange={(e) => setUsernameInput(e.target.value.toLowerCase())}
                                        placeholder="—Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ—á–Ω—ã–µ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"
                                        className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm"
                                    />
                                </div>
                                
                                <div>
                                    <label className="text-slate-400 text-sm mb-1 block">–ü–∞—Ä–æ–ª—å</label>
                                    <input 
                                        type="password" 
                                        value={passwordInput}
                                        onChange={(e) => setPasswordInput(e.target.value)}
                                        placeholder="–≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                                        className="w-full bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white focus:border-indigo-500 outline-none text-sm"
                                    />
                                </div>
                                
                                {authError && (
                                    <div className="bg-red-500/10 border border-red-500/20 rounded-xl p-3">
                                        <p className="text-red-400 text-sm text-center">{authError}</p>
                                    </div>
                                )}
                                
                                <Button 
                                    onClick={handleAuth} 
                                    className="w-full"
                                    disabled={!usernameInput.trim()}
                                >
                                    {usersData[usernameInput] ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è'}
                                </Button>
                                
                                <p className="text-slate-500 text-xs text-center">
                                    {usersData[usernameInput] 
                                        ? '–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π–¥–∏—Ç–µ' 
                                        : '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å? –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–∫–∫–∞—É–Ω—Ç'}
                                </p>
                            </div>
                        </div>
                    </div>
                );
            }

            // –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–°
            return (
                <div className="h-screen flex flex-col bg-slate-900 safe-area-top">
                    {/* Header */}
                    <div className="bg-slate-800 border-b border-slate-700 p-3 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="relative">
                                <div className={`w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg ${userFrame === 'basic' ? 'frame-basic' : userFrame === 'silver' ? 'frame-silver' : userFrame === 'gold' ? 'frame-gold' : userFrame === 'diamond' ? 'frame-diamond' : userFrame === 'rainbow' ? 'frame-rainbow' : ''}`}>
                                    {userAvatar || currentUser[0].toUpperCase()}
                                </div>
                                <NFTOrbitalDisplay userNFTs={userNFTs} />
                            </div>
                            <div>
                                <h1 className="font-bold text-white" style={
                                    userNameColor === 'red' ? {color: '#ef4444'} :
                                    userNameColor === 'orange' ? {color: '#f97316'} :
                                    userNameColor === 'yellow' ? {color: '#eab308'} :
                                    userNameColor === 'green' ? {color: '#22c55e'} :
                                    userNameColor === 'blue' ? {color: '#3b82f6'} :
                                    userNameColor === 'purple' ? {color: '#a855f7'} :
                                    userNameColor === 'rainbow' ? {background: 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'} : {}
                                }>
                                    {currentUser}
                                </h1>
                                <p className="text-slate-400 text-xs">{userStatusEmoji} {userStatus}</p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                            <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl px-3 py-1">
                                <span className="text-yellow-500 font-bold text-sm">{userCoins.toFixed(0)}</span>
                            </div>
                            <button onClick={() => setIsNFTMarketOpen(true)} className="p-2 text-green-400 hover:bg-green-500/10 rounded-xl transition-colors">
                                <Store size={20} />
                            </button>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-xl transition-colors">
                                <SettingsIcon size={20} />
                            </button>
                        </div>
                    </div>

                    {/* Mobile Content */}
                    <div className="flex-1 overflow-hidden mobile-full-height">
                        {/* Chats View */}
                        {activeView === 'chats' && (
                            <div className="h-full flex flex-col">
                                {/* Search */}
                                <div className="p-3 border-b border-slate-700">
                                    <div className="relative">
                                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={16} />
                                        <input
                                            type="text"
                                            placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            className="w-full bg-slate-700 border border-slate-600 rounded-xl pl-9 pr-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"
                                        />
                                    </div>
                                </div>

                                {/* Chats List */}
                                <div className="flex-1 overflow-y-auto no-scrollbar">
                                    {searchQuery ? (
                                        <div className="p-2">
                                            {searchResults.map(username => (
                                                <button
                                                    key={username}
                                                    onClick={() => {
                                                        setActiveChatUser(username);
                                                        setActiveView('chat');
                                                        setSearchQuery('');
                                                    }}
                                                    className="w-full p-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-colors text-left"
                                                >
                                                    <div className="w-12 h-12 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">
                                                        {usersData[username]?.avatar || username[0].toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <div className="text-white font-medium">{username}</div>
                                                        <div className="text-slate-400 text-xs">{usersData[username]?.status || '–í —Å–µ—Ç–∏'}</div>
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="p-2">
                                            {chats.map(chat => (
                                                <button
                                                    key={chat.user}
                                                    onClick={() => {
                                                        setActiveChatUser(chat.user);
                                                        setActiveView('chat');
                                                    }}
                                                    className="w-full p-3 rounded-xl flex items-center gap-3 hover:bg-slate-700 transition-colors text-left mb-2"
                                                >
                                                    <div className="w-12 h-12 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">
                                                        {usersData[chat.user]?.avatar || chat.user[0].toUpperCase()}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-white font-medium truncate">{chat.user}</div>
                                                        <div className="text-slate-400 text-xs truncate">
                                                            {chat.lastMessage.sender === currentUser ? '–í—ã: ' : ''}
                                                            {chat.lastMessage.text}
                                                        </div>
                                                    </div>
                                                    <div className="text-slate-500 text-xs">
                                                        {format(chat.lastMessage.timestamp, 'HH:mm')}
                                                    </div>
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Chat View */}
                        {activeView === 'chat' && activeChatUser && (
                            <div className="h-full flex flex-col">
                                {/* Chat Header */}
                                <div className="bg-slate-800 border-b border-slate-700 p-3 flex items-center gap-3 shrink-0">
                                    <button 
                                        onClick={() => setActiveView('chats')}
                                        className="p-1 text-slate-400 hover:text-white"
                                    >
                                        <ChevronLeft size={20} />
                                    </button>
                                    <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-sm">
                                        {usersData[activeChatUser]?.avatar || activeChatUser[0].toUpperCase()}
                                    </div>
                                    <div className="flex-1">
                                        <div className="text-white font-medium">{activeChatUser}</div>
                                        <div className="text-slate-400 text-xs">{usersData[activeChatUser]?.status || '–í —Å–µ—Ç–∏'}</div>
                                    </div>
                                </div>

                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto p-3 space-y-2 no-scrollbar">
                                    {messages.map(message => (
                                        <MessageBubble
                                            key={message.id}
                                            message={message}
                                            isOwn={message.sender === currentUser}
                                            chatId={[currentUser, activeChatUser].sort().join('_')}
                                            messageId={message.id}
                                            currentUser={currentUser}
                                        />
                                    ))}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Message Input */}
                                <div className="bg-slate-800 border-t border-slate-700 p-3 shrink-0 mobile-chat-input">
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                                            value={messageInput}
                                            onChange={(e) => setMessageInput(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                            className="flex-1 bg-slate-700 border border-slate-600 rounded-xl px-3 py-2 text-white text-sm focus:border-indigo-500 outline-none"
                                        />
                                        <Button onClick={handleSendMessage} disabled={!messageInput.trim()}>
                                            <Send size={16} />
                                        </Button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Other Views */}
                        {activeView === 'clicker' && (
                            <div className="h-full overflow-y-auto no-scrollbar p-4">
                                <Clicker 
                                    userCoins={userCoins}
                                    onCoinClick={handleCoinClick}
                                    currentUser={currentUser}
                                    clickerLevel={clickerLevel}
                                />
                                <AutoClicker
                                    userCoins={userCoins}
                                    onCoinsUpdate={setUserCoins}
                                    currentUser={currentUser}
                                    clickerLevel={clickerLevel}
                                />
                                <div className="grid grid-cols-2 gap-3 mt-4">
                                    <Button onClick={() => setIsTransferCoinsOpen(true)} variant="secondary" className="text-xs">
                                        üí∏ –ü–µ—Ä–µ–≤–æ–¥
                                    </Button>
                                    <Button onClick={() => setIsCasinoModalOpen(true)} variant="secondary" className="text-xs">
                                        üé∞ –ö–∞–∑–∏–Ω–æ
                                    </Button>
                                </div>
                            </div>
                        )}

                        {activeView === 'market' && (
                            <div className="h-full overflow-y-auto no-scrollbar p-4">
                                <div className="text-center mb-6">
                                    <h2 className="text-xl font-bold text-white mb-2">üé¥ NFT –ú–∞–≥–∞–∑–∏–Ω</h2>
                                    <p className="text-slate-400">–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ NFT —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏</p>
                                </div>
                                <Button 
                                    onClick={() => setIsNFTMarketOpen(true)} 
                                    variant="gold" 
                                    className="w-full mb-4"
                                >
                                    üõçÔ∏è –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω
                                </Button>
                                
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-slate-800 rounded-xl p-4 text-center">
                                        <Coins className="mx-auto mb-2 text-yellow-400" size={24} />
                                        <div className="text-white font-bold">{userCoins.toFixed(0)}</div>
                                        <div className="text-slate-400 text-xs">–ë–∞–ª–∞–Ω—Å</div>
                                    </div>
                                    <div className="bg-slate-800 rounded-xl p-4 text-center">
                                        <Wallet className="mx-auto mb-2 text-green-400" size={24} />
                                        <div className="text-white font-bold">{userNFTs.filter(nft => !nft.hidden).length}</div>
                                        <div className="text-slate-400 text-xs">NFT</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeView === 'profile' && (
                            <div className="h-full overflow-y-auto no-scrollbar p-4">
                                <div className="text-center mb-6">
                                    <div className={`w-20 h-20 mx-auto rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-3xl shadow-xl ${userFrame === 'basic' ? 'frame-basic' : userFrame === 'silver' ? 'frame-silver' : userFrame === 'gold' ? 'frame-gold' : ''}`}>
                                        {userAvatar || currentUser[0].toUpperCase()}
                                    </div>
                                    <h2 className="text-xl font-bold text-white mt-3" style={
                                        userNameColor === 'red' ? {color: '#ef4444'} :
                                        userNameColor === 'orange' ? {color: '#f97316'} :
                                        userNameColor === 'yellow' ? {color: '#eab308'} :
                                        userNameColor === 'green' ? {color: '#22c55e'} :
                                        userNameColor === 'blue' ? {color: '#3b82f6'} :
                                        userNameColor === 'purple' ? {color: '#a855f7'} :
                                        userNameColor === 'rainbow' ? {background: 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent'} : {}
                                    }>
                                        {currentUser}
                                    </h2>
                                    <p className="text-slate-400">{userStatusEmoji} {userStatus}</p>
                                </div>

                                <div className="space-y-3">
                                    <Button onClick={() => setIsSettingsOpen(true)} variant="secondary" className="w-full">
                                        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                                    </Button>
                                    <Button onClick={handleLogout} variant="danger" className="w-full">
                                        üö™ –í—ã–π—Ç–∏
                                    </Button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Mobile Tab Bar */}
                    <MobileTabBar 
                        activeView={activeView} 
                        onViewChange={setActiveView}
                        unreadCount={0}
                    />

                    {/* Modals */}
                    <SettingsModal
                        isOpen={isSettingsOpen}
                        onClose={() => setIsSettingsOpen(false)}
                        currentUser={currentUser}
                        onLogout={handleLogout}
                        userCoins={userCoins}
                        userAvatar={userAvatar}
                        userFrame={userFrame}
                        userNameColor={userNameColor}
                        userStatus={userStatus}
                        userStatusEmoji={userStatusEmoji}
                        onAvatarChange={handleAvatarChange}
                        onFrameChange={handleFrameChange}
                        onColorChange={handleColorChange}
                        onStatusChange={handleStatusChange}
                    />

                    <NFTMarketModal
                        isOpen={isNFTMarketOpen}
                        onClose={() => setIsNFTMarketOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userNFTs={userNFTs}
                        onNFTUpdate={setUserNFTs}
                        usersData={usersData}
                    />

                    {/* –î–û–ë–ê–í–¨–¢–ï –û–°–¢–ê–õ–¨–ù–´–ï –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */}
                </div>
            );
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
