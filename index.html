<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS - Secure Messenger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
            }
          }
        }
      }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles -->
    <style>
      body { background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
      
      /* Mobile optimizations */
      @media (max-width: 640px) {
        .safe-area-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        /* Hide scrollbar on mobile for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      }
    </style>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Video, Settings as SettingsIcon, Menu, Trash2, Smile, MoreVertical, Lock, LogOut, User as UserIcon, Loader2 } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        // --- Services ---
        const firebaseConfig = {
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87",
            measurementId: "G-SCD5JVFM5E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Components ---

        // 1. Button
        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                ghost: "bg-transparent hover:bg-white/5 text-slate-300"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? (
                        <Loader2 className="animate-spin h-5 w-5" />
                    ) : (<>{icon && <span className="text-lg">{icon}</span>}{children}</>)}
                </button>
            );
        };

        // 2. Settings Modal
        const SettingsModal = ({ isOpen, onClose, currentUser, onLogout }) => {
            const [activeTab, setActiveTab] = useState('profile');
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmDelete, setConfirmDelete] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });

            if (!isOpen) return null;

            const handleChangePassword = async () => {
                if (!oldPassword || !newPassword) return;
                setIsLoading(true);
                try {
                    const userRef = ref(db, `users/${currentUser}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val();
                    if (userData.password !== oldPassword) {
                        setMessage({ type: 'error', text: '–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω' });
                        setIsLoading(false); return;
                    }
                    await update(userRef, { password: newPassword });
                    setMessage({ type: 'success', text: '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω' });
                    setOldPassword(''); setNewPassword('');
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è' }); }
                setIsLoading(false);
            };

            const handleDeleteAccount = async () => {
                if (confirmDelete !== currentUser) {
                     setMessage({ type: 'error', text: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
                     return;
                }
                setIsLoading(true);
                try {
                    await remove(ref(db, `users/${currentUser}`));
                    onLogout();
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è' }); setIsLoading(false); }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><UserIcon size={20} className="text-indigo-500" /> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="flex border-b border-slate-800 bg-slate-900/50">
                            {['profile', 'security', 'danger'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 text-sm font-medium transition-colors capitalize ${activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'}`}>
                                    {tab === 'profile' ? '–ü—Ä–æ—Ñ–∏–ª—å' : tab === 'security' ? '–ü–∞—Ä–æ–ª—å' : '–£–¥–∞–ª–∏—Ç—å'}
                                </button>
                            ))}
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            {message.text && <div className={`mb-4 p-3 rounded-lg text-sm text-center ${message.type === 'error' ? 'text-red-400 bg-red-500/10' : 'text-green-400 bg-green-500/10'}`}>{message.text}</div>}
                            
                            {activeTab === 'profile' && (
                                <div className="space-y-6 text-center">
                                    <div className="w-24 h-24 mx-auto rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-4xl shadow-xl">{currentUser ? currentUser[0].toUpperCase() : '?'}</div>
                                    <div><h3 className="text-2xl font-bold text-white">{currentUser}</h3><p className="text-slate-400">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p></div>
                                    <Button variant="secondary" onClick={onLogout} className="w-full" icon={<LogOut size={18} />}>–í—ã–π—Ç–∏</Button>
                                </div>
                            )}

                            {activeTab === 'security' && (
                                <div className="space-y-4">
                                    <input type="password" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" value={oldPassword} onChange={e => setOldPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none" />
                                    <input type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" value={newPassword} onChange={e => setNewPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none" />
                                    <Button onClick={handleChangePassword} isLoading={isLoading} disabled={!oldPassword || !newPassword} className="w-full">–û–±–Ω–æ–≤–∏—Ç—å</Button>
                                </div>
                            )}

                            {activeTab === 'danger' && (
                                <div className="space-y-4 p-4 bg-red-500/5 border border-red-500/10 rounded-xl">
                                    <p className="text-sm text-slate-400">–í–≤–µ–¥–∏—Ç–µ <b>{currentUser}</b> –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.</p>
                                    <input type="text" placeholder={currentUser} value={confirmDelete} onChange={e => setConfirmDelete(e.target.value)} className="w-full bg-slate-800 border border-red-900/30 rounded-xl px-4 py-3 text-white focus:border-red-500 outline-none" />
                                    <Button variant="danger" onClick={handleDeleteAccount} isLoading={isLoading} disabled={confirmDelete !== currentUser} className="w-full">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞</Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Message Bubble
        const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•'];
        const MessageBubble = ({ message, isOwn, chatId, messageId, currentUser }) => {
            const [showActions, setShowActions] = useState(false);
            const [showReactions, setShowReactions] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setShowActions(false); setShowReactions(false);
                    }
                };
                if (showActions || showReactions) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showActions, showReactions]);

            const handleDelete = async () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    try {
                        await update(ref(db, `messages/${chatId}/${messageId}`), { deleted: true });
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                }
                setShowActions(false);
            };

            const handleReaction = async (emoji) => {
                try {
                    const msgRef = ref(db, `messages/${chatId}/${messageId}/reactions`);
                    const currentReactions = message.reactions || {};
                    if (currentReactions[currentUser] === emoji) {
                        await update(msgRef, { [currentUser]: null });
                    } else {
                        await update(msgRef, { [currentUser]: emoji });
                    }
                    setShowReactions(false); setShowActions(false);
                } catch (error) {
                    console.error('Reaction error:', error);
                }
            };

            if (message.deleted) return null;

            const renderContent = () => {
                switch (message.type) {
                    case 'photo': return <div className="relative group"><img src={message.mediaUrl} alt="Photo" className="max-w-full sm:max-w-[320px] max-h-[400px] object-cover rounded-lg" loading="lazy" /></div>;
                    case 'video': return <video controls src={message.mediaUrl} className="max-w-full sm:max-w-[320px] max-h-[400px] rounded-lg bg-black" playsInline />;
                    case 'audio': return <div className="flex items-center gap-3 min-w-[200px]"><div className={`p-2 rounded-full ${isOwn ? 'bg-white/20' : 'bg-indigo-500/20 text-indigo-400'}`}><Mic size={16}/></div><audio controls src={message.mediaUrl} className="h-8 w-full max-w-[200px]" /></div>;
                    default: return <p className="break-words whitespace-pre-wrap leading-relaxed text-[15px]">{message.text}</p>;
                }
            };

            return (
                <div className={`group flex mb-4 ${isOwn ? 'justify-end' : 'justify-start'} animate-slide-up relative z-0`} ref={containerRef}>
                    <div className={`relative max-w-[85%] sm:max-w-[70%] rounded-2xl px-4 py-3 shadow-sm transition-all ${isOwn ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-100 rounded-bl-none border border-slate-700'}`}>
                        <button onClick={(e) => { e.stopPropagation(); setShowActions(!showActions); if(!showActions) setShowReactions(false); }} className={`absolute -top-3 ${isOwn ? 'left-0' : 'right-0'} p-1.5 rounded-full bg-slate-800 border border-slate-700 shadow-md text-slate-400 z-10 hover:text-white hover:scale-110`}><MoreVertical size={14} /></button>
                        
                        {showActions && (
                            <div className={`absolute -top-14 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex items-center p-1.5 gap-1 animate-fade-in`}>
                                <button onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); }} className="p-2 rounded-lg hover:bg-slate-800 text-slate-300"><Smile size={18} /></button>
                                {isOwn && <><div className="w-px h-6 bg-slate-800 mx-1"></div><button onClick={(e) => { e.stopPropagation(); handleDelete(); }} className="p-2 rounded-lg hover:bg-red-500/20 text-red-400"><Trash2 size={18} /></button></>}
                            </div>
                        )}
                        
                        {showReactions && (
                            <div className={`absolute -top-28 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl z-50 flex flex-wrap max-w-[160px] p-2 gap-2 animate-fade-in`}>
                                {EMOJIS.map(emoji => <button key={emoji} onClick={(e) => { e.stopPropagation(); handleReaction(emoji); }} className="hover:bg-slate-800 p-1.5 rounded-lg text-xl">{emoji}</button>)}
                            </div>
                        )}

                        {renderContent()}
                        <div className={`flex items-center justify-end gap-1 mt-1 text-[10px] ${isOwn ? 'text-indigo-200' : 'text-slate-500'} font-medium`}><span>{format(message.timestamp, 'HH:mm')}</span></div>
                        
                        {message.reactions && Object.keys(message.reactions).length > 0 && (
                            <div className={`absolute -bottom-3 ${isOwn ? 'left-0' : 'right-0'} flex -space-x-1 cursor-pointer`} onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); setShowActions(true); }}>
                                {Object.entries(message.reactions).slice(0, 4).map(([user, emoji]) => (
                                    <div key={user} className="bg-slate-800 border border-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md z-10" title={user}>{emoji}</div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [isLoginView, setIsLoginView] = useState(true);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [chats, setChats] = useState([]);
            const [areChatsLoading, setAreChatsLoading] = useState(false);
            const [activeChatUser, setActiveChatUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [showMobileSidebar, setShowMobileSidebar] = useState(true);
            const [isRecording, setIsRecording] = useState(false);
            const [connectionError, setConnectionError] = useState('');
            const mediaRecorderRef = useRef(null);
            const messagesEndRef = useRef(null);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase
            useEffect(() => {
                if (currentUser) {
                    const testConnection = async () => {
                        try {
                            const testRef = ref(db, '.info/connected');
                            onValue(testRef, (snapshot) => {
                                if (snapshot.val() === true) {
                                    setConnectionError('');
                                } else {
                                    setConnectionError('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                                }
                            });
                        } catch (error) {
                            setConnectionError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase');
                        }
                    };
                    testConnection();
                }
            }, [currentUser]);

            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
            useEffect(() => {
                if (currentUser) {
                    setAreChatsLoading(true);
                    const userRef = ref(db, `users/${currentUser}`);
                    
                    // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    update(userRef, { 
                        isOnline: true, 
                        lastSeen: Date.now() 
                    }).catch(error => {
                        console.warn('Cannot update user status:', error);
                    });
                    
                    const messagesRef = ref(db, 'messages');
                    const unsubscribe = onValue(messagesRef, (snapshot) => {
                        setAreChatsLoading(false);
                        const data = snapshot.val();
                        if (!data) { 
                            setChats([]); 
                            return; 
                        }
                        
                        const newChats = new Map();
                        
                        Object.entries(data).forEach(([chatId, chatMessages]) => {
                            const usersInChat = chatId.split('_');
                            if (usersInChat.includes(currentUser)) {
                                const otherUser = usersInChat.find(user => user !== currentUser) || currentUser;
                                
                                if (chatMessages && Object.keys(chatMessages).length > 0) {
                                    const messagesList = Object.values(chatMessages)
                                        .filter(m => m && !m.deleted)
                                        .sort((a, b) => b.timestamp - a.timestamp);
                                    
                                    if (messagesList.length > 0) {
                                        newChats.set(otherUser, { 
                                            user: otherUser, 
                                            lastMessage: messagesList[0], 
                                            timestamp: messagesList[0].timestamp 
                                        });
                                    }
                                }
                            }
                        });
                        
                        setChats(Array.from(newChats.values()).sort((a, b) => b.timestamp - a.timestamp));
                    }, (error) => {
                        console.error('Chats loading error:', error);
                        setAreChatsLoading(false);
                        setConnectionError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
                    });
                    
                    return () => { 
                        off(messagesRef); 
                        update(userRef, { isOnline: false }).catch(()=>{}); 
                    };
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ê –°–û–†–¢–ò–†–û–í–ö–ê
            useEffect(() => {
                if (currentUser && activeChatUser) {
                    const chatId = [currentUser, activeChatUser].sort().join('_');
                    const chatRef = ref(db, `messages/${chatId}`);
                    
                    const unsubscribe = onValue(chatRef, (snapshot) => {
                        const data = snapshot.val();
                        const messagesData = data ? Object.entries(data)
                            .map(([k, v]) => ({ ...v, id: k }))
                            .filter(msg => !msg.deleted)
                            .sort((a, b) => a.timestamp - b.timestamp) : []; // –ò–°–ü–†–ê–í–õ–ï–ù–û: —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –≤—Ä–µ–º–µ–Ω–∏
                        setMessages(messagesData);
                    }, (error) => {
                        console.error('Messages loading error:', error);
                        setConnectionError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
                    });
                    
                    setShowMobileSidebar(false);
                    return () => off(chatRef);
                } else { 
                    setShowMobileSidebar(true); 
                }
            }, [currentUser, activeChatUser]);

            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            useEffect(() => { 
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); 
            }, [messages]);

            const handleAuth = () => {
                if (!usernameInput.trim() || !passwordInput.trim()) return;
                const cleanUsername = usernameInput.trim();
                const userRef = ref(db, `users/${cleanUsername}`);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (isLoginView) {
                        if (data && data.password === passwordInput) {
                            localStorage.setItem('dolbaeb_user', cleanUsername); 
                            setCurrentUser(cleanUsername); 
                            setAuthError('');
                        } else { 
                            setAuthError('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); 
                        }
                    } else {
                        if (data) { 
                            setAuthError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); 
                        } else {
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º set –≤–º–µ—Å—Ç–æ update –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            set(userRef, { 
                                username: cleanUsername, 
                                password: passwordInput, 
                                createdAt: Date.now(), 
                                isOnline: true, 
                                lastSeen: Date.now() 
                            }).then(() => { 
                                localStorage.setItem('dolbaeb_user', cleanUsername); 
                                setCurrentUser(cleanUsername); 
                                setAuthError(''); 
                            }).catch(error => {
                                console.error('Registration error:', error);
                                setAuthError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.');
                            });
                        }
                    }
                }, { onlyOnce: true });
            };

            const handleLogout = () => {
                if(currentUser) {
                    update(ref(db, `users/${currentUser}`), { isOnline: false, lastSeen: Date.now() }).catch(() => {});
                }
                localStorage.removeItem('dolbaeb_user'); 
                setCurrentUser(null); 
                setActiveChatUser(null); 
                setChats([]); 
                setIsSettingsOpen(false);
            };

            const handleSendMessage = async (type = 'text', content = messageInput) => {
                if ((!content.trim() && type === 'text') || !currentUser || !activeChatUser) return;
                
                const chatId = [currentUser, activeChatUser].sort().join('_');
                console.log('Sending message to chat:', chatId);
                
                try {
                    const messageRef = push(ref(db, `messages/${chatId}`));
                    
                    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ undefined –ø–æ–ª–µ–π
                    const messageData = {
                        sender: currentUser, 
                        text: type === 'text' ? content : '', 
                        timestamp: Date.now(),
                        type, 
                        deleted: false
                    };
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º mediaUrl —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (type !== 'text' && content) {
                        messageData.mediaUrl = content;
                    }
                    
                    await set(messageRef, messageData);
                    
                    console.log('Message sent successfully');
                    if (type === 'text') setMessageInput('');
                } catch (e) { 
                    console.error("Send error details:", e);
                    console.error("Error code:", e.code);
                    console.error("Error message:", e.message);
                    
                    if (e.code === 'PERMISSION_DENIED') {
                        alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Firebase Database.\n\n–ó–∞–π–¥–∏—Ç–µ –≤ Firebase Console ‚Üí Realtime Database ‚Üí Rules –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:\n\n{\n  \"rules\": {\n    \".read\": true,\n    \".write\": true\n  }\n}");
                    } else {
                        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + (e.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'));
                    }
                }
            };

            const handleSearch = (term) => {
                setSearchQuery(term);
                if (!term.trim()) { 
                    setSearchResults([]); 
                    return; 
                }
                const q = query(ref(db, 'users'), orderByChild('username'), startAt(term), endAt(term + '\uf8ff'));
                onValue(q, (snapshot) => {
                    const data = snapshot.val();
                    setSearchResults(data ? Object.values(data).filter(u => u.username !== currentUser) : []);
                }, { onlyOnce: true });
            };

            const handleFileUpload = (e, type) => {
                const file = e.target.files?.[0];
                if (!file || file.size > 8 * 1024 * 1024) { 
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 8MB'); 
                    return; 
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    if (ev.target.result) {
                        handleSendMessage(type, ev.target.result);
                    }
                };
                reader.onerror = () => {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                };
                reader.readAsDataURL(file); 
                e.target.value = '';
            };

            const toggleRecording = async () => {
                if (isRecording) { 
                    mediaRecorderRef.current?.stop(); 
                    setIsRecording(false); 
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 
                                         MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
                        
                        const mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
                        const audioChunks = [];
                        
                        mediaRecorder.ondataavailable = (e) => { 
                            if (e.data.size > 0) audioChunks.push(e.data); 
                        };
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                if (e.target.result) {
                                    handleSendMessage('audio', e.target.result);
                                }
                            };
                            reader.readAsDataURL(blob);
                            stream.getTracks().forEach(t => t.stop());
                        };
                        mediaRecorder.start(); 
                        setIsRecording(true); 
                        mediaRecorderRef.current = mediaRecorder;
                    } catch (err) { 
                        alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"); 
                    }
                }
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-slate-950 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-950 to-slate-950">
                        <div className="w-full max-w-md bg-slate-900/60 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-indigo-500/20 animate-fade-in relative overflow-hidden">
                            <div className="text-center mb-10">
                                <h1 className="text-4xl font-bold text-white mb-2">DolbaebSMS</h1>
                                <p className="text-slate-400 font-light">Secure. Fast. Simple.</p>
                            </div>
                            {authError && <div className="p-3 mb-4 rounded-xl bg-red-500/10 text-red-400 text-center">{authError}</div>}
                            <div className="space-y-4">
                                <input type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-indigo-500 outline-none" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} />
                                <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-indigo-500 outline-none" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAuth()} />
                            </div>
                            <Button className="w-full mt-6 py-4" onClick={handleAuth}>{isLoginView ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'}</Button>
                            <div className="text-center mt-6">
                                <button onClick={() => { setIsLoginView(!isLoginView); setAuthError(''); }} className="text-slate-400 hover:text-indigo-400 text-sm">
                                    {isLoginView ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} currentUser={currentUser} onLogout={handleLogout} />
                    
                    {/* Connection Error Banner */}
                    {connectionError && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg text-sm backdrop-blur-sm">
                            {connectionError}
                        </div>
                    )}
                    
                    {/* Sidebar */}
                    <div className={`${showMobileSidebar ? 'flex' : 'hidden'} md:flex w-full md:w-[420px] flex-col border-r border-slate-800 bg-slate-900 z-10`}>
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between h-[72px]">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold">{currentUser[0].toUpperCase()}</div>
                                <div>
                                    <h2 className="font-bold text-white">{currentUser}</h2>
                                    <span className="text-[11px] text-green-500 flex items-center gap-1">‚óè –í —Å–µ—Ç–∏</span>
                                </div>
                            </div>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2.5 rounded-xl bg-slate-800 text-slate-400 hover:text-white">
                                <SettingsIcon size={20} />
                            </button>
                        </div>
                        <div className="p-4">
                            <div className="relative">
                                <Search className="absolute left-3 top-3 text-slate-500" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="–ü–æ–∏—Å–∫..." 
                                    className="w-full bg-slate-800 border border-slate-700 rounded-xl py-2.5 pl-10 text-slate-200 outline-none focus:border-indigo-500" 
                                    value={searchQuery} 
                                    onChange={e => handleSearch(e.target.value)} 
                                />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-2">
                            {areChatsLoading ? (
                                <div className="flex flex-col items-center justify-center mt-10 text-slate-500 gap-2">
                                    <Loader2 className="animate-spin text-indigo-500" size={24} />
                                    <p className="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                                </div>
                            ) : searchQuery ? (
                                searchResults.length ? searchResults.map(u => (
                                    <div 
                                        key={u.username} 
                                        onClick={() => { setActiveChatUser(u.username); setSearchQuery(''); setSearchResults([]); }} 
                                        className="p-3 flex items-center gap-3 rounded-xl hover:bg-slate-800 cursor-pointer"
                                    >
                                        <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-300 font-bold border border-slate-700">
                                            {u.username[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 className="font-medium text-slate-200">{u.username}</h3>
                                        </div>
                                    </div>
                                )) : <div className="text-center text-slate-500 mt-4">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            ) : (
                                chats.length ? chats.map(c => (
                                    <div 
                                        key={c.user} 
                                        onClick={() => setActiveChatUser(c.user)} 
                                        className={`p-3 flex items-center gap-3 rounded-xl cursor-pointer hover:bg-slate-800 ${activeChatUser === c.user ? 'bg-slate-800' : ''}`}
                                    >
                                        <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold border border-slate-700">
                                            {c.user[0].toUpperCase()}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <div className="flex justify-between items-baseline">
                                                <h3 className="font-semibold text-slate-200 truncate">{c.user}</h3>
                                                <span className="text-xs text-slate-500">
                                                    {new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                </span>
                                            </div>
                                            <p className="text-sm text-slate-400 truncate">
                                                {c.lastMessage.type === 'text' ? c.lastMessage.text : 
                                                 c.lastMessage.type === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 
                                                 c.lastMessage.type === 'video' ? 'üé• –í–∏–¥–µ–æ' : 
                                                 c.lastMessage.type === 'audio' ? 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ' : '–°–æ–æ–±—â–µ–Ω–∏–µ'}
                                            </p>
                                        </div>
                                    </div>
                                )) : (
                                    <div className="text-center text-slate-500 mt-10 p-4">
                                        <p>–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                                        <p className="text-xs mt-2">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                                    </div>
                                )
                            )}
                        </div>
                    </div>

                    {/* Chat Area */}
                    {activeChatUser ? (
                        <div className={`${!showMobileSidebar ? 'flex' : 'hidden md:flex'} flex-1 flex-col bg-slate-950 relative`}>
                            <div className="h-[72px] px-4 flex items-center gap-3 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md sticky top-0 z-20">
                                <button onClick={() => { setActiveChatUser(null); setShowMobileSidebar(true); }} className="md:hidden text-slate-400">
                                    <ChevronLeft size={24} />
                                </button>
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold">
                                    {activeChatUser[0].toUpperCase()}
                                </div>
                                <h3 className="font-bold text-slate-200">{activeChatUser}</h3>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                {messages.map(msg => (
                                    <MessageBubble 
                                        key={msg.id} 
                                        message={msg} 
                                        isOwn={msg.sender === currentUser} 
                                        chatId={[currentUser, activeChatUser].sort().join('_')} 
                                        messageId={msg.id} 
                                        currentUser={currentUser} 
                                    />
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="p-3 bg-slate-900 border-t border-slate-800 safe-area-bottom">
                                <div className="flex items-end gap-2 max-w-4xl mx-auto">
                                    <div className="flex gap-1 bg-slate-800 p-1 rounded-xl shrink-0">
                                        <label className="p-2 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <ImageIcon size={20} />
                                            <input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(e, 'photo')} />
                                        </label>
                                        <label className="p-2 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <Video size={20} />
                                            <input type="file" className="hidden" accept="video/*" onChange={e => handleFileUpload(e, 'video')} />
                                        </label>
                                        <button 
                                            onClick={toggleRecording} 
                                            className={`p-2 rounded-lg ${isRecording ? 'text-red-500 animate-pulse' : 'text-slate-400 hover:text-indigo-400'}`}
                                        >
                                            {isRecording ? <div className="w-5 h-5 bg-red-500 rounded-sm" /> : <Mic size={20} />}
                                        </button>
                                    </div>
                                    <div className="flex-1 min-w-0 bg-slate-800 rounded-2xl border border-slate-700">
                                        <textarea 
                                            value={messageInput} 
                                            onChange={e => setMessageInput(e.target.value)} 
                                            onKeyPress={e => { 
                                                if(e.key === 'Enter' && !e.shiftKey) { 
                                                    e.preventDefault(); 
                                                    handleSendMessage('text'); 
                                                }
                                            }} 
                                            placeholder={isRecording ? "–ó–∞–ø–∏—Å—å..." : "–°–æ–æ–±—â–µ–Ω–∏–µ..."} 
                                            className="w-full bg-transparent text-white px-4 py-3 outline-none resize-none h-[50px] custom-scrollbar" 
                                        />
                                    </div>
                                    <button 
                                        onClick={() => handleSendMessage('text')} 
                                        disabled={!messageInput.trim() && !isRecording} 
                                        className="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 shadow-lg shadow-indigo-600/20 shrink-0"
                                    >
                                        <Send size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="hidden md:flex flex-1 items-center justify-center bg-slate-950 text-slate-500 flex-col gap-4">
                            <div className="w-24 h-24 rounded-full bg-slate-900 border border-slate-800 flex items-center justify-center">
                                <Send size={40} className="text-indigo-500" />
                            </div>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
