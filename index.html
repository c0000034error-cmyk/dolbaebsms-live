<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS - Secure Messenger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-gold': 'pulseGold 2s infinite',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              pulseGold: { '0%, 100%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.05)', opacity: '0.8' } }
            }
          }
        }
      }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles -->
    <style>
      body { background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
      
      /* Frame styles */
      .frame-basic { border: 2px solid #6b7280; box-shadow: 0 0 5px rgba(107, 114, 128, 0.5); }
      .frame-silver { border: 3px solid #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.7); }
      .frame-gold { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
      .frame-diamond { border: 3px solid #b9f2ff; box-shadow: 0 0 20px rgba(185, 242, 255, 0.9); }
      .frame-rainbow { 
        border: 3px solid transparent;
        background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff) border-box;
        box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
      }
      
      /* Mobile optimizations */
      @media (max-width: 640px) {
        .safe-area-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        /* Hide scrollbar on mobile for cleaner look */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      }

      .coin-animation {
        animation: coinPop 0.5s ease-out;
      }

      @keyframes coinPop {
        0% { transform: scale(0.5); opacity: 0; }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); opacity: 1; }
      }

      .avatar-locked {
        filter: grayscale(1) brightness(0.5);
        position: relative;
      }

      .avatar-locked::after {
        content: "üîí";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        z-index: 10;
      }

      /* Casino animations */
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes win {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
      }

      @keyframes diceRoll {
        0% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(90deg) scale(1.1); }
        50% { transform: rotate(180deg) scale(1); }
        75% { transform: rotate(270deg) scale(1.1); }
        100% { transform: rotate(360deg) scale(1); }
      }

      @keyframes cardFlip {
        0% { transform: rotateY(0deg); }
        50% { transform: rotateY(90deg); }
        100% { transform: rotateY(0deg); }
      }

      .slot-machine {
        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
        border: 2px solid #475569;
        border-radius: 12px;
        padding: 10px;
        position: relative;
        overflow: hidden;
      }

      .slot-reel {
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        background: #0f172a;
        border-radius: 8px;
        margin: 5px;
        border: 1px solid #334155;
      }

      .spinning {
        animation: spin 0.1s linear infinite;
      }

      .win-animation {
        animation: win 0.5s ease-in-out 3;
      }

      .dice-rolling {
        animation: diceRoll 0.5s ease-in-out;
      }

      .card-flipping {
        animation: cardFlip 0.6s ease-in-out;
      }

      /* Card styles */
      .card {
        width: 80px;
        height: 120px;
        background: #1e293b;
        border: 2px solid #475569;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        color: white;
        margin: 5px;
      }

      .card.red { background: #dc2626; }
      .card.black { background: #1f2937; }
      .card.win { box-shadow: 0 0 20px #22c55e; }

      /* Roulette styles */
      .roulette-wheel {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: conic-gradient(
          #ef4444 0deg 60deg,
          #000000 60deg 120deg,
          #3b82f6 120deg 180deg,
          #ef4444 180deg 240deg,
          #000000 240deg 300deg,
          #3b82f6 300deg 360deg
        );
        position: relative;
        margin: 0 auto;
        transition: transform 3s cubic-bezier(0.2, 0.8, 0.3, 1);
      }

      .roulette-pointer {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 20px solid #ffffff;
        z-index: 10;
      }

      /* Coin flip */
      .coin {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(45deg, #f59e0b, #fbbf24);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        margin: 0 auto;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 1s;
      }

      .coin.flipped {
        transform: rotateY(180deg);
      }

      .coin-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .coin-back {
        transform: rotateY(180deg);
        background: linear-gradient(45deg, #dc2626, #ef4444);
      }
    </style>

    <!-- Import Map -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "date-fns": "https://esm.sh/date-fns@2.30.0",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Video, Settings as SettingsIcon, Menu, Trash2, Smile, MoreVertical, Lock, LogOut, User as UserIcon, Loader2, Coins, Zap, Crown, Palette, Edit3, Dice5, Trophy } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        // --- Services ---
        const firebaseConfig = {
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87",
            measurementId: "G-SCD5JVFM5E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Components ---

        // 1. Button
        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-4 py-3 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                ghost: "bg-transparent hover:bg-white/5 text-slate-300",
                gold: "bg-yellow-500 hover:bg-yellow-400 text-white shadow-lg shadow-yellow-500/20"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? (
                        <Loader2 className="animate-spin h-5 w-5" />
                    ) : (<>{icon && <span className="text-lg">{icon}</span>}{children}</>)}
                </button>
            );
        };

        // 2. Casino Modal with Multiple Games
        const CasinoModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate }) => {
            const [activeGame, setActiveGame] = useState('slots');
            const [betAmount, setBetAmount] = useState(1);
            const [isSpinning, setIsSpinning] = useState(false);
            const [result, setResult] = useState(null);
            const [lastWin, setLastWin] = useState(0);

            // Slots state
            const [slots, setSlots] = useState(['üçí', 'üçã', 'üçä']);
            
            // Dice state
            const [dice1, setDice1] = useState(1);
            const [dice2, setDice2] = useState(1);
            const [diceBet, setDiceBet] = useState('over'); // 'over' or 'under'
            
            // Cards state
            const [cards, setCards] = useState([null, null, null]);
            const [selectedCard, setSelectedCard] = useState(null);
            
            // Roulette state
            const [rouletteNumber, setRouletteNumber] = useState(0);
            const [rouletteColor, setRouletteColor] = useState('red'); // 'red', 'black', 'blue'
            const [rouletteBet, setRouletteBet] = useState('red');
            
            // Coin flip state
            const [coinSide, setCoinSide] = useState('heads');
            const [coinBet, setCoinBet] = useState('heads');

            if (!isOpen) return null;

            const games = [
                { id: 'slots', name: 'üé∞ –°–ª–æ—Ç—ã', description: '3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö = x3' },
                { id: 'dice', name: 'üé≤ –ö–æ—Å—Ç–∏', description: '–®–∞–Ω—Å 60%' },
                { id: 'cards', name: 'üÉè –ö–∞—Ä—Ç—ã', description: '–ù–∞–π–¥–∏ —Ç—É–∑–∞!' },
                { id: 'roulette', name: 'üé° –†—É–ª–µ—Ç–∫–∞', description: '–¶–≤–µ—Ç–∞' },
                { id: 'coin', name: 'ü™ô –ú–æ–Ω–µ—Ç–∫–∞', description: '50/50' }
            ];

            const symbols = ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '‚≠ê', '7Ô∏è‚É£'];

            // SLOTS GAME
            const spinSlots = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                
                setIsSpinning(true);
                setResult(null);

                // Deduct bet amount
                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                // Simulate spinning animation
                const spins = 20;
                let spinCount = 0;

                const spinInterval = setInterval(() => {
                    const newSlots = [
                        symbols[Math.floor(Math.random() * symbols.length)],
                        symbols[Math.floor(Math.random() * symbols.length)],
                        symbols[Math.floor(Math.random() * symbols.length)]
                    ];
                    setSlots(newSlots);
                    spinCount++;

                    if (spinCount >= spins) {
                        clearInterval(spinInterval);
                        
                        // Final result with HIGHER WIN CHANCES
                        const finalSlots = [
                            symbols[Math.floor(Math.random() * symbols.length)],
                            symbols[Math.floor(Math.random() * symbols.length)],
                            symbols[Math.floor(Math.random() * symbols.length)]
                        ];
                        
                        // Increase chances of winning
                        if (Math.random() < 0.6) { // 60% chance to manipulate for win
                            if (Math.random() < 0.7) {
                                // Make two symbols the same
                                finalSlots[1] = finalSlots[0];
                            }
                            if (Math.random() < 0.4) {
                                // Make all three the same
                                finalSlots[2] = finalSlots[0];
                                finalSlots[1] = finalSlots[0];
                            }
                        }
                        
                        setSlots(finalSlots);

                        // Calculate win with BETTER ODDS
                        let winMultiplier = 0;
                        if (finalSlots[0] === finalSlots[1] && finalSlots[1] === finalSlots[2]) {
                            // Three same symbols
                            if (finalSlots[0] === '7Ô∏è‚É£') winMultiplier = 5;
                            else if (finalSlots[0] === '‚≠ê') winMultiplier = 3;
                            else winMultiplier = 2.5;
                        } else if (finalSlots[0] === finalSlots[1] || finalSlots[1] === finalSlots[2] || finalSlots[0] === finalSlots[2]) {
                            // Two same symbols - MORE FREQUENT
                            winMultiplier = 1.8;
                        }

                        const winAmount = betAmount * winMultiplier;
                        if (winAmount > 0) {
                            const finalCoins = newCoins + winAmount;
                            update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                            onCoinsUpdate(finalCoins);
                            setLastWin(winAmount);
                        }

                        setResult({
                            win: winAmount > 0,
                            amount: winAmount,
                            multiplier: winMultiplier
                        });

                        setIsSpinning(false);
                    }
                }, 100);
            };

            // DICE GAME
            const rollDice = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                
                setIsSpinning(true);
                setResult(null);

                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                // Animate dice
                let rollCount = 0;
                const rollInterval = setInterval(() => {
                    setDice1(Math.floor(Math.random() * 6) + 1);
                    setDice2(Math.floor(Math.random() * 6) + 1);
                    rollCount++;

                    if (rollCount >= 10) {
                        clearInterval(rollInterval);
                        
                        // Final roll with BETTER ODDS
                        const total = Math.floor(Math.random() * 11) + 2; // 2-12
                        
                        // Manipulate results for better player experience
                        let finalTotal;
                        if (diceBet === 'over') {
                            // Higher chance to roll over 7
                            finalTotal = Math.random() < 0.65 ? 
                                Math.floor(Math.random() * 5) + 8 : // 8-12 (65% chance)
                                Math.floor(Math.random() * 6) + 2;  // 2-7 (35% chance)
                        } else {
                            // Higher chance to roll under 7
                            finalTotal = Math.random() < 0.65 ? 
                                Math.floor(Math.random() * 5) + 2 : // 2-6 (65% chance)
                                Math.floor(Math.random() * 6) + 7;  // 7-12 (35% chance)
                        }
                        
                        // Set individual dice values to match total
                        const die1 = Math.floor(Math.random() * 6) + 1;
                        const die2 = finalTotal - die1;
                        
                        setDice1(Math.max(1, Math.min(6, die1)));
                        setDice2(Math.max(1, Math.min(6, die2)));

                        const win = (diceBet === 'over' && finalTotal > 7) || 
                                   (diceBet === 'under' && finalTotal < 7);
                        
                        const winAmount = win ? betAmount * 1.8 : 0;
                        if (win) {
                            const finalCoins = newCoins + winAmount;
                            update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                            onCoinsUpdate(finalCoins);
                            setLastWin(winAmount);
                        }

                        setResult({
                            win: win,
                            amount: winAmount,
                            total: finalTotal
                        });

                        setIsSpinning(false);
                    }
                }, 100);
            };

            // CARD GAME
            const startCardGame = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                
                setIsSpinning(true);
                setResult(null);
                setSelectedCard(null);

                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                // Create cards - one ace, two other cards
                const cardTypes = ['A', 'K', 'Q'];
                const shuffled = [...cardTypes].sort(() => Math.random() - 0.5);
                setCards(shuffled);

                setIsSpinning(false);
            };

            const selectCard = async (index) => {
                if (selectedCard !== null || isSpinning) return;
                
                setIsSpinning(true);
                setSelectedCard(index);

                // Reveal result after delay
                setTimeout(() => {
                    const isAce = cards[index] === 'A';
                    const winAmount = isAce ? betAmount * 3 : 0;
                    
                    if (isAce) {
                        const finalCoins = userCoins - betAmount + winAmount;
                        update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                        onCoinsUpdate(finalCoins);
                        setLastWin(winAmount);
                    }

                    setResult({
                        win: isAce,
                        amount: winAmount,
                        card: cards[index]
                    });

                    setIsSpinning(false);
                }, 1000);
            };

            // ROULETTE GAME
            const spinRoulette = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                
                setIsSpinning(true);
                setResult(null);

                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                // Animate roulette
                const spins = 50 + Math.floor(Math.random() * 20);
                let spinCount = 0;

                const spinInterval = setInterval(() => {
                    const num = Math.floor(Math.random() * 6);
                    const colors = ['red', 'black', 'blue'];
                    setRouletteNumber(num);
                    setRouletteColor(colors[num % 3]);
                    spinCount++;

                    if (spinCount >= spins) {
                        clearInterval(spinInterval);
                        
                        // Final result with BETTER COLOR DISTRIBUTION
                        const finalNumber = Math.floor(Math.random() * 6);
                        const colorMap = {
                            0: 'red', 1: 'black', 2: 'blue',
                            3: 'red', 4: 'black', 5: 'blue'
                        };
                        const finalColor = colorMap[finalNumber];
                        
                        setRouletteNumber(finalNumber);
                        setRouletteColor(finalColor);

                        // Increase win chances for color bets
                        let win = false;
                        if (rouletteBet === finalColor) {
                            win = true;
                        } else if (Math.random() < 0.3) { // 30% chance to force win
                            win = true;
                        }

                        const winAmount = win ? betAmount * 2 : 0;
                        if (win) {
                            const finalCoins = newCoins + winAmount;
                            update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                            onCoinsUpdate(finalCoins);
                            setLastWin(winAmount);
                        }

                        setResult({
                            win: win,
                            amount: winAmount,
                            color: finalColor
                        });

                        setIsSpinning(false);
                    }
                }, 50);
            };

            // COIN FLIP GAME
            const flipCoin = async () => {
                if (isSpinning || betAmount > userCoins || betAmount <= 0) return;
                
                setIsSpinning(true);
                setResult(null);

                const newCoins = userCoins - betAmount;
                await update(ref(db, `users/${currentUser}`), { coins: newCoins });
                onCoinsUpdate(newCoins);

                // Animate coin flip
                let flipCount = 0;
                const flipInterval = setInterval(() => {
                    setCoinSide(Math.random() > 0.5 ? 'heads' : 'tails');
                    flipCount++;

                    if (flipCount >= 10) {
                        clearInterval(flipInterval);
                        
                        // Final result with SLIGHTLY BETTER ODDS
                        const finalSide = Math.random() < 0.55 ? coinBet : 
                                         (coinBet === 'heads' ? 'tails' : 'heads');
                        
                        setCoinSide(finalSide);

                        const win = finalSide === coinBet;
                        const winAmount = win ? betAmount * 1.9 : 0;
                        if (win) {
                            const finalCoins = newCoins + winAmount;
                            update(ref(db, `users/${currentUser}`), { coins: finalCoins });
                            onCoinsUpdate(finalCoins);
                            setLastWin(winAmount);
                        }

                        setResult({
                            win: win,
                            amount: winAmount,
                            side: finalSide
                        });

                        setIsSpinning(false);
                    }
                }, 100);
            };

            const maxBet = Math.min(userCoins, 100);

            const renderGame = () => {
                switch (activeGame) {
                    case 'slots':
                        return (
                            <div className="space-y-4">
                                <div className="slot-machine">
                                    <div className="flex justify-between mb-4">
                                        <div className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>
                                            {slots[0]}
                                        </div>
                                        <div className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>
                                            {slots[1]}
                                        </div>
                                        <div className={`slot-reel flex-1 ${isSpinning ? 'spinning' : ''}`}>
                                            {slots[2]}
                                        </div>
                                    </div>
                                </div>
                                <Button 
                                    onClick={spinSlots}
                                    isLoading={isSpinning}
                                    disabled={userCoins < betAmount || isSpinning}
                                    variant="gold"
                                    className="w-full"
                                >
                                    {isSpinning ? '–ö—Ä—É—Ç–∏–º...' : `–ö—Ä—É—Ç–∏—Ç—å –∑–∞ ${betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤`}
                                </Button>
                            </div>
                        );

                    case 'dice':
                        return (
                            <div className="space-y-4">
                                <div className="text-center">
                                    <div className="flex justify-center gap-4 mb-4">
                                        <div className={`text-4xl p-4 bg-slate-800 rounded-lg ${isSpinning ? 'dice-rolling' : ''}`}>
                                            {dice1}
                                        </div>
                                        <div className={`text-4xl p-4 bg-slate-800 rounded-lg ${isSpinning ? 'dice-rolling' : ''}`}>
                                            {dice2}
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mb-4">
                                        <button
                                            onClick={() => setDiceBet('over')}
                                            className={`flex-1 py-2 rounded-lg ${
                                                diceBet === 'over' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300'
                                            }`}
                                        >
                                            –ë–æ–ª—å—à–µ 7
                                        </button>
                                        <button
                                            onClick={() => setDiceBet('under')}
                                            className={`flex-1 py-2 rounded-lg ${
                                                diceBet === 'under' ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-300'
                                            }`}
                                        >
                                            –ú–µ–Ω—å—à–µ 7
                                        </button>
                                    </div>
                                </div>
                                <Button 
                                    onClick={rollDice}
                                    isLoading={isSpinning}
                                    disabled={userCoins < betAmount || isSpinning}
                                    variant="gold"
                                    className="w-full"
                                >
                                    {isSpinning ? '–ë—Ä–æ—Å–∞–µ–º...' : `–ë—Ä–æ—Å–∏—Ç—å –∑–∞ ${betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤`}
                                </Button>
                            </div>
                        );

                    case 'cards':
                        return (
                            <div className="space-y-4">
                                <div className="flex justify-center gap-2 mb-4">
                                    {cards.map((card, index) => (
                                        <div
                                            key={index}
                                            onClick={() => selectCard(index)}
                                            className={`card ${selectedCard === index ? 'card-flipping' : ''} ${
                                                selectedCard !== null && cards[index] === 'A' ? 'win' : ''
                                            } ${selectedCard === index ? (cards[index] === 'A' ? 'red' : 'black') : ''}`}
                                        >
                                            {selectedCard === index ? card : '?'}
                                        </div>
                                    ))}
                                </div>
                                {cards.every(card => card === null) ? (
                                    <Button 
                                        onClick={startCardGame}
                                        disabled={userCoins < betAmount}
                                        variant="gold"
                                        className="w-full"
                                    >
                                        –ù–∞—á–∞—Ç—å –∏–≥—Ä—É –∑–∞ {betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤
                                    </Button>
                                ) : (
                                    <Button 
                                        onClick={startCardGame}
                                        disabled={userCoins < betAmount || isSpinning}
                                        variant="gold"
                                        className="w-full"
                                    >
                                        –ù–æ–≤–∞—è –∏–≥—Ä–∞ –∑–∞ {betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤
                                    </Button>
                                )}
                            </div>
                        );

                    case 'roulette':
                        return (
                            <div className="space-y-4">
                                <div className="relative">
                                    <div className="roulette-wheel" style={{ transform: `rotate(${rouletteNumber * 60}deg)` }}>
                                        <div className="roulette-pointer"></div>
                                    </div>
                                    <div className="text-center mt-4 text-xl font-bold">
                                        <span className={rouletteColor === 'red' ? 'text-red-400' : rouletteColor === 'blue' ? 'text-blue-400' : 'text-white'}>
                                            {rouletteColor === 'red' ? '–ö–†–ê–°–ù–û–ï' : rouletteColor === 'blue' ? '–°–ò–ù–ï–ï' : '–ß–ï–†–ù–û–ï'}
                                        </span>
                                    </div>
                                </div>
                                <div className="flex gap-2 mb-4">
                                    {['red', 'black', 'blue'].map(color => (
                                        <button
                                            key={color}
                                            onClick={() => setRouletteBet(color)}
                                            className={`flex-1 py-2 rounded-lg ${
                                                rouletteBet === color ? 
                                                (color === 'red' ? 'bg-red-600' : color === 'blue' ? 'bg-blue-600' : 'bg-gray-800') + ' text-white' : 
                                                'bg-slate-700 text-slate-300'
                                            }`}
                                        >
                                            {color === 'red' ? '–ö—Ä–∞—Å–Ω–æ–µ' : color === 'blue' ? '–°–∏–Ω–µ–µ' : '–ß–µ—Ä–Ω–æ–µ'}
                                        </button>
                                    ))}
                                </div>
                                <Button 
                                    onClick={spinRoulette}
                                    isLoading={isSpinning}
                                    disabled={userCoins < betAmount || isSpinning}
                                    variant="gold"
                                    className="w-full"
                                >
                                    {isSpinning ? '–ö—Ä—É—Ç–∏–º...' : `–ö—Ä—É—Ç–∏—Ç—å –∑–∞ ${betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤`}
                                </Button>
                            </div>
                        );

                    case 'coin':
                        return (
                            <div className="space-y-4">
                                <div className={`coin ${isSpinning ? 'flipped' : ''}`}>
                                    <div className="coin-face">
                                        {coinSide === 'heads' ? 'üëë' : '‚≠ê'}
                                    </div>
                                    <div className="coin-face coin-back">
                                        {coinSide === 'tails' ? '‚≠ê' : 'üëë'}
                                    </div>
                                </div>
                                <div className="flex gap-2 mb-4">
                                    <button
                                        onClick={() => setCoinBet('heads')}
                                        className={`flex-1 py-2 rounded-lg ${
                                            coinBet === 'heads' ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-slate-300'
                                        }`}
                                    >
                                        üëë –û—Ä—ë–ª
                                    </button>
                                    <button
                                        onClick={() => setCoinBet('tails')}
                                        className={`flex-1 py-2 rounded-lg ${
                                            coinBet === 'tails' ? 'bg-yellow-600 text-white' : 'bg-slate-700 text-slate-300'
                                        }`}
                                    >
                                        ‚≠ê –†–µ—à–∫–∞
                                    </button>
                                </div>
                                <Button 
                                    onClick={flipCoin}
                                    isLoading={isSpinning}
                                    disabled={userCoins < betAmount || isSpinning}
                                    variant="gold"
                                    className="w-full"
                                >
                                    {isSpinning ? '–ü–æ–¥–±—Ä–∞—Å—ã–≤–∞–µ–º...' : `–ü–æ–¥–±—Ä–æ—Å–∏—Ç—å –∑–∞ ${betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤`}
                                </Button>
                            </div>
                        );

                    default:
                        return null;
                }
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Trophy size={20} className="text-yellow-500" /> –ö–∞–∑–∏–Ω–æ</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6">
                            <div className="text-center mb-6">
                                <div className="text-slate-400 mb-2">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                                <div className="text-2xl font-bold text-yellow-500">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</div>
                            </div>

                            {/* Game Selection */}
                            <div className="grid grid-cols-3 gap-2 mb-6">
                                {games.map(game => (
                                    <button
                                        key={game.id}
                                        onClick={() => setActiveGame(game.id)}
                                        className={`p-2 rounded-lg text-center text-sm ${
                                            activeGame === game.id 
                                            ? 'bg-indigo-600 text-white' 
                                            : 'bg-slate-800 text-slate-300 hover:bg-slate-700'
                                        }`}
                                    >
                                        <div className="font-medium">{game.name}</div>
                                        <div className="text-xs opacity-75">{game.description}</div>
                                    </button>
                                ))}
                            </div>

                            {/* Bet Controls */}
                            <div className="mb-6">
                                <label className="text-slate-400 text-sm mb-2 block">–°—Ç–∞–≤–∫–∞: {betAmount.toFixed(3)} –∫–æ–∏–Ω–æ–≤</label>
                                <input 
                                    type="range" 
                                    min="0.1" 
                                    max={maxBet} 
                                    step="0.1"
                                    value={betAmount} 
                                    onChange={e => setBetAmount(parseFloat(e.target.value))}
                                    className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer slider"
                                    disabled={isSpinning}
                                />
                                <div className="flex justify-between text-xs text-slate-500 mt-1">
                                    <span>0.1</span>
                                    <span>{maxBet.toFixed(1)}</span>
                                </div>
                            </div>

                            {/* Game Area */}
                            {renderGame()}

                            {/* Result Display */}
                            {result && (
                                <div className={`text-center mt-4 p-3 rounded-lg ${result.win ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                    {result.win ? (
                                        <div className="win-animation">
                                            üéâ –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ {result.amount.toFixed(3)} –∫–æ–∏–Ω–æ–≤!
                                        </div>
                                    ) : (
                                        'üò¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!'
                                    )}
                                </div>
                            )}

                            {/* Game Instructions */}
                            <div className="text-xs text-slate-500 text-center mt-4 space-y-1">
                                {activeGame === 'slots' && (
                                    <>
                                        <div>3 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö = x2.5 | 2 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö = x1.8</div>
                                        <div>‚≠ê = x3 | 7Ô∏è‚É£ = x5</div>
                                    </>
                                )}
                                {activeGame === 'dice' && (
                                    <div>–í—ã–∏–≥—Ä—ã—à: x1.8 | –®–∞–Ω—Å: ~65%</div>
                                )}
                                {activeGame === 'cards' && (
                                    <div>–ù–∞–π–¥–∏—Ç–µ —Ç—É–∑–∞! –í—ã–∏–≥—Ä—ã—à: x3</div>
                                )}
                                {activeGame === 'roulette' && (
                                    <div>–í—ã–∏–≥—Ä—ã—à: x2 | –ö—Ä–∞—Å–Ω–æ–µ/–°–∏–Ω–µ–µ/–ß–µ—Ä–Ω–æ–µ</div>
                                )}
                                {activeGame === 'coin' && (
                                    <div>–í—ã–∏–≥—Ä—ã—à: x1.9 | –®–∞–Ω—Å: 55%</div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Name Color Modal
        const NameColorModal = ({ isOpen, onClose, currentUser, userCoins, onColorChange, purchasedColors }) => {
            const [selectedColor, setSelectedColor] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const colors = [
                { id: 'red', name: '–ö—Ä–∞—Å–Ω—ã–π', value: '#ef4444', price: 20 },
                { id: 'orange', name: '–û—Ä–∞–Ω–∂–µ–≤—ã–π', value: '#f97316', price: 20 },
                { id: 'yellow', name: '–ñ–µ–ª—Ç—ã–π', value: '#eab308', price: 20 },
                { id: 'green', name: '–ó–µ–ª–µ–Ω—ã–π', value: '#22c55e', price: 20 },
                { id: 'blue', name: '–°–∏–Ω–∏–π', value: '#3b82f6', price: 20 },
                { id: 'purple', name: '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', value: '#a855f7', price: 20 },
                { id: 'pink', name: '–†–æ–∑–æ–≤—ã–π', value: '#ec4899', price: 20 },
                { id: 'cyan', name: '–ì–æ–ª—É–±–æ–π', value: '#06b6d4', price: 20 },
                { id: 'rainbow', name: '–†–∞–¥—É–∂–Ω—ã–π', value: 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)', price: 50 }
            ];

            if (!isOpen) return null;

            const handleColorSelect = async (color) => {
                const isPurchased = purchasedColors.includes(color.id);
                
                if (!isPurchased && userCoins < color.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${color.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedColors = [...purchasedColors, color.id];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - color.price,
                            nameColor: color.id,
                            purchasedColors: newPurchasedColors
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            nameColor: color.id
                        });
                    }
                    setSelectedColor(color.id);
                    onColorChange(color.id);
                    onClose();
                } catch (error) {
                    console.error('Color change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ü–≤–µ—Ç–∞');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Palette size={20} className="text-yellow-500" /> –¶–≤–µ—Ç –∏–º–µ–Ω–∏</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            <div className="text-center mb-6">
                                <p className="text-slate-400">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={16} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Ü–≤–µ—Ç–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
                                    )}
                                </p>
                                <p className="text-sm text-slate-500 mt-2">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                {colors.map((color) => {
                                    const isPurchased = purchasedColors.includes(color.id);
                                    const canAfford = userCoins >= color.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi';
                                    
                                    return (
                                        <button
                                            key={color.id}
                                            onClick={() => !isLocked && handleColorSelect(color)}
                                            disabled={isLoading || isLocked}
                                            className={`p-4 rounded-xl flex flex-col items-center gap-3 transition-all duration-200 ${
                                                isLocked 
                                                    ? 'bg-slate-800 border-2 border-slate-700 avatar-locked' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 hover:scale-105'
                                            }`}
                                        >
                                            <div 
                                                className="w-16 h-16 rounded-full flex items-center justify-center text-white font-bold text-2xl"
                                                style={{ 
                                                    background: color.value,
                                                    border: '2px solid #374151'
                                                }}
                                            >
                                                A
                                            </div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white">{color.name}</h3>
                                                <p className="text-sm text-slate-400">
                                                    {color.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : 
                                                     isPurchased ? <span className="text-green-500">‚úì –ö—É–ø–ª–µ–Ω–æ</span> :
                                                     currentUser === 'kayivi' ? <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span> :
                                                     `${color.price} –∫–æ–∏–Ω–æ–≤`}
                                                </p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Status Modal
        const StatusModal = ({ isOpen, onClose, currentUser, userCoins, onStatusChange, purchasedStatuses }) => {
            const [selectedStatus, setSelectedStatus] = useState('');
            const [customStatus, setCustomStatus] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const statuses = [
                { id: 'online', text: '–í —Å–µ—Ç–∏', emoji: 'üü¢', price: 0 },
                { id: 'away', text: '–û—Ç–æ—à–µ–ª', emoji: 'üü°', price: 0 },
                { id: 'dnd', text: '–ù–µ –±–µ—Å–ø–æ–∫–æ–∏—Ç—å', emoji: 'üî¥', price: 0 },
                { id: 'custom1', text: '–û—Ç–¥—ã—Ö–∞—é', emoji: 'üò¥', price: 20 },
                { id: 'custom2', text: '–†–∞–±–æ—Ç–∞—é', emoji: 'üíº', price: 20 },
                { id: 'custom3', text: '–í –ø—É—Ç–∏', emoji: 'üöó', price: 20 },
                { id: 'custom4', text: '–í –æ—Ç–ø—É—Å–∫–µ', emoji: 'üèñÔ∏è', price: 20 },
                { id: 'custom5', text: '–£—á—É—Å—å', emoji: 'üìö', price: 20 }
            ];

            if (!isOpen) return null;

            const handleStatusSelect = async (status) => {
                const isPurchased = purchasedStatuses.includes(status.id) || status.price === 0;
                
                if (!isPurchased && userCoins < status.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${status.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedStatuses = [...purchasedStatuses, status.id];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - status.price,
                            status: status.text,
                            statusEmoji: status.emoji,
                            purchasedStatuses: newPurchasedStatuses
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            status: status.text,
                            statusEmoji: status.emoji
                        });
                    }
                    setSelectedStatus(status.id);
                    onStatusChange(status.text, status.emoji);
                    onClose();
                } catch (error) {
                    console.error('Status change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞');
                }
                setIsLoading(false);
            };

            const handleCustomStatus = async () => {
                if (!customStatus.trim() || userCoins < 20 && currentUser !== 'kayivi') {
                    alert('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤ (20)');
                    return;
                }

                setIsLoading(true);
                try {
                    if (currentUser !== 'kayivi') {
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - 20,
                            status: customStatus,
                            statusEmoji: 'üí¨'
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            status: customStatus,
                            statusEmoji: 'üí¨'
                        });
                    }
                    onStatusChange(customStatus, 'üí¨');
                    onClose();
                } catch (error) {
                    console.error('Custom status error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ç–∞—Ç—É—Å–∞');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><Edit3 size={20} className="text-yellow-500" /> –°—Ç–∞—Ç—É—Å</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            <div className="text-center mb-6">
                                <p className="text-slate-400">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={16} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å—Ç–∞—Ç—É—Å</span>
                                    )}
                                </p>
                                <p className="text-sm text-slate-500 mt-2">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>

                            {/* Custom Status */}
                            <div className="mb-6 p-4 bg-slate-800 rounded-xl">
                                <h3 className="text-white font-medium mb-2">–°–≤–æ–π —Å—Ç–∞—Ç—É—Å (20 –∫–æ–∏–Ω–æ–≤)</h3>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å..." 
                                        value={customStatus}
                                        onChange={e => setCustomStatus(e.target.value)}
                                        className="flex-1 bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-white outline-none"
                                    />
                                    <Button 
                                        onClick={handleCustomStatus}
                                        isLoading={isLoading}
                                        disabled={!customStatus.trim() || (userCoins < 20 && currentUser !== 'kayivi')}
                                        variant="primary"
                                    >
                                        –û–ö
                                    </Button>
                                </div>
                            </div>

                            {/* Predefined Statuses */}
                            <div className="grid grid-cols-1 gap-2">
                                {statuses.map((status) => {
                                    const isPurchased = purchasedStatuses.includes(status.id) || status.price === 0;
                                    const canAfford = userCoins >= status.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi';
                                    
                                    return (
                                        <button
                                            key={status.id}
                                            onClick={() => !isLocked && handleStatusSelect(status)}
                                            disabled={isLoading || isLocked}
                                            className={`p-3 rounded-xl flex items-center gap-3 transition-all duration-200 text-left ${
                                                isLocked 
                                                    ? 'bg-slate-800 border border-slate-700 avatar-locked' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border border-slate-600 hover:border-yellow-500'
                                            }`}
                                        >
                                            <span className="text-2xl">{status.emoji}</span>
                                            <div className="flex-1">
                                                <div className="text-white">{status.text}</div>
                                            </div>
                                            <div className="text-sm text-slate-400">
                                                {status.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : 
                                                 isPurchased ? <span className="text-green-500">‚úì</span> :
                                                 currentUser === 'kayivi' ? <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span> :
                                                 `${status.price} –∫–æ–∏–Ω–æ–≤`}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Avatar Modal
        const AvatarModal = ({ isOpen, onClose, currentUser, userCoins, onAvatarChange, purchasedAvatars }) => {
            const [selectedAvatar, setSelectedAvatar] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const avatars = [
                { emoji: 'üê∂', price: 10, name: '–°–æ–±–∞–∫–∞' },
                { emoji: 'üê±', price: 15, name: '–ö–æ—à–∫–∞' },
                { emoji: 'üê≠', price: 20, name: '–ú—ã—à—å' },
                { emoji: 'üêπ', price: 25, name: '–•–æ–º—è–∫' },
                { emoji: 'üê∞', price: 30, name: '–ö—Ä–æ–ª–∏–∫' },
                { emoji: 'ü¶ä', price: 35, name: '–õ–∏—Å–∞' },
                { emoji: 'üêª', price: 40, name: '–ú–µ–¥–≤–µ–¥—å' },
                { emoji: 'üêº', price: 45, name: '–ü–∞–Ω–¥–∞' },
                { emoji: 'üê®', price: 50, name: '–ö–æ–∞–ª–∞' },
                { emoji: 'üêØ', price: 60, name: '–¢–∏–≥—Ä' },
                { emoji: 'ü¶Å', price: 70, name: '–õ–µ–≤' },
                { emoji: 'üêÆ', price: 80, name: '–ö–æ—Ä–æ–≤–∞' },
                { emoji: 'üê∑', price: 90, name: '–°–≤–∏–Ω—å—è' },
                { emoji: 'üê∏', price: 100, name: '–õ—è–≥—É—à–∫–∞' },
                { emoji: 'üêµ', price: 120, name: '–û–±–µ–∑—å—è–Ω–∞' },
                { emoji: 'ü¶Ñ', price: 150, name: '–ï–¥–∏–Ω–æ—Ä–æ–≥' },
                { emoji: 'üêô', price: 200, name: '–û—Å—å–º–∏–Ω–æ–≥' },
                { emoji: 'üê¨', price: 250, name: '–î–µ–ª—å—Ñ–∏–Ω' },
                { emoji: 'üê≥', price: 300, name: '–ö–∏—Ç' },
                { emoji: 'ü¶ì', price: 400, name: '–ó–µ–±—Ä–∞' }
            ];

            if (!isOpen) return null;

            const handleAvatarSelect = async (avatar) => {
                const isPurchased = purchasedAvatars.includes(avatar.emoji);
                
                if (!isPurchased && userCoins < avatar.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${avatar.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–π –∞–≤–∞—Ç–∞—Ä–∫–∏.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedAvatars = [...purchasedAvatars, avatar.emoji];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - avatar.price,
                            avatar: avatar.emoji,
                            purchasedAvatars: newPurchasedAvatars
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            avatar: avatar.emoji
                        });
                    }
                    setSelectedAvatar(avatar.emoji);
                    onAvatarChange(avatar.emoji);
                    onClose();
                } catch (error) {
                    console.error('Avatar change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –∞–≤–∞—Ç–∞—Ä–∫–∏');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-4xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><UserIcon size={20} className="text-yellow-500" /> –ú–∞–≥–∞–∑–∏–Ω –∞–≤–∞—Ç–∞—Ä–æ–∫</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            <div className="text-center mb-6">
                                <p className="text-slate-400">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={16} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
                                    )}
                                </p>
                                <p className="text-sm text-slate-500 mt-2">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-4 md:grid-cols-5 gap-4">
                                {avatars.map((avatar, index) => {
                                    const isPurchased = purchasedAvatars.includes(avatar.emoji);
                                    const canAfford = userCoins >= avatar.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi';
                                    
                                    return (
                                        <button
                                            key={index}
                                            onClick={() => !isLocked && handleAvatarSelect(avatar)}
                                            disabled={isLoading || isLocked}
                                            className={`p-4 rounded-xl flex flex-col items-center gap-2 transition-all duration-200 ${
                                                isLocked 
                                                    ? 'bg-slate-800 border-2 border-slate-700 avatar-locked' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 hover:scale-105'
                                            }`}
                                        >
                                            <div className="text-4xl">{avatar.emoji}</div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white text-sm">{avatar.name}</h3>
                                                <p className="text-sm text-slate-400">
                                                    {isPurchased ? (
                                                        <span className="text-green-500">‚úì –ö—É–ø–ª–µ–Ω–æ</span>
                                                    ) : currentUser === 'kayivi' ? (
                                                        <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                                                    ) : (
                                                        `${avatar.price} –∫–æ–∏–Ω–æ–≤`
                                                    )}
                                                </p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Frame Modal
        const FrameModal = ({ isOpen, onClose, currentUser, userCoins, onFrameChange, userFrame, purchasedFrames }) => {
            const [selectedFrame, setSelectedFrame] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const frames = [
                { id: 'none', name: '–ë–µ–∑ —Ä–∞–º–∫–∏', price: 0, className: '' },
                { id: 'basic', name: '–ë–∞–∑–æ–≤–∞—è —Ä–∞–º–∫–∞', price: 10, className: 'frame-basic' },
                { id: 'silver', name: '–°–µ—Ä–µ–±—Ä—è–Ω–∞—è —Ä–∞–º–∫–∞', price: 50, className: 'frame-silver' },
                { id: 'gold', name: '–ó–æ–ª–æ—Ç–∞—è —Ä–∞–º–∫–∞', price: 100, className: 'frame-gold' },
                { id: 'diamond', name: '–ê–ª–º–∞–∑–Ω–∞—è —Ä–∞–º–∫–∞', price: 250, className: 'frame-diamond' },
                { id: 'rainbow', name: '–†–∞–¥—É–∂–Ω–∞—è —Ä–∞–º–∫–∞', price: 500, className: 'frame-rainbow' }
            ];

            if (!isOpen) return null;

            const handleFrameSelect = async (frame) => {
                const isPurchased = purchasedFrames.includes(frame.id);
                
                if (!isPurchased && userCoins < frame.price && currentUser !== 'kayivi') {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${frame.price} –∫–æ–∏–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–π —Ä–∞–º–∫–∏.`);
                    return;
                }

                setIsLoading(true);
                try {
                    if (!isPurchased && currentUser !== 'kayivi') {
                        const newPurchasedFrames = [...purchasedFrames, frame.id];
                        await update(ref(db, `users/${currentUser}`), { 
                            coins: userCoins - frame.price,
                            frame: frame.id,
                            purchasedFrames: newPurchasedFrames
                        });
                    } else {
                        await update(ref(db, `users/${currentUser}`), { 
                            frame: frame.id
                        });
                    }
                    setSelectedFrame(frame.id);
                    onFrameChange(frame.id);
                    onClose();
                } catch (error) {
                    console.error('Frame change error:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —Ä–∞–º–∫–∏');
                }
                setIsLoading(false);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-2xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><ImageIcon size={20} className="text-yellow-500" /> –ú–∞–≥–∞–∑–∏–Ω —Ä–∞–º–æ–∫</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            <div className="text-center mb-6">
                                <p className="text-slate-400">
                                    {currentUser === 'kayivi' ? (
                                        <span className="text-yellow-500 flex items-center justify-center gap-2">
                                            <Crown size={16} /> –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±–∏—Ä–∞—Ç—å —Ä–∞–º–∫–∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ!
                                        </span>
                                    ) : (
                                        <span>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–º–∫—É –¥–ª—è –ø–æ–∫—É–ø–∫–∏</span>
                                    )}
                                </p>
                                <p className="text-sm text-slate-500 mt-2">–í–∞—à–∏ –∫–æ–∏–Ω—ã: <span className="text-yellow-500 font-bold">{userCoins.toFixed(3)}</span></p>
                            </div>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                {frames.map((frame) => {
                                    const isPurchased = purchasedFrames.includes(frame.id);
                                    const canAfford = userCoins >= frame.price || currentUser === 'kayivi';
                                    const isLocked = !isPurchased && !canAfford && currentUser !== 'kayivi' && frame.price > 0;
                                    
                                    return (
                                        <button
                                            key={frame.id}
                                            onClick={() => !isLocked && handleFrameSelect(frame)}
                                            disabled={isLoading || isLocked}
                                            className={`p-4 rounded-xl flex flex-col items-center gap-3 transition-all duration-200 ${
                                                isLocked 
                                                    ? 'bg-slate-800 border-2 border-slate-700 avatar-locked' 
                                                    : userFrame === frame.id 
                                                    ? 'bg-slate-700 border-2 border-yellow-500' 
                                                    : 'bg-slate-800 hover:bg-slate-700 border-2 border-slate-600 hover:border-yellow-500 hover:scale-105'
                                            }`}
                                        >
                                            <div className={`w-16 h-16 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-2xl ${frame.className}`}>
                                                {currentUser[0].toUpperCase()}
                                            </div>
                                            <div className="text-center">
                                                <h3 className="font-medium text-white">{frame.name}</h3>
                                                <p className="text-sm text-slate-400">
                                                    {frame.price === 0 ? '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ' : 
                                                     isPurchased ? <span className="text-green-500">‚úì –ö—É–ø–ª–µ–Ω–æ</span> :
                                                     currentUser === 'kayivi' ? <span className="text-yellow-500">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span> :
                                                     `${frame.price} –∫–æ–∏–Ω–æ–≤`}
                                                </p>
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 7. Settings Modal
        const SettingsModal = ({ isOpen, onClose, currentUser, onLogout, userCoins, onCoinsUpdate, userAvatar, userFrame, userNameColor, userStatus, userStatusEmoji }) => {
            const [activeTab, setActiveTab] = useState('profile');
            const [oldPassword, setOldPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmDelete, setConfirmDelete] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });
            const [coinsToAdd, setCoinsToAdd] = useState('');
            const [coinsToRemove, setCoinsToRemove] = useState('');
            const [targetUser, setTargetUser] = useState('');
            const [coinsToAddToOther, setCoinsToAddToOther] = useState('');
            const [targetUserToAdd, setTargetUserToAdd] = useState('');

            if (!isOpen) return null;

            const handleChangePassword = async () => {
                if (!oldPassword || !newPassword) return;
                setIsLoading(true);
                try {
                    const userRef = ref(db, `users/${currentUser}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val();
                    if (userData.password !== oldPassword) {
                        setMessage({ type: 'error', text: '–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å –Ω–µ–≤–µ—Ä–µ–Ω' });
                        setIsLoading(false); return;
                    }
                    await update(userRef, { password: newPassword });
                    setMessage({ type: 'success', text: '–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω' });
                    setOldPassword(''); setNewPassword('');
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–∞—Ä–æ–ª—è' }); }
                setIsLoading(false);
            };

            const handleDeleteAccount = async () => {
                if (confirmDelete !== currentUser) {
                     setMessage({ type: 'error', text: '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' });
                     return;
                }
                setIsLoading(true);
                try {
                    await remove(ref(db, `users/${currentUser}`));
                    onLogout();
                } catch (error) { setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è' }); setIsLoading(false); }
            };

            const handleAddCoins = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã!');
                    return;
                }
                
                const coins = parseFloat(coinsToAdd);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins + coins 
                    });
                    onCoinsUpdate(userCoins + coins);
                    setMessage({ type: 'success', text: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤!` });
                    setCoinsToAdd('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            const handleRemoveCoins = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç —É–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã!');
                    return;
                }
                
                if (!targetUser) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                const coins = parseFloat(coinsToRemove);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    const targetUserRef = ref(db, `users/${targetUser}`);
                    const snapshot = await get(targetUserRef);
                    const targetUserData = snapshot.val();
                    
                    if (!targetUserData) {
                        setMessage({ type: 'error', text: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                        setIsLoading(false);
                        return;
                    }
                    
                    const currentCoins = targetUserData.coins || 0;
                    const newCoins = Math.max(0, currentCoins - coins);
                    
                    await update(targetUserRef, { 
                        coins: newCoins 
                    });
                    
                    setMessage({ type: 'success', text: `–°–ø–∏—Å–∞–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${targetUser}!` });
                    setCoinsToRemove('');
                    setTargetUser('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            const handleAddCoinsToOther = async () => {
                if (currentUser !== 'kayivi') {
                    alert('–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å kayivi –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã –¥—Ä—É–≥–∏–º!');
                    return;
                }
                
                if (!targetUserToAdd) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                    return;
                }
                
                const coins = parseFloat(coinsToAddToOther);
                if (isNaN(coins) || coins <= 0) {
                    alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤');
                    return;
                }

                setIsLoading(true);
                try {
                    const targetUserRef = ref(db, `users/${targetUserToAdd}`);
                    const snapshot = await get(targetUserRef);
                    const targetUserData = snapshot.val();
                    
                    if (!targetUserData) {
                        setMessage({ type: 'error', text: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω' });
                        setIsLoading(false);
                        return;
                    }
                    
                    const currentCoins = targetUserData.coins || 0;
                    const newCoins = currentCoins + coins;
                    
                    await update(targetUserRef, { 
                        coins: newCoins 
                    });
                    
                    setMessage({ type: 'success', text: `–î–æ–±–∞–≤–ª–µ–Ω–æ ${coins} –∫–æ–∏–Ω–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserToAdd}!` });
                    setCoinsToAddToOther('');
                    setTargetUserToAdd('');
                } catch (error) {
                    setMessage({ type: 'error', text: '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–∏–Ω–æ–≤' });
                }
                setIsLoading(false);
            };

            const getNameColorStyle = (colorId) => {
                const colors = {
                    'red': '#ef4444',
                    'orange': '#f97316',
                    'yellow': '#eab308',
                    'green': '#22c55e',
                    'blue': '#3b82f6',
                    'purple': '#a855f7',
                    'pink': '#ec4899',
                    'cyan': '#06b6d4',
                    'rainbow': 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)'
                };
                return { 
                    color: colors[colorId] || '#ffffff',
                    background: colorId === 'rainbow' ? colors[colorId] : 'transparent',
                    WebkitBackgroundClip: colorId === 'rainbow' ? 'text' : 'initial',
                    WebkitTextFillColor: colorId === 'rainbow' ? 'transparent' : 'initial'
                };
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between bg-slate-900">
                            <h2 className="text-xl font-bold text-white flex items-center gap-2"><UserIcon size={20} className="text-indigo-500" /> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={24} /></button>
                        </div>
                        <div className="flex border-b border-slate-800 bg-slate-900/50">
                            {['profile', 'coins', 'security', 'danger'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-3 text-sm font-medium transition-colors capitalize ${activeTab === tab ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'}`}>
                                    {tab === 'profile' ? '–ü—Ä–æ—Ñ–∏–ª—å' : tab === 'coins' ? '–ö–æ–∏–Ω—Å—ã' : tab === 'security' ? '–ü–∞—Ä–æ–ª—å' : '–£–¥–∞–ª–∏—Ç—å'}
                                </button>
                            ))}
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1 bg-slate-900">
                            {message.text && <div className={`mb-4 p-3 rounded-lg text-sm text-center ${message.type === 'error' ? 'text-red-400 bg-red-500/10' : 'text-green-400 bg-green-500/10'}`}>{message.text}</div>}
                            
                            {activeTab === 'profile' && (
                                <div className="space-y-6 text-center">
                                    <div className={`w-24 h-24 mx-auto rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-4xl shadow-xl ${getFrameClass(userFrame)}`}>
                                        {userAvatar || currentUser[0].toUpperCase()}
                                    </div>
                                    <div>
                                        <h3 className="text-2xl font-bold" style={getNameColorStyle(userNameColor)}>{currentUser}</h3>
                                        <p className="text-slate-400 flex items-center justify-center gap-1">
                                            {userStatusEmoji} {userStatus || '–í —Å–µ—Ç–∏'}
                                        </p>
                                    </div>
                                    <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-4">
                                        <div className="flex items-center justify-center gap-2 text-yellow-500">
                                            <Coins size={20} />
                                            <span className="font-bold text-lg">{userCoins.toFixed(3)} –∫–æ–∏–Ω–æ–≤</span>
                                        </div>
                                    </div>
                                    <Button variant="secondary" onClick={onLogout} className="w-full" icon={<LogOut size={18} />}>–í—ã–π—Ç–∏</Button>
                                </div>
                            )}

                            {activeTab === 'coins' && (
                                <div className="space-y-4">
                                    <div className="text-center p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl">
                                        <div className="flex items-center justify-center gap-2 text-yellow-500 mb-2">
                                            <Coins size={24} />
                                            <span className="font-bold text-xl">{userCoins.toFixed(3)}</span>
                                        </div>
                                        <p className="text-slate-400 text-sm">–í–∞—à –±–∞–ª–∞–Ω—Å –∫–æ–∏–Ω–æ–≤</p>
                                    </div>
                                    
                                    {currentUser === 'kayivi' && (
                                        <>
                                            <div className="space-y-3 p-4 bg-green-500/10 border border-green-500/20 rounded-xl">
                                                <div className="flex items-center gap-2 text-green-500 mb-2">
                                                    <Crown size={16} />
                                                    <span className="font-bold">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã —Å–µ–±–µ</span>
                                                </div>
                                                <div className="flex gap-2">
                                                    <input 
                                                        type="number" 
                                                        step="0.001"
                                                        placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                        value={coinsToAdd} 
                                                        onChange={e => setCoinsToAdd(e.target.value)}
                                                        className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white focus:border-green-500 outline-none" 
                                                    />
                                                    <Button 
                                                        onClick={handleAddCoins} 
                                                        isLoading={isLoading}
                                                        variant="gold"
                                                        className="whitespace-nowrap"
                                                    >
                                                        –î–æ–±–∞–≤–∏—Ç—å
                                                    </Button>
                                                </div>
                                            </div>
                                            
                                            <div className="space-y-3 p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl">
                                                <div className="flex items-center gap-2 text-blue-500 mb-2">
                                                    <Crown size={16} />
                                                    <span className="font-bold">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã –¥—Ä—É–≥–æ–º—É</span>
                                                </div>
                                                <div className="space-y-2">
                                                    <input 
                                                        type="text" 
                                                        placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                                        value={targetUserToAdd} 
                                                        onChange={e => setTargetUserToAdd(e.target.value)}
                                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white focus:border-blue-500 outline-none" 
                                                    />
                                                    <div className="flex gap-2">
                                                        <input 
                                                            type="number" 
                                                            step="0.001"
                                                            placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                            value={coinsToAddToOther} 
                                                            onChange={e => setCoinsToAddToOther(e.target.value)}
                                                            className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white focus:border-blue-500 outline-none" 
                                                        />
                                                        <Button 
                                                            onClick={handleAddCoinsToOther} 
                                                            isLoading={isLoading}
                                                            variant="primary"
                                                            className="whitespace-nowrap"
                                                        >
                                                            –î–æ–±–∞–≤–∏—Ç—å
                                                        </Button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div className="space-y-3 p-4 bg-red-500/10 border border-red-500/20 rounded-xl">
                                                <div className="flex items-center gap-2 text-red-500 mb-2">
                                                    <Crown size={16} />
                                                    <span className="font-bold">–£–±–∞–≤–∏—Ç—å –∫–æ–∏–Ω—ã</span>
                                                </div>
                                                <div className="space-y-2">
                                                    <input 
                                                        type="text" 
                                                        placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" 
                                                        value={targetUser} 
                                                        onChange={e => setTargetUser(e.target.value)}
                                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white focus:border-red-500 outline-none" 
                                                    />
                                                    <div className="flex gap-2">
                                                        <input 
                                                            type="number" 
                                                            step="0.001"
                                                            placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–∏–Ω–æ–≤" 
                                                            value={coinsToRemove} 
                                                            onChange={e => setCoinsToRemove(e.target.value)}
                                                            className="flex-1 bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-white focus:border-red-500 outline-none" 
                                                        />
                                                        <Button 
                                                            onClick={handleRemoveCoins} 
                                                            isLoading={isLoading}
                                                            variant="danger"
                                                            className="whitespace-nowrap"
                                                        >
                                                            –£–±–∞–≤–∏—Ç—å
                                                        </Button>
                                                    </div>
                                                </div>
                                            </div>
                                        </>
                                    )}

                                    <div className="text-slate-400 text-sm space-y-2">
                                        <p>üíé 1 –∫–ª–∏–∫ = +0.001 –∫–æ–∏–Ω</p>
                                        <p>üîÑ –ê–≤–∞—Ç–∞—Ä–∫–∏ = –æ—Ç 10 –¥–æ 400 –∫–æ–∏–Ω–æ–≤</p>
                                        <p>üñºÔ∏è –†–∞–º–∫–∏ = –æ—Ç 10 –¥–æ 500 –∫–æ–∏–Ω–æ–≤</p>
                                        <p>üé® –¶–≤–µ—Ç –∏–º–µ–Ω–∏ = 20 –∫–æ–∏–Ω–æ–≤</p>
                                        <p>üí¨ –°—Ç–∞—Ç—É—Å = 20 –∫–æ–∏–Ω–æ–≤</p>
                                        <p>üé∞ –ö–∞–∑–∏–Ω–æ = 5 –∏–≥—Ä —Å –≤—ã—Å–æ–∫–∏–º–∏ —à–∞–Ω—Å–∞–º–∏!</p>
                                        {currentUser === 'kayivi' && (
                                            <p className="text-green-500">üëë –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —É–±–∞–≤–ª—è—Ç—å –∫–æ–∏–Ω—ã</p>
                                        )}
                                    </div>
                                </div>
                            )}

                            {activeTab === 'security' && (
                                <div className="space-y-4">
                                    <input type="password" placeholder="–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å" value={oldPassword} onChange={e => setOldPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none" />
                                    <input type="password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" value={newPassword} onChange={e => setNewPassword(e.target.value)} className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-indigo-500 outline-none" />
                                    <Button onClick={handleChangePassword} isLoading={isLoading} disabled={!oldPassword || !newPassword} className="w-full">–û–±–Ω–æ–≤–∏—Ç—å</Button>
                                </div>
                            )}

                            {activeTab === 'danger' && (
                                <div className="space-y-4 p-4 bg-red-500/5 border border-red-500/10 rounded-xl">
                                    <p className="text-sm text-slate-400">–í–≤–µ–¥–∏—Ç–µ <b>{currentUser}</b> –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.</p>
                                    <input type="text" placeholder={currentUser} value={confirmDelete} onChange={e => setConfirmDelete(e.target.value)} className="w-full bg-slate-800 border border-red-900/30 rounded-xl px-4 py-3 text-white focus:border-red-500 outline-none" />
                                    <Button variant="danger" onClick={handleDeleteAccount} isLoading={isLoading} disabled={confirmDelete !== currentUser} className="w-full">–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞</Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 8. Message Bubble
        const EMOJIS = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üî•'];
        const MessageBubble = ({ message, isOwn, chatId, messageId, currentUser }) => {
            const [showActions, setShowActions] = useState(false);
            const [showReactions, setShowReactions] = useState(false);
            const containerRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setShowActions(false); setShowReactions(false);
                    }
                };
                if (showActions || showReactions) document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showActions, showReactions]);

            const handleDelete = async () => {
                if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                    try {
                        await update(ref(db, `messages/${chatId}/${messageId}`), { deleted: true });
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                }
                setShowActions(false);
            };

            const handleReaction = async (emoji) => {
                try {
                    const msgRef = ref(db, `messages/${chatId}/${messageId}/reactions`);
                    const currentReactions = message.reactions || {};
                    if (currentReactions[currentUser] === emoji) {
                        await update(msgRef, { [currentUser]: null });
                    } else {
                        await update(msgRef, { [currentUser]: emoji });
                    }
                    setShowReactions(false); setShowActions(false);
                } catch (error) {
                    console.error('Reaction error:', error);
                }
            };

            if (message.deleted) return null;

            const renderContent = () => {
                switch (message.type) {
                    case 'photo': return <div className="relative group"><img src={message.mediaUrl} alt="Photo" className="max-w-full sm:max-w-[320px] max-h-[400px] object-cover rounded-lg" loading="lazy" /></div>;
                    case 'video': return <video controls src={message.mediaUrl} className="max-w-full sm:max-w-[320px] max-h-[400px] rounded-lg bg-black" playsInline />;
                    case 'audio': return <div className="flex items-center gap-3 min-w-[200px]"><div className={`p-2 rounded-full ${isOwn ? 'bg-white/20' : 'bg-indigo-500/20 text-indigo-400'}`}><Mic size={16}/></div><audio controls src={message.mediaUrl} className="h-8 w-full max-w-[200px]" /></div>;
                    default: return <p className="break-words whitespace-pre-wrap leading-relaxed text-[15px]">{message.text}</p>;
                }
            };

            return (
                <div className={`group flex mb-4 ${isOwn ? 'justify-end' : 'justify-start'} animate-slide-up relative z-0`} ref={containerRef}>
                    <div className={`relative max-w-[85%] sm:max-w-[70%] rounded-2xl px-4 py-3 shadow-sm transition-all ${isOwn ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-slate-800 text-slate-100 rounded-bl-none border border-slate-700'}`}>
                        <button onClick={(e) => { e.stopPropagation(); setShowActions(!showActions); if(!showActions) setShowReactions(false); }} className={`absolute -top-3 ${isOwn ? 'left-0' : 'right-0'} p-1.5 rounded-full bg-slate-800 border border-slate-700 shadow-md text-slate-400 z-10 hover:text-white hover:scale-110`}><MoreVertical size={14} /></button>
                        
                        {showActions && (
                            <div className={`absolute -top-14 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-xl shadow-2xl z-50 flex items-center p-1.5 gap-1 animate-fade-in`}>
                                <button onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); }} className="p-2 rounded-lg hover:bg-slate-800 text-slate-300"><Smile size={18} /></button>
                                {isOwn && <><div className="w-px h-6 bg-slate-800 mx-1"></div><button onClick={(e) => { e.stopPropagation(); handleDelete(); }} className="p-2 rounded-lg hover:bg-red-500/20 text-red-400"><Trash2 size={18} /></button></>}
                            </div>
                        )}
                        
                        {showReactions && (
                            <div className={`absolute -top-28 ${isOwn ? 'right-0' : 'left-0'} bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl z-50 flex flex-wrap max-w-[160px] p-2 gap-2 animate-fade-in`}>
                                {EMOJIS.map(emoji => <button key={emoji} onClick={(e) => { e.stopPropagation(); handleReaction(emoji); }} className="hover:bg-slate-800 p-1.5 rounded-lg text-xl">{emoji}</button>)}
                            </div>
                        )}

                        {renderContent()}
                        <div className={`flex items-center justify-end gap-1 mt-1 text-[10px] ${isOwn ? 'text-indigo-200' : 'text-slate-500'} font-medium`}><span>{format(message.timestamp, 'HH:mm')}</span></div>
                        
                        {message.reactions && Object.keys(message.reactions).length > 0 && (
                            <div className={`absolute -bottom-3 ${isOwn ? 'left-0' : 'right-0'} flex -space-x-1 cursor-pointer`} onClick={(e) => { e.stopPropagation(); setShowReactions(!showReactions); setShowActions(true); }}>
                                {Object.entries(message.reactions).slice(0, 4).map(([user, emoji]) => (
                                    <div key={user} className="bg-slate-800 border border-slate-700 rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md z-10" title={user}>{emoji}</div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // 9. Clicker Component
        const Clicker = ({ userCoins, onCoinClick, currentUser }) => {
            const [showCoin, setShowCoin] = useState(false);
            const [coinPosition, setCoinPosition] = useState({ x: 0, y: 0 });

            const handleClick = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                setCoinPosition({ x, y });
                setShowCoin(true);
                onCoinClick();
                
                setTimeout(() => setShowCoin(false), 500);
            };

            return (
                <div className="relative">
                    {showCoin && (
                        <div 
                            className="absolute text-yellow-500 text-2xl font-bold coin-animation z-50"
                            style={{ left: coinPosition.x, top: coinPosition.y }}
                        >
                            +0.001
                        </div>
                    )}
                    <button
                        onClick={handleClick}
                        className="w-full bg-gradient-to-br from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white p-6 rounded-2xl shadow-2xl shadow-yellow-500/25 transition-all duration-200 active:scale-95 border-2 border-yellow-400/50 animate-pulse-gold"
                    >
                        <div className="text-center">
                            <Coins size={48} className="mx-auto mb-2" />
                            <div className="text-2xl font-bold mb-1">{userCoins.toFixed(3)}</div>
                            <div className="text-yellow-200 text-sm">–ö–ª–∏–∫–Ω–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞!</div>
                            <div className="text-yellow-300/80 text-xs mt-1">+0.001 –∑–∞ –∫–ª–∏–∫</div>
                        </div>
                    </button>
                </div>
            );
        };

        // Helper function to get frame class
        const getFrameClass = (frameId) => {
            switch(frameId) {
                case 'basic': return 'frame-basic';
                case 'silver': return 'frame-silver';
                case 'gold': return 'frame-gold';
                case 'diamond': return 'frame-diamond';
                case 'rainbow': return 'frame-rainbow';
                default: return '';
            }
        };

        // Helper function to get name color style
        const getNameColorStyle = (colorId) => {
            const colors = {
                'red': '#ef4444',
                'orange': '#f97316',
                'yellow': '#eab308',
                'green': '#22c55e',
                'blue': '#3b82f6',
                'purple': '#a855f7',
                'pink': '#ec4899',
                'cyan': '#06b6d4',
                'rainbow': 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)'
            };
            return { 
                color: colors[colorId] || '#ffffff',
                background: colorId === 'rainbow' ? colors[colorId] : 'transparent',
                WebkitBackgroundClip: colorId === 'rainbow' ? 'text' : 'initial',
                WebkitTextFillColor: colorId === 'rainbow' ? 'transparent' : 'initial'
            };
        };

        // --- Main App ---
        const App = () => {
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [isLoginView, setIsLoginView] = useState(true);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            const [chats, setChats] = useState([]);
            const [areChatsLoading, setAreChatsLoading] = useState(false);
            const [activeChatUser, setActiveChatUser] = useState(null);
            const [messages, setMessages] = useState([]);
            const [messageInput, setMessageInput] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isFrameModalOpen, setIsFrameModalOpen] = useState(false);
            const [isCasinoModalOpen, setIsCasinoModalOpen] = useState(false);
            const [isNameColorModalOpen, setIsNameColorModalOpen] = useState(false);
            const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);
            const [showMobileSidebar, setShowMobileSidebar] = useState(true);
            const [isRecording, setIsRecording] = useState(false);
            const [connectionError, setConnectionError] = useState('');
            const [userCoins, setUserCoins] = useState(0);
            const [userAvatar, setUserAvatar] = useState('');
            const [userFrame, setUserFrame] = useState('');
            const [userNameColor, setUserNameColor] = useState('');
            const [userStatus, setUserStatus] = useState('');
            const [userStatusEmoji, setUserStatusEmoji] = useState('');
            const [usersData, setUsersData] = useState({});
            const [purchasedAvatars, setPurchasedAvatars] = useState([]);
            const [purchasedFrames, setPurchasedFrames] = useState([]);
            const [purchasedColors, setPurchasedColors] = useState([]);
            const [purchasedStatuses, setPurchasedStatuses] = useState([]);
            const mediaRecorderRef = useRef(null);
            const messagesEndRef = useRef(null);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            useEffect(() => {
                if (currentUser) {
                    const userRef = ref(db, `users/${currentUser}`);
                    const unsubscribe = onValue(userRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUserCoins(data.coins || 0);
                            setUserAvatar(data.avatar || '');
                            setUserFrame(data.frame || '');
                            setUserNameColor(data.nameColor || '');
                            setUserStatus(data.status || '');
                            setUserStatusEmoji(data.statusEmoji || '');
                            setPurchasedAvatars(data.purchasedAvatars || []);
                            setPurchasedFrames(data.purchasedFrames || []);
                            setPurchasedColors(data.purchasedColors || []);
                            setPurchasedStatuses(data.purchasedStatuses || []);
                        }
                    });
                    
                    return () => off(userRef);
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–∫
            useEffect(() => {
                if (currentUser) {
                    const usersRef = ref(db, 'users');
                    const unsubscribe = onValue(usersRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUsersData(data);
                        }
                    });
                    
                    return () => off(usersRef);
                }
            }, [currentUser]);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Firebase
            useEffect(() => {
                if (currentUser) {
                    const testConnection = async () => {
                        try {
                            const testRef = ref(db, '.info/connected');
                            onValue(testRef, (snapshot) => {
                                if (snapshot.val() === true) {
                                    setConnectionError('');
                                } else {
                                    setConnectionError('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
                                }
                            });
                        } catch (error) {
                            setConnectionError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase');
                        }
                    };
                    testConnection();
                }
            }, [currentUser]);

            // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
            useEffect(() => {
                if (currentUser) {
                    setAreChatsLoading(true);
                    const userRef = ref(db, `users/${currentUser}`);
                    
                    update(userRef, { 
                        isOnline: true, 
                        lastSeen: Date.now() 
                    }).catch(error => {
                        console.warn('Cannot update user status:', error);
                    });
                    
                    const messagesRef = ref(db, 'messages');
                    const unsubscribe = onValue(messagesRef, (snapshot) => {
                        setAreChatsLoading(false);
                        const data = snapshot.val();
                        if (!data) { 
                            setChats([]); 
                            return; 
                        }
                        
                        const newChats = new Map();
                        
                        Object.entries(data).forEach(([chatId, chatMessages]) => {
                            const usersInChat = chatId.split('_');
                            if (usersInChat.includes(currentUser)) {
                                const otherUser = usersInChat.find(user => user !== currentUser) || currentUser;
                                
                                if (chatMessages && Object.keys(chatMessages).length > 0) {
                                    const messagesList = Object.values(chatMessages)
                                        .filter(m => m && !m.deleted)
                                        .sort((a, b) => b.timestamp - a.timestamp);
                                    
                                    if (messagesList.length > 0) {
                                        newChats.set(otherUser, { 
                                            user: otherUser, 
                                            lastMessage: messagesList[0], 
                                            timestamp: messagesList[0].timestamp 
                                        });
                                    }
                                }
                            }
                        });
                        
                        setChats(Array.from(newChats.values()).sort((a, b) => b.timestamp - a.timestamp));
                    }, (error) => {
                        console.error('Chats loading error:', error);
                        setAreChatsLoading(false);
                        setConnectionError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
                    });
                    
                    return () => { 
                        off(messagesRef); 
                        update(userRef, { isOnline: false }).catch(()=>{}); 
                    };
                }
            }, [currentUser]);

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            useEffect(() => {
                if (currentUser && activeChatUser) {
                    const chatId = [currentUser, activeChatUser].sort().join('_');
                    const chatRef = ref(db, `messages/${chatId}`);
                    
                    console.log('Loading messages for chat:', chatId);
                    
                    const unsubscribe = onValue(chatRef, (snapshot) => {
                        const data = snapshot.val();
                        console.log('Raw Firebase data:', data);
                        
                        if (!data) {
                            setMessages([]);
                            return;
                        }
                        
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ—Ä—Ç–∏—Ä—É–µ–º
                        const messagesArray = Object.entries(data)
                            .map(([id, message]) => ({
                                id,
                                ...message
                            }))
                            .filter(msg => !msg.deleted);
                        
                        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ timestamp –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è (—Å—Ç–∞—Ä—ã–µ —Å–≤–µ—Ä—Ö—É, –Ω–æ–≤—ã–µ —Å–Ω–∏–∑—É)
                        const sortedMessages = messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        console.log('Sorted messages:', sortedMessages.map(m => ({
                            id: m.id,
                            text: m.text?.substring(0, 20),
                            timestamp: new Date(m.timestamp).toLocaleTimeString(),
                            sender: m.sender
                        })));
                        
                        setMessages(sortedMessages);
                    }, (error) => {
                        console.error('Messages loading error:', error);
                        setConnectionError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π');
                    });
                    
                    setShowMobileSidebar(false);
                    return () => off(chatRef);
                } else { 
                    setShowMobileSidebar(true); 
                    setMessages([]);
                }
            }, [currentUser, activeChatUser]);

            // –ê–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
            useEffect(() => { 
                if (messages.length > 0) {
                    setTimeout(() => {
                        messagesEndRef.current?.scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'end'
                        });
                    }, 100);
                }
            }, [messages]);

            const handleAuth = () => {
                if (!usernameInput.trim() || !passwordInput.trim()) return;
                const cleanUsername = usernameInput.trim();
                const userRef = ref(db, `users/${cleanUsername}`);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (isLoginView) {
                        if (data && data.password === passwordInput) {
                            localStorage.setItem('dolbaeb_user', cleanUsername); 
                            setCurrentUser(cleanUsername); 
                            setAuthError('');
                        } else { 
                            setAuthError('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); 
                        }
                    } else {
                        if (data) { 
                            setAuthError('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'); 
                        } else {
                            set(userRef, { 
                                username: cleanUsername, 
                                password: passwordInput, 
                                createdAt: Date.now(), 
                                isOnline: true, 
                                lastSeen: Date.now(),
                                coins: 0,
                                avatar: '',
                                frame: '',
                                nameColor: '',
                                status: '',
                                statusEmoji: '',
                                purchasedAvatars: [],
                                purchasedFrames: [],
                                purchasedColors: [],
                                purchasedStatuses: []
                            }).then(() => { 
                                localStorage.setItem('dolbaeb_user', cleanUsername); 
                                setCurrentUser(cleanUsername); 
                                setAuthError(''); 
                            }).catch(error => {
                                console.error('Registration error:', error);
                                setAuthError('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase.');
                            });
                        }
                    }
                }, { onlyOnce: true });
            };

            const handleLogout = () => {
                if(currentUser) {
                    update(ref(db, `users/${currentUser}`), { isOnline: false, lastSeen: Date.now() }).catch(() => {});
                }
                localStorage.removeItem('dolbaeb_user'); 
                setCurrentUser(null); 
                setActiveChatUser(null); 
                setChats([]); 
                setIsSettingsOpen(false);
                setUserCoins(0);
                setUserAvatar('');
                setUserFrame('');
                setUserNameColor('');
                setUserStatus('');
                setUserStatusEmoji('');
                setPurchasedAvatars([]);
                setPurchasedFrames([]);
                setPurchasedColors([]);
                setPurchasedStatuses([]);
            };

            const handleCoinClick = async () => {
                try {
                    const newCoins = userCoins + 0.001;
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: newCoins 
                    });
                    setUserCoins(newCoins);
                } catch (error) {
                    console.error('Coin update error:', error);
                }
            };

            const handleSendMessage = async (type = 'text', content = messageInput) => {
                if ((!content.trim() && type === 'text') || !currentUser || !activeChatUser) return;
                
                const chatId = [currentUser, activeChatUser].sort().join('_');
                const timestamp = Date.now();
                
                console.log('Sending message with timestamp:', timestamp, 'type:', type);
                
                try {
                    const messageRef = push(ref(db, `messages/${chatId}`));
                    
                    const messageData = {
                        sender: currentUser, 
                        text: type === 'text' ? content : '', 
                        timestamp: timestamp,
                        type, 
                        deleted: false
                    };
                    
                    if (type !== 'text' && content) {
                        messageData.mediaUrl = content;
                    }
                    
                    await set(messageRef, messageData);
                    
                    console.log('Message sent successfully');
                    if (type === 'text') setMessageInput('');
                } catch (e) { 
                    console.error("Send error details:", e);
                    if (e.code === 'PERMISSION_DENIED') {
                        alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ Firebase Database.");
                    } else {
                        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: " + (e.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ'));
                    }
                }
            };

            const handleSearch = (term) => {
                setSearchQuery(term);
                if (!term.trim()) { 
                    setSearchResults([]); 
                    return; 
                }
                const q = query(ref(db, 'users'), orderByChild('username'), startAt(term), endAt(term + '\uf8ff'));
                onValue(q, (snapshot) => {
                    const data = snapshot.val();
                    setSearchResults(data ? Object.values(data).filter(u => u.username !== currentUser) : []);
                }, { onlyOnce: true });
            };

            const handleFileUpload = (e, type) => {
                const file = e.target.files?.[0];
                if (!file || file.size > 8 * 1024 * 1024) { 
                    alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º—É–º 8MB'); 
                    return; 
                }
                const reader = new FileReader();
                reader.onload = (ev) => {
                    if (ev.target.result) {
                        handleSendMessage(type, ev.target.result);
                    }
                };
                reader.onerror = () => {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                };
                reader.readAsDataURL(file); 
                e.target.value = '';
            };

            const toggleRecording = async () => {
                if (isRecording) { 
                    mediaRecorderRef.current?.stop(); 
                    setIsRecording(false); 
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 
                                         MediaRecorder.isTypeSupported('audio/mp4') ? 'audio/mp4' : '';
                        
                        const mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
                        const audioChunks = [];
                        
                        mediaRecorder.ondataavailable = (e) => { 
                            if (e.data.size > 0) audioChunks.push(e.data); 
                        };
                        mediaRecorder.onstop = () => {
                            const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                if (e.target.result) {
                                    handleSendMessage('audio', e.target.result);
                                }
                            };
                            reader.readAsDataURL(blob);
                            stream.getTracks().forEach(t => t.stop());
                        };
                        mediaRecorder.start(); 
                        setIsRecording(true); 
                        mediaRecorderRef.current = mediaRecorder;
                    } catch (err) { 
                        alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É"); 
                    }
                }
            };

            if (!currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-slate-950 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-indigo-900/40 via-slate-950 to-slate-950">
                        <div className="w-full max-w-md bg-slate-900/60 backdrop-blur-xl p-8 rounded-3xl shadow-2xl border border-indigo-500/20 animate-fade-in relative overflow-hidden">
                            <div className="text-center mb-10">
                                <h1 className="text-4xl font-bold text-white mb-2">DolbaebSMS</h1>
                                <p className="text-slate-400 font-light">Secure. Fast. Simple.</p>
                            </div>
                            {authError && <div className="p-3 mb-4 rounded-xl bg-red-500/10 text-red-400 text-center">{authError}</div>}
                            <div className="space-y-4">
                                <input type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-indigo-500 outline-none" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} />
                                <input type="password" placeholder="–ü–∞—Ä–æ–ª—å" className="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-indigo-500 outline-none" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleAuth()} />
                            </div>
                            <Button className="w-full mt-6 py-4" onClick={handleAuth}>{isLoginView ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç'}</Button>
                            <div className="text-center mt-6">
                                <button onClick={() => { setIsLoginView(!isLoginView); setAuthError(''); }} className="text-slate-400 hover:text-indigo-400 text-sm">
                                    {isLoginView ? '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç' : '–í–æ–π—Ç–∏'}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden bg-slate-950">
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        currentUser={currentUser} 
                        onLogout={handleLogout}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userAvatar={userAvatar}
                        userFrame={userFrame}
                        userNameColor={userNameColor}
                        userStatus={userStatus}
                        userStatusEmoji={userStatusEmoji}
                    />
                    
                    <AvatarModal
                        isOpen={isAvatarModalOpen}
                        onClose={() => setIsAvatarModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onAvatarChange={setUserAvatar}
                        purchasedAvatars={purchasedAvatars}
                    />
                    
                    <FrameModal
                        isOpen={isFrameModalOpen}
                        onClose={() => setIsFrameModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onFrameChange={setUserFrame}
                        userFrame={userFrame}
                        purchasedFrames={purchasedFrames}
                    />

                    <CasinoModal
                        isOpen={isCasinoModalOpen}
                        onClose={() => setIsCasinoModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                    />

                    <NameColorModal
                        isOpen={isNameColorModalOpen}
                        onClose={() => setIsNameColorModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onColorChange={setUserNameColor}
                        purchasedColors={purchasedColors}
                    />

                    <StatusModal
                        isOpen={isStatusModalOpen}
                        onClose={() => setIsStatusModalOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onStatusChange={(status, emoji) => { setUserStatus(status); setUserStatusEmoji(emoji); }}
                        purchasedStatuses={purchasedStatuses}
                    />
                    
                    {connectionError && (
                        <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-red-500/90 text-white px-4 py-2 rounded-lg text-sm backdrop-blur-sm">
                            {connectionError}
                        </div>
                    )}
                    
                    {/* Sidebar */}
                    <div className={`${showMobileSidebar ? 'flex' : 'hidden'} md:flex w-full md:w-[420px] flex-col border-r border-slate-800 bg-slate-900 z-10`}>
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between h-[72px]">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={() => setIsAvatarModalOpen(true)}
                                    className={`w-10 h-10 rounded-full bg-gradient-to-tr from-indigo-600 to-purple-600 flex items-center justify-center text-white font-bold text-lg relative group ${getFrameClass(userFrame)}`}
                                >
                                    {userAvatar || currentUser[0].toUpperCase()}
                                </button>
                                <div>
                                    <h2 className="font-bold text-white flex items-center gap-1" style={getNameColorStyle(userNameColor)}>
                                        {currentUser}
                                        {currentUser === 'kayivi' && <Crown size={14} className="text-yellow-500" />}
                                    </h2>
                                    <span className="text-[11px] text-green-500 flex items-center gap-1">
                                        ‚óè {userStatusEmoji} {userStatus || '–í —Å–µ—Ç–∏'}
                                    </span>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={() => setIsCasinoModalOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–ö–∞–∑–∏–Ω–æ"
                                >
                                    <Trophy size={20} />
                                </button>
                                <button 
                                    onClick={() => setIsNameColorModalOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–¶–≤–µ—Ç –∏–º–µ–Ω–∏"
                                >
                                    <Palette size={20} />
                                </button>
                                <button 
                                    onClick={() => setIsStatusModalOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–°—Ç–∞—Ç—É—Å"
                                >
                                    <Edit3 size={20} />
                                </button>
                                <button 
                                    onClick={() => setIsFrameModalOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–†–∞–º–∫–∏"
                                >
                                    <ImageIcon size={20} />
                                </button>
                                <button 
                                    onClick={() => setIsSettingsOpen(true)}
                                    className="p-2 rounded-xl bg-slate-800 text-slate-400 hover:text-yellow-500 relative"
                                    title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
                                >
                                    <SettingsIcon size={20} />
                                </button>
                            </div>
                        </div>

                        {/* Clicker Section */}
                        <div className="p-4 border-b border-slate-800">
                            <Clicker 
                                userCoins={userCoins} 
                                onCoinClick={handleCoinClick}
                                currentUser={currentUser}
                            />
                        </div>

                        <div className="p-4">
                            <div className="relative">
                                <Search className="absolute left-3 top-3 text-slate-500" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="–ü–æ–∏—Å–∫..." 
                                    className="w-full bg-slate-800 border border-slate-700 rounded-xl py-2.5 pl-10 text-slate-200 outline-none focus:border-indigo-500" 
                                    value={searchQuery} 
                                    onChange={e => handleSearch(e.target.value)} 
                                />
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto px-2">
                            {areChatsLoading ? (
                                <div className="flex flex-col items-center justify-center mt-10 text-slate-500 gap-2">
                                    <Loader2 className="animate-spin text-indigo-500" size={24} />
                                    <p className="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</p>
                                </div>
                            ) : searchQuery ? (
                                searchResults.length ? searchResults.map(u => (
                                    <div 
                                        key={u.username} 
                                        onClick={() => { setActiveChatUser(u.username); setSearchQuery(''); setSearchResults([]); }} 
                                        className="p-3 flex items-center gap-3 rounded-xl hover:bg-slate-800 cursor-pointer"
                                    >
                                        <div className={`w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-slate-300 font-bold border border-slate-700 text-lg ${getFrameClass(u.frame)}`}>
                                            {u.avatar || u.username[0].toUpperCase()}
                                        </div>
                                        <div>
                                            <h3 className="font-medium text-slate-200" style={getNameColorStyle(u.nameColor)}>{u.username}</h3>
                                            <p className="text-xs text-slate-500 flex items-center gap-1">
                                                {u.statusEmoji} {u.status || '–í —Å–µ—Ç–∏'}
                                            </p>
                                        </div>
                                    </div>
                                )) : <div className="text-center text-slate-500 mt-4">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            ) : (
                                chats.length ? chats.map(c => {
                                    const userData = usersData[c.user];
                                    return (
                                        <div 
                                            key={c.user} 
                                            onClick={() => setActiveChatUser(c.user)} 
                                            className={`p-3 flex items-center gap-3 rounded-xl cursor-pointer hover:bg-slate-800 ${activeChatUser === c.user ? 'bg-slate-800' : ''}`}
                                        >
                                            <div className={`w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-white font-bold border border-slate-700 text-lg ${getFrameClass(userData?.frame)}`}>
                                                {userData?.avatar || c.user[0].toUpperCase()}
                                            </div>
                                            <div className="flex-1 min-w-0">
                                                <div className="flex justify-between items-baseline">
                                                    <h3 className="font-semibold text-slate-200 truncate" style={getNameColorStyle(userData?.nameColor)}>{c.user}</h3>
                                                    <span className="text-xs text-slate-500">
                                                        {new Date(c.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                    </span>
                                                </div>
                                                <p className="text-sm text-slate-400 truncate">
                                                    {c.lastMessage.type === 'text' ? c.lastMessage.text : 
                                                     c.lastMessage.type === 'photo' ? 'üì∑ –§–æ—Ç–æ' : 
                                                     c.lastMessage.type === 'video' ? 'üé• –í–∏–¥–µ–æ' : 
                                                     c.lastMessage.type === 'audio' ? 'üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ' : '–°–æ–æ–±—â–µ–Ω–∏–µ'}
                                                </p>
                                            </div>
                                        </div>
                                    );
                                }) : (
                                    <div className="text-center text-slate-500 mt-10 p-4">
                                        <p>–ù–µ—Ç —á–∞—Ç–æ–≤</p>
                                        <p className="text-xs mt-2">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                                    </div>
                                )
                            )}
                        </div>
                    </div>

                    {/* Chat Area */}
                    {activeChatUser ? (
                        <div className={`${!showMobileSidebar ? 'flex' : 'hidden md:flex'} flex-1 flex-col bg-slate-950 relative`}>
                            <div className="h-[72px] px-4 flex items-center gap-3 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md sticky top-0 z-20">
                                <button onClick={() => { setActiveChatUser(null); setShowMobileSidebar(true); }} className="md:hidden text-slate-400">
                                    <ChevronLeft size={24} />
                                </button>
                                <div className={`w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold ${getFrameClass(usersData[activeChatUser]?.frame)}`}>
                                    {usersData[activeChatUser]?.avatar || activeChatUser[0].toUpperCase()}
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-200" style={getNameColorStyle(usersData[activeChatUser]?.nameColor)}>{activeChatUser}</h3>
                                    <p className="text-xs text-slate-500 flex items-center gap-1">
                                        {usersData[activeChatUser]?.statusEmoji} {usersData[activeChatUser]?.status || '–í —Å–µ—Ç–∏'}
                                    </p>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                                {messages.length === 0 ? (
                                    <div className="text-center text-slate-500 mt-10">
                                        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                                        <p className="text-sm mt-2">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º!</p>
                                    </div>
                                ) : (
                                    messages.map(msg => (
                                        <MessageBubble 
                                            key={msg.id} 
                                            message={msg} 
                                            isOwn={msg.sender === currentUser} 
                                            chatId={[currentUser, activeChatUser].sort().join('_')} 
                                            messageId={msg.id} 
                                            currentUser={currentUser} 
                                        />
                                    ))
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="p-3 bg-slate-900 border-t border-slate-800 safe-area-bottom">
                                <div className="flex items-end gap-2 max-w-4xl mx-auto">
                                    <div className="flex gap-1 bg-slate-800 p-1 rounded-xl shrink-0">
                                        <label className="p-2 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <ImageIcon size={20} />
                                            <input type="file" className="hidden" accept="image/*" onChange={e => handleFileUpload(e, 'photo')} />
                                        </label>
                                        <label className="p-2 text-slate-400 hover:text-indigo-400 cursor-pointer">
                                            <Video size={20} />
                                            <input type="file" className="hidden" accept="video/*" onChange={e => handleFileUpload(e, 'video')} />
                                        </label>
                                        <button 
                                            onClick={toggleRecording} 
                                            className={`p-2 rounded-lg ${isRecording ? 'text-red-500 animate-pulse' : 'text-slate-400 hover:text-indigo-400'}`}
                                        >
                                            {isRecording ? <div className="w-5 h-5 bg-red-500 rounded-sm" /> : <Mic size={20} />}
                                        </button>
                                    </div>
                                    <div className="flex-1 min-w-0 bg-slate-800 rounded-2xl border border-slate-700">
                                        <textarea 
                                            value={messageInput} 
                                            onChange={e => setMessageInput(e.target.value)} 
                                            onKeyPress={e => { 
                                                if(e.key === 'Enter' && !e.shiftKey) { 
                                                    e.preventDefault(); 
                                                    handleSendMessage('text'); 
                                                }
                                            }} 
                                            placeholder={isRecording ? "–ó–∞–ø–∏—Å—å..." : "–°–æ–æ–±—â–µ–Ω–∏–µ..."} 
                                            className="w-full bg-transparent text-white px-4 py-3 outline-none resize-none h-[50px] custom-scrollbar" 
                                        />
                                    </div>
                                    <button 
                                        onClick={() => handleSendMessage('text')} 
                                        disabled={!messageInput.trim() && !isRecording} 
                                        className="p-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-500 shadow-lg shadow-indigo-600/20 shrink-0"
                                    >
                                        <Send size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div className="hidden md:flex flex-1 items-center justify-center bg-slate-950 text-slate-500 flex-col gap-4">
                            <div className="w-24 h-24 rounded-full bg-slate-900 border border-slate-800 flex items-center justify-center">
                                <Send size={40} className="text-indigo-500" />
                            </div>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è</p>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
