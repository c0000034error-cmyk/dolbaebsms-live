<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>DolbaebSMS - Secure Messenger</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: {
              gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' }
            },
            animation: {
              'fade-in': 'fadeIn 0.3s ease-out',
              'slide-up': 'slideUp 0.3s ease-out',
              'pulse-gold': 'pulseGold 2s infinite',
              'float': 'float 3s ease-in-out infinite',
              'gift-float': 'giftFloat 2s ease-in-out',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
              pulseGold: { '0%, 100%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.05)', opacity: '0.8' } },
              float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
              giftFloat: { 
                '0%': { transform: 'translateY(100px) scale(0.5)', opacity: '0' },
                '50%': { transform: 'translateY(-20px) scale(1.2)', opacity: '1' },
                '100%': { transform: 'translateY(0) scale(1)', opacity: '1' }
              }
            }
          }
        }
      }
    </script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Styles -->
    <style>
      * { box-sizing: border-box; }
      body { background-color: #0f172a; color: #e2e8f0; overscroll-behavior-y: none; height: 100vh; overflow: hidden; }
      #root { height: 100vh; overflow: hidden; }
      
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #475569; }
      
      .custom-scrollbar::-webkit-scrollbar { width: 5px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
      
      /* Frames */
      .frame-basic { border: 2px solid #6b7280; box-shadow: 0 0 5px rgba(107, 114, 128, 0.5); }
      .frame-silver { border: 3px solid #c0c0c0; box-shadow: 0 0 10px rgba(192, 192, 192, 0.7); }
      .frame-gold { border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
      .frame-diamond { border: 3px solid #b9f2ff; box-shadow: 0 0 20px rgba(185, 242, 255, 0.9); }
      .frame-rainbow { border: 3px solid transparent; background: linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff) border-box; box-shadow: 0 0 25px rgba(255, 255, 255, 0.5); }
      .frame-platinum { border: 3px solid #e5e4e2; box-shadow: 0 0 20px rgba(229, 228, 226, 0.8); }
      .frame-obsidian { border: 3px solid #0b0b0b; box-shadow: 0 0 25px rgba(11, 11, 11, 0.9); }
      .frame-emerald { border: 3px solid #50c878; box-shadow: 0 0 20px rgba(80, 200, 120, 0.8); }
      .frame-ruby { border: 3px solid #e0115f; box-shadow: 0 0 20px rgba(224, 17, 95, 0.8); }
      .frame-sapphire { border: 3px solid #0f52ba; box-shadow: 0 0 20px rgba(15, 82, 186, 0.8); }
      .frame-legendary { border: 3px solid transparent; background: linear-gradient(45deg, #ff6b6b, #ffa500, #ffff00, #00ff00, #00ffff, #0000ff, #8a2be2) border-box; box-shadow: 0 0 30px rgba(255, 255, 255, 0.7); animation: legendary-glow 3s infinite alternate; }
      
      @keyframes legendary-glow {
        0% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.7); }
        50% { box-shadow: 0 0 30px rgba(255, 255, 0, 0.7); }
        100% { box-shadow: 0 0 20px rgba(138, 43, 226, 0.7); }
      }
      
      @media (max-width: 640px) {
        .safe-area-bottom { padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
        .safe-area-top { padding-top: max(0.5rem, env(safe-area-inset-top)); }
        .compact-header { padding: 0.5rem; height: 50px; }
      }

      .avatar-locked { filter: grayscale(1) brightness(0.5); position: relative; }
      .avatar-locked::after { content: "üîí"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; z-index: 10; }

      /* NFT styles */
      .nft-container { position: relative; display: inline-block; }
      .nft-orbital { position: absolute; width: 60px; height: 60px; top: 50%; left: 50%; margin-top: -30px; margin-left: -30px; animation: orbit 10s linear infinite; z-index: 5; pointer-events: none; }
      .nft-item { position: absolute; font-size: 20px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; animation: float 3s ease-in-out infinite; text-shadow: 0 0 5px black; }
      @keyframes orbit { 0% { transform: rotate(0deg) translateX(40px) rotate(0deg); } 100% { transform: rotate(360deg) translateX(40px) rotate(-360deg); } }

      /* Slot machine */
      .slot-machine { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border: 2px solid #475569; border-radius: 12px; padding: 8px; position: relative; overflow: hidden; }
      .slot-reel { height: 50px; display: flex; align-items: center; justify-content: center; font-size: 20px; background: #0f172a; border-radius: 6px; margin: 4px; border: 1px solid #334155; }
      .spinning { animation: spin 0.1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }

      /* NFT Rarity & Float Colors */
      .nft-float-good { color: #4ade80; } /* Low float */
      .nft-float-mid { color: #fbbf24; }
      .nft-float-bad { color: #f87171; }
      
      .price-up { color: #4ade80; animation: pulse-green 1s; }
      .price-down { color: #f87171; animation: pulse-red 1s; }
      
      @keyframes pulse-green { 0% { opacity: 0.5; } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; } }
      @keyframes pulse-red { 0% { opacity: 0.5; } 50% { opacity: 1; transform: scale(0.9); } 100% { opacity: 1; } }
    </style>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
        "date-fns": "https://esm.sh/date-fns@2.30.0",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/database": "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"
      }
    }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Search, Send, Image as ImageIcon, Mic, X, ChevronLeft, Video, Settings as SettingsIcon, Menu, Trash2, Smile, MoreVertical, Lock, LogOut, User as UserIcon, Loader2, Coins, Zap, Crown, Palette, Edit3, Dice5, Trophy, Gift, Bot, TrendingUp, Send as SendIcon, Info, Clock, Star, Sparkles, ShoppingCart, Users, ArrowLeftRight, Shirt } from 'lucide-react';
        import { format } from 'date-fns';
        import { initializeApp } from 'firebase/app';
        import { getDatabase, ref, onValue, set, update, push, off, query, orderByChild, startAt, endAt, remove, get } from 'firebase/database';

        const firebaseConfig = {
            apiKey: "AIzaSyA35T6z2FYS6m9IEJ9x7evxCphgpLhgMX4",
            authDomain: "dolbaebsms-live.firebaseapp.com",
            databaseURL: "https://dolbaebsms-live-default-rtdb.firebaseio.com",
            projectId: "dolbaebsms-live",
            storageBucket: "dolbaebsms-live.firebasestorage.app",
            messagingSenderId: "912825721862",
            appId: "1:912825721862:web:b92d7f7f553ca4536c0f87",
            measurementId: "G-SCD5JVFM5E"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Global NFT Definitions (Massive List) ---
        const ALL_NFTS = [
            // Animals
            { id: 'ghost', name: '–ü—Ä–∏–∑—Ä–∞–∫', emoji: 'üëª', basePrice: 600, rarity: 'common', power: 10, volatility: 0.05 },
            { id: 'robot', name: '–†–æ–±–æ—Ç', emoji: 'ü§ñ', basePrice: 800, rarity: 'common', power: 15, volatility: 0.05 },
            { id: 'panda', name: '–ü–∞–Ω–¥–∞', emoji: 'üêº', basePrice: 900, rarity: 'common', power: 12, volatility: 0.04 },
            { id: 'fox', name: '–õ–∏—Å–∞', emoji: 'ü¶ä', basePrice: 1100, rarity: 'common', power: 18, volatility: 0.06 },
            { id: 'cat', name: '–ö–æ—Ç', emoji: 'üê±', basePrice: 750, rarity: 'common', power: 11, volatility: 0.03 },
            { id: 'dog', name: '–ü–µ—Å', emoji: 'üê∂', basePrice: 700, rarity: 'common', power: 12, volatility: 0.03 },
            
            // Rare
            { id: 'alien', name: '–ü—Ä–∏—à–µ–ª–µ—Ü', emoji: 'üëΩ', basePrice: 1200, rarity: 'rare', power: 25, volatility: 0.08 },
            { id: 'tiger', name: '–¢–∏–≥—Ä', emoji: 'üêØ', basePrice: 1300, rarity: 'rare', power: 30, volatility: 0.07 },
            { id: 'lion', name: '–õ–µ–≤', emoji: 'ü¶Å', basePrice: 1400, rarity: 'rare', power: 35, volatility: 0.07 },
            { id: 'eagle', name: '–û—Ä—ë–ª', emoji: 'ü¶Ö', basePrice: 1600, rarity: 'rare', power: 28, volatility: 0.09 },
            { id: 'skull', name: '–ß–µ—Ä–µ–ø', emoji: 'üíÄ', basePrice: 1500, rarity: 'rare', power: 33, volatility: 0.1 },
            
            // Epic
            { id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω', emoji: 'üêâ', basePrice: 1800, rarity: 'epic', power: 50, volatility: 0.12 },
            { id: 'dinosaur', name: '–î–∏–Ω–æ–∑–∞–≤—Ä', emoji: 'ü¶ñ', basePrice: 2000, rarity: 'epic', power: 45, volatility: 0.11 },
            { id: 'phoenix', name: '–§–µ–Ω–∏–∫—Å', emoji: 'ü¶ö', basePrice: 2200, rarity: 'epic', power: 55, volatility: 0.13 },
            { id: 'whale', name: '–ö–∏—Ç', emoji: 'üêã', basePrice: 2400, rarity: 'epic', power: 48, volatility: 0.08 },
            
            // Legendary
            { id: 'unicorn', name: '–ï–¥–∏–Ω–æ—Ä–æ–≥', emoji: 'ü¶Ñ', basePrice: 3000, rarity: 'legendary', power: 80, volatility: 0.15 },
            { id: 'spaceship', name: '–ö–æ—Ä–∞–±–ª—å', emoji: 'üöÄ', basePrice: 3500, rarity: 'legendary', power: 75, volatility: 0.18 },
            { id: 'comet', name: '–ö–æ–º–µ—Ç–∞', emoji: '‚òÑÔ∏è', basePrice: 4000, rarity: 'legendary', power: 85, volatility: 0.16 },
            { id: 'diamond', name: '–ê–ª–º–∞–∑', emoji: 'üíé', basePrice: 5000, rarity: 'legendary', power: 90, volatility: 0.05 },
            
            // Mythic
            { id: 'crown', name: '–ö–æ—Ä–æ–Ω–∞', emoji: 'üëë', basePrice: 8000, rarity: 'mythic', power: 150, volatility: 0.2 },
            { id: 'blackhole', name: '–ß–µ—Ä–Ω–∞—è –î—ã—Ä–∞', emoji: 'üï≥Ô∏è', basePrice: 10000, rarity: 'mythic', power: 180, volatility: 0.25 },
            { id: 'dna', name: '–î–ù–ö', emoji: 'üß¨', basePrice: 12000, rarity: 'mythic', power: 200, volatility: 0.15 },
            
            // Weapons/Items
            { id: 'sword', name: '–ú–µ—á', emoji: '‚öîÔ∏è', basePrice: 950, rarity: 'common', power: 20, volatility: 0.06 },
            { id: 'shield', name: '–©–∏—Ç', emoji: 'üõ°Ô∏è', basePrice: 900, rarity: 'common', power: 20, volatility: 0.04 },
            { id: 'bomb', name: '–ë–æ–º–±–∞', emoji: 'üí£', basePrice: 1100, rarity: 'rare', power: 40, volatility: 0.12 },
            { id: 'gun', name: '–ü–∏—Å—Ç–æ–ª–µ—Ç', emoji: 'üî´', basePrice: 1250, rarity: 'rare', power: 35, volatility: 0.1 },
            
            // Vehicles
            { id: 'car', name: '–¢–∞—á–∫–∞', emoji: 'üèéÔ∏è', basePrice: 2500, rarity: 'epic', power: 60, volatility: 0.1 },
            { id: 'plane', name: '–°–∞–º–æ–ª–µ—Ç', emoji: '‚úàÔ∏è', basePrice: 3200, rarity: 'legendary', power: 70, volatility: 0.12 },
            
            // Meme/Fun
            { id: 'poop', name: '–ö–∞–∫–∞—à–∫–∞', emoji: 'üí©', basePrice: 5000, rarity: 'mythic', power: 1, volatility: 0.5 },
            { id: 'clown', name: '–ö–ª–æ—É–Ω', emoji: 'ü§°', basePrice: 1500, rarity: 'rare', power: 25, volatility: 0.3 },
            { id: 'peach', name: '–ü–µ—Ä—Å–∏–∫', emoji: 'üçë', basePrice: 800, rarity: 'common', power: 5, volatility: 0.1 }
        ];

        // --- Components ---

        const Button = ({ children, variant = 'primary', className = '', isLoading, icon, ...props }) => {
            const baseStyles = "relative flex items-center justify-center gap-2 px-3 py-2.5 rounded-xl font-medium transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-sm min-h-[44px]";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-100 border border-slate-600",
                danger: "bg-red-500/10 hover:bg-red-500/20 text-red-500 border border-red-500/20",
                ghost: "bg-transparent hover:bg-white/5 text-slate-300",
                gold: "bg-yellow-500 hover:bg-yellow-400 text-white shadow-lg shadow-yellow-500/20"
            };
            return (
                <button className={`${baseStyles} ${variants[variant]} ${className}`} disabled={isLoading || props.disabled} {...props}>
                    {isLoading ? (<Loader2 className="animate-spin h-4 w-4" />) : (<>{icon && <span className="text-base">{icon}</span>}{children}</>)}
                </button>
            );
        };

        const NFTMarketModal = ({ isOpen, onClose, currentUser, userCoins, onCoinsUpdate, userNFTs, onNFTUpdate }) => {
            const [activeTab, setActiveTab] = useState('market');
            const [marketPrices, setMarketPrices] = useState({});
            const [priceTrends, setPriceTrends] = useState({}); // 'up' or 'down'
            const [isLoading, setIsLoading] = useState(false);
            const [giftRecipient, setGiftRecipient] = useState('');
            const [selectedNFTInstance, setSelectedNFTInstance] = useState(null);

            // Listen to market prices
            useEffect(() => {
                const pricesRef = ref(db, 'marketState');
                const unsubscribe = onValue(pricesRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.prices) {
                        setPriceTrends(prev => {
                            const newTrends = {};
                            Object.keys(data.prices).forEach(key => {
                                if (prev[key]) {
                                    newTrends[key] = data.prices[key] > prev[key] ? 'up' : 'down';
                                }
                            });
                            return { ...prev, ...newTrends };
                        });
                        setMarketPrices(data.prices);
                    }
                });
                return () => off(pricesRef);
            }, []);

            if (!isOpen) return null;

            const getCurrentPrice = (nftId) => {
                return Math.floor(marketPrices[nftId] || ALL_NFTS.find(n => n.id === nftId).basePrice);
            };

            const handleBuyNFT = async (nftDef) => {
                const currentPrice = getCurrentPrice(nftDef.id);
                if (userCoins < currentPrice) {
                    alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤! –ù—É–∂–Ω–æ ${currentPrice}`);
                    return;
                }

                setIsLoading(true);
                try {
                    // Generate unique stats
                    const newNFT = {
                        id: nftDef.id,
                        instanceId: `${Date.now()}_${Math.floor(Math.random() * 10000)}`,
                        purchasedAt: Date.now(),
                        wear: parseFloat(Math.random().toFixed(4)), // 0.0000 - 1.0000
                        pattern: Math.floor(Math.random() * 1000), // 0 - 999
                        isEquipped: false
                    };

                    const newNFTList = [...(userNFTs || []), newNFT];
                    
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins - currentPrice,
                        nfts: newNFTList
                    });
                    
                    onCoinsUpdate(userCoins - currentPrice);
                    onNFTUpdate(newNFTList);
                    alert(`–ö—É–ø–ª–µ–Ω: ${nftDef.name} (Float: ${newNFT.wear})`);
                } catch (error) {
                    console.error(error);
                    alert('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏');
                }
                setIsLoading(false);
            };

            const toggleEquip = async (instanceId) => {
                const updatedNFTs = userNFTs.map(nft => {
                    if (nft.instanceId === instanceId) {
                        return { ...nft, isEquipped: !nft.isEquipped };
                    }
                    return nft;
                });
                
                await update(ref(db, `users/${currentUser}`), { nfts: updatedNFTs });
                onNFTUpdate(updatedNFTs);
            };

            const handleSellNFT = async (nftInstance) => {
                const currentPrice = getCurrentPrice(nftInstance.id);
                const sellPrice = Math.floor(currentPrice * 0.8); // 80% of current market value
                
                if (confirm(`–ü—Ä–æ–¥–∞—Ç—å ${ALL_NFTS.find(n => n.id === nftInstance.id).name} –∑–∞ ${sellPrice} –∫–æ–∏–Ω–æ–≤?`)) {
                    setIsLoading(true);
                    const newNFTList = userNFTs.filter(n => n.instanceId !== nftInstance.instanceId);
                    
                    await update(ref(db, `users/${currentUser}`), { 
                        coins: userCoins + sellPrice,
                        nfts: newNFTList
                    });
                    
                    onCoinsUpdate(userCoins + sellPrice);
                    onNFTUpdate(newNFTList);
                    setIsLoading(false);
                }
            };

            const handleGift = async () => {
                if (!giftRecipient.trim() || !selectedNFTInstance) return;
                
                setIsLoading(true);
                try {
                    const recipientRef = ref(db, `users/${giftRecipient.toLowerCase()}`);
                    const snap = await get(recipientRef);
                    if (!snap.exists()) {
                        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        setIsLoading(false);
                        return;
                    }

                    const recData = snap.val();
                    const recNFTs = recData.nfts || [];

                    // Remove from sender
                    const senderNFTs = userNFTs.filter(n => n.instanceId !== selectedNFTInstance.instanceId);
                    await update(ref(db, `users/${currentUser}`), { nfts: senderNFTs });

                    // Add to recipient (Reset equipped status)
                    const giftedNFT = { ...selectedNFTInstance, isEquipped: false, giftedFrom: currentUser };
                    await update(recipientRef, { nfts: [...recNFTs, giftedNFT] });

                    // Send message
                    const chatId = [currentUser, giftRecipient.toLowerCase()].sort().join('_');
                    await push(ref(db, `messages/${chatId}`), {
                        sender: currentUser,
                        text: `–í–∞–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω NFT!`,
                        type: 'nft_gift',
                        nftData: { ...giftedNFT, ...ALL_NFTS.find(n => n.id === giftedNFT.id) },
                        timestamp: Date.now()
                    });

                    onNFTUpdate(senderNFTs);
                    setSelectedNFTInstance(null);
                    setGiftRecipient('');
                    alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                } catch (e) {
                    console.error(e);
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
                }
                setIsLoading(false);
            };

            const getWearColor = (wear) => {
                if (wear < 0.1) return 'text-green-400 font-bold'; // Factory New
                if (wear < 0.3) return 'text-green-200'; // Minimal Wear
                if (wear < 0.6) return 'text-yellow-200'; // Field Tested
                return 'text-red-400'; // Battle Scarred
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-3 bg-black/80 backdrop-blur-sm animate-fade-in safe-area-top safe-area-bottom">
                    <div className="w-full max-w-4xl bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-3 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                            <h2 className="text-lg font-bold text-white flex gap-2"><TrendingUp className="text-yellow-500" /> NFT –ë–∏—Ä–∂–∞</h2>
                            <button onClick={onClose}><X className="text-slate-400" /></button>
                        </div>
                        
                        <div className="flex border-b border-slate-800">
                            {['market', 'inventory', 'gift'].map(t => (
                                <button key={t} onClick={() => setActiveTab(t)} className={`flex-1 py-3 text-sm ${activeTab === t ? 'text-indigo-400 border-b-2 border-indigo-400' : 'text-slate-400'}`}>
                                    {t === 'market' ? '–ú–∞–≥–∞–∑–∏–Ω' : t === 'inventory' ? '–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å' : '–ü–æ–¥–∞—Ä–∏—Ç—å'}
                                </button>
                            ))}
                        </div>

                        <div className="p-4 overflow-y-auto custom-scrollbar flex-1 bg-slate-950">
                            {activeTab === 'market' && (
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                                    {ALL_NFTS.map(nft => {
                                        const price = getCurrentPrice(nft.id);
                                        const trend = priceTrends[nft.id];
                                        return (
                                            <div key={nft.id} className="bg-slate-900 border border-slate-800 p-3 rounded-xl flex flex-col items-center gap-2 relative overflow-hidden group hover:border-indigo-500 transition-colors">
                                                <div className="text-4xl transform group-hover:scale-110 transition-transform">{nft.emoji}</div>
                                                <div className="text-center w-full">
                                                    <div className="font-bold text-sm">{nft.name}</div>
                                                    <div className={`text-xs font-mono flex justify-center items-center gap-1 ${trend === 'up' ? 'price-up' : trend === 'down' ? 'price-down' : 'text-yellow-500'}`}>
                                                        {price} coins
                                                        {trend === 'up' ? '‚ñ≤' : trend === 'down' ? '‚ñº' : ''}
                                                    </div>
                                                </div>
                                                <Button onClick={() => handleBuyNFT(nft)} variant="gold" className="w-full text-xs h-8">–ö—É–ø–∏—Ç—å</Button>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {activeTab === 'inventory' && (
                                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                    {userNFTs.map(inst => {
                                        const def = ALL_NFTS.find(n => n.id === inst.id);
                                        if (!def) return null;
                                        return (
                                            <div key={inst.instanceId} className={`bg-slate-900 border ${inst.isEquipped ? 'border-green-500 bg-green-500/10' : 'border-slate-800'} p-3 rounded-xl flex flex-col items-center gap-2`}>
                                                <div className="text-4xl">{def.emoji}</div>
                                                <div className="text-center w-full">
                                                    <div className="font-bold text-sm">{def.name}</div>
                                                    <div className={`text-[10px] ${getWearColor(inst.wear)}`}>Float: {inst.wear}</div>
                                                    <div className="text-[10px] text-slate-500">Pattern: {inst.pattern}</div>
                                                </div>
                                                <div className="flex gap-1 w-full">
                                                    <Button onClick={() => toggleEquip(inst.instanceId)} variant={inst.isEquipped ? 'secondary' : 'primary'} className="flex-1 text-[10px] h-8 px-1">
                                                        {inst.isEquipped ? '–°–Ω—è—Ç—å' : '–ù–∞–¥–µ—Ç—å'}
                                                    </Button>
                                                    <Button onClick={() => handleSellNFT(inst)} variant="danger" className="flex-1 text-[10px] h-8 px-1">
                                                        –ü—Ä–æ–¥–∞—Ç—å ({Math.floor(getCurrentPrice(inst.id) * 0.8)})
                                                    </Button>
                                                </div>
                                                <Button onClick={() => { setSelectedNFTInstance(inst); setActiveTab('gift'); }} variant="ghost" className="w-full text-[10px] h-6">–ü–æ–¥–∞—Ä–∏—Ç—å</Button>
                                            </div>
                                        );
                                    })}
                                    {userNFTs.length === 0 && <div className="col-span-full text-center text-slate-500">–ü—É—Å—Ç–æ</div>}
                                </div>
                            )}

                            {activeTab === 'gift' && (
                                <div className="flex flex-col items-center gap-4">
                                    {selectedNFTInstance ? (
                                        <div className="bg-slate-800 p-4 rounded-xl text-center border border-yellow-500/50">
                                            <div className="text-6xl mb-2">{ALL_NFTS.find(n => n.id === selectedNFTInstance.id).emoji}</div>
                                            <div className="font-bold">{ALL_NFTS.find(n => n.id === selectedNFTInstance.id).name}</div>
                                            <div className="text-xs text-slate-400">Float: {selectedNFTInstance.wear} | Pattern: {selectedNFTInstance.pattern}</div>
                                        </div>
                                    ) : (
                                        <div className="text-slate-400">–í—ã–±–µ—Ä–∏—Ç–µ NFT –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∞—Ä–∏—Ç—å"</div>
                                    )}
                                    <input 
                                        className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 outline-none" 
                                        placeholder="–ù–∏–∫–Ω–µ–π–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–º–∞–ª–µ–Ω—å–∫–∏–µ –±—É–∫–≤—ã)"
                                        value={giftRecipient}
                                        onChange={e => setGiftRecipient(e.target.value.toLowerCase())}
                                    />
                                    <Button onClick={handleGift} disabled={!selectedNFTInstance || !giftRecipient} className="w-full" variant="gold">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</Button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, currentUser, onLogout, onOpenAvatar, onOpenFrame, onOpenColor, onOpenStatus, userCoins }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in">
                    <div className="w-full max-w-md bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b border-slate-800 flex justify-between items-center">
                            <h2 className="text-lg font-bold flex gap-2 items-center"><SettingsIcon size={20}/> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                            <button onClick={onClose}><X className="text-slate-400"/></button>
                        </div>
                        <div className="p-4 space-y-4">
                             <div className="grid grid-cols-2 gap-3">
                                <Button onClick={onOpenAvatar} variant="secondary" className="h-auto py-4 flex-col gap-2">
                                    <UserIcon size={24}/> <span>–ê–≤–∞—Ç–∞—Ä–∫–∞</span>
                                </Button>
                                <Button onClick={onOpenFrame} variant="secondary" className="h-auto py-4 flex-col gap-2">
                                    <ImageIcon size={24}/> <span>–†–∞–º–∫–∞</span>
                                </Button>
                                <Button onClick={onOpenColor} variant="secondary" className="h-auto py-4 flex-col gap-2">
                                    <Palette size={24}/> <span>–¶–≤–µ—Ç –Ω–∏–∫–∞</span>
                                </Button>
                                <Button onClick={onOpenStatus} variant="secondary" className="h-auto py-4 flex-col gap-2">
                                    <Edit3 size={24}/> <span>–°—Ç–∞—Ç—É—Å</span>
                                </Button>
                            </div>
                            <div className="bg-slate-800 p-3 rounded-xl text-center">
                                <div className="text-slate-400 text-xs">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                                <div className="text-xl font-bold text-yellow-500">{userCoins.toFixed(3)}</div>
                            </div>
                            <Button onClick={onLogout} variant="danger" className="w-full" icon={<LogOut size={16}/>}>–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            // State
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('dolbaeb_user'));
            const [isLoginView, setIsLoginView] = useState(true);
            const [usernameInput, setUsernameInput] = useState('');
            const [passwordInput, setPasswordInput] = useState('');
            const [authError, setAuthError] = useState('');
            
            // Modals
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isAvatarModalOpen, setIsAvatarModalOpen] = useState(false);
            const [isFrameModalOpen, setIsFrameModalOpen] = useState(false);
            const [isColorModalOpen, setIsColorModalOpen] = useState(false);
            const [isStatusModalOpen, setIsStatusModalOpen] = useState(false);
            const [isNFTMarketOpen, setIsNFTMarketOpen] = useState(false);

            // User Data
            const [userCoins, setUserCoins] = useState(0);
            const [userAvatar, setUserAvatar] = useState('');
            const [userFrame, setUserFrame] = useState('');
            const [userNameColor, setUserNameColor] = useState('');
            const [userStatus, setUserStatus] = useState('');
            const [userNFTs, setUserNFTs] = useState([]);
            
            // Other Data
            const [usersData, setUsersData] = useState({});

            // Market Logic (Global Price Updates)
            useEffect(() => {
                if (currentUser) {
                    const updateMarket = () => {
                        const pricesRef = ref(db, 'marketState');
                        get(pricesRef).then(snap => {
                            const data = snap.val() || { prices: {}, lastUpdate: 0 };
                            const now = Date.now();
                            
                            // Update prices every 30 seconds
                            if (now - data.lastUpdate > 30000) {
                                const newPrices = {};
                                ALL_NFTS.forEach(nft => {
                                    const oldPrice = data.prices[nft.id] || nft.basePrice;
                                    const change = (Math.random() - 0.5) * 2 * nft.volatility;
                                    let newPrice = oldPrice * (1 + change);
                                    
                                    // Ensure price stays sane (0.1x to 10x base)
                                    newPrice = Math.max(nft.basePrice * 0.1, Math.min(nft.basePrice * 10, newPrice));
                                    newPrices[nft.id] = Math.floor(newPrice);
                                });
                                update(pricesRef, { prices: newPrices, lastUpdate: now });
                            }
                        });
                    };
                    
                    const interval = setInterval(updateMarket, 10000); // Check every 10s if update needed
                    updateMarket(); // Initial check
                    return () => clearInterval(interval);
                }
            }, [currentUser]);

            // Sync User Data
            useEffect(() => {
                if (currentUser) {
                    const userRef = ref(db, `users/${currentUser}`);
                    return onValue(userRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setUserCoins(data.coins || 0);
                            setUserAvatar(data.avatar || '');
                            setUserFrame(data.frame || '');
                            setUserNameColor(data.nameColor || '');
                            setUserStatus(data.status || '');
                            setUserNFTs(data.nfts || []);
                        }
                    });
                }
            }, [currentUser]);

            // Auth
            const handleAuth = () => {
                let cleanUsername = usernameInput.trim().toLowerCase();
                
                // Validate Username
                const regex = /^[a-z–∞-—è0-9]{1,20}$/;
                if (!regex.test(cleanUsername)) {
                    setAuthError('–ù–∏–∫: 1-20 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã (ru/en) –∏ —Ü–∏—Ñ—Ä—ã, –±–µ–∑ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤.');
                    return;
                }

                if (!passwordInput.trim()) return;

                const userRef = ref(db, `users/${cleanUsername}`);
                get(userRef).then((snapshot) => {
                    const data = snapshot.val();
                    if (isLoginView) {
                        if (data && data.password === passwordInput) {
                            localStorage.setItem('dolbaeb_user', cleanUsername);
                            setCurrentUser(cleanUsername);
                            setAuthError('');
                        } else {
                            setAuthError('–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                        }
                    } else {
                        if (data) {
                            setAuthError('–ù–∏–∫ –∑–∞–Ω—è—Ç');
                        } else {
                            set(userRef, {
                                username: cleanUsername,
                                password: passwordInput,
                                coins: 100, // Bonus for new users
                                createdAt: Date.now()
                            }).then(() => {
                                localStorage.setItem('dolbaeb_user', cleanUsername);
                                setCurrentUser(cleanUsername);
                                setAuthError('');
                            });
                        }
                    }
                });
            };

            const handleLogout = () => {
                localStorage.removeItem('dolbaeb_user');
                setCurrentUser(null);
                setUserCoins(0);
                setIsSettingsOpen(false);
            };

            // Render Render
            if (!currentUser) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-slate-950">
                        <div className="w-full max-w-md bg-slate-900 p-6 rounded-3xl border border-slate-700 shadow-2xl">
                            <h1 className="text-3xl font-bold text-center mb-6">DolbaebSMS</h1>
                            {authError && <div className="p-3 bg-red-500/10 text-red-400 rounded-xl mb-4 text-sm text-center">{authError}</div>}
                            <div className="space-y-3">
                                <input className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 outline-none" placeholder="–ù–∏–∫–Ω–µ–π–º (a-z, –∞-—è, 0-9)" value={usernameInput} onChange={e => setUsernameInput(e.target.value)} />
                                <input className="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 outline-none" type="password" placeholder="–ü–∞—Ä–æ–ª—å" value={passwordInput} onChange={e => setPasswordInput(e.target.value)} />
                                <Button onClick={handleAuth} className="w-full">{isLoginView ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å'}</Button>
                            </div>
                            <button onClick={() => { setIsLoginView(!isLoginView); setAuthError(''); }} className="w-full mt-4 text-sm text-slate-400">{isLoginView ? '–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –°–æ–∑–¥–∞—Ç—å' : '–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏'}</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-slate-950 text-white overflow-hidden safe-area-top">
                    {/* Modals */}
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        currentUser={currentUser}
                        onLogout={handleLogout}
                        userCoins={userCoins}
                        onOpenAvatar={() => setIsAvatarModalOpen(true)}
                        onOpenFrame={() => setIsFrameModalOpen(true)}
                        onOpenColor={() => setIsColorModalOpen(true)}
                        onOpenStatus={() => setIsStatusModalOpen(true)}
                    />

                    <NFTMarketModal 
                        isOpen={isNFTMarketOpen}
                        onClose={() => setIsNFTMarketOpen(false)}
                        currentUser={currentUser}
                        userCoins={userCoins}
                        onCoinsUpdate={setUserCoins}
                        userNFTs={userNFTs}
                        onNFTUpdate={setUserNFTs}
                    />

                    {/* Placeholder Modals for Avatar/Frame/Color/Status (Basic Implementation for functionality check) */}
                    {isAvatarModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80">
                            <div className="bg-slate-900 p-5 rounded-xl border border-slate-700">
                                <h3 className="text-xl font-bold mb-3">–ú–∞–≥–∞–∑–∏–Ω –ê–≤–∞—Ç–∞—Ä–æ–∫</h3>
                                <div className="grid grid-cols-4 gap-2 mb-4">
                                    {['üê∂','üê±','ü¶ä','üêº','ü§ñ','üëΩ','üëª','üíÄ'].map(emoji => (
                                        <button key={emoji} onClick={() => {
                                            update(ref(db, `users/${currentUser}`), { avatar: emoji });
                                            setIsAvatarModalOpen(false);
                                        }} className="text-3xl p-2 hover:bg-slate-800 rounded-lg">{emoji}</button>
                                    ))}
                                </div>
                                <Button onClick={() => setIsAvatarModalOpen(false)} variant="secondary" className="w-full">–ó–∞–∫—Ä—ã—Ç—å</Button>
                            </div>
                        </div>
                    )}

                    {isFrameModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80">
                            <div className="bg-slate-900 p-5 rounded-xl border border-slate-700">
                                <h3 className="text-xl font-bold mb-3">–ú–∞–≥–∞–∑–∏–Ω –†–∞–º–æ–∫</h3>
                                <div className="space-y-2 mb-4">
                                    <button onClick={() => { update(ref(db, `users/${currentUser}`), { frame: 'frame-gold' }); setIsFrameModalOpen(false); }} className="w-full p-2 bg-slate-800 rounded frame-gold text-yellow-500">–ó–æ–ª–æ—Ç–∞—è</button>
                                    <button onClick={() => { update(ref(db, `users/${currentUser}`), { frame: 'frame-rainbow' }); setIsFrameModalOpen(false); }} className="w-full p-2 bg-slate-800 rounded frame-rainbow">–†–∞–¥—É–∂–Ω–∞—è</button>
                                    <button onClick={() => { update(ref(db, `users/${currentUser}`), { frame: '' }); setIsFrameModalOpen(false); }} className="w-full p-2 bg-slate-800 rounded">–°–Ω—è—Ç—å —Ä–∞–º–∫—É</button>
                                </div>
                                <Button onClick={() => setIsFrameModalOpen(false)} variant="secondary" className="w-full">–ó–∞–∫—Ä—ã—Ç—å</Button>
                            </div>
                        </div>
                    )}
                    
                    {/* Main UI Structure - Simplified for Demo */}
                    <div className="w-full md:w-[320px] bg-slate-900 border-r border-slate-800 flex flex-col">
                        <div className="p-3 border-b border-slate-800 flex justify-between items-center">
                            <div className="flex items-center gap-2">
                                <div className="nft-container">
                                    <div className={`w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-xl ${userFrame}`}>
                                        {userAvatar || currentUser[0].toUpperCase()}
                                    </div>
                                    {/* Equipped NFTs Orbital */}
                                    <div className="nft-orbital">
                                        {userNFTs.filter(n => n.isEquipped).map((nft, i, arr) => {
                                            const def = ALL_NFTS.find(d => d.id === nft.id);
                                            if(!def) return null;
                                            const angle = (i / arr.length) * 360;
                                            return (
                                                <div key={nft.instanceId} className="nft-item" style={{ transform: `rotate(${angle}deg) translateX(30px) rotate(-${angle}deg)` }}>
                                                    {def.emoji}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div>
                                    <div className="font-bold">{currentUser}</div>
                                    <div className="text-xs text-yellow-500">{userCoins.toFixed(2)} coins</div>
                                </div>
                            </div>
                            <div className="flex gap-1">
                                <button onClick={() => setIsNFTMarketOpen(true)} className="p-2 hover:bg-slate-800 rounded-lg text-yellow-500"><TrendingUp size={20}/></button>
                                <button onClick={() => setIsSettingsOpen(true)} className="p-2 hover:bg-slate-800 rounded-lg"><SettingsIcon size={20}/></button>
                            </div>
                        </div>
                        <div className="flex-1 p-4 text-center text-slate-500 flex flex-col items-center justify-center">
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)</p>
                            <p className="text-xs mt-2">–í–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏ –º–∞–≥–∞–∑–∏–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!</p>
                        </div>
                    </div>
                    <div className="hidden md:flex flex-1 bg-slate-950 items-center justify-center text-slate-600">
                        DolbaebSMS Desktop
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
