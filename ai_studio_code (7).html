<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Methamphetamine OS</title>
    
    <!-- Firebase (Стабильная версия) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --accent: #6366f1; --bg: #000; --panel: #111; --text: #eee; --error: #ef4444; }
        * { box-sizing: border-box; outline: none; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: url('https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=2070&auto=format&fit=crop') center/cover;
            display: flex; justify-content: center; align-items: center;
        }
        .auth-backdrop {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
        }
        .auth-card {
            position: relative; width: 350px; padding: 40px;
            background: #09090b; border: 1px solid #333; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            text-align: center;
        }
        .auth-header h1 { font-size: 24px; font-weight: 700; color: white; margin-bottom: 5px; }
        .auth-header p { color: #888; font-size: 13px; margin-bottom: 25px; }
        
        .input-box { margin-bottom: 15px; text-align: left; position: relative; }
        .input-box label { font-size: 11px; font-weight: 600; color: #666; margin-bottom: 5px; display: block; letter-spacing: 0.5px; }
        .auth-input {
            width: 100%; padding: 12px; background: #18181b; border: 1px solid #27272a;
            color: white; border-radius: 10px; font-size: 14px; transition: 0.2s;
        }
        .auth-input:focus { border-color: var(--accent); background: #202023; }
        
        /* Глазик для пароля */
        .password-toggle {
            position: absolute; right: 15px; top: 38px; color: #666; cursor: pointer;
        }
        .password-toggle:hover { color: white; }

        .main-btn {
            width: 100%; padding: 12px; background: var(--accent); border: none;
            color: white; font-weight: 600; border-radius: 10px; cursor: pointer;
            margin-top: 10px; transition: 0.2s;
        }
        .main-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .link-btn {
            background: none; border: none; color: #888; font-size: 12px;
            margin-top: 15px; cursor: pointer; text-decoration: underline;
        }
        
        .error-banner {
            background: rgba(239, 68, 68, 0.1); color: #fca5a5; padding: 10px;
            border-radius: 8px; font-size: 12px; margin-bottom: 15px; border: 1px solid var(--error);
            display: none; text-align: left;
        }

        /* --- APP UI --- */
        #app-root { display: none; grid-template-columns: 70px 240px 1fr 45%; height: 100vh; }
        
        .sidebar { background: #050505; border-right: 1px solid #222; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        .icon { width: 45px; height: 45px; border-radius: 14px; background: #18181b; display: grid; place-items: center; margin-bottom: 10px; cursor: pointer; transition: 0.2s; color: #888; }
        .icon:hover, .icon.active { background: var(--accent); color: white; }
        
        .channels { background: #0a0a0a; border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; }
        .c-item { padding: 8px 12px; border-radius: 8px; font-size: 14px; color: #888; cursor: pointer; margin-bottom: 2px; }
        .c-item:hover, .c-item.active { background: #18181b; color: white; }
        .voice-panel { margin-top: auto; padding: 15px; background: #111; border-radius: 12px; border: 1px solid #222; }

        .chat-area { display: flex; flex-direction: column; background: #000; }
        .msg-list { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; gap: 10px; animation: fade 0.3s; }
        @keyframes fade { from{opacity:0; transform:translateY(5px)} to{opacity:1} }
        .msg-bubble { background: #18181b; padding: 8px 14px; border-radius: 0 12px 12px 12px; max-width: 85%; line-height: 1.4; font-size: 14px; word-wrap: break-word; }
        .msg-info { font-size: 10px; color: #666; margin-bottom: 2px; }
        .input-bar { padding: 20px; border-top: 1px solid #222; display: flex; gap: 10px; }
        .chat-input { flex: 1; background: #111; border: 1px solid #222; padding: 10px 15px; border-radius: 8px; color: white; }
        
        .browser-area { border-left: 1px solid #222; display: flex; flex-direction: column; background: #050505; }
        .nav-bar { padding: 10px; border-bottom: 1px solid #222; display: flex; gap: 8px; }
        .url-bar { flex: 1; background: #000; border: 1px solid #333; color: #aaa; border-radius: 6px; padding: 6px 10px; font-family: 'JetBrains Mono'; font-size: 12px; }
        .web-frame { flex: 1; border: none; background: white; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: none; place-items: center; }
        .modal-box { background: #111; padding: 30px; border-radius: 20px; width: 350px; border: 1px solid #333; }
        .danger-btn { width: 100%; padding: 10px; background: #3f1515; color: #fca5a5; border: 1px solid #7f1d1d; border-radius: 8px; cursor: pointer; margin-top: 10px; }

    </style>
</head>
<body>

<!-- ЭКРАН ВХОДА И РЕГИСТРАЦИИ -->
<div id="auth-screen">
    <div class="auth-backdrop"></div>
    <div class="auth-card">
        <div class="auth-header">
            <h1 id="auth-title">ВХОД</h1>
            <p id="auth-desc">Methamphetamine OS</p>
        </div>

        <div class="error-banner" id="error-msg">Ошибка</div>

        <div class="input-box">
            <label>ЛОГИН (НИКНЕЙМ)</label>
            <input type="text" id="username" class="auth-input" placeholder="Придумай логин..." autocomplete="off">
        </div>
        
        <div class="input-box">
            <label>ПАРОЛЬ</label>
            <input type="password" id="password" class="auth-input" placeholder="••••••••">
            <i class="fas fa-eye password-toggle" id="toggle-icon" onclick="togglePass()"></i>
        </div>

        <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px; font-size:12px; color:#888;">
            <input type="checkbox" id="remember" checked>
            <label for="remember" style="margin:0; font-size:12px; font-weight:400; color:#888;">Запомнить меня</label>
        </div>

        <button class="main-btn" id="submit-btn" onclick="processAuth()">ВОЙТИ</button>
        <button class="link-btn" id="toggle-btn" onclick="switchAuth()">Нет аккаунта? Регистрация</button>
    </div>
</div>

<!-- ОКНО НАСТРОЕК -->
<div class="modal" id="settings-modal">
    <div class="modal-box">
        <h2 style="color:white; margin-bottom:20px;">Настройки</h2>
        
        <div class="input-box">
            <label>СМЕНИТЬ ПАРОЛЬ</label>
            <input type="password" id="new-pass" class="auth-input" placeholder="Новый пароль">
            <button onclick="changePass()" style="margin-top:5px; background:#222; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Сохранить</button>
        </div>

        <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333;">
            <button class="danger-btn" onclick="logout()">ВЫЙТИ ИЗ АККАУНТА</button>
            <button class="danger-btn" onclick="deleteUser()" style="background:red; color:white; border:none; margin-top:10px;">УДАЛИТЬ АККАУНТ</button>
        </div>
        <button onclick="document.getElementById('settings-modal').style.display='none'" style="margin-top:20px; background:none; border:none; color:#888; cursor:pointer;">Закрыть</button>
    </div>
</div>

<!-- ПРИЛОЖЕНИЕ -->
<div id="app-root">
    <!-- Сайдбар -->
    <div class="sidebar">
        <div class="icon active"><i class="fas fa-comment"></i></div>
        <div class="icon" onclick="resetBrowser()"><i class="fas fa-globe"></i></div>
        <div class="icon" style="margin-top:auto; margin-bottom:20px;" onclick="document.getElementById('settings-modal').style.display='grid'"><i class="fas fa-user-cog"></i></div>
    </div>

    <!-- Список каналов -->
    <div class="channels">
        <div style="font-size:11px; font-weight:bold; color:#444; margin-bottom:10px;">TEXT CHANNELS</div>
        <div class="c-item active"># general</div>
        <div class="c-item"># media-links</div>
        
        <div class="voice-panel">
            <div style="color:#10b981; font-size:10px; margin-bottom:5px;">ONLINE</div>
            <div style="font-size:9px; color:#555;">MY ID:</div>
            <div id="my-peer-id" style="font-family:'JetBrains Mono'; font-size:10px; color:white; user-select:all;">...</div>
            <input type="text" id="friend-id" placeholder="ID друга" style="width:100%; margin:5px 0; background:#000; border:none; color:white; padding:4px; font-size:11px;">
            <button onclick="callUser()" style="width:100%; background:var(--accent); border:none; color:white; font-size:10px; padding:5px; cursor:pointer; border-radius:4px;">POZVONIT</button>
        </div>
    </div>

    <!-- Чат -->
    <div class="chat-area">
        <div class="msg-list" id="messages"></div>
        <div class="input-bar">
            <input type="text" class="chat-input" id="msg-text" placeholder="Сообщение...">
            <button onclick="sendMsg()" style="background:var(--accent); border:none; width:40px; border-radius:8px; color:white; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Браузер -->
    <div class="browser-area">
        <div class="nav-bar">
            <button onclick="resetBrowser()" style="background:none; border:none; color:#888; cursor:pointer;"><i class="fas fa-home"></i></button>
            <input type="text" class="url-bar" id="url-in" placeholder="Google Search or URL..." onkeypress="if(event.key==='Enter') navigate()">
            <button onclick="navigate()" style="background:none; border:none; color:white; cursor:pointer;"><i class="fas fa-search"></i></button>
        </div>
        <iframe class="web-frame" id="frame" src=""></iframe>
        
        <!-- Окно звонка -->
        <div id="video-zone" style="position:absolute; bottom:20px; right:20px; display:none; background:black; padding:5px; border-radius:10px; border:1px solid #333;">
            <video id="remote-vid" autoplay style="width:200px; border-radius:8px;"></video>
            <video id="local-vid" autoplay muted style="position:absolute; top:10px; right:10px; width:60px; border-radius:4px; border:1px solid white;"></video>
            <button onclick="location.reload()" style="width:100%; background:red; border:none; color:white; font-size:10px; margin-top:5px; cursor:pointer;">СБРОС</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // 1. КОНФИГУРАЦИЯ FIREBASE (ИСПРАВЛЕНА!)
    // ============================================
    const firebaseConfig = {
      apiKey: "AIzaSyBFAWc-An48eKYfTMGhlJICkDPdecEJbb4", // Тут была ошибка (k маленькая)
      authDomain: "kolyasurfing-1a685.firebaseapp.com",
      databaseURL: "https://kolyasurfing-1a685-default-rtdb.firebaseio.com",
      projectId: "kolyasurfing-1a685",
      storageBucket: "kolyasurfing-1a685.firebasestorage.app",
      messagingSenderId: "1039204722214",
      appId: "1:1039204722214:web:0f441d51b176645e3ea8e7",
      measurementId: "G-R7EYJJQ7R5"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const peer = new Peer();

    // ============================================
    // 2. ЛОГИКА АВТОРИЗАЦИИ
    // ============================================
    let isRegister = false;
    let currentUser = null;

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-root').style.display = 'grid';
            loadChat();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
            document.getElementById('app-root').style.display = 'none';
        }
    });

    function togglePass() {
        const passInput = document.getElementById('password');
        const icon = document.getElementById('toggle-icon');
        if (passInput.type === 'password') {
            passInput.type = 'text';
            icon.className = 'fas fa-eye-slash password-toggle';
        } else {
            passInput.type = 'password';
            icon.className = 'fas fa-eye password-toggle';
        }
    }

    function switchAuth() {
        isRegister = !isRegister;
        document.getElementById('auth-title').innerText = isRegister ? "РЕГИСТРАЦИЯ" : "ВХОД";
        document.getElementById('submit-btn').innerText = isRegister ? "СОЗДАТЬ АККАУНТ" : "ВОЙТИ";
        document.getElementById('toggle-btn').innerText = isRegister ? "Уже есть аккаунт? Войти" : "Нет аккаунта? Регистрация";
        document.getElementById('error-msg').style.display = 'none';
    }

    async function processAuth() {
        const login = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value;
        const remember = document.getElementById('remember').checked;
        const errorEl = document.getElementById('error-msg');

        if (!login || !pass) {
            errorEl.innerText = "Введите логин и пароль";
            errorEl.style.display = 'block';
            return;
        }

        const fakeEmail = login + "@meth.os";

        try {
            await auth.setPersistence(remember ? firebase.auth.Auth.Persistence.LOCAL : firebase.auth.Auth.Persistence.SESSION);
            
            if (isRegister) {
                await auth.createUserWithEmailAndPassword(fakeEmail, pass);
                await auth.currentUser.updateProfile({ displayName: login });
            } else {
                await auth.signInWithEmailAndPassword(fakeEmail, pass);
            }
        } catch (err) {
            console.error(err);
            let msg = err.message;
            if(err.code === 'auth/email-already-in-use') msg = "Этот логин уже занят!";
            if(err.code === 'auth/wrong-password') msg = "Неверный пароль!";
            if(err.code === 'auth/user-not-found') msg = "Такого пользователя нет!";
            if(err.code === 'auth/weak-password') msg = "Пароль должен быть от 6 символов!";
            
            errorEl.innerText = msg;
            errorEl.style.display = 'block';
        }
    }

    function logout() { auth.signOut(); location.reload(); }
    
    async function changePass() {
        try {
            await auth.currentUser.updatePassword(document.getElementById('new-pass').value);
            alert('Пароль успешно изменен!');
        } catch(e) { alert(e.message); }
    }

    async function deleteUser() {
        if(confirm("Удалить аккаунт навсегда? Это нельзя отменить.")) {
            try { await auth.currentUser.delete(); } 
            catch(e) { alert("В целях безопасности, выйдите и войдите снова, чтобы удалить аккаунт."); }
        }
    }

    // ============================================
    // 3. ЧАТ
    // ============================================
    const msgInp = document.getElementById('msg-text');
    msgInp.addEventListener('keypress', e => { if(e.key==='Enter') sendMsg() });

    function sendMsg() {
        const txt = msgInp.value.trim();
        if(!txt) return;
        
        cleanupOldMessages();

        db.collection('messages').add({
            user: currentUser.displayName || currentUser.email.split('@')[0],
            text: txt,
            uid: currentUser.uid,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        msgInp.value = '';
    }

    function loadChat() {
        db.collection('messages').orderBy('ts', 'asc').onSnapshot(snap => {
            const list = document.getElementById('messages');
            list.innerHTML = '';
            
            snap.forEach(doc => {
                const d = doc.data();
                if(!d.ts) return;
                
                const div = document.createElement('div');
                div.className = 'msg';
                const color = d.uid === currentUser.uid ? '#6366f1' : '#333';
                
                div.innerHTML = `
                    <div style="width:35px; height:35px; background:${color}; border-radius:50%; flex-shrink:0;"></div>
                    <div>
                        <div class="msg-info">${d.user}</div>
                        <div class="msg-bubble">${d.text}</div>
                    </div>
                `;
                list.appendChild(div);
            });
            list.scrollTop = list.scrollHeight;
        });
    }

    async function cleanupOldMessages() {
        const twoDaysAgo = new Date(Date.now() - (2 * 24 * 60 * 60 * 1000));
        const snapshot = await db.collection('messages').where('ts', '<', twoDaysAgo).get();
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        if(!snapshot.empty) batch.commit();
    }

    // ============================================
    // 4. БРАУЗЕР
    // ============================================
    function navigate() {
        const val = document.getElementById('url-in').value;
        const iframe = document.getElementById('frame');
        
        if(val.includes('youtube') || val.includes('youtu.be')) {
            let v = val.split('v=')[1] || val.split('/').pop();
            v = v.split('&')[0];
            iframe.src = `https://www.youtube.com/embed/${v}?autoplay=1`;
        } else if(val.includes('google')) {
            iframe.src = "https://www.google.com/webhp?igu=1";
        } else {
            if(!val.includes('.')) iframe.src = `https://www.bing.com/search?q=${encodeURIComponent(val)}`;
            else iframe.src = val.startsWith('http') ? val : 'https://' + val;
        }
    }
    
    function resetBrowser() {
        document.getElementById('frame').src = "https://www.google.com/webhp?igu=1";
    }

    // ============================================
    // 5. ЗВОНКИ
    // ============================================
    peer.on('open', id => document.getElementById('my-peer-id').innerText = id);
    peer.on('call', call => {
        navigator.mediaDevices.getUserMedia({audio:true, video:true}).then(stream => {
            document.getElementById('video-zone').style.display = 'block';
            document.getElementById('local-vid').srcObject = stream;
            call.answer(stream);
            call.on('stream', rs => document.getElementById('remote-vid').srcObject = rs);
        })
    });

    function callUser() {
        const id = document.getElementById('friend-id').value;
        navigator.mediaDevices.getUserMedia({audio:true, video:true}).then(stream => {
            document.getElementById('video-zone').style.display = 'block';
            document.getElementById('local-vid').srcObject = stream;
            const call = peer.call(id, stream);
            call.on('stream', rs => document.getElementById('remote-vid').srcObject = rs);
        })
    }

    resetBrowser();

</script>
</body>
</html>